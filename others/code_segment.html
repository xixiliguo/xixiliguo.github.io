<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link rel="icon" type="image/jpg" href="/img/coast.jpg"><title>一些代码片段 | xixiliguo</title><meta name="description" content="stay hungry stay foolish"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.443127ae.js" as="script"><link rel="preload" href="/assets/css/styles.d5a7f181.css" as="style"><link rel="preload" href="/assets/js/838.91c535db.js" as="script"><link rel="preload" href="/assets/js/app.1ace75fc.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.d5a7f181.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><!----><span class="site-name">xixiliguo</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/linux/atop.md" class="nav-link" aria-label="Linux运维"><!--[--><!--]--> Linux运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/network/tcpdump-wireshark.md" class="nav-link" aria-label="网络协议"><!--[--><!--]--> 网络协议 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/golang/golang-exec.md" class="nav-link" aria-label="Golang笔记"><!--[--><!--]--> Golang笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/k8s/runc.md" class="nav-link" aria-label="容器与k8s"><!--[--><!--]--> 容器与k8s <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/algorithm/radix-tree.md" class="nav-link" aria-label="算法笔记"><!--[--><!--]--> 算法笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/kernel/linux-trap.md" class="nav-link" aria-label="内核分析"><!--[--><!--]--> 内核分析 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/others/lua-implemention-gc.md" class="nav-link" aria-label="杂项"><!--[--><!--]--> 杂项 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/linux/atop.md" class="nav-link" aria-label="Linux运维"><!--[--><!--]--> Linux运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/network/tcpdump-wireshark.md" class="nav-link" aria-label="网络协议"><!--[--><!--]--> 网络协议 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/golang/golang-exec.md" class="nav-link" aria-label="Golang笔记"><!--[--><!--]--> Golang笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/k8s/runc.md" class="nav-link" aria-label="容器与k8s"><!--[--><!--]--> 容器与k8s <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/algorithm/radix-tree.md" class="nav-link" aria-label="算法笔记"><!--[--><!--]--> 算法笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/kernel/linux-trap.md" class="nav-link" aria-label="内核分析"><!--[--><!--]--> 内核分析 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/others/lua-implemention-gc.md" class="nav-link" aria-label="杂项"><!--[--><!--]--> 杂项 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">杂项</p><ul class=""><li><!--[--><a href="/others/lua-implemention-gc.html" class="nav-link sidebar-item" aria-label="Lua实现原理 - GC垃圾回收"><!--[--><!--]--> Lua实现原理 - GC垃圾回收 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/others/lua-implemention-type-value.html" class="nav-link sidebar-item" aria-label="Lua实现原理 - 类型与值"><!--[--><!--]--> Lua实现原理 - 类型与值 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/others/code_segment.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="一些代码片段"><!--[--><!--]--> 一些代码片段 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/others/code_segment.html#使用golang实现类似ping获取网络时延" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用golang实现类似ping获取网络时延"><!--[--><!--]--> 使用golang实现类似ping获取网络时延 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/others/code_segment.html#使用golang打印系统调用时errorno的含义" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用golang打印系统调用时errorno的含义"><!--[--><!--]--> 使用golang打印系统调用时errorno的含义 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/others/code_segment.html#分析两个关于超出最大文件数的错误逻辑" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="分析两个关于超出最大文件数的错误逻辑"><!--[--><!--]--> 分析两个关于超出最大文件数的错误逻辑 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/others/code_segment.html#分析eagain的产生场景" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="分析EAGAIN的产生场景"><!--[--><!--]--> 分析EAGAIN的产生场景 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/others/code_segment.html#实现类似hexdump打印格式的代码" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="实现类似hexdump打印格式的代码"><!--[--><!--]--> 实现类似hexdump打印格式的代码 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>记录自己日常写的一些代码片段</p><h3 id="使用golang实现类似ping获取网络时延" tabindex="-1"><a class="header-anchor" href="#使用golang实现类似ping获取网络时延" aria-hidden="true">#</a> 使用golang实现类似ping获取网络时延</h3><div class="language-golang ext-golang"><pre class="language-golang"><code>package main

import (
	&quot;log&quot;
	&quot;net&quot;
	&quot;os&quot;
	&quot;syscall&quot;
	&quot;time&quot;
	&quot;unsafe&quot;

	&quot;golang.org/x/net/icmp&quot;
	&quot;golang.org/x/net/ipv4&quot;
)

func main() {

	conn, err := net.DialIP(&quot;ip4:icmp&quot;, nil, &amp;net.IPAddr{IP: net.ParseIP(&quot;114.114.114.114&quot;)})
	if err != nil {
		log.Fatalf(&quot;net DialIP: %s&quot;, err)
	}
	rawconn, err := conn.SyscallConn()
	if err != nil {
		log.Fatalf(&quot;get raw: %s&quot;, err)
	}
	rawconn.Control(func(fd uintptr) {
		syscall.SetsockoptInt(int(fd), syscall.SOL_SOCKET, syscall.SO_TIMESTAMP, 1)

	})
	wm := icmp.Message{
		Type: ipv4.ICMPTypeEcho,
		Code: 0,
		Body: &amp;icmp.Echo{
			ID: os.Getpid() &amp; 0xffff, Seq: 1,
			Data: []byte(&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;),
		},
	}
	wb, err := wm.Marshal(nil)
	if err != nil {
		log.Fatalf(&quot;generate icmp request: %s&quot;, err)
	}

	beforetime := time.Now()
	log.Printf(&quot;send %+v\n&quot;, wm)
	_, err = conn.Write(wb)
	if err != nil {
		log.Fatalf(&quot;send icmp request: %s&quot;, err)
	}

	rb := make([]byte, 1500)
	oob := make([]byte, 1500)
	n, oobn, _, addr, err := conn.ReadMsgIP(rb, oob)

	if err != nil {
		log.Fatal(err)
	}

	header, err := ipv4.ParseHeader(rb[:n])
	if err != nil {
		log.Fatalf(&quot;decode ip header of icmp response: %s&quot;, err)
	}

	rm, err := icmp.ParseMessage(1, rb[header.Len:n])

	if err != nil {
		log.Fatalf(&quot;parse icmp messages: %s&quot;, err)
	}
	switch rm.Type {
	case ipv4.ICMPTypeEchoReply:
		resp := rm.Body.(*icmp.Echo)
		if resp.ID != os.Getpid()&amp;0xffff || resp.Seq != 1 {
			log.Fatalf(&quot;receiv icmp response for antoher process&quot;)
		}
		cmsgs, err := syscall.ParseSocketControlMessage(oob[:oobn])
		if err != nil {
			log.Fatalf(&quot;parse cmsg: %s&quot;, err)
		}
		m := cmsgs[0]
		aftertime := time.Now()
		if m.Header.Level == syscall.SOL_SOCKET &amp;&amp; m.Header.Type == syscall.SCM_TIMESTAMP {
			var recvtime syscall.Timeval
			recvtime = *(*syscall.Timeval)(unsafe.Pointer(&amp;m.Data[0]))
			aftertime = time.Unix(recvtime.Unix())
			log.Printf(&quot;using so_timestamp&quot;)
		}
		log.Printf(&quot;after %dms, got msg %+v from %v&quot;, aftertime.Sub(beforetime).Milliseconds(), rm, addr)

	default:
		log.Printf(&quot;got %+v from %v; want echo reply&quot;, rm, addr)
	}

}
</code></pre></div><p>运行结果如下:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ go run main.go
<span class="token number">2020</span>/09/30 00:12:07 send <span class="token punctuation">{</span>Type:echo Code:0 Checksum:0 Body:0xc000094870<span class="token punctuation">}</span>
<span class="token number">2020</span>/09/30 00:12:07 using so_timestamp
<span class="token number">2020</span>/09/30 00:12:07 after 30ms, got msg <span class="token operator">&amp;</span><span class="token punctuation">{</span>Type:echo reply Code:0 Checksum:38592 Body:0xc00006c060<span class="token punctuation">}</span> from <span class="token number">114.114</span>.114.114
</code></pre></div><h3 id="使用golang打印系统调用时errorno的含义" tabindex="-1"><a class="header-anchor" href="#使用golang打印系统调用时errorno的含义" aria-hidden="true">#</a> 使用golang打印系统调用时errorno的含义</h3><div class="language-golang ext-golang"><pre class="language-golang"><code>package main

import (
	&quot;fmt&quot;
	&quot;syscall&quot;
)

func main() {
	for i := 1; i &lt; 133; i++ {
		errno := syscall.Errno(i)
		fmt.Printf(&quot;Errno %d 0x%x: %s\n&quot;, i, i, errno.Error())
	}
}
</code></pre></div><p>运行结果如下:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ go run main.go
Errno <span class="token number">1</span> 0x1: operation not permitted
Errno <span class="token number">2</span> 0x2: no such <span class="token function">file</span> or directory
Errno <span class="token number">3</span> 0x3: no such process
Errno <span class="token number">4</span> 0x4: interrupted system call
Errno <span class="token number">5</span> 0x5: input/output error
Errno <span class="token number">6</span> 0x6: no such device or address
Errno <span class="token number">7</span> 0x7: argument list too long
Errno <span class="token number">8</span> 0x8: <span class="token builtin class-name">exec</span> <span class="token function">format</span> error
Errno <span class="token number">9</span> 0x9: bad <span class="token function">file</span> descriptor
Errno <span class="token number">10</span> 0xa: no child processes
Errno <span class="token number">11</span> 0xb: resource temporarily unavailable
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre></div><h3 id="分析两个关于超出最大文件数的错误逻辑" tabindex="-1"><a class="header-anchor" href="#分析两个关于超出最大文件数的错误逻辑" aria-hidden="true">#</a> 分析两个关于超出最大文件数的错误逻辑</h3><p>ENFILE是指超过了系统级最大的文件句柄数. <code>sysctl fs.file-max</code><br> EMFILE是指超过了该进程指定的最大文件数. <code>cat /proc/[pid]/limits</code>里的<code>Max open files</code></p><div class="language-c ext-c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">ENFILE</span>		<span class="token expression"><span class="token number">23</span>	</span><span class="token comment">/* File table overflow */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EMFILE</span>		<span class="token expression"><span class="token number">24</span>	</span><span class="token comment">/* Too many open files */</span></span>
</code></pre></div><p><code>Too many open files</code> 演示代码:</p><div class="language-c ext-c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> old_lim<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> new_lim<span class="token punctuation">;</span>

    <span class="token comment">// Get old limits</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_lim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Old limits -&gt; soft limit= %ld \t&quot;</span>
          <span class="token string">&quot; hard limit= %ld \n&quot;</span><span class="token punctuation">,</span> old_lim<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">,</span>
                               old_lim<span class="token punctuation">.</span>rlim_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set new value</span>
    lim<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    lim<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>


    <span class="token comment">// Set limits</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get new limits</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NOFILE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_lim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;New limits -&gt; soft limit= %ld \t&quot;</span>
          <span class="token string">&quot; hard limit= %ld \n&quot;</span><span class="token punctuation">,</span> new_lim<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">,</span>
                                new_lim<span class="token punctuation">.</span>rlim_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Try to open a new file</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;errno %d: %s\n&quot;</span><span class="token punctuation">,</span> errno<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Opened successfully\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果如下, 说明当进程打开的文件数超过<code>ulimit -a</code>里设置的值或者<code>RLIMIT_NOFILE</code>, 两者等价. 返回<code>EMFILE</code> 24号错误</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ gcc -g testopenfiles-process.c -o testopenfiles-process <span class="token operator">&amp;&amp;</span> ./testopenfiles-process
Old limits -<span class="token operator">&gt;</span> soft <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">1048576</span> 	 hard <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">1048576</span>
New limits -<span class="token operator">&gt;</span> soft <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">3</span> 	 hard <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">3</span>
errno <span class="token number">24</span>: Too many <span class="token function">open</span> files
</code></pre></div><p><code>File table overflow</code> 或者<code>Too many open files in system</code>演示代码:</p><div class="language-c ext-c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">200000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">&quot;foo%d.txt&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;errno %d: %s\n&quot;</span><span class="token punctuation">,</span> errno<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Opened successfully\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果如下, 说明当进程打开的文件数系统的最大文件数时. 返回<code>ENFILE</code> 23号错误</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ gcc -g testopenfiles-system.c -o testopenfiles-system <span class="token operator">&amp;&amp;</span> ./testopenfiles-system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
errno <span class="token number">23</span>: Too many <span class="token function">open</span> files <span class="token keyword">in</span> system
</code></pre></div><p>dmesg里可以同时也打印类似<code>VFS: file-max limit 135375 reached</code>这样的日志.</p><h3 id="分析eagain的产生场景" tabindex="-1"><a class="header-anchor" href="#分析eagain的产生场景" aria-hidden="true">#</a> 分析EAGAIN的产生场景</h3><div class="language-c ext-c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">EAGAIN</span>		<span class="token expression"><span class="token number">11</span>	</span><span class="token comment">/* Try again */</span></span>
</code></pre></div><p>在<code>fork</code>等系统调用时返回<code>EAGAIN Resource temporarily unavailable</code>是因为进程/线程数超限了, 要检查两种情况</p><ol><li>当该进程/线程对应的用户的所有进程数超过上限, <code>ulimit -a</code>里的<code>NOFILE</code></li><li><code>sysctl kernel.pid_max</code> OS系统级的最大进程数<br> 有一篇详细的案例可参考: https://access.redhat.com/solutions/1434943<br><code>man 2 fork</code>里的解释如下:</li></ol><div class="language-text ext-text"><pre class="language-text"><code>EAGAIN fork() cannot allocate sufficient memory to copy the parent&#39;s page tables and allocate a task structure for the child.
EAGAIN It  was  not  possible to create a new process because the caller&#39;s RLIMIT_NPROC resource limit was encountered.  To exceed this limit, the process must have either the CAP_SYS_ADMIN or the CAP_SYS_RESOURCE capability.   
</code></pre></div><p>非root用户执行如下代码:</p><div class="language-c ext-c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/resource.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> old_lim<span class="token punctuation">,</span> lim<span class="token punctuation">,</span> new_lim<span class="token punctuation">;</span>

  <span class="token comment">// Get old limits</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NPROC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_lim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Old limits -&gt; soft limit= %ld \t&quot;</span>
        <span class="token string">&quot; hard limit= %ld \n&quot;</span><span class="token punctuation">,</span>
        old_lim<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">,</span> old_lim<span class="token punctuation">.</span>rlim_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Set new value</span>
  lim<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  lim<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

  <span class="token comment">// Set limits</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_NPROC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Get new limits</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getrlimit</span><span class="token punctuation">(</span>RLIMIT_NPROC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_lim<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token function">printf</span><span class="token punctuation">(</span>
        <span class="token string">&quot;New limits -&gt; soft limit= %ld &quot;</span>
        <span class="token string">&quot;\t hard limit= %ld \n&quot;</span><span class="token punctuation">,</span>
        new_lim<span class="token punctuation">.</span>rlim_cur<span class="token punctuation">,</span> new_lim<span class="token punctuation">.</span>rlim_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;%s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token keyword">int</span> targetFork <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token class-name">pid_t</span> forkResult<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> targetFork<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    forkResult <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>forkResult <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;errno %d %s\n&quot;</span><span class="token punctuation">,</span> errno<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>forkResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Child pid: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parent pid: %d trigger fork %d times %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果为:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ ./a.out
Old limits -<span class="token operator">&gt;</span> soft <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">4096</span> 	 hard <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">5370</span>
New limits -<span class="token operator">&gt;</span> soft <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">5</span> 	 hard <span class="token assign-left variable">limit</span><span class="token operator">=</span> <span class="token number">5</span>
Parent pid: <span class="token number">26665</span> trigger fork <span class="token number">1</span> <span class="token builtin class-name">times</span> <span class="token number">1068333019</span>
Child pid: <span class="token number">26666</span>
Parent pid: <span class="token number">26665</span> trigger fork <span class="token number">2</span> <span class="token builtin class-name">times</span> <span class="token number">1068329250</span>
Parent pid: <span class="token number">26665</span> trigger fork <span class="token number">3</span> <span class="token builtin class-name">times</span> <span class="token number">1068329250</span>
Child pid: <span class="token number">26667</span>
errno <span class="token number">11</span> Resource temporarily unavailable
errno <span class="token number">11</span> Resource temporarily unavailable
errno <span class="token number">11</span> Resource temporarily unavailable
errno <span class="token number">11</span> Resource temporarily unavailable
errno <span class="token number">11</span> Resource temporarily unavailable
errno <span class="token number">11</span> Resource temporarily unavailable
errno <span class="token number">11</span> Resource temporarily unavailable
Child pid: <span class="token number">26668</span>
</code></pre></div><p>如果是<code>root</code>用户执行, 则不会有报错, 是因为root默认有<code>CAP_SYS_ADMIN</code>或者<code>CAP_SYS_RESOURCE</code>权限</p><h3 id="实现类似hexdump打印格式的代码" tabindex="-1"><a class="header-anchor" href="#实现类似hexdump打印格式的代码" aria-hidden="true">#</a> 实现类似hexdump打印格式的代码</h3><div class="language-c ext-c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">extern</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>environ<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">hexDump</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>desc<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buffLine<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>pc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>desc <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:\n&quot;</span><span class="token punctuation">,</span> desc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s\n&quot;</span><span class="token punctuation">,</span> buffLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Prints the ADDRESS</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %08x &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Prints the HEXCODES that represent each chars.</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%02x&quot;</span><span class="token punctuation">,</span> pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0x20</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0x7e</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      buffLine<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;.&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      buffLine<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> pc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buffLine<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;\0&#39;</span><span class="token punctuation">;</span>  <span class="token comment">// Clears the next array buffLine</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;   &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;  &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;  %s\n&quot;</span><span class="token punctuation">,</span> buffLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>end<span class="token punctuation">;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;argc = %p %d\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>argc<span class="token punctuation">,</span> argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;argv = %p\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;argv[%d] = %p %s\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;environ = %p\n&quot;</span><span class="token punctuation">,</span> environ<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;environ[%d] = %p %s\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> environ<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>end <span class="token operator">=</span> environ<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">*</span>end <span class="token operator">!=</span> <span class="token number">0x00</span><span class="token punctuation">;</span> end<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">hexDump</span><span class="token punctuation">(</span><span class="token string">&quot;begin from argv[0]&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> end <span class="token operator">-</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">7/18/2021, 6:56:35 AM</span></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/others/lua-implemention-type-value.html" class="nav-link" aria-label="Lua实现原理 - 类型与值"><!--[--><!--]--> Lua实现原理 - 类型与值 <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.443127ae.js" defer></script><script src="/assets/js/838.91c535db.js" defer></script><script src="/assets/js/app.1ace75fc.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link rel="icon" type="image/jpg" href="/img/coast.jpg"><title>Linux 网卡多队列介绍 | xixiliguo</title><meta name="description" content="stay hungry stay foolish"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.443127ae.js" as="script"><link rel="preload" href="/assets/css/styles.d5a7f181.css" as="style"><link rel="preload" href="/assets/js/838.91c535db.js" as="script"><link rel="preload" href="/assets/js/app.1ace75fc.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.d5a7f181.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><!----><span class="site-name">xixiliguo</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/linux/atop.md" class="nav-link" aria-label="Linux运维"><!--[--><!--]--> Linux运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/network/tcpdump-wireshark.md" class="nav-link" aria-label="网络协议"><!--[--><!--]--> 网络协议 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/golang/golang-exec.md" class="nav-link" aria-label="Golang笔记"><!--[--><!--]--> Golang笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/k8s/runc.md" class="nav-link" aria-label="容器与k8s"><!--[--><!--]--> 容器与k8s <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/algorithm/radix-tree.md" class="nav-link" aria-label="算法笔记"><!--[--><!--]--> 算法笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/kernel/linux-trap.md" class="nav-link" aria-label="内核分析"><!--[--><!--]--> 内核分析 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/others/lua-implemention-gc.md" class="nav-link" aria-label="杂项"><!--[--><!--]--> 杂项 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/linux/atop.md" class="nav-link" aria-label="Linux运维"><!--[--><!--]--> Linux运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/network/tcpdump-wireshark.md" class="nav-link" aria-label="网络协议"><!--[--><!--]--> 网络协议 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/golang/golang-exec.md" class="nav-link" aria-label="Golang笔记"><!--[--><!--]--> Golang笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/k8s/runc.md" class="nav-link" aria-label="容器与k8s"><!--[--><!--]--> 容器与k8s <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/algorithm/radix-tree.md" class="nav-link" aria-label="算法笔记"><!--[--><!--]--> 算法笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/kernel/linux-trap.md" class="nav-link" aria-label="内核分析"><!--[--><!--]--> 内核分析 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/others/lua-implemention-gc.md" class="nav-link" aria-label="杂项"><!--[--><!--]--> 杂项 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">Linux运维</p><ul class=""><li><!--[--><a href="/linux/atop.html" class="nav-link sidebar-item" aria-label="ATOP工作原理总结"><!--[--><!--]--> ATOP工作原理总结 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/cloud-init.html" class="nav-link sidebar-item" aria-label="cloud-init学习笔记"><!--[--><!--]--> cloud-init学习笔记 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/linux-shadow.html" class="nav-link sidebar-item" aria-label="Linux /etc/shadow 文件学习笔记"><!--[--><!--]--> Linux /etc/shadow 文件学习笔记 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/bandersnatch-pypi.html" class="nav-link sidebar-item" aria-label="使用Bandersnatch搭建私有Pypi源"><!--[--><!--]--> 使用Bandersnatch搭建私有Pypi源 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/ntp.html" class="nav-link sidebar-item" aria-label="理解NTP协议"><!--[--><!--]--> 理解NTP协议 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/dns.html" class="nav-link sidebar-item" aria-label="DNS学习总结"><!--[--><!--]--> DNS学习总结 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/linux/multi-queue.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="Linux 网卡多队列介绍"><!--[--><!--]--> Linux 网卡多队列介绍 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/linux/multi-queue.html#多网卡队列实现图例" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="多网卡队列实现图例"><!--[--><!--]--> 多网卡队列实现图例 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/linux/multi-queue.html#检查中断与对应的cpu关系" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="检查中断与对应的CPU关系"><!--[--><!--]--> 检查中断与对应的CPU关系 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/linux/multi-queue.html#rps-xps-rfs" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="RPS, XPS, RFS"><!--[--><!--]--> RPS, XPS, RFS <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/linux/multi-queue.html#根据top输出查看软中断负载" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="根据top输出查看软中断负载"><!--[--><!--]--> 根据top输出查看软中断负载 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/linux/multi-queue.html#参考" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="参考"><!--[--><!--]--> 参考 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/linux/linux-boot.html" class="nav-link sidebar-item" aria-label="Linux Boot过程总结"><!--[--><!--]--> Linux Boot过程总结 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/yum-update.html" class="nav-link sidebar-item" aria-label="使用Yum 升级OS"><!--[--><!--]--> 使用Yum 升级OS <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/linux/linux-common-commands.html" class="nav-link sidebar-item" aria-label="Linux 下常用命令与技巧汇总"><!--[--><!--]--> Linux 下常用命令与技巧汇总 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>单CPU处理网络IO存在瓶颈, 目前经常使用网卡多队列提高性能.</p><p>通常情况下, 每张网卡有一个队列(queue), 所有收到的包从这个队列入, 内核从这个队列里取数据处理. 该队列其实是ring buffer(环形队列), 内核如果取数据不及时, 则会存在丢包的情况.<br> 一个CPU处理一个队列的数据, 这个叫中断. 默认是cpu0(第一个CPU)处理. 一旦流量特别大, 这个CPU负载很高, 性能存在瓶颈. 所以网卡开发了多队列功能, 即一个网卡有多个队列, 收到的包根据TCP四元组信息hash后放入其中一个队列, 后面该链接的所有包都放入该队列. 每个队列对应不同的中断, 使用irqbalance将不同的中断绑定到不同的核. 充分利用了多核并行处理特性. 提高了效率.</p><h3 id="多网卡队列实现图例" tabindex="-1"><a class="header-anchor" href="#多网卡队列实现图例" aria-hidden="true">#</a> 多网卡队列实现图例</h3><div class="language-text ext-text"><pre class="language-text"><code>             普通单队列                                   
   +-----------------------------+                        
   | queue                       |                        
   |                             |                        
   |   +----------+  +----------+|           +---------+  
   |   |  packet  |  |  packet  ||----------&gt;|  CPU 0  |  
   |   +----------+  +----------+|           +---------+  
   +-----------------------------+                        
                                                    
                             开启多网卡队列               
                                                        
    +----------------------------+                       
    | queue                      |                       
    |                            |                       
    |  +----------+ +----------+ |           +---------+ 
    |  |  packet  | |  packet  | |---------&gt; |  CPU 0  | 
    |  +----------+ +----------+ |           +---------+ 
    +----------------------------+           +---------+ 
                                             |  CPU 1  |  
                                             +---------+  
                                             +---------+  
    +----------------------------+           |  CPU 2  |  
    | queue                      |           +---------+  
    |                            |                        
    |  +----------+ +----------+ |           +---------+  
    |  |  packet  | |  packet  | |---------&gt; |  CPU 3  |  
    |  +----------+ +----------+ |           +---------+  
    +----------------------------+                        
</code></pre></div><h3 id="检查中断与对应的cpu关系" tabindex="-1"><a class="header-anchor" href="#检查中断与对应的cpu关系" aria-hidden="true">#</a> 检查中断与对应的CPU关系</h3><p>如下显示, 第一列是中断号, 后面两列是对应CPU处理该中断的次数, virtio-input和 virtio-output为网卡队列的中断 可见大部分包被CPU1处理</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># cat /proc/interrupts | egrep &#39;CPU|virtio.*(input|output)&#39;</span>
           CPU0       CPU1
 <span class="token number">27</span>:          <span class="token number">7</span>      <span class="token number">89632</span>   PCI-MSI-edge      virtio3-input.0
 <span class="token number">30</span>:          <span class="token number">2</span>          <span class="token number">0</span>   PCI-MSI-edge      virtio3-output.0
 <span class="token number">31</span>:          <span class="token number">7</span>      <span class="token number">23319</span>   PCI-MSI-edge      virtio3-input.1
 <span class="token number">32</span>:          <span class="token number">2</span>          <span class="token number">0</span>   PCI-MSI-edge      virtio3-output.1
</code></pre></div><p>查询具体中断所绑定的CPU信息<br> smp_affinity_list显示CPU序号. 比如 0 代表 CPU0, 2代表 CPU2 smp_affinity 是十六进制显示. 比如 2 为10, 代表 CPU1 (第二个CPU)</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># for i in {30..32}; do echo -n &quot;Interrupt $i is allowed on CPUs &quot;; cat /proc/irq/$i/smp_affinity_list; done</span>
Interrupt <span class="token number">30</span> is allowed on CPUs <span class="token number">0</span>
Interrupt <span class="token number">31</span> is allowed on CPUs <span class="token number">1</span>
Interrupt <span class="token number">32</span> is allowed on CPUs <span class="token number">0</span>
</code></pre></div><h3 id="rps-xps-rfs" tabindex="-1"><a class="header-anchor" href="#rps-xps-rfs" aria-hidden="true">#</a> RPS, XPS, RFS</h3><p>之前谈的多网卡队列需要硬件实现, RPS则是软件实现,将包让指定的CPU去处理中断.<br> 配置文件为<code>/sys/class/net/eth*/queues/rx*/rps_cpus</code>. 默认为0, 表示不启动RPS 如果要让该队列被CPU0,1处理, 则设置 echo &quot;3&quot; &gt; /sys/class/net/eth*/queues/rx*/rps_cpus, 3代表十六进制表示11, 即指CPU0和CPU1<br> 在开启多网卡队列RSS时, 已经起到了均衡的作用. RPS则可以在队列数小于CPU数时, 进一步提升性能. 因为进一步利用所有CPU. RFS则进一步扩展RPS的能力, 它会分析并将包发往最合适的CPU(程序运行所在的CPU). 检查当前RPS, RFS开启情况:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># for i in $(ls -1 /sys/class/net/eth*/queues/rx*/rps_*); do echo -n &quot;${i}:  &quot;  ; cat ${i}; done</span>
/sys/class/net/eth0/queues/rx-0/rps_cpus:  <span class="token number">3</span>
/sys/class/net/eth0/queues/rx-0/rps_flow_cnt:  <span class="token number">4096</span>
/sys/class/net/eth0/queues/rx-1/rps_cpus:  <span class="token number">3</span>
/sys/class/net/eth0/queues/rx-1/rps_flow_cnt:  <span class="token number">4096</span>
<span class="token comment"># cat /proc/sys/net/core/rps_sock_flow_entries</span>
<span class="token number">8192</span>
</code></pre></div><p>XPS是将发送包指定到CPU, 通常和同一队列的rps和xps配置一致.</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># for i in $(ls -1 /sys/class/net/eth*/queues/tx*/xps_cpus); do echo -n &quot;${i}:  &quot;  ; cat ${i}; done</span>
/sys/class/net/eth0/queues/tx-0/xps_cpus:  <span class="token number">3</span>
/sys/class/net/eth0/queues/tx-1/xps_cpus:  <span class="token number">3</span>
</code></pre></div><h3 id="根据top输出查看软中断负载" tabindex="-1"><a class="header-anchor" href="#根据top输出查看软中断负载" aria-hidden="true">#</a> 根据top输出查看软中断负载</h3><p>top进入交互式界面后, 按1 显示所有cpu的负载. si 是软中断的CPU使用率. 如果高比如50%, 说明该CPU忙于处理中断, 通常就是收发网络IO</p><div class="language-text ext-text"><pre class="language-text"><code>top - 18:58:33 up 16 days, 19:58,  2 users,  load average: 0.00, 0.01, 0.05
Tasks:  89 total,   2 running,  87 sleeping,   0 stopped,   0 zombie
%Cpu0  :  1.3 us,  0.0 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
%Cpu1  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  3880032 total,  2911912 free,   199600 used,   768520 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  3411892 avail Mem
</code></pre></div><h3 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h3><p>https://www.kernel.org/doc/Documentation/IRQ-affinity.txt<br> https://www.kernel.org/doc/Documentation/networking/scaling.txt<br> https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-red_hat_enterprise_linux-performance_tuning_guide-networking-configuration_tools#sect-Red_Hat_Enterprise_Linux-Performance_Tuning_Guide-Configuration_tools-Configuring_Receive_Packet_Steering_RPS<br> https://lwn.net/Articles/370153/<br> https://lwn.net/Articles/412062/</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">7/18/2021, 6:56:35 AM</span></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/linux/dns.html" class="nav-link" aria-label="DNS学习总结"><!--[--><!--]--> DNS学习总结 <!--[--><!--]--></a></span><span class="next"><a href="/linux/linux-boot.html" class="nav-link" aria-label="Linux Boot过程总结"><!--[--><!--]--> Linux Boot过程总结 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.443127ae.js" defer></script><script src="/assets/js/838.91c535db.js" defer></script><script src="/assets/js/app.1ace75fc.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>cloud-init学习笔记 | xixiliguo</title>
    <meta name="description" content="博客">
    <link rel="stylesheet" href="/assets/style.d1dca3a2.css">
    <link rel="modulepreload" href="/assets/app.526dca4e.js">
    <link rel="modulepreload" href="/assets/linux_cloud-init.md.e0bc6141.lean.js">
    
    <script>(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-6b5fd0a9><!--[--><!--]--><!--[--><span tabindex="-1" data-v-45f6ae50></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-45f6ae50> Skip to content </a><!--]--><!----><header class="VPNav" data-v-6b5fd0a9 data-v-0e356168><div class="VPNavBar has-sidebar" data-v-0e356168 data-v-8856f192><div class="container" data-v-8856f192><div class="VPNavBarTitle has-sidebar" data-v-8856f192 data-v-6a6f7ff6><a class="title" href="/" data-v-6a6f7ff6><!--[--><img class="VPImage logo" src="/img/coast.jpg" data-v-73ae1788><!--]--><!--[-->xixiliguo<!--]--></a></div><div class="content" data-v-8856f192><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8856f192 data-v-a30758ee><span id="main-nav-aria-label" class="visually-hidden" data-v-a30758ee>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/linux-common-commands.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Linux运维<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/network/tcp.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->网络协议<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/golang/golang-exec.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Golang笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/k8s/runc.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->容器与k8s<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/radix-tree.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->算法笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/kernel/kernel-syscall-sched.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->内核分析<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/code_segment.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->杂项<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8856f192 data-v-311055f2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-311055f2 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-8856f192 data-v-0562f5c0 data-v-8dccea88><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8dccea88><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8dccea88><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8dccea88><div class="VPMenu" data-v-8dccea88 data-v-e73581a2><!----><!--[--><!--[--><!----><div class="group" data-v-0562f5c0><div class="item appearance" data-v-0562f5c0><p class="label" data-v-0562f5c0>Appearance</p><div class="appearance-action" data-v-0562f5c0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-0562f5c0 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8856f192 data-v-6f008456><span class="container" data-v-6f008456><span class="top" data-v-6f008456></span><span class="middle" data-v-6f008456></span><span class="bottom" data-v-6f008456></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-6b5fd0a9 data-v-92b0f14a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-92b0f14a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-92b0f14a><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-92b0f14a>Menu</span></button><a class="top-link" href="#" data-v-92b0f14a> Return to top </a></div><aside class="VPSidebar" data-v-6b5fd0a9 data-v-55e4c7db><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-55e4c7db><span class="visually-hidden" id="sidebar-aria-label" data-v-55e4c7db> Sidebar Navigation </span><!--[--><div class="group" data-v-55e4c7db><section class="VPSidebarGroup" data-v-55e4c7db data-v-1f69a7ed><div class="title" data-v-1f69a7ed><h2 class="title-text" data-v-1f69a7ed>Linux运维</h2><div class="action" data-v-1f69a7ed><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-1f69a7ed><!--[--><a class="VPLink link" href="/linux/atop.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>ATOP工作原理总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/bandersnatch-pypi.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>使用Bandersnatch搭建私有Pypi源</span><!--]--><!----></a><a class="VPLink link active" href="/linux/cloud-init.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>cloud-init学习笔记</span><!--]--><!----></a><a class="VPLink link" href="/linux/dns.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>DNS学习总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/linux-boot.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux Boot过程总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/linux-common-commands.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux 下常用命令与技巧汇总</span><!--]--><!----></a><a class="VPLink link" href="/linux/shadow.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux /etc/shadow 文件学习笔记</span><!--]--><!----></a><a class="VPLink link" href="/linux/multi-queue.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux 网卡多队列介绍</span><!--]--><!----></a><a class="VPLink link" href="/linux/ntp.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>理解NTP协议</span><!--]--><!----></a><a class="VPLink link" href="/linux/yum-update.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>使用Yum 升级OS</span><!--]--><!----></a><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-6b5fd0a9 data-v-a4c57a06><div class="VPDoc has-sidebar" data-v-a4c57a06 data-v-79ca2460><div class="container" data-v-79ca2460><div class="aside" data-v-79ca2460><div class="aside-curtain" data-v-79ca2460></div><div class="aside-container" data-v-79ca2460><div class="aside-content" data-v-79ca2460><div class="VPDocAside" data-v-79ca2460 data-v-779d834d><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-779d834d data-v-51e5a8ce><div class="content" data-v-51e5a8ce><div class="outline-marker" data-v-51e5a8ce></div><div class="outline-title" data-v-51e5a8ce>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-51e5a8ce><span class="visually-hidden" id="doc-outline-aria-label" data-v-51e5a8ce> Table of Contents for current page </span><ul class="root" data-v-51e5a8ce><!--[--><li style="" data-v-51e5a8ce><a class="outline-link" href="#cloud-init介绍" data-v-51e5a8ce>cloud-init介绍</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#基本概念和相关文件目录" data-v-51e5a8ce>基本概念和相关文件目录</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#工作原理" data-v-51e5a8ce>工作原理</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#cloud-init-源码结构" data-v-51e5a8ce>cloud-init 源码结构</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#运行的主入口" data-v-51e5a8ce>运行的主入口</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#常见模板介绍" data-v-51e5a8ce>常见模板介绍</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#数据源实现" data-v-51e5a8ce>数据源实现</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#配置文件" data-v-51e5a8ce>配置文件</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-779d834d></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-79ca2460><div class="content-container" data-v-79ca2460><!--[--><!--]--><main class="main" data-v-79ca2460><div style="position:relative;" class="vp-doc _linux_cloud-init" data-v-79ca2460><div><h2 id="cloud-init介绍" tabindex="-1">cloud-init介绍 <a class="header-anchor" href="#cloud-init介绍" aria-hidden="true">#</a></h2><p>目前大部分公有云（openstack, AWS, Aliyun）都在使用cloud-init, 已经成为虚拟机元数据管理和OS系统配置初始化的事实标准.最早cloud-init由ubuntu的母公司 Canonical 开发。主要思想是当用户首次创建虚拟机时，将前台设置的主机名，密码或者秘钥等存入metadata server(顾名思义，存放元数据的服务器）。在openstack环境下当cloud-init随虚拟机启动而运行时，通过http协议访问metadata server，获取这些信息并修改主机配置。完成系统的环境初始化。本文以openstack + centos7 + cloud-init 0.7.9 为例,分两篇介绍基本概念，工作原理和源码解读。<br></p><p>如下是一些cloud-init的关键信息：<br> 源码： <a href="https://github.com/cloud-init/cloud-init" target="_blank" rel="noopener noreferrer">https://github.com/cloud-init/cloud-init</a><br> 文档： <a href="https://cloudinit.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">https://cloudinit.readthedocs.io/en/latest/</a><br> 配置文件： /etc/cloud/cloud.cfg<br> 日志：/var/log/cloud-init.log<br> 存放关键数据的目录： /var/lib/cloud/</p><h2 id="基本概念和相关文件目录" tabindex="-1">基本概念和相关文件目录 <a class="header-anchor" href="#基本概念和相关文件目录" aria-hidden="true">#</a></h2><h3 id="datasources" tabindex="-1">datasources <a class="header-anchor" href="#datasources" aria-hidden="true">#</a></h3><p>cloud-init将openstack, AWS, Aliyun等众多云平台抽象成数据源，使用统一的接口适配所有平台。<br> 具体地，openstack下获取数据的方法是访问http://169.254.169.254 下的 userdata和metadata</p><h3 id="userdata" tabindex="-1">userdata <a class="header-anchor" href="#userdata" aria-hidden="true">#</a></h3><p>可以是文件，shell脚本或者cloud-init配置文件。租户可以在前台输入。<br> 具体的格式,请参考<br><a href="https://cloudinit.readthedocs.io/en/latest/topics/format.html" target="_blank" rel="noopener noreferrer">https://cloudinit.readthedocs.io/en/latest/topics/format.html</a><br> 如下是一个shell脚本的userdata, openstack下用它来初始化root用户的密码</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@ecs-test-wangbo log]# curl http://169.254.169.254/openstack/2015-10-15/user_data</span></span>
<span class="line"><span style="color:#A6ACCD;">#!/bin/bash</span></span>
<span class="line"><span style="color:#A6ACCD;">echo &#39;root:$6$O9wyDQ$LYGAz6V/dy66Ve8eJkeATAbXOwjkWGpLbr4QoxkH8iQ0nsLa7.n3lzSlOer7Okb2RD8FObkP3RRPHEKS2xGip0&#39; | chpasswd -e;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="metadata" tabindex="-1">metadata <a class="header-anchor" href="#metadata" aria-hidden="true">#</a></h3><p>包含主机名，实例id和其他服务器相关的信息</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@ecs-test-wangbo log]# curl http://169.254.169.254/openstack/2015-10-15/meta_data.json | python -m json.tool</span></span>
<span class="line"><span style="color:#A6ACCD;">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span>
<span class="line"><span style="color:#A6ACCD;">                                 Dload  Upload   Total   Spent    Left  Speed</span></span>
<span class="line"><span style="color:#A6ACCD;">100  1297  100  1297    0     0   2452      0 --:--:-- --:--:-- --:--:--  2456</span></span>
<span class="line"><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;availability_zone&quot;: &quot;cn-east-2a&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;hostname&quot;: &quot;ecs-test-wangbo.novalocal&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;launch_index&quot;: 0,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;meta&quot;: {</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;charging_mode&quot;: &quot;0&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;image_name&quot;: &quot;CentOS 7.3 64bit&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;metering.cloudServiceType&quot;: &quot;hws.service.type.ec2&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;metering.image_id&quot;: &quot;643d831d-a69c-433f-803f-065e0e2e2911&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;metering.imagetype&quot;: &quot;gold&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;metering.resourcespeccode&quot;: &quot;c1.medium.linux&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;metering.resourcetype&quot;: &quot;1&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;os_bit&quot;: &quot;64&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;os_type&quot;: &quot;Linux&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">        &quot;vpc_id&quot;: &quot;8428b86b-7ec1-4b31-97aa-d6a0db2c3aab&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    },</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;name&quot;: &quot;ecs-test-wangbo&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;project_id&quot;: &quot;9b4e13cdeb7c4c6ebb929a4a503e51a2&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;random_seed&quot;: &quot;zUPkPLRFdLufLlYMnqQcrcp/nob7nJecOH/Nsv+hjDcNz1oYLvW/6qHgbL/++Kqvt0DLbkgpxRCO+lnqZfdOMadnZUHabdzB5LjEqOBFnk22RewmAh2sITOD1QPqmsvEssAOlz39FrUtK7+0XHIFclwYZIk8XtXPQa9L1lM9v76Y3+cZI18m1V0E+He1qLQzfyfu4qYYc8ER4YcGS2T2L/cZIRT9o20vwrLO7Ut2d98uitHhUphfVMVANG2DkZDK3U4DgR4M8q7jFMl5a3oR370XVYS7XqAn8YopCFXH1wAKCzipbzVL+JXiq9W6xFNvDvnK+bKdMVHf7ge+zUmRG6LnPpBqFLUT03qyhrErTLrV6mjpw3u4+uAX/Okn8NoWB0eEqly/VSgR3eAF4v/Ga2GylUSRCXcHH5Ss0RvbcXmF0NeGcMKH1QueBd9wBRxygBJsXZS0ZKfd+T13cA22TwqWLw4UFj3gu08/NE51A9sZu9quM6HL+XWOdqcOtN1T3aJVp6w2uisAfJCNEVq7Ftr2k0SsJdVHWw6dseDc3kOCC0Q+JPZh8deGF28/v+dykZH7yyHhFZCQZqHGarrd+QPwTzc3mdzzV/BL+GeNbYXKQXf6Uibv5s9usI6QwF+sfOg6AKtyUICWTDGgKRL1FUaDR3zF4sGIftO0AZ49vhI=&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">    &quot;uuid&quot;: &quot;e9f15094-8157-4c78-96a1-674cbaf26baf&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="stage" tabindex="-1">stage <a class="header-anchor" href="#stage" aria-hidden="true">#</a></h3><p>cloud-init对系统的配置分为四个阶段， 内部叫stage。 分别是local, network,config, final</p><h3 id="modules" tabindex="-1">modules <a class="header-anchor" href="#modules" aria-hidden="true">#</a></h3><p>具体的定制化配置是由模块完成。每个模块根据获取的元数据和配置文件完成相关配置<br> cloud.cfg里的部分配置：</p><div class="language-yaml"><span class="copy"></span><pre><code><span class="line"><span style="color:#F07178;">cloud_init_modules</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">// 定义init阶段需要执行的模块</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">migrator          // 迁移老的cloud-init数据为新的</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bootcmd           // 启动时执行相关命令</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">write-files       // 根据cloud.cfg的配置写数据到文件里</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">growpart          // 扩展分区到硬盘的大小 ，默认对根分区执行。 它需要调用“growpart”或者”gpart“</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">resizefs          // resize文件系统，适配新的大小。 默认对根目录执行</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set_hostname      // 根据元数据设置主机名</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update_hostname   // 更新主机名，适用于当用户自定义主机名时</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update_etc_hosts</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rsyslog</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">users-groups      // 根据cloud.cfg的配置创建用户组和用户</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ssh               // 配置sshd</span></span>
<span class="line"></span></code></pre></div><h3 id="handlers" tabindex="-1">handlers <a class="header-anchor" href="#handlers" aria-hidden="true">#</a></h3><p>用于具体处理userdata.目前有四类默认的handler： boot hook， cloud config ，shell script， upstart job</p><h3 id="frequencies" tabindex="-1">frequencies <a class="header-anchor" href="#frequencies" aria-hidden="true">#</a></h3><p>handler/module的运行频率， 目前有三个有效值:<br> once-per-instance<br> always<br> once</p><h3 id="var-lib-cloud-目录解读" tabindex="-1">/var/lib/cloud/目录解读 <a class="header-anchor" href="#var-lib-cloud-目录解读" aria-hidden="true">#</a></h3><p>该目录主要保存元数据和其他一些运行时需要的信息</p><p>/var/lib/cloud/data 文件夹存放具体的数据源，主机名和实例ID<br> result.json 记录了一些数据源信息<br> status.json 记录了每个stage运行的开始时间，结束时间和遇到的error</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">/var/lib/cloud/data</span></span>
<span class="line"><span style="color:#A6ACCD;">├── instance-id</span></span>
<span class="line"><span style="color:#A6ACCD;">├── previous-datasource</span></span>
<span class="line"><span style="color:#A6ACCD;">├── previous-hostname</span></span>
<span class="line"><span style="color:#A6ACCD;">├── previous-instance-id</span></span>
<span class="line"><span style="color:#A6ACCD;">├── result.json</span></span>
<span class="line"><span style="color:#A6ACCD;">└── status.json</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>/var/lib/cloud/instance 存放元数据和其他一些缓存文件</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">/var/lib/cloud/instance</span></span>
<span class="line"><span style="color:#A6ACCD;">├── boot-finished         // 记录cloud-ini运行完的时间</span></span>
<span class="line"><span style="color:#A6ACCD;">├── cloud-config.txt</span></span>
<span class="line"><span style="color:#A6ACCD;">├── datasource        </span></span>
<span class="line"><span style="color:#A6ACCD;">├── handlers</span></span>
<span class="line"><span style="color:#A6ACCD;">├── obj.pkl              // 缓存文件</span></span>
<span class="line"><span style="color:#A6ACCD;">├── scripts</span></span>
<span class="line"><span style="color:#A6ACCD;">│   └── part-001         // userdata为shell脚本，解析后归档到此</span></span>
<span class="line"><span style="color:#A6ACCD;">├── sem                  // 该目录用来存放各模块执行时的锁文件</span></span>
<span class="line"><span style="color:#A6ACCD;">├── user-data.txt        // 从数据源获取的user-data</span></span>
<span class="line"><span style="color:#A6ACCD;">├── user-data.txt.i</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vendor-data.txt</span></span>
<span class="line"><span style="color:#A6ACCD;">└── vendor-data.txt.i</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="工作原理" tabindex="-1">工作原理 <a class="header-anchor" href="#工作原理" aria-hidden="true">#</a></h2><p>前面提到cloudinit分四个阶段执行，具体它们以服务的形式注册到系统中按如下顺序依次运行:<br> local - cloud-init-local.service<br> nework - cloud-init.service<br> config - cloud-config.service<br> final - cloud-final.service<br> 每个具体的服务中对应的命令如下，都只运行一次，没有常驻进程<br> 可以看到执行的都是 /usr/bin/cloud-init这个文件，但参数不一样<br> 所有debug日志全部默认输出到/var/log/cloud-init.log</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@ecs-test-wangbo ~]# grep ExecStart /lib/systemd/system/cloud-*.service</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/systemd/system/cloud-config.service:ExecStart=/usr/bin/cloud-init modules --mode=config</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/systemd/system/cloud-final.service:ExecStart=/usr/bin/cloud-init modules --mode=final</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/systemd/system/cloud-init-local.service:ExecStart=/usr/bin/cloud-init init --local</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/systemd/system/cloud-init-local.service:ExecStart=/bin/touch /run/cloud-init/network-config-ready</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/systemd/system/cloud-init.service:ExecStart=/usr/bin/cloud-init init</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@ecs-test-wangbo ~]# </span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">[root@ecs-test-wangbo ~]# grep &quot;Cloud-init v. 0.7.9 running&quot; /var/log/cloud-init.log </span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,309 - util.py[DEBUG]: Cloud-init v. 0.7.9 running &#39;init-local&#39; at Wed, 18 Oct 2017 01:57:50 +0000. Up 9.28 seconds.</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:56,036 - util.py[DEBUG]: Cloud-init v. 0.7.9 running &#39;init&#39; at Wed, 18 Oct 2017 01:57:56 +0000. Up 15.03 seconds.</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:43,771 - util.py[DEBUG]: Cloud-init v. 0.7.9 running &#39;modules:config&#39; at Wed, 18 Oct 2017 01:58:43 +0000. Up 62.72 seconds.</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,165 - util.py[DEBUG]: Cloud-init v. 0.7.9 running &#39;modules:final&#39; at Wed, 18 Oct 2017 01:58:44 +0000. Up 63.11 seconds.</span></span>
<span class="line"><span style="color:#A6ACCD;">[root@ecs-test-wangbo ~]# </span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="local-阶段" tabindex="-1">local 阶段 <a class="header-anchor" href="#local-阶段" aria-hidden="true">#</a></h3><p>此时 instance 尝试从ConfigDrive等本地源获取信息。在openstack环境下是不存在的，然后cloud-init 检查系统是否有默认网卡，有则配置为dhcp, 并写入 /etc/sysconfig/network-scripts/ifcfg-eth0. 只有配置了dhcp, 该网卡有了ip, 才能进一步连接metadataserver获取元数据 因为使用了dhcp, 所有也会从dhcp server获取dns配置并写入/etc/resolv.conf。 这个和vpc里配置的dns服务器是一致的</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,500 - main.py[DEBUG]: No local datasource found</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,500 - util.py[DEBUG]: Reading from /sys/class/net/eth0/carrier (quiet=False)</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,500 - util.py[DEBUG]: Reading from /sys/class/net/eth0/dormant (quiet=False)</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,500 - util.py[DEBUG]: Reading from /sys/class/net/eth0/operstate (quiet=False)</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,500 - util.py[DEBUG]: Read 5 bytes from /sys/class/net/eth0/operstate</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,500 - util.py[DEBUG]: Reading from /sys/class/net/eth0/address (quiet=False)</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,501 - util.py[DEBUG]: Read 18 bytes from /sys/class/net/eth0/address</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:50,501 - stages.py[DEBUG]: applying net config names for {&#39;version&#39;: 1, &#39;config&#39;: [{&#39;subnets&#39;: [{&#39;type&#39;: &#39;dhcp&#39;}], &#39;type&#39;: &#39;physical&#39;, &#39;name&#39;: &#39;eth0&#39;, &#39;mac_address&#39;: &#39;fa:16:3e:b0:e3:5d&#39;}]}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="network-阶段" tabindex="-1">network 阶段 <a class="header-anchor" href="#network-阶段" aria-hidden="true">#</a></h3><p>此时 instance 已经有自己的ip, 然后搜索所有网路源如下</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">2017-10-18 09:57:56,102 - __init__.py[DEBUG]: Searching for network data source in: [u&#39;DataSourceNoCloudNet&#39;, u&#39;DataSourceAzureNet&#39;, u&#39;DataSourceAltCloud&#39;, u&#39;DataSourceOVFNet&#39;, u&#39;DataSourceMAAS&#39;, u&#39;DataSourceGCE&#39;, u&#39;DataSourceOpenStack&#39;, u&#39;DataSourceEc2&#39;, u&#39;DataSourceCloudStack&#39;, u&#39;DataSourceBigstep&#39;, u&#39;DataSourceNone&#39;]</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>最终通过访问 169.254.169.254成功获取openstack下的数据,</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:31,288 - __init__.py[DEBUG]: Seeing if we can get any data from &lt;class &#39;cloudinit.sources.DataSourceOpenStack.DataSourceOpenStack&#39;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:31,289 - url_helper.py[DEBUG]: [0/1] open &#39;http://169.254.169.254/openstack&#39; with {&#39;url&#39;: &#39;http://169.254.169.254/openstack&#39;, &#39;headers&#39;: {&#39;User-Agent&#39;: &#39;Cloud-Init/0.7.9&#39;}, &#39;allow_redirects&#39;: True, &#39;method&#39;: &#39;GET&#39;, &#39;timeout&#39;: 10.0} configuration</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:31,952 - url_helper.py[DEBUG]: Read from http://169.254.169.254/openstack (200, 50b) after 1 attempts</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:31,952 - DataSourceOpenStack.py[DEBUG]: Using metadata source: &#39;http://169.254.169.254</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>下面日志表明抓取数据成功，并写入<code>/var/lib/cloud/instances/e9f15094-8157-4c78-96a1-674cbaf26baf</code></p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:43,120 - util.py[DEBUG]: Crawl of openstack metadata service took 11.168 seconds</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>其他步骤如下:</p><ol><li>解析userdata,并执行</li><li>按cloud.cfg里的配置顺序，依次运行各模块</li></ol><h3 id="config-阶段" tabindex="-1">config 阶段 <a class="header-anchor" href="#config-阶段" aria-hidden="true">#</a></h3><p>执行一些配置模块。</p><h3 id="final-阶段" tabindex="-1">final 阶段 <a class="header-anchor" href="#final-阶段" aria-hidden="true">#</a></h3><p>此时大部分定制化已经完成， 这里只是一些简单的收尾工作 比如 final-message 模块，只是在日志里打印cloud-init启动结束</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,236 - handlers.py[DEBUG]: start: modules-final/config-final-message: running config-final-message with frequency always</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,236 - helpers.py[DEBUG]: Running config-final-message using lock (&lt;cloudinit.helpers.DummyLock object at 0x1c81750&gt;)</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,236 - util.py[DEBUG]: Reading from /proc/uptime (quiet=False)</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,236 - util.py[DEBUG]: Read 12 bytes from /proc/uptime</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,240 - util.py[DEBUG]: Cloud-init v. 0.7.9 finished at Wed, 18 Oct 2017 01:58:44 +0000. Datasource DataSourceOpenStack [net,ver=2].  Up 63.25 seconds</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,240 - util.py[DEBUG]: Writing to /var/lib/cloud/instance/boot-finished - wb: [420] 51 bytes</span></span>
<span class="line"><span style="color:#A6ACCD;">2017-10-18 09:58:44,241 - handlers.py[DEBUG]: finish: modules-final/config-final-message: SUCCESS: config-final-message ran successfully</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="cloud-init-源码结构" tabindex="-1">cloud-init 源码结构 <a class="header-anchor" href="#cloud-init-源码结构" aria-hidden="true">#</a></h2><p>大部分代码存放于 /lib/python2.7/site-packages/cloudinit </p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">├── cmd                   // 所有命令的主入口</span></span>
<span class="line"><span style="color:#A6ACCD;">├── config                // 各种模块文件</span></span>
<span class="line"><span style="color:#A6ACCD;">├── distros               // 各OS具体操作实现（比如安装软件，写文件）</span></span>
<span class="line"><span style="color:#A6ACCD;">│   └── parsers</span></span>
<span class="line"><span style="color:#A6ACCD;">├── filters               // 日志相关的过滤</span></span>
<span class="line"><span style="color:#A6ACCD;">├── handlers              // 处理userdata的具体实现</span></span>
<span class="line"><span style="color:#A6ACCD;">├── mergers               // 辅助函数</span></span>
<span class="line"><span style="color:#A6ACCD;">├── net                   // 网络配置的通用操作 </span></span>
<span class="line"><span style="color:#A6ACCD;">├── reporting             // 通用的类，用于报告各种事件</span></span>
<span class="line"><span style="color:#A6ACCD;">└── sources               // openstack, aliyun等数据源的类实现</span></span>
<span class="line"><span style="color:#A6ACCD;">    └── helpers</span></span>
<span class="line"><span style="color:#A6ACCD;">        └── vmware</span></span>
<span class="line"><span style="color:#A6ACCD;">            └── imc</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="运行的主入口" tabindex="-1">运行的主入口 <a class="header-anchor" href="#运行的主入口" aria-hidden="true">#</a></h2><p>local, network, config, final三个不同阶段通过不同的参数，传递给主程序.比如local的具体命令行为 <code>/usr/bin/cloud-init init --local</code>.首先主入口是 <code>cmd/main.py</code>, 解析命令行参数</p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">sysv_args</span><span style="color:#89DDFF;">=None):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> sysv_args </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None:</span></span>
<span class="line"><span style="color:#A6ACCD;">        parser </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> argparse</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ArgumentParser</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">prog</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">sysv_args</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">        sysv_args </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> sysv_args</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">        parser </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> argparse</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ArgumentParser</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><p>local, init会走入 <code>main_init</code>这个函数， local主要是寻找本地源（比如configdriver）, init阶段是寻找网络源（比如通过http消息获取metadata）</p><p>当前华为云的裸金属镜像使用configdriver这种方式，原理如下：</p><blockquote><p>物理机启动minios, 下载镜像和metadata<br> 给一块硬盘分区，将镜像dd写入第一分区<br> 在该硬盘的最后位置，生成一个分区，写入metadata<br> minios重启系统，让物理机从新的硬盘引导<br> OS启动后，里面的cloud-init会挂载分区 /dev/sr0类似这样的<br> mount后将读取普通文件一样获取metadata</p></blockquote><p><code>main_init</code>主要做的事情如下：</p><ol><li>读取配置文件</li><li>初始化日志信息</li><li>根据配置初始化运行时相关的目录和权限</li><li>如果是寻找网络源的过程，检查是否已经存在信息，有则提前退出，无则继续第五步</li><li>根据当前Cloud-init所支持的datasource列表， 逐个搜索，看是否可以获取元数据。 所有全部数据源都检查后没有找到数据且命令行没有设置 <code>--force</code>， cloud-init会提前推出， 否则继续第六步。</li><li>配置网络， local阶段会自动设置eth0为dhcp模式，用自动获取ip, 这样在init阶段（有时也叫network）时网络源才能正常工作。</li><li>如果元数据里有userdata, 则程序开始解析并运行</li><li>重读配置文件，获取该阶段需要运行的模块</li><li>根据待运行的模块重新配置日志输出</li><li>执行8步获取的模块列表</li></ol><h2 id="常见模板介绍" tabindex="-1">常见模板介绍 <a class="header-anchor" href="#常见模板介绍" aria-hidden="true">#</a></h2><p>config文件下包含所有模块，通过名字很容易识别其对应的功能。 比如 <code>cc_set_hostname.py</code> 用于创建虚拟机时设置主机名。 ``cc_update_hostname.py`用于每次启动时更新主机名。 模块都根据对应的配置项执行， 同时每个模块有自己固定的运行频率（per isntance, per always等）</p><h3 id="cc-set-hostname-py" tabindex="-1">cc_set_hostname.py <a class="header-anchor" href="#cc-set-hostname-py" aria-hidden="true">#</a></h3><p>只在创建虚拟机时运行一次， 如果perserve_hostname为false, 则模块不运行。 从metadata里提取hostname, 然后运行对应OS下的设置主机名命令</p><h3 id="cc-update-hostname-py" tabindex="-1">cc_update_hostname.py <a class="header-anchor" href="#cc-update-hostname-py" aria-hidden="true">#</a></h3><p>每次虚拟机重启都会运行一次（包括第一次新建虚拟机）， 如果perserve_hostname为true, 则模块不运行。</p><ol><li>首先检查是否存在/var/lib/cloud/data/previous-hostname文件，有则对比当前OS的主机名， 如果不一样认为管理员维护主机名。提前退出</li><li>发现当前元数据和当前OS的主机名不一样，则直接更新</li><li>将最新的主机名写入 previous-hostname</li></ol><h3 id="cc-growpart-py" tabindex="-1">cc_growpart.py <a class="header-anchor" href="#cc-growpart-py" aria-hidden="true">#</a></h3><p>每次虚拟机重启都会运行一次（包括第一次新建虚拟机）， 它会调整分区， 实现自动扩容，默认对根盘所有的虚拟磁盘执行。若要正常工作，还需要安装cloud-utils-growpart等辅助软件包</p><h3 id="cc-resizefs-py" tabindex="-1">cc_resizefs.py <a class="header-anchor" href="#cc-resizefs-py" aria-hidden="true">#</a></h3><p>每次虚拟机重启都会运行一次（包括第一次新建虚拟机）, 它主要配置growpart, 对文件系统扩容。 growpart主要针对磁盘。 不同的文件系统，调用不同的命令</p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_resize_btrfs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mount_point</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">btrfs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">filesystem</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">resize</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">max</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mount_point</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_resize_ext</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mount_point</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">resize2fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_resize_xfs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mount_point</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xfs_growfs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_resize_ufs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">mount_point</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">growfs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> devpth</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Do not use a dictionary as these commands should be able to be used</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># for multiple filesystem types if possible, e.g. one command for</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># ext2, ext3 and ext4.</span></span>
<span class="line"><span style="color:#A6ACCD;">RESIZE_FS_PREFIXES_CMDS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">btrfs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> _resize_btrfs</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ext</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> _resize_ext</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xfs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> _resize_xfs</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ufs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> _resize_ufs</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre></div><h2 id="数据源实现" tabindex="-1">数据源实现 <a class="header-anchor" href="#数据源实现" aria-hidden="true">#</a></h2><p><code>sources</code>下面是每个数据源的具体实现，openstack, aliyun这些都继承<code>__init__.py</code>中的元类<code>DataSource</code>. 这个metaclass实现了一些通用的操作。</p><p>openstack中通过访问 <code>http://169.254.169.254</code>获取信息<br> aliyun通过<code>http://100.100.100.200</code>获取<br> configdirve 查找<code>/dev/sr0</code>,<code>/dev/sr1</code>,<code>/dev/cd0</code>,<code>/dev/cd1</code>等设备，有则mount 后访问文件</p><h2 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-hidden="true">#</a></h2><p>cloud-init采用yaml格式的文件。yaml格式的具体说明参见 <a href="http://www.ruanyifeng.com/blog/2016/07/yaml.html" target="_blank" rel="noopener noreferrer">http://www.ruanyifeng.com/blog/2016/07/yaml.html</a><br> 特别注意：yaml不支持tab键，支持多个空格，但相同层级的元素左侧对齐。 cloud-init对布尔有特殊处理。 如下， true, 1, on, yes 均认为是true</p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">TRUE_STRINGS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">on</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">yes</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">FALSE_STRINGS </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">off</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">0</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">no</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-79ca2460 data-v-04568844><div class="edit-info" data-v-04568844><!----><div class="last-updated" data-v-04568844><p class="VPLastUpdated" data-v-04568844 data-v-0ce8c960>Last updated: <time datatime="2022-07-14T14:54:09.000Z" data-v-0ce8c960></time></p></div></div><div class="prev-next" data-v-04568844><div class="pager" data-v-04568844><a class="pager-link prev" href="/linux/bandersnatch-pypi.html" data-v-04568844><span class="desc" data-v-04568844>Previous page</span><span class="title" data-v-04568844>使用Bandersnatch搭建私有Pypi源</span></a></div><div class="has-prev pager" data-v-04568844><a class="pager-link next" href="/linux/dns.html" data-v-04568844><span class="desc" data-v-04568844>Next page</span><span class="title" data-v-04568844>DNS学习总结</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-6b5fd0a9 data-v-5b331722><div class="container" data-v-5b331722><p class="message" data-v-5b331722>Released under the MIT License.</p><p class="copyright" data-v-5b331722>Copyright © 2022-present xixiliguo</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_algorithm-dfs.md\":\"a73dea67\",\"algorithm_binary-index-tree.md\":\"8bc3e51f\",\"algorithm_radix-tree.md\":\"6b75afb6\",\"algorithm_segment-tree.md\":\"c689b78e\",\"algorithm_unionfind.md\":\"a646711f\",\"golang_golang-exec.md\":\"357621ac\",\"golang_strings-algorithm-golang.md\":\"57a20191\",\"index.md\":\"27757f36\",\"k8s_runc.md\":\"09e5ae92\",\"kernel_kernel-cgroup-namespace.md\":\"4a81fd3c\",\"kernel_kernel-crash.md\":\"27a485e9\",\"kernel_kernel-irq.md\":\"0bfc9b45\",\"kernel_kernel-memory.md\":\"1c2cf851\",\"kernel_kernel-syscall-sched.md\":\"29c8373b\",\"kernel_linux-trap.md\":\"ae6473f3\",\"linux_atop.md\":\"6cfa95b0\",\"linux_bandersnatch-pypi.md\":\"dee4724b\",\"linux_cloud-init.md\":\"e0bc6141\",\"linux_dns.md\":\"ccf3bd81\",\"linux_linux-boot.md\":\"459acaa4\",\"linux_linux-common-commands.md\":\"c3e4942a\",\"linux_linux-shadow.md\":\"4d01a795\",\"linux_multi-queue.md\":\"9db1b9ad\",\"linux_ntp.md\":\"0f26af7e\",\"linux_yum-update.md\":\"67a0bf95\",\"network_libvirt-network.md\":\"90682305\",\"network_tcp.md\":\"2211909d\",\"network_tcpdump-wireshark.md\":\"a2fe5423\",\"others_code_segment.md\":\"f0f03c59\",\"others_lua-implemention-gc.md\":\"80382876\",\"others_lua-implemention-type-value.md\":\"e4816df1\"}")</script>
    <script type="module" async src="/assets/app.526dca4e.js"></script>
    
  </body>
</html>
<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用Yum 升级OS | xixiliguo</title>
    <meta name="description" content="博客">
    <meta name="generator" content="VitePress v1.3.1">
    <link rel="preload stylesheet" href="/assets/style.g77m8Zzh.css" as="style">
    
    <script type="module" src="/assets/app.vqWpy80y.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.KQnwS2KS.js">
    <link rel="modulepreload" href="/assets/chunks/theme.CompDPuL.js">
    <link rel="modulepreload" href="/assets/linux_yum-update.md.lqyvCo22.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar has-sidebar top" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-ab179fa1><a class="title" href="/" data-v-ab179fa1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/img/coast.jpg" alt data-v-8426fc1a><!--]--><span data-v-ab179fa1>xixiliguo</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/linux-common-commands.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>Linux运维</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/network/tcp.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>网络协议</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/golang/golang-exec.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>Golang笔记</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/k8s/runc.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>容器与k8s</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/radix-tree.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>算法笔记</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/kernel/kernel-syscall-sched.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>内核分析</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/code_segment.html" tabindex="0" data-v-dc692963 data-v-9c663999><!--[--><span data-v-9c663999>杂项</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-b6c34ac9><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-b6c34ac9><span class="vpi-more-horizontal icon" data-v-b6c34ac9></span></button><div class="menu" data-v-b6c34ac9><div class="VPMenu" data-v-b6c34ac9 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-17a5e62e><button data-v-17a5e62e>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 collapsible has-active" data-v-c40bc020 data-v-b7550ba0><div class="item" role="button" tabindex="0" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><h2 class="text" data-v-b7550ba0>Linux运维</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b7550ba0><span class="vpi-chevron-right caret-icon" data-v-b7550ba0></span></div></div><div class="items" data-v-b7550ba0><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/atop.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>ATOP工作原理总结</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/bandersnatch-pypi.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>使用Bandersnatch搭建私有Pypi源</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/cloud-init.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>cloud-init学习笔记</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/dns.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>DNS学习总结</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/linux-boot.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>Linux Boot过程总结</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/linux-common-commands.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>Linux 下常用命令与技巧汇总</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/linux-shadow.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>Linux /etc/shadow 文件学习笔记</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/multi-queue.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>Linux 网卡多队列介绍</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/ntp.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>理解NTP协议</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/yum-update.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>使用Yum 升级OS</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/linux/tty.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>tty pts相关过程</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>On this page</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _linux_yum-update" data-v-39a288b8><div><p>主要介绍使用yum 升级OS软件包的一些细节</p><h1 id="repo源" tabindex="-1">Repo源 <a class="header-anchor" href="#repo源" aria-label="Permalink to &quot;Repo源&quot;">​</a></h1><p>每个源下面有个<code>repodata</code>这个文件夹, 该文件夹存放着软件包的元数据(包名,路径,版本,依赖关系)<br> 比如<code>https://mirrors.tuna.tsinghua.edu.cn/centos/7.6.1810/os/x86_64/</code><br> 下面的repodata里 <code>25cd2c29e5adb2b6f8a5b091237dd9f760e97815b37f2557f2cd1c12a5f294f0-primary.xml.gz</code> 文件就是元数据文件</p><h2 id="创建repo源的操作" tabindex="-1">创建Repo源的操作 <a class="header-anchor" href="#创建repo源的操作" aria-label="Permalink to &quot;创建Repo源的操作&quot;">​</a></h2><p>已<code>/opt/mirrors/CentOS7</code>为例:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CentOS7/Packages</span></span></code></pre></div><p>将所有软件rpm包上传到文件夹<code>Packages</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /opt/mirrors/CentOS7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">createrepo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><p>该操作会生成<code>yum</code>会用到的元数据,并放入到<code>repodata</code>目录.<br> 并不一定非要创建<code>Packages</code>目录, <code>createrepo</code>会自动查找指定目录及其子目录. <code>Packages</code>是个很好的约定,方便管理<br> rpm包是集合, 含有二进制文件, 版本信息, 依赖关系等. <code>createrepo</code>通过读取每个rpm的信息,并生成元数据.<br> 这样<code>yum</code>在分析时只需要下载元数据,就可以得知该源有哪个软件,什么版本等.不必每次下载源里的包.</p><p>我们使用<code>yum checkupdate</code>等命令时, 假设访问<code>xxx/CentOS7</code>, <code>yum</code>会检查是否有<code>xxx/CentOS7/repodata</code>这个目录,并获取相应的元数据.</p><h1 id="rpm相关操作" tabindex="-1">rpm相关操作 <a class="header-anchor" href="#rpm相关操作" aria-label="Permalink to &quot;rpm相关操作&quot;">​</a></h1><h2 id="rpmsave与rpmnew" tabindex="-1">rpmsave与rpmnew <a class="header-anchor" href="#rpmsave与rpmnew" aria-label="Permalink to &quot;rpmsave与rpmnew&quot;">​</a></h2><p>rpm的spec文件里可以指定新版配置文件的升级方式<br> 默认升级时旧版本有改动,则用新版本替换旧版本的文件. 旧版本的文件改名为XXXX.rpmsave<br> 如果spec文件里指定为<code>%config(noreplace)</code>, 则升级时旧版本有改动, 保留旧文件,新版本文件改为XXXX.rpmnew<br> 这里的改动指新版本的rpm里对比旧版本rpm里的默认文件. 并非拿可能被用户修改过的文件和新版本里的文件对比<br> 如果文件不存在(比如人为删除), 升级时会重新生成该文件， 不管是configfile还是 noconfigfile</p><p>卸载时对于<code>%config(noreplace)</code>的文件,如果有改动,则不会删除,改名为XXXX.rpmsave</p><p><a href="https://blog.csdn.net/xukunddp/article/details/6409795" target="_blank" rel="noreferrer">https://blog.csdn.net/xukunddp/article/details/6409795</a> 有相关解释<br><a href="https://www.cl.cam.ac.uk/~jw35/docs/rpm_config.html" target="_blank" rel="noreferrer">https://www.cl.cam.ac.uk/~jw35/docs/rpm_config.html</a> 描述了各种改动场景下的结果</p><p>如果没有spec文件, 可通过如下步骤从已安装的软件包确认下配置文件的覆盖方式<br> 比较文件的flags是否 第5个Bit位位1. 即 XX &amp; (1&lt;&lt;4) 是否非0<br> 显示<code>/etc/pam.d/sshd</code>,<code>/etc/ssh/sshd_config</code>,<code>/etc/sysconfig/sshd</code>的属性是 %config(noreplace)</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --qf &#39;[%{filenames}: %{fileflags}\n]&#39; openssh-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/etc/pam.d/sshd:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 17</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/etc/ssh/sshd_config:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 17</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/etc/sysconfig/sshd:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 17</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/lib/systemd/system/sshd-keygen.service:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/lib/systemd/system/sshd.service:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/lib/systemd/system/sshd.socket:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/lib/systemd/system/sshd@.service:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/lib64/fipscheck/sshd.hmac:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/libexec/openssh/sftp-server:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/sbin/sshd:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/sbin/sshd-keygen:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/share/man/man5/moduli.5.gz:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/share/man/man5/sshd_config.5.gz:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/share/man/man8/sftp-server.8.gz:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/share/man/man8/sshd.8.gz:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/var/empty/sshd:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># grep -r RPMFILE_NOREPLACE /usr/include/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/include/rpm/rpmfi.h:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    RPMFILE_NOREPLACE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">	=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  4),</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	/*!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> %%config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">noreplace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span></span></code></pre></div><p>参考: <a href="https://www.redhat.com/archives/rpm-list/2003-October/msg00140.html" target="_blank" rel="noreferrer">https://www.redhat.com/archives/rpm-list/2003-October/msg00140.html</a></p><h2 id="查询依赖关系" tabindex="-1">查询依赖关系 <a class="header-anchor" href="#查询依赖关系" aria-label="Permalink to &quot;查询依赖关系&quot;">​</a></h2><p>检查软件提供哪些capability</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --provides openssh-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config(openssh-server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) = 7.4p1-16.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssh-server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7.4p1-16.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssh-server(x86-64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) = 7.4p1-16.el7</span></span></code></pre></div><p>检查软件需要哪些capability</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --requires openssh-server</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/sbin/useradd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config(openssh-server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) = 7.4p1-16.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fipscheck-lib(x86-64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">= 1.3.0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libaudit.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.17</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.2.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.3.4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libc.so.6(GLIBC_2.8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcom_err.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcrypt.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcrypt.so.1(GLIBC_2.2.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcrypto.so.10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcrypto.so.10(OPENSSL_1.0.1_EC</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcrypto.so.10(OPENSSL_1.0.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libcrypto.so.10(libcrypto.so.10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libdl.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libfipscheck.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libgssapi_krb5.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libgssapi_krb5.so.2(gssapi_krb5_2_MIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libk5crypto.so.3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libkrb5.so.3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libkrb5.so.3(krb5_3_MIT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">liblber-2.4.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libldap-2.4.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libpam.so.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libpam.so.0(LIBPAM_1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libresolv.so.2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libselinux.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libsystemd.so.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libsystemd.so.0(LIBSYSTEMD_209</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libutil.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libutil.so.1(GLIBC_2.2.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libwrap.so.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">libz.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7.4p1-16.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pam</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.0.1-3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpmlib(CompressedFileNames</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">= 3.0.4-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpmlib(FileDigests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">= 4.6.0-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpmlib(PayloadFilesHavePrefix</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">= 4.0-1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rtld(GNU_HASH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemd-units</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemd-units</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemd-units</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpmlib(PayloadIsXz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">= 5.2-1</span></span></code></pre></div><p>根据capability,查询哪个包提供</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --whatprovides pam</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pam-1.1.8-22.el7.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --whatprovides libsystemd.so.0\(\)\(64bit\)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemd-libs-219-62.el7_6.6.x86_64</span></span></code></pre></div><p>查询哪个包需要某个特定的capability</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --whatrequires pam</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">passwd-0.79-4.el7.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cronie-1.4.11-20.el7_6.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">util-linux-2.23.2-59.el7_6.1.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssh-server-7.4p1-16.el7.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">authconfig-6.2.8-30.el7.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># rpm -q --whatrequires libsystemd.so.0\(\)\(64bit\)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dbus-libs-1.10.24-13.el7_6.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dbus-1.10.24-13.el7_6.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">polkit-0.112-18.el7_6.1.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">util-linux-2.23.2-59.el7_6.1.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssh-server-7.4p1-16.el7.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rsyslog-8.24.0-34.el7.x86_64</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">procps-ng-3.3.10-23.el7.x86_64</span></span></code></pre></div><p>如果要查询本地rpm软件包的信息, 需要使用<code>-p</code><br> 比如之前是<code>rpm -ql bpftool</code>, 要改为<code>rpm -ql -p bpftool-3.10.0-957.el7.x86_64.rpm</code></p><p>如果要查询的包,文件或者capability, 不在本地已安装的包里, 可以使用<code>repoquery</code>从已知源中查询<br> 例如查询哪个包提供了<code>strace</code>这个capability:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repoquery</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --whatprovides</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> strace</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strace-0:4.12-9.el7.x86_64</span></span></code></pre></div><p>repoquery不仅支持从源中查,还会从本地已安装的信息来查.</p><h2 id="spec文件" tabindex="-1">SPEC文件 <a class="header-anchor" href="#spec文件" aria-label="Permalink to &quot;SPEC文件&quot;">​</a></h2><p>rpm的构建过程需要源代码和<code>spec</code>文件. <code>spec</code>文件用于描述rpm的元数据信息和指导如何编译,打包,封装为二进制的rpm文件</p><p>跟着如下教程, 自己可以从xxx.src.rpm编译出xxx.rpm文件. 常用于问题定位,增加日志等.<br><a href="https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/" target="_blank" rel="noreferrer">https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/</a></p><p>下面两篇文章介绍了SPEC的语法:<br><a href="https://fedoraproject.org/wiki/How_to_create_am_RPM_package/zh-cn" target="_blank" rel="noreferrer">https://fedoraproject.org/wiki/How_to_create_am_RPM_package/zh-cn</a><br><a href="https://rpm-packaging-guide.github.io" target="_blank" rel="noreferrer">https://rpm-packaging-guide.github.io</a></p><h2 id="其他" tabindex="-1">其他 <a class="header-anchor" href="#其他" aria-label="Permalink to &quot;其他&quot;">​</a></h2><p>本地rpm包解压缩</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpm2cpio</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> xxx.rpm</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cpio</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -div</span></span></code></pre></div><h1 id="yum相关操作" tabindex="-1">yum相关操作 <a class="header-anchor" href="#yum相关操作" aria-label="Permalink to &quot;yum相关操作&quot;">​</a></h1><p><code>yum</code>的主要代码在<code>/usr/lib/python2.7/site-packages/yum/</code><br><code>class YumBase</code> 是主要的类, 含大部分操作</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> YumBase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">depsolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Depsolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">):</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;This is a primary structure and base class. It houses the</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    objects and methods needed to perform most things in yum. It is</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    almost an abstract class in that you will need to add your own</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    class above it for most real use.</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;</span></span></code></pre></div><p>yum所有的操作,都是分析具体的操作(删除,更新,新安装),进而分析相关的依赖, 比如更新时,检查依赖是否满足,不满足也要将依赖的包进程更新.<br> 分析完后将对应包和状态(比如updated, erase等)放入事务中,然后执行具体的操作</p><p>查询特定软件依赖哪些包</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># yum deplist rsync</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Loaded</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> plugins:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fastestmirror</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Loading</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mirror</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> speeds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cached</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> hostfile</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> base:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mirrors.cqu.edu.cn</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> extras:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mirror.jdcloud.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> updates:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mirrors.aliyun.com</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">package:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 3.1.2-6.el7_6.1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /bin/sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bash.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4.2.46-31.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libacl.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libacl.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.2.51-14.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libacl.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ACL_1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libacl.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.2.51-14.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libattr.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libattr.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.4.46-13.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libattr.so.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ATTR_1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libattr.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.4.46-13.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libc.so.6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GLIBC_2.15</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> glibc.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.17-260.el7_6.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libpopt.so.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> popt.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.13-16.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libpopt.so.0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">LIBPOPT_0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> popt.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.13-16.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rtld</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GNU_HASH</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> glibc.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.17-260.el7_6.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> glibc.i686</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2.17-260.el7_6.5</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd-units</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 219-62.el7_6.6</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  dependency:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zlib</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zlib.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.2.7-18.el7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   provider:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> zlib.i686</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1.2.7-18.el7</span></span></code></pre></div><h2 id="history相关操作" tabindex="-1">history相关操作 <a class="header-anchor" href="#history相关操作" aria-label="Permalink to &quot;history相关操作&quot;">​</a></h2><p><a href="https://www.cyberciti.biz/faq/yum-history-command" target="_blank" rel="noreferrer">https://www.cyberciti.biz/faq/yum-history-command</a></p><h2 id="yum-update-与-yum-update-to-的区别" tabindex="-1">yum update 与 yum update-to 的区别 <a class="header-anchor" href="#yum-update-与-yum-update-to-的区别" aria-label="Permalink to &quot;yum update 与 yum update-to 的区别&quot;">​</a></h2><p>yum 有两种升级命令， yum update 和 yum update-to<br> yum update kernel 会升级Repo里的最新版<br> yum update kernel-3.10.0-327.62.59.83.h108.x86_64 会升级到指定版本。 但如果这个指定版本就是当前已安装的版本， 则自动升级到repo里的最新版。</p><p>yum update-to kernel-3.10.0-327.62.59.83.h108.x86_64 升级到指定版本， 如果这个指定版本就是当前已安装的版本， 则不升级<br> 但是yum update-to kernel则会升级多个高版本的内核。 因为yum update-to 一般要求就是软件包的版本信息</p><h2 id="yum-update" tabindex="-1">yum update <a class="header-anchor" href="#yum-update" aria-label="Permalink to &quot;yum update&quot;">​</a></h2><p>没有指定的软件包,则升级所有软件, 主要逻辑代码在<code>/usr/lib/python2.7/site-packages/yum/__init__.py</code>里类<code>YumBase</code>的函数<code>update</code><br> 加<code>-v</code>可打印详细的日志</p><ol><li>使用rpm模块, 通过<code>dbMatch</code>获取已安装软件的所有信息</li><li>连接repo, 获取所有availble 的软件包信息</li><li>精简newpkg的列表,比如只保留软件包的最新版本</li><li>完成依赖关系检查, 主要是检查依赖项和冲突项</li><li>用户确认OK后,执行下载,升级操作</li></ol><p>如下下yum的包状态, 打印Debug日志时可以对照分析</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>           i = the package will be installed</span></span>
<span class="line"><span>           u = the package will be an update</span></span>
<span class="line"><span>           e = the package will be erased</span></span>
<span class="line"><span>           r = the package will be reinstalled</span></span>
<span class="line"><span>           d = the package will be a downgrade</span></span>
<span class="line"><span>           o = the package will be obsoleting another package</span></span>
<span class="line"><span>           ud = the package will be updated</span></span>
<span class="line"><span>           od = the package will be obsoleted</span></span></code></pre></div><h2 id="yum-downgrade" tabindex="-1">yum downgrade <a class="header-anchor" href="#yum-downgrade" aria-label="Permalink to &quot;yum downgrade&quot;">​</a></h2><p><code>yum history undo</code>, 这里undo的是升级事务, 则内部调用的是<code>yum downgrader</code><br> 主要执行入口在类<code>YumBase</code>的函数<code>history_redo</code></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pkg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> transaction.trans_data:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pkg.state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Updated&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.downgrade(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">pkgtup</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pkg.pkgtup):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        done </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                except</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> yum.Errors.DowngradeError:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                    self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.logger.critical(_(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Failed to downgrade: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), pkg)</span></span></code></pre></div><p>加<code>-v</code>可打印详细的日志<br> 主要是删除已安装的包, 然后<code>yum update</code>指定的新包.<br> 这里删除已安装的包, 很容易删掉其他依赖包. 导致问题. 如下是删除包的一些描述</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Are  used  to  remove  the  specified packages from the system as well as removing any packages which depend on the package being removed. remove operates on</span></span>
<span class="line"><span>              groups, files, provides and filelists just like the &quot;install&quot; command.(See Specifying package names for more information)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>              Note that &quot;yum&quot; is included in the protected_packages configuration, by default.  So you can&#39;t accidentally remove yum itself.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>              The remove_leaf_only configuration changes the behaviour of this command to only remove packages which aren&#39;t required by something else.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>              The clean_requirements_on_remove configuration changes the behaviour of this command to also remove packages that are only dependencies of this package.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>              Because remove does a lot of work to make it as easy as possible to use, there are also a few specific remove commands &quot;remove-n&quot;, &quot;remove-na&quot;  and  &quot;remove-</span></span>
<span class="line"><span>              nevra&quot;. These only work on package names, and do not process wildcards etc.</span></span></code></pre></div><h2 id="其他-1" tabindex="-1">其他 <a class="header-anchor" href="#其他-1" aria-label="Permalink to &quot;其他&quot;">​</a></h2><p><code>yum list installed</code>的结果并不等于<code>rpm -qa</code>. <code>rpm -qa</code>会多<code>gpg-pubkey</code>这个软件包. 解释如下:<br><a href="https://unix.stackexchange.com/questions/190203/what-are-gpg-pubkey-packages" target="_blank" rel="noreferrer">https://unix.stackexchange.com/questions/190203/what-are-gpg-pubkey-packages</a></p><p>可以使用python库<code>rpm</code>来比较软件包的版本. <code>rpm.labelCompare((an,av,ar),(bn,bv,br))</code><br> 返回值1 表示a较新. 0 相等. -1 b较新. 下面是具体的例子:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># python</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Python</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2.7.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (default, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 2019,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 14:30:50</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[GCC </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4.8.5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20150623</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (Red Hat </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">36</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)] on linux2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Type</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;help&quot;,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;copyright&quot;,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;credits&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;license&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> for</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> more</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> information.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rpm</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpm.labelCompare((</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;systemd&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;219&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;62.el7_6.6&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;systemd&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;219&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;63.el7_6.6&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;&gt;&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><a href="https://stackoverflow.com/questions/3206319/how-do-i-compare-rpm-versions-in-python" target="_blank" rel="noreferrer">https://stackoverflow.com/questions/3206319/how-do-i-compare-rpm-versions-in-python</a></p><h1 id="升级前检查" tabindex="-1">升级前检查 <a class="header-anchor" href="#升级前检查" aria-label="Permalink to &quot;升级前检查&quot;">​</a></h1><ul><li>检查repo里是否有当前OS已安装的软件包. 方便回退.<br> 以下两个命令等价</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">package-cleanup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --orphans</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> extras</span></span></code></pre></div><p>代码看是通过<code>/usr/share/yum-cli/cli.py</code>里类<code>YumBaseCli</code>的函数<code>returnPkgLists</code>, 进一步调用类<code>YumBase</code>的函数<code>doPackageLists</code> 实现</p><ul><li>检查本地rpm数据库是否由依赖问题, 相当于升级前校验</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">package-cleanup</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --problems</span></span></code></pre></div><p>通过<code>rpmdb.check_dependencies()</code>实现</p><ul><li>模拟<code>yum update</code>但不真正升级, 检查是否报错. 相当于dry-run. 原理是对每次确认选择都是<code>no</code></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --assumeno</span></span></code></pre></div><p>使用<code>echo $?</code>检查上述命令的返回码. 非零表明有异常.</p><h1 id="升级" tabindex="-1">升级 <a class="header-anchor" href="#升级" aria-label="Permalink to &quot;升级&quot;">​</a></h1><ul><li>升级命令</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -y</span></span></code></pre></div><h1 id="升级后检查" tabindex="-1">升级后检查 <a class="header-anchor" href="#升级后检查" aria-label="Permalink to &quot;升级后检查&quot;">​</a></h1><ul><li>检查哪些进程需要重启,才能使用新的软件包或者库</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># needs-restarting</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /usr/lib/systemd/systemd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --system</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --deserialize</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 16</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">443</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> login</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">3838</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@pts/3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1009</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sbin/dhclient</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -q</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -lf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/dhclient/dhclient--eth0.lease</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -pf</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/run/dhclient-eth0.pid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">2221</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sshd:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@pts/0</span></span></code></pre></div><p>原理:<br> 在<code>/proc</code>下遍历所有<code>pid</code>下面的<code>smaps</code>文件, 获取所有打开文件的信息<br> 检查这些文件对应的rpm包的安装时间<br> 和进程的启动时间对比, 如果rpm的时间晚,则打印出来<br> 具体可以查看<code>/usr/bin/needs-restarting</code>, 它是一个py脚本</p><p>细节:<br> 通过<code>/proc/[pid]/stat</code>下的信息和os的<code>boot_time</code>来计算进程的启动时间</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_process_time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pid, boot_time):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps_stat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/proc/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/stat&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> %</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pid).read().strip()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Filename of the executable might contain spaces, so we throw it away</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps_stat </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ps_stat[ps_stat.rfind(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;)&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:].split()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;utime&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jiffies_to_seconds(ps_stat[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">11</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;stime&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jiffies_to_seconds(ps_stat[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">12</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cutime&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jiffies_to_seconds(ps_stat[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">13</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;cstime&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jiffies_to_seconds(ps_stat[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">14</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;start_time&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boot_time </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> jiffies_to_seconds(ps_stat[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">19</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ps[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;state&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;R&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : _(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Running&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                   &#39;S&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : _(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Sleeping&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                   &#39;D&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : _(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Uninterruptible&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                   &#39;Z&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : _(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Zombie&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                   &#39;T&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : _(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Traced/Stopped&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                   }.get(ps_stat[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], _(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;Unknown&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>通过rpmdb库里的<code>searchFiles</code>函数获取打开文件对应的包, 进而获取安装时间,即<code>installtime</code></p><p>进程属于哪个systemd service的方法是 获取该pid的cgroup, 如果有<code>name=systemd</code>则说明它是一个服务, 然后已<code>/</code>为分隔符后的最后一个字段就是对应的service</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /proc/3656/cgroup</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">11:blkio:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">10:cpuset:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">9:net_prio,net_cls:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">8:perf_event:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">7:hugetlb:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">6:freezer:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">5:memory:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">4:devices:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">3:pids:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">2:cpuacct,cpu:/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">1:name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=systemd:/system.slice/sshd.service</span></span></code></pre></div><ul><li>检查是否重启OS才能使相应更新后的软件包生效. 当然OS能正常运行.只是不重启无法使用新的功能或者特性.<br> 原理是检查升级的包是否在如下列表里</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span> &#39;kernel&#39;, &#39;glibc&#39;, &#39;linux-firmware&#39;, &#39;systemd&#39;, &#39;udev&#39;,</span></span>
<span class="line"><span> `openssl-libs&#39;, &#39;gnutls&#39;, &#39;dbus&#39;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># needs-restarting -r</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Core</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> libraries</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> or</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> services</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> have</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> been</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> updated:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  systemd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 219-62.el7_6.6</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Reboot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> is</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> required</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ensure</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> that</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> your</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> benefits</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> these</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> updates.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">More</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> information:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">https://access.redhat.com/solutions/27943</span></span></code></pre></div><p>如下命令打印哪些服务需要重启</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># needs-restarting -s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">network.service</span></span></code></pre></div><h1 id="回退" tabindex="-1">回退 <a class="header-anchor" href="#回退" aria-label="Permalink to &quot;回退&quot;">​</a></h1><p>使用<code>yum history</code>查询要回退事务的ID, 比如<code>213</code>. 然后运行<code>yum history undo 213</code><br> 先查询指定的事务里的包状态信息, 然后反方向生成事务, 再次执行. 比如之前是更新, 那么新事务就是卸载新包,安装旧包</p><h1 id="其他-2" tabindex="-1">其他 <a class="header-anchor" href="#其他-2" aria-label="Permalink to &quot;其他&quot;">​</a></h1><p>查询本地软件包来自哪个repo</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># find-repos-of-install kernel</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Loaded</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> plugins:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fastestmirror</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel-3.10.0-123.el7.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> anaconda</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kernel-3.10.0-957.21.2.el7.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> repo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> updates</span></span></code></pre></div><p>使用<code>yum repolist -v</code>查询repo详情</p><h1 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h1><p>How to use yum history to roll back an update in Red Hat Enterprise Linux 6 , 7<br><a href="https://access.redhat.com/solutions/64069" target="_blank" rel="noreferrer">https://access.redhat.com/solutions/64069</a><br> How to use yum to downgrade or rollback some package updates<br><a href="https://access.redhat.com/solutions/29617" target="_blank" rel="noreferrer">https://access.redhat.com/solutions/29617</a></p></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><!----><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>Last updated: <time datetime="2025-08-06T14:00:52.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/linux/ntp.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>理解NTP协议</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/linux/tty.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>tty pts相关过程</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>Released under the MIT License.</p><p class="copyright" data-v-e315a0ad>Copyright © 2022-present xixiliguo</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"algorithm_algorithm-dfs.md\":\"BaN2DDPj\",\"algorithm_binary-index-tree.md\":\"BbCxYesA\",\"algorithm_radix-tree.md\":\"DJFaXSLb\",\"algorithm_segment-tree.md\":\"IbTXSvdF\",\"algorithm_unionfind.md\":\"B3tdQ7Bw\",\"golang_golang-exec.md\":\"C4dFGdKU\",\"golang_strings-algorithm-golang.md\":\"AKT-usL2\",\"index.md\":\"kQtiz820\",\"k8s_runc.md\":\"DzRFbvP4\",\"kernel_block.md\":\"CBjMlEf0\",\"kernel_ebpf.md\":\"BKpLBf67\",\"kernel_function-call-conventions.md\":\"DhQRBoxr\",\"kernel_kernel-cgroup-namespace.md\":\"BtIyFZo_\",\"kernel_kernel-crash.md\":\"Cq1WLW20\",\"kernel_kernel-irq.md\":\"BvINSooY\",\"kernel_kernel-memory.md\":\"UqqJ_XZE\",\"kernel_kernel-syscall-sched.md\":\"CLGw--v1\",\"kernel_linux-trap.md\":\"aX3m8ohF\",\"kernel_trace.md\":\"cQ_8euoq\",\"kernel_virtio.md\":\"C1PgHMpC\",\"linux_atop.md\":\"Dn--ARTi\",\"linux_bandersnatch-pypi.md\":\"BfoxNmM7\",\"linux_cloud-init.md\":\"DfqnE83L\",\"linux_dns.md\":\"DkTMoa71\",\"linux_linux-boot.md\":\"C2o8Qze_\",\"linux_linux-common-commands.md\":\"DxNV7yA6\",\"linux_linux-shadow.md\":\"BDbRbzVa\",\"linux_multi-queue.md\":\"DolDDFm0\",\"linux_ntp.md\":\"BayUks8g\",\"linux_tty.md\":\"tSs9ZFU1\",\"linux_yum-update.md\":\"lqyvCo22\",\"network_libvirt-network.md\":\"B2eU3sPn\",\"network_neighbour.md\":\"6PeVkU2L\",\"network_net_bpftrace.md\":\"CpcygBAU\",\"network_ss.md\":\"BLAH86d1\",\"network_tcp.md\":\"CUCq-Yy6\",\"network_tcpdump-wireshark.md\":\"B0MKuqLl\",\"others_code_segment.md\":\"Db2pjtxW\",\"others_lua-implemention-gc.md\":\"I0221m6G\",\"others_lua-implemention-type-value.md\":\"LSAalCd1\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"xixiliguo\",\"description\":\"博客\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/img/coast.jpg\",\"nav\":[{\"text\":\"Linux运维\",\"link\":\"/linux/linux-common-commands\"},{\"text\":\"网络协议\",\"link\":\"/network/tcp\"},{\"text\":\"Golang笔记\",\"link\":\"/golang/golang-exec\"},{\"text\":\"容器与k8s\",\"link\":\"/k8s/runc\"},{\"text\":\"算法笔记\",\"link\":\"/algorithm/radix-tree\"},{\"text\":\"内核分析\",\"link\":\"/kernel/kernel-syscall-sched\"},{\"text\":\"杂项\",\"link\":\"/others/code_segment\"}],\"sidebar\":{\"/linux/\":[{\"text\":\"Linux运维\",\"collapsed\":false,\"items\":[{\"text\":\"ATOP工作原理总结\",\"link\":\"/linux/atop\"},{\"text\":\"使用Bandersnatch搭建私有Pypi源\",\"link\":\"/linux/bandersnatch-pypi\"},{\"text\":\"cloud-init学习笔记\",\"link\":\"/linux/cloud-init\"},{\"text\":\"DNS学习总结\",\"link\":\"/linux/dns\"},{\"text\":\"Linux Boot过程总结\",\"link\":\"/linux/linux-boot\"},{\"text\":\"Linux 下常用命令与技巧汇总\",\"link\":\"/linux/linux-common-commands\"},{\"text\":\"Linux /etc/shadow 文件学习笔记\",\"link\":\"/linux/linux-shadow\"},{\"text\":\"Linux 网卡多队列介绍\",\"link\":\"/linux/multi-queue\"},{\"text\":\"理解NTP协议\",\"link\":\"/linux/ntp\"},{\"text\":\"使用Yum 升级OS\",\"link\":\"/linux/yum-update\"},{\"text\":\"tty pts相关过程\",\"link\":\"/linux/tty\"}]}],\"/network/\":[{\"text\":\"网络协议\",\"collapsed\":false,\"items\":[{\"text\":\"Libvirt Network\",\"link\":\"/network/libvirt-network\"},{\"text\":\"TCP协议栈\",\"link\":\"/network/tcp\"},{\"text\":\"邻居子系统\",\"link\":\"/network/neighbour\"},{\"text\":\"Tcpdump与Wireshark点滴记录\",\"link\":\"/network/tcpdump-wireshark\"},{\"text\":\"ss命令指南\",\"link\":\"/network/ss\"},{\"text\":\"常用的bpftrace脚本\",\"link\":\"/network/net_bpftrace\"}]}],\"/golang/\":[{\"text\":\"Golang笔记\",\"items\":[{\"text\":\"Golang os/exec 实现\",\"link\":\"/golang/golang-exec\"},{\"text\":\"从Go标准库看字符串匹配算法\",\"link\":\"/golang/strings-algorithm-golang\"}]}],\"/k8s/\":[{\"text\":\"容器与k8s\",\"items\":[{\"text\":\"runc 容器运行时学习笔记\",\"link\":\"/k8s/runc\"}]}],\"/algorithm/\":[{\"text\":\"算法笔记\",\"items\":[{\"text\":\"力扣: DFS相关题解\",\"link\":\"/algorithm/algorithm-dfs\"},{\"text\":\"树状数组和相关题解\",\"link\":\"/algorithm/binary-index-tree\"},{\"text\":\"Radix Tree介绍与httprouter源码笔记\",\"link\":\"/algorithm/radix-tree\"},{\"text\":\"线段树相关题解\",\"link\":\"/algorithm/segment-tree\"},{\"text\":\"UnionFind并查集和相关题解\",\"link\":\"/algorithm/unionfind\"}]}],\"/kernel/\":[{\"text\":\"内核分析\",\"items\":[{\"text\":\"cgroup与命名空间\",\"link\":\"/kernel/kernel-cgroup-namespace\"},{\"text\":\"crash分析\",\"link\":\"/kernel/kernel-crash\"},{\"text\":\"中断\",\"link\":\"/kernel/kernel-irq\"},{\"text\":\"内存管理\",\"link\":\"/kernel/kernel-memory\"},{\"text\":\"系统调用与进程调度\",\"link\":\"/kernel/kernel-syscall-sched\"},{\"text\":\"Linux: Trap\",\"link\":\"/kernel/linux-trap\"},{\"text\":\"virtio驱动\",\"link\":\"/kernel/virtio\"},{\"text\":\"函数调用规约\",\"link\":\"/kernel/function-call-conventions\"},{\"text\":\"eBPF\",\"link\":\"/kernel/ebpf\"},{\"text\":\"跟踪技术原理\",\"link\":\"/kernel/trace\"},{\"text\":\"块设备\",\"link\":\"/kernel/block\"}]}],\"/others/\":[{\"text\":\"杂项\",\"items\":[{\"text\":\"一些代码片段\",\"link\":\"/others/code_segment\"},{\"text\":\"Lua实现原理 - GC垃圾回收\",\"link\":\"/others/lua-implemention-gc\"},{\"text\":\"Lua实现原理 - 类型与值\",\"link\":\"/others/lua-implemention-type-value\"}]}]},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2022-present xixiliguo\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用Yum 升级OS | xixiliguo</title>
    <meta name="description" content="博客">
    <link rel="stylesheet" href="/assets/style.d1dca3a2.css">
    <link rel="modulepreload" href="/assets/app.526dca4e.js">
    <link rel="modulepreload" href="/assets/linux_yum-update.md.67a0bf95.lean.js">
    
    <script>(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-6b5fd0a9><!--[--><!--]--><!--[--><span tabindex="-1" data-v-45f6ae50></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-45f6ae50> Skip to content </a><!--]--><!----><header class="VPNav" data-v-6b5fd0a9 data-v-0e356168><div class="VPNavBar has-sidebar" data-v-0e356168 data-v-8856f192><div class="container" data-v-8856f192><div class="VPNavBarTitle has-sidebar" data-v-8856f192 data-v-6a6f7ff6><a class="title" href="/" data-v-6a6f7ff6><!--[--><img class="VPImage logo" src="/img/coast.jpg" data-v-73ae1788><!--]--><!--[-->xixiliguo<!--]--></a></div><div class="content" data-v-8856f192><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8856f192 data-v-a30758ee><span id="main-nav-aria-label" class="visually-hidden" data-v-a30758ee>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/linux-common-commands.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Linux运维<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/network/tcp.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->网络协议<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/golang/golang-exec.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Golang笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/k8s/runc.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->容器与k8s<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/radix-tree.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->算法笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/kernel/kernel-syscall-sched.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->内核分析<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/code_segment.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->杂项<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8856f192 data-v-311055f2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-311055f2 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-8856f192 data-v-0562f5c0 data-v-8dccea88><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8dccea88><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8dccea88><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8dccea88><div class="VPMenu" data-v-8dccea88 data-v-e73581a2><!----><!--[--><!--[--><!----><div class="group" data-v-0562f5c0><div class="item appearance" data-v-0562f5c0><p class="label" data-v-0562f5c0>Appearance</p><div class="appearance-action" data-v-0562f5c0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-0562f5c0 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8856f192 data-v-6f008456><span class="container" data-v-6f008456><span class="top" data-v-6f008456></span><span class="middle" data-v-6f008456></span><span class="bottom" data-v-6f008456></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-6b5fd0a9 data-v-92b0f14a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-92b0f14a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-92b0f14a><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-92b0f14a>Menu</span></button><a class="top-link" href="#" data-v-92b0f14a> Return to top </a></div><aside class="VPSidebar" data-v-6b5fd0a9 data-v-55e4c7db><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-55e4c7db><span class="visually-hidden" id="sidebar-aria-label" data-v-55e4c7db> Sidebar Navigation </span><!--[--><div class="group" data-v-55e4c7db><section class="VPSidebarGroup" data-v-55e4c7db data-v-1f69a7ed><div class="title" data-v-1f69a7ed><h2 class="title-text" data-v-1f69a7ed>Linux运维</h2><div class="action" data-v-1f69a7ed><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-1f69a7ed><!--[--><a class="VPLink link" href="/linux/atop.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>ATOP工作原理总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/bandersnatch-pypi.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>使用Bandersnatch搭建私有Pypi源</span><!--]--><!----></a><a class="VPLink link" href="/linux/cloud-init.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>cloud-init学习笔记</span><!--]--><!----></a><a class="VPLink link" href="/linux/dns.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>DNS学习总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/linux-boot.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux Boot过程总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/linux-common-commands.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux 下常用命令与技巧汇总</span><!--]--><!----></a><a class="VPLink link" href="/linux/shadow.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux /etc/shadow 文件学习笔记</span><!--]--><!----></a><a class="VPLink link" href="/linux/multi-queue.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux 网卡多队列介绍</span><!--]--><!----></a><a class="VPLink link" href="/linux/ntp.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>理解NTP协议</span><!--]--><!----></a><a class="VPLink link active" href="/linux/yum-update.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>使用Yum 升级OS</span><!--]--><!----></a><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-6b5fd0a9 data-v-a4c57a06><div class="VPDoc has-sidebar" data-v-a4c57a06 data-v-79ca2460><div class="container" data-v-79ca2460><div class="aside" data-v-79ca2460><div class="aside-curtain" data-v-79ca2460></div><div class="aside-container" data-v-79ca2460><div class="aside-content" data-v-79ca2460><div class="VPDocAside" data-v-79ca2460 data-v-779d834d><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-779d834d data-v-51e5a8ce><div class="content" data-v-51e5a8ce><div class="outline-marker" data-v-51e5a8ce></div><div class="outline-title" data-v-51e5a8ce>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-51e5a8ce><span class="visually-hidden" id="doc-outline-aria-label" data-v-51e5a8ce> Table of Contents for current page </span><ul class="root" data-v-51e5a8ce><!--[--><li style="" data-v-51e5a8ce><a class="outline-link" href="#创建repo源的操作" data-v-51e5a8ce>创建Repo源的操作</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#rpmsave与rpmnew" data-v-51e5a8ce>rpmsave与rpmnew</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#查询依赖关系" data-v-51e5a8ce>查询依赖关系</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#spec文件" data-v-51e5a8ce>SPEC文件</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#其他" data-v-51e5a8ce>其他</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#history相关操作" data-v-51e5a8ce>history相关操作</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#yum-update-与-yum-update-to-的区别" data-v-51e5a8ce>yum update 与 yum update-to 的区别</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#yum-update" data-v-51e5a8ce>yum update</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#yum-downgrade" data-v-51e5a8ce>yum downgrade</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#其他-1" data-v-51e5a8ce>其他</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-779d834d></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-79ca2460><div class="content-container" data-v-79ca2460><!--[--><!--]--><main class="main" data-v-79ca2460><div style="position:relative;" class="vp-doc _linux_yum-update" data-v-79ca2460><div><p>主要介绍使用yum 升级OS软件包的一些细节</p><h1 id="repo源" tabindex="-1">Repo源 <a class="header-anchor" href="#repo源" aria-hidden="true">#</a></h1><p>每个源下面有个<code>repodata</code>这个文件夹, 该文件夹存放着软件包的元数据(包名,路径,版本,依赖关系)<br> 比如<code>https://mirrors.tuna.tsinghua.edu.cn/centos/7.6.1810/os/x86_64/</code><br> 下面的repodata里 <code>25cd2c29e5adb2b6f8a5b091237dd9f760e97815b37f2557f2cd1c12a5f294f0-primary.xml.gz</code> 文件就是元数据文件</p><h2 id="创建repo源的操作" tabindex="-1">创建Repo源的操作 <a class="header-anchor" href="#创建repo源的操作" aria-hidden="true">#</a></h2><p>已<code>/opt/mirrors/CentOS7</code>为例:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">mkdir -p CentOS7/Packages</span></span>
<span class="line"></span></code></pre></div><p>将所有软件rpm包上传到文件夹<code>Packages</code></p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> /opt/mirrors/CentOS7</span></span>
<span class="line"><span style="color:#A6ACCD;">createrepo </span><span style="color:#82AAFF;">.</span></span>
<span class="line"></span></code></pre></div><p>该操作会生成<code>yum</code>会用到的元数据,并放入到<code>repodata</code>目录.<br> 并不一定非要创建<code>Packages</code>目录, <code>createrepo</code>会自动查找指定目录及其子目录. <code>Packages</code>是个很好的约定,方便管理<br> rpm包是集合, 含有二进制文件, 版本信息, 依赖关系等. <code>createrepo</code>通过读取每个rpm的信息,并生成元数据.<br> 这样<code>yum</code>在分析时只需要下载元数据,就可以得知该源有哪个软件,什么版本等.不必每次下载源里的包.</p><p>我们使用<code>yum checkupdate</code>等命令时, 假设访问<code>xxx/CentOS7</code>, <code>yum</code>会检查是否有<code>xxx/CentOS7/repodata</code>这个目录,并获取相应的元数据.</p><h1 id="rpm相关操作" tabindex="-1">rpm相关操作 <a class="header-anchor" href="#rpm相关操作" aria-hidden="true">#</a></h1><h2 id="rpmsave与rpmnew" tabindex="-1">rpmsave与rpmnew <a class="header-anchor" href="#rpmsave与rpmnew" aria-hidden="true">#</a></h2><p>rpm的spec文件里可以指定新版配置文件的升级方式<br> 默认升级时旧版本有改动,则用新版本替换旧版本的文件. 旧版本的文件改名为XXXX.rpmsave<br> 如果spec文件里指定为<code>%config(noreplace)</code>, 则升级时旧版本有改动, 保留旧文件,新版本文件改为XXXX.rpmnew<br> 这里的改动指新版本的rpm里对比旧版本rpm里的默认文件. 并非拿可能被用户修改过的文件和新版本里的文件对比<br> 如果文件不存在(比如人为删除), 升级时会重新生成该文件， 不管是configfile还是 noconfigfile</p><p>卸载时对于<code>%config(noreplace)</code>的文件,如果有改动,则不会删除,改名为XXXX.rpmsave</p><p><a href="https://blog.csdn.net/xukunddp/article/details/6409795" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/xukunddp/article/details/6409795</a> 有相关解释<br><a href="https://www.cl.cam.ac.uk/~jw35/docs/rpm_config.html" target="_blank" rel="noopener noreferrer">https://www.cl.cam.ac.uk/~jw35/docs/rpm_config.html</a> 描述了各种改动场景下的结果</p><p>如果没有spec文件, 可通过如下步骤从已安装的软件包确认下配置文件的覆盖方式<br> 比较文件的flags是否 第5个Bit位位1. 即 XX &amp; (1&lt;&lt;4) 是否非0<br> 显示<code>/etc/pam.d/sshd</code>,<code>/etc/ssh/sshd_config</code>,<code>/etc/sysconfig/sshd</code>的属性是 %config(noreplace)</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --qf &#39;[%{filenames}: %{fileflags}\n]&#39; openssh-server</span></span>
<span class="line"><span style="color:#A6ACCD;">/etc/pam.d/sshd: 17</span></span>
<span class="line"><span style="color:#A6ACCD;">/etc/ssh/sshd_config: 17</span></span>
<span class="line"><span style="color:#A6ACCD;">/etc/sysconfig/sshd: 17</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/lib/systemd/system/sshd-keygen.service: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/lib/systemd/system/sshd.service: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/lib/systemd/system/sshd.socket: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/lib/systemd/system/sshd@.service: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/lib64/fipscheck/sshd.hmac: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/libexec/openssh/sftp-server: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/sbin/sshd: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/sbin/sshd-keygen: 0</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/share/man/man5/moduli.5.gz: 2</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/share/man/man5/sshd_config.5.gz: 2</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/share/man/man8/sftp-server.8.gz: 2</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/share/man/man8/sshd.8.gz: 2</span></span>
<span class="line"><span style="color:#A6ACCD;">/var/empty/sshd: 0</span></span>
<span class="line"></span></code></pre></div><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># grep -r RPMFILE_NOREPLACE /usr/include/</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/include/rpm/rpmfi.h:    RPMFILE_NOREPLACE	= </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">1 </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#C3E88D;">  </span><span style="color:#89DDFF;font-style:italic;">4),</span><span style="color:#C3E88D;">	/*!&lt; from %%config(noreplace) */</span></span>
<span class="line"></span></code></pre></div><p>参考: <a href="https://www.redhat.com/archives/rpm-list/2003-October/msg00140.html" target="_blank" rel="noopener noreferrer">https://www.redhat.com/archives/rpm-list/2003-October/msg00140.html</a></p><h2 id="查询依赖关系" tabindex="-1">查询依赖关系 <a class="header-anchor" href="#查询依赖关系" aria-hidden="true">#</a></h2><p>检查软件提供哪些capability</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --provides openssh-server</span></span>
<span class="line"><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">openssh-server</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> = 7.4p1-16.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">openssh-server = 7.4p1-16.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">openssh-server</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x86-64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> = 7.4p1-16.el7</span></span>
<span class="line"></span></code></pre></div><p>检查软件需要哪些capability</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --requires openssh-server</span></span>
<span class="line"><span style="color:#A6ACCD;">/bin/bash</span></span>
<span class="line"><span style="color:#A6ACCD;">/bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">/bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">/bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">/bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/sbin/useradd</span></span>
<span class="line"><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">openssh-server</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> = 7.4p1-16.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">fipscheck-lib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x86-64</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">= 1.3.0</span></span>
<span class="line"><span style="color:#82AAFF;">libaudit.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libc.so.6</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.14</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.16</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.17</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.2.5</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.3</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.3.4</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.4</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.8</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libcom_err.so.2</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libcrypt.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libcrypt.so.1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.2.5</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libcrypto.so.10</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libcrypto.so.10</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">OPENSSL_1.0.1_EC</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libcrypto.so.10</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">OPENSSL_1.0.2</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libcrypto.so.10</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">libcrypto.so.10</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libdl.so.2</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libfipscheck.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libgssapi_krb5.so.2</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libgssapi_krb5.so.2</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">gssapi_krb5_2_MIT</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libk5crypto.so.3</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libkrb5.so.3</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libkrb5.so.3</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">krb5_3_MIT</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">liblber-2.4.so.2</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libldap-2.4.so.2</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libpam.so.0</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libpam.so.0</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">LIBPAM_1.0</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libresolv.so.2</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libselinux.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libsystemd.so.0</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libsystemd.so.0</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">LIBSYSTEMD_209</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libutil.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">libutil.so.1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.2.5</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libwrap.so.0</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">libz.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">openssh = 7.4p1-16.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">pam </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">= 1.0.1-3</span></span>
<span class="line"><span style="color:#A6ACCD;">rpmlib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CompressedFileNames</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">= 3.0.4-1</span></span>
<span class="line"><span style="color:#A6ACCD;">rpmlib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FileDigests</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">= 4.6.0-1</span></span>
<span class="line"><span style="color:#A6ACCD;">rpmlib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">PayloadFilesHavePrefix</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">= 4.0-1</span></span>
<span class="line"><span style="color:#A6ACCD;">rtld</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GNU_HASH</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">systemd-units</span></span>
<span class="line"><span style="color:#A6ACCD;">systemd-units</span></span>
<span class="line"><span style="color:#A6ACCD;">systemd-units</span></span>
<span class="line"><span style="color:#A6ACCD;">rpmlib</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">PayloadIsXz</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">= 5.2-1</span></span>
<span class="line"></span></code></pre></div><p>根据capability,查询哪个包提供</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --whatprovides pam</span></span>
<span class="line"><span style="color:#A6ACCD;">pam-1.1.8-22.el7.x86_64</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --whatprovides libsystemd.so.0\(\)\(64bit\)</span></span>
<span class="line"><span style="color:#A6ACCD;">systemd-libs-219-62.el7_6.6.x86_64</span></span>
<span class="line"></span></code></pre></div><p>查询哪个包需要某个特定的capability</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --whatrequires pam</span></span>
<span class="line"><span style="color:#A6ACCD;">passwd-0.79-4.el7.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">cronie-1.4.11-20.el7_6.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">util-linux-2.23.2-59.el7_6.1.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">openssh-server-7.4p1-16.el7.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">authconfig-6.2.8-30.el7.x86_64</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># rpm -q --whatrequires libsystemd.so.0\(\)\(64bit\)</span></span>
<span class="line"><span style="color:#A6ACCD;">dbus-libs-1.10.24-13.el7_6.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">dbus-1.10.24-13.el7_6.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">polkit-0.112-18.el7_6.1.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">util-linux-2.23.2-59.el7_6.1.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">openssh-server-7.4p1-16.el7.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">rsyslog-8.24.0-34.el7.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">procps-ng-3.3.10-23.el7.x86_64</span></span>
<span class="line"></span></code></pre></div><p>如果要查询本地rpm软件包的信息, 需要使用<code>-p</code><br> 比如之前是<code>rpm -ql bpftool</code>, 要改为<code>rpm -ql -p bpftool-3.10.0-957.el7.x86_64.rpm</code></p><p>如果要查询的包,文件或者capability, 不在本地已安装的包里, 可以使用<code>repoquery</code>从已知源中查询<br> 例如查询哪个包提供了<code>strace</code>这个capability:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">$ repoquery --whatprovides strace</span></span>
<span class="line"><span style="color:#A6ACCD;">strace-0:4.12-9.el7.x86_64</span></span>
<span class="line"></span></code></pre></div><p>repoquery不仅支持从源中查,还会从本地已安装的信息来查.</p><h2 id="spec文件" tabindex="-1">SPEC文件 <a class="header-anchor" href="#spec文件" aria-hidden="true">#</a></h2><p>rpm的构建过程需要源代码和<code>spec</code>文件. <code>spec</code>文件用于描述rpm的元数据信息和指导如何编译,打包,封装为二进制的rpm文件</p><p>跟着如下教程, 自己可以从xxx.src.rpm编译出xxx.rpm文件. 常用于问题定位,增加日志等.<br><a href="https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/" target="_blank" rel="noopener noreferrer">https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/</a></p><p>下面两篇文章介绍了SPEC的语法:<br><a href="https://fedoraproject.org/wiki/How_to_create_am_RPM_package/zh-cn" target="_blank" rel="noopener noreferrer">https://fedoraproject.org/wiki/How_to_create_am_RPM_package/zh-cn</a><br><a href="https://rpm-packaging-guide.github.io" target="_blank" rel="noopener noreferrer">https://rpm-packaging-guide.github.io</a></p><h2 id="其他" tabindex="-1">其他 <a class="header-anchor" href="#其他" aria-hidden="true">#</a></h2><p>本地rpm包解压缩</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">rpm2cpio xxx.rpm </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> cpio -div</span></span>
<span class="line"></span></code></pre></div><h1 id="yum相关操作" tabindex="-1">yum相关操作 <a class="header-anchor" href="#yum相关操作" aria-hidden="true">#</a></h1><p><code>yum</code>的主要代码在<code>/usr/lib/python2.7/site-packages/yum/</code><br><code>class YumBase</code> 是主要的类, 含大部分操作</p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">YumBase</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">depsolve</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Depsolve</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">This is a primary structure and base class. It houses the</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    objects and methods needed to perform most things in yum. It is</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    almost an abstract class in that you will need to add your own</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    class above it for most real use.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"></span></code></pre></div><p>yum所有的操作,都是分析具体的操作(删除,更新,新安装),进而分析相关的依赖, 比如更新时,检查依赖是否满足,不满足也要将依赖的包进程更新.<br> 分析完后将对应包和状态(比如updated, erase等)放入事务中,然后执行具体的操作</p><p>查询特定软件依赖哪些包</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># yum deplist rsync</span></span>
<span class="line"><span style="color:#A6ACCD;">Loaded plugins: fastestmirror</span></span>
<span class="line"><span style="color:#A6ACCD;">Loading mirror speeds from cached hostfile</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> base: mirrors.cqu.edu.cn</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> extras: mirror.jdcloud.com</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> updates: mirrors.aliyun.com</span></span>
<span class="line"><span style="color:#A6ACCD;">package: rsync.x86_64 3.1.2-6.el7_6.1</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: /bin/sh</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: bash.x86_64 4.2.46-31.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: </span><span style="color:#82AAFF;">libacl.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: libacl.x86_64 2.2.51-14.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: libacl.so.1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ACL_1.0</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: libacl.x86_64 2.2.51-14.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: </span><span style="color:#82AAFF;">libattr.so.1</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: libattr.x86_64 2.4.46-13.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: libattr.so.1</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ATTR_1.0</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: libattr.x86_64 2.4.46-13.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: libc.so.6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GLIBC_2.15</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: glibc.x86_64 2.17-260.el7_6.5</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: </span><span style="color:#82AAFF;">libpopt.so.0</span><span style="color:#89DDFF;">()(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: popt.x86_64 1.13-16.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: libpopt.so.0</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">LIBPOPT_0</span><span style="color:#89DDFF;">)(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: popt.x86_64 1.13-16.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: rtld</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">GNU_HASH</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: glibc.x86_64 2.17-260.el7_6.5</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: glibc.i686 2.17-260.el7_6.5</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: systemd-units</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: systemd.x86_64 219-62.el7_6.6</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependency: zlib</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: zlib.x86_64 1.2.7-18.el7</span></span>
<span class="line"><span style="color:#A6ACCD;">   provider: zlib.i686 1.2.7-18.el7</span></span>
<span class="line"></span></code></pre></div><h2 id="history相关操作" tabindex="-1">history相关操作 <a class="header-anchor" href="#history相关操作" aria-hidden="true">#</a></h2><p><a href="https://www.cyberciti.biz/faq/yum-history-command" target="_blank" rel="noopener noreferrer">https://www.cyberciti.biz/faq/yum-history-command</a></p><h2 id="yum-update-与-yum-update-to-的区别" tabindex="-1">yum update 与 yum update-to 的区别 <a class="header-anchor" href="#yum-update-与-yum-update-to-的区别" aria-hidden="true">#</a></h2><p>yum 有两种升级命令， yum update 和 yum update-to<br> yum update kernel 会升级Repo里的最新版<br> yum update kernel-3.10.0-327.62.59.83.h108.x86_64 会升级到指定版本。 但如果这个指定版本就是当前已安装的版本， 则自动升级到repo里的最新版。</p><p>yum update-to kernel-3.10.0-327.62.59.83.h108.x86_64 升级到指定版本， 如果这个指定版本就是当前已安装的版本， 则不升级<br> 但是yum update-to kernel则会升级多个高版本的内核。 因为yum update-to 一般要求就是软件包的版本信息</p><h2 id="yum-update" tabindex="-1">yum update <a class="header-anchor" href="#yum-update" aria-hidden="true">#</a></h2><p>没有指定的软件包,则升级所有软件, 主要逻辑代码在<code>/usr/lib/python2.7/site-packages/yum/__init__.py</code>里类<code>YumBase</code>的函数<code>update</code><br> 加<code>-v</code>可打印详细的日志</p><ol><li>使用rpm模块, 通过<code>dbMatch</code>获取已安装软件的所有信息</li><li>连接repo, 获取所有availble 的软件包信息</li><li>精简newpkg的列表,比如只保留软件包的最新版本</li><li>完成依赖关系检查, 主要是检查依赖项和冲突项</li><li>用户确认OK后,执行下载,升级操作</li></ol><p>如下下yum的包状态, 打印Debug日志时可以对照分析</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">           i = the package will be installed</span></span>
<span class="line"><span style="color:#A6ACCD;">           u = the package will be an update</span></span>
<span class="line"><span style="color:#A6ACCD;">           e = the package will be erased</span></span>
<span class="line"><span style="color:#A6ACCD;">           r = the package will be reinstalled</span></span>
<span class="line"><span style="color:#A6ACCD;">           d = the package will be a downgrade</span></span>
<span class="line"><span style="color:#A6ACCD;">           o = the package will be obsoleting another package</span></span>
<span class="line"><span style="color:#A6ACCD;">           ud = the package will be updated</span></span>
<span class="line"><span style="color:#A6ACCD;">           od = the package will be obsoleted</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="yum-downgrade" tabindex="-1">yum downgrade <a class="header-anchor" href="#yum-downgrade" aria-hidden="true">#</a></h2><p><code>yum history undo</code>, 这里undo的是升级事务, 则内部调用的是<code>yum downgrader</code><br> 主要执行入口在类<code>YumBase</code>的函数<code>history_redo</code></p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> pkg </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> transaction</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">trans_data</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> pkg</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">state</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Updated</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">downgrade</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pkgtup</span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;">pkg</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">pkgtup</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">                        done </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">True</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">except</span><span style="color:#A6ACCD;"> yum</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">Errors</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DowngradeError</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">                    self</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">logger</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">critical</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Failed to downgrade: %s</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">),</span><span style="color:#82AAFF;"> pkg</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>加<code>-v</code>可打印详细的日志<br> 主要是删除已安装的包, 然后<code>yum update</code>指定的新包.<br> 这里删除已安装的包, 很容易删掉其他依赖包. 导致问题. 如下是删除包的一些描述</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">Are  used  to  remove  the  specified packages from the system as well as removing any packages which depend on the package being removed. remove operates on</span></span>
<span class="line"><span style="color:#A6ACCD;">              groups, files, provides and filelists just like the &quot;install&quot; command.(See Specifying package names for more information)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">              Note that &quot;yum&quot; is included in the protected_packages configuration, by default.  So you can&#39;t accidentally remove yum itself.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">              The remove_leaf_only configuration changes the behaviour of this command to only remove packages which aren&#39;t required by something else.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">              The clean_requirements_on_remove configuration changes the behaviour of this command to also remove packages that are only dependencies of this package.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">              Because remove does a lot of work to make it as easy as possible to use, there are also a few specific remove commands &quot;remove-n&quot;, &quot;remove-na&quot;  and  &quot;remove-</span></span>
<span class="line"><span style="color:#A6ACCD;">              nevra&quot;. These only work on package names, and do not process wildcards etc.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="其他-1" tabindex="-1">其他 <a class="header-anchor" href="#其他-1" aria-hidden="true">#</a></h2><p><code>yum list installed</code>的结果并不等于<code>rpm -qa</code>. <code>rpm -qa</code>会多<code>gpg-pubkey</code>这个软件包. 解释如下:<br><a href="https://unix.stackexchange.com/questions/190203/what-are-gpg-pubkey-packages" target="_blank" rel="noopener noreferrer">https://unix.stackexchange.com/questions/190203/what-are-gpg-pubkey-packages</a></p><p>可以使用python库<code>rpm</code>来比较软件包的版本. <code>rpm.labelCompare((an,av,ar),(bn,bv,br))</code><br> 返回值1 表示a较新. 0 相等. -1 b较新. 下面是具体的例子:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># python</span></span>
<span class="line"><span style="color:#A6ACCD;">Python 2.7.5 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">default, Apr  9 2019, 14:30:50</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">GCC 4.8.5 20150623 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Red Hat 4.8.5-36</span><span style="color:#89DDFF;">)]</span><span style="color:#A6ACCD;"> on linux2</span></span>
<span class="line"><span style="color:#A6ACCD;">Type </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">help</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">copyright</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">credits</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> or </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">license</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> more information.</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; import rpm</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; rpm.labelCompare</span><span style="color:#89DDFF;">((</span><span style="color:#C3E88D;">&quot;systemd&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">219</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">62</span><span style="color:#C3E88D;">.el</span><span style="color:#F78C6C;">7</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">.</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">&quot;)</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;">(&quot;systemd&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">219</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#C3E88D;">&quot;</span><span style="color:#F78C6C;">63</span><span style="color:#C3E88D;">.el</span><span style="color:#F78C6C;">7</span><span style="color:#C3E88D;">_</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">.</span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">-1</span></span>
<span class="line"><span style="color:#A6ACCD;">&gt;&gt;&gt; </span><span style="color:#82AAFF;">exit</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><p><a href="https://stackoverflow.com/questions/3206319/how-do-i-compare-rpm-versions-in-python" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/3206319/how-do-i-compare-rpm-versions-in-python</a></p><h1 id="升级前检查" tabindex="-1">升级前检查 <a class="header-anchor" href="#升级前检查" aria-hidden="true">#</a></h1><ul><li>检查repo里是否有当前OS已安装的软件包. 方便回退.<br> 以下两个命令等价</li></ul><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">package-cleanup --orphans</span></span>
<span class="line"><span style="color:#A6ACCD;">yum list extras</span></span>
<span class="line"></span></code></pre></div><p>代码看是通过<code>/usr/share/yum-cli/cli.py</code>里类<code>YumBaseCli</code>的函数<code>returnPkgLists</code>, 进一步调用类<code>YumBase</code>的函数<code>doPackageLists</code> 实现</p><ul><li>检查本地rpm数据库是否由依赖问题, 相当于升级前校验</li></ul><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">package-cleanup --problems</span></span>
<span class="line"></span></code></pre></div><p>通过<code>rpmdb.check_dependencies()</code>实现</p><ul><li>模拟<code>yum update</code>但不真正升级, 检查是否报错. 相当于dry-run. 原理是对每次确认选择都是<code>no</code></li></ul><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">yum update --assumeno </span></span>
<span class="line"></span></code></pre></div><p>使用<code>echo $?</code>检查上述命令的返回码. 非零表明有异常.</p><h1 id="升级" tabindex="-1">升级 <a class="header-anchor" href="#升级" aria-hidden="true">#</a></h1><ul><li>升级命令</li></ul><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">yum update -y</span></span>
<span class="line"></span></code></pre></div><h1 id="升级后检查" tabindex="-1">升级后检查 <a class="header-anchor" href="#升级后检查" aria-hidden="true">#</a></h1><ul><li>检查哪些进程需要重启,才能使用新的软件包或者库</li></ul><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># needs-restarting</span></span>
<span class="line"><span style="color:#A6ACCD;">1 </span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> /usr/lib/systemd/systemd --system --deserialize 16</span></span>
<span class="line"><span style="color:#A6ACCD;">443 </span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> login -- root</span></span>
<span class="line"><span style="color:#A6ACCD;">3838 </span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> sshd: root@pts/3</span></span>
<span class="line"><span style="color:#A6ACCD;">1009 </span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> /sbin/dhclient -H localhost -1 -q -lf /var/lib/dhclient/dhclient--eth0.lease -pf /var/run/dhclient-eth0.pid eth0</span></span>
<span class="line"><span style="color:#A6ACCD;">2221 </span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> sshd: root@pts/0</span></span>
<span class="line"></span></code></pre></div><p>原理:<br> 在<code>/proc</code>下遍历所有<code>pid</code>下面的<code>smaps</code>文件, 获取所有打开文件的信息<br> 检查这些文件对应的rpm包的安装时间<br> 和进程的启动时间对比, 如果rpm的时间晚,则打印出来<br> 具体可以查看<code>/usr/bin/needs-restarting</code>, 它是一个py脚本</p><p>细节:<br> 通过<code>/proc/[pid]/stat</code>下的信息和os的<code>boot_time</code>来计算进程的启动时间</p><div class="language-python"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_process_time</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pid</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> boot_time</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps_stat </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">open</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/proc/%d/stat</span><span style="color:#89DDFF;">&quot;</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">%</span><span style="color:#82AAFF;"> pid</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">read</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">strip</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Filename of the executable might contain spaces, so we throw it away</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps_stat </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">ps_stat</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">rfind</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">:].</span><span style="color:#82AAFF;">split</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">utime</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">jiffies_to_seconds</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">11</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">stime</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">jiffies_to_seconds</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">12</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cutime</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">jiffies_to_seconds</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">13</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">cstime</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">jiffies_to_seconds</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">14</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">start_time</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> boot_time </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">jiffies_to_seconds</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">19</span><span style="color:#89DDFF;">])</span></span>
<span class="line"><span style="color:#A6ACCD;">    ps</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">state</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">R</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Running</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                   </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">S</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Sleeping</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                   </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">D</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Uninterruptible</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                   </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Z</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Zombie</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#A6ACCD;">                   </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">T</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Traced/Stopped</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                   </span><span style="color:#89DDFF;">}.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">ps_stat</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">],</span><span style="color:#82AAFF;"> _</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Unknown</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre></div><p>通过rpmdb库里的<code>searchFiles</code>函数获取打开文件对应的包, 进而获取安装时间,即<code>installtime</code></p><p>进程属于哪个systemd service的方法是 获取该pid的cgroup, 如果有<code>name=systemd</code>则说明它是一个服务, 然后已<code>/</code>为分隔符后的最后一个字段就是对应的service</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">$ cat /proc/3656/cgroup</span></span>
<span class="line"><span style="color:#A6ACCD;">11:blkio:/</span></span>
<span class="line"><span style="color:#A6ACCD;">10:cpuset:/</span></span>
<span class="line"><span style="color:#A6ACCD;">9:net_prio,net_cls:/</span></span>
<span class="line"><span style="color:#A6ACCD;">8:perf_event:/</span></span>
<span class="line"><span style="color:#A6ACCD;">7:hugetlb:/</span></span>
<span class="line"><span style="color:#A6ACCD;">6:freezer:/</span></span>
<span class="line"><span style="color:#A6ACCD;">5:memory:/</span></span>
<span class="line"><span style="color:#A6ACCD;">4:devices:/</span></span>
<span class="line"><span style="color:#A6ACCD;">3:pids:/</span></span>
<span class="line"><span style="color:#A6ACCD;">2:cpuacct,cpu:/</span></span>
<span class="line"><span style="color:#A6ACCD;">1:name=systemd:/system.slice/sshd.service</span></span>
<span class="line"></span></code></pre></div><ul><li>检查是否重启OS才能使相应更新后的软件包生效. 当然OS能正常运行.只是不重启无法使用新的功能或者特性.<br> 原理是检查升级的包是否在如下列表里</li></ul><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;"> &#39;kernel&#39;, &#39;glibc&#39;, &#39;linux-firmware&#39;, &#39;systemd&#39;, &#39;udev&#39;,</span></span>
<span class="line"><span style="color:#A6ACCD;"> `openssl-libs&#39;, &#39;gnutls&#39;, &#39;dbus&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># needs-restarting -r</span></span>
<span class="line"><span style="color:#A6ACCD;">Core libraries or services have been updated:</span></span>
<span class="line"><span style="color:#A6ACCD;">  systemd -</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> 219-62.el7_6.6</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Reboot is required to ensure that your system benefits from these updates.</span></span>
<span class="line"><span style="color:#A6ACCD;">More information:</span></span>
<span class="line"><span style="color:#A6ACCD;">https://access.redhat.com/solutions/27943</span></span>
<span class="line"></span></code></pre></div><p>如下命令打印哪些服务需要重启</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># needs-restarting -s</span></span>
<span class="line"><span style="color:#A6ACCD;">network.service</span></span>
<span class="line"></span></code></pre></div><h1 id="回退" tabindex="-1">回退 <a class="header-anchor" href="#回退" aria-hidden="true">#</a></h1><p>使用<code>yum history</code>查询要回退事务的ID, 比如<code>213</code>. 然后运行<code>yum history undo 213</code><br> 先查询指定的事务里的包状态信息, 然后反方向生成事务, 再次执行. 比如之前是更新, 那么新事务就是卸载新包,安装旧包</p><h1 id="其他-2" tabindex="-1">其他 <a class="header-anchor" href="#其他-2" aria-hidden="true">#</a></h1><p>查询本地软件包来自哪个repo</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># find-repos-of-install kernel</span></span>
<span class="line"><span style="color:#A6ACCD;">Loaded plugins: fastestmirror</span></span>
<span class="line"><span style="color:#A6ACCD;">kernel-3.10.0-123.el7.x86_64 from repo anaconda</span></span>
<span class="line"><span style="color:#A6ACCD;">kernel-3.10.0-957.21.2.el7.x86_64 from repo updates</span></span>
<span class="line"></span></code></pre></div><p>使用<code>yum repolist -v</code>查询repo详情</p><h1 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h1><p>How to use yum history to roll back an update in Red Hat Enterprise Linux 6 , 7<br><a href="https://access.redhat.com/solutions/64069" target="_blank" rel="noopener noreferrer">https://access.redhat.com/solutions/64069</a><br> How to use yum to downgrade or rollback some package updates<br><a href="https://access.redhat.com/solutions/29617" target="_blank" rel="noopener noreferrer">https://access.redhat.com/solutions/29617</a></p></div></div></main><footer class="VPDocFooter" data-v-79ca2460 data-v-04568844><div class="edit-info" data-v-04568844><!----><div class="last-updated" data-v-04568844><p class="VPLastUpdated" data-v-04568844 data-v-0ce8c960>Last updated: <time datatime="2022-07-14T14:54:09.000Z" data-v-0ce8c960></time></p></div></div><div class="prev-next" data-v-04568844><div class="pager" data-v-04568844><a class="pager-link prev" href="/linux/ntp.html" data-v-04568844><span class="desc" data-v-04568844>Previous page</span><span class="title" data-v-04568844>理解NTP协议</span></a></div><div class="has-prev pager" data-v-04568844><!----></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-6b5fd0a9 data-v-5b331722><div class="container" data-v-5b331722><p class="message" data-v-5b331722>Released under the MIT License.</p><p class="copyright" data-v-5b331722>Copyright © 2022-present xixiliguo</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_algorithm-dfs.md\":\"a73dea67\",\"algorithm_binary-index-tree.md\":\"8bc3e51f\",\"algorithm_radix-tree.md\":\"6b75afb6\",\"algorithm_segment-tree.md\":\"c689b78e\",\"algorithm_unionfind.md\":\"a646711f\",\"golang_golang-exec.md\":\"357621ac\",\"golang_strings-algorithm-golang.md\":\"57a20191\",\"index.md\":\"27757f36\",\"k8s_runc.md\":\"09e5ae92\",\"kernel_kernel-cgroup-namespace.md\":\"4a81fd3c\",\"kernel_kernel-crash.md\":\"27a485e9\",\"kernel_kernel-irq.md\":\"0bfc9b45\",\"kernel_kernel-memory.md\":\"1c2cf851\",\"kernel_kernel-syscall-sched.md\":\"29c8373b\",\"kernel_linux-trap.md\":\"ae6473f3\",\"linux_atop.md\":\"6cfa95b0\",\"linux_bandersnatch-pypi.md\":\"dee4724b\",\"linux_cloud-init.md\":\"e0bc6141\",\"linux_dns.md\":\"ccf3bd81\",\"linux_linux-boot.md\":\"459acaa4\",\"linux_linux-common-commands.md\":\"c3e4942a\",\"linux_linux-shadow.md\":\"4d01a795\",\"linux_multi-queue.md\":\"9db1b9ad\",\"linux_ntp.md\":\"0f26af7e\",\"linux_yum-update.md\":\"67a0bf95\",\"network_libvirt-network.md\":\"90682305\",\"network_tcp.md\":\"2211909d\",\"network_tcpdump-wireshark.md\":\"a2fe5423\",\"others_code_segment.md\":\"f0f03c59\",\"others_lua-implemention-gc.md\":\"80382876\",\"others_lua-implemention-type-value.md\":\"e4816df1\"}")</script>
    <script type="module" async src="/assets/app.526dca4e.js"></script>
    
  </body>
</html>
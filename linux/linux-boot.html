<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux Boot过程总结 | xixiliguo</title>
    <meta name="description" content="博客">
    <link rel="stylesheet" href="/assets/style.d1dca3a2.css">
    <link rel="modulepreload" href="/assets/app.526dca4e.js">
    <link rel="modulepreload" href="/assets/linux_linux-boot.md.459acaa4.lean.js">
    
    <script>(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-6b5fd0a9><!--[--><!--]--><!--[--><span tabindex="-1" data-v-45f6ae50></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-45f6ae50> Skip to content </a><!--]--><!----><header class="VPNav" data-v-6b5fd0a9 data-v-0e356168><div class="VPNavBar has-sidebar" data-v-0e356168 data-v-8856f192><div class="container" data-v-8856f192><div class="VPNavBarTitle has-sidebar" data-v-8856f192 data-v-6a6f7ff6><a class="title" href="/" data-v-6a6f7ff6><!--[--><img class="VPImage logo" src="/img/coast.jpg" data-v-73ae1788><!--]--><!--[-->xixiliguo<!--]--></a></div><div class="content" data-v-8856f192><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8856f192 data-v-a30758ee><span id="main-nav-aria-label" class="visually-hidden" data-v-a30758ee>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/linux-common-commands.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Linux运维<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/network/tcp.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->网络协议<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/golang/golang-exec.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Golang笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/k8s/runc.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->容器与k8s<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/radix-tree.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->算法笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/kernel/kernel-syscall-sched.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->内核分析<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/code_segment.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->杂项<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8856f192 data-v-311055f2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-311055f2 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-8856f192 data-v-0562f5c0 data-v-8dccea88><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8dccea88><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8dccea88><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8dccea88><div class="VPMenu" data-v-8dccea88 data-v-e73581a2><!----><!--[--><!--[--><!----><div class="group" data-v-0562f5c0><div class="item appearance" data-v-0562f5c0><p class="label" data-v-0562f5c0>Appearance</p><div class="appearance-action" data-v-0562f5c0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-0562f5c0 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8856f192 data-v-6f008456><span class="container" data-v-6f008456><span class="top" data-v-6f008456></span><span class="middle" data-v-6f008456></span><span class="bottom" data-v-6f008456></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-6b5fd0a9 data-v-92b0f14a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-92b0f14a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-92b0f14a><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-92b0f14a>Menu</span></button><a class="top-link" href="#" data-v-92b0f14a> Return to top </a></div><aside class="VPSidebar" data-v-6b5fd0a9 data-v-55e4c7db><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-55e4c7db><span class="visually-hidden" id="sidebar-aria-label" data-v-55e4c7db> Sidebar Navigation </span><!--[--><div class="group" data-v-55e4c7db><section class="VPSidebarGroup" data-v-55e4c7db data-v-1f69a7ed><div class="title" data-v-1f69a7ed><h2 class="title-text" data-v-1f69a7ed>Linux运维</h2><div class="action" data-v-1f69a7ed><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-1f69a7ed><!--[--><a class="VPLink link" href="/linux/atop.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>ATOP工作原理总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/bandersnatch-pypi.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>使用Bandersnatch搭建私有Pypi源</span><!--]--><!----></a><a class="VPLink link" href="/linux/cloud-init.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>cloud-init学习笔记</span><!--]--><!----></a><a class="VPLink link" href="/linux/dns.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>DNS学习总结</span><!--]--><!----></a><a class="VPLink link active" href="/linux/linux-boot.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux Boot过程总结</span><!--]--><!----></a><a class="VPLink link" href="/linux/linux-common-commands.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux 下常用命令与技巧汇总</span><!--]--><!----></a><a class="VPLink link" href="/linux/shadow.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux /etc/shadow 文件学习笔记</span><!--]--><!----></a><a class="VPLink link" href="/linux/multi-queue.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux 网卡多队列介绍</span><!--]--><!----></a><a class="VPLink link" href="/linux/ntp.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>理解NTP协议</span><!--]--><!----></a><a class="VPLink link" href="/linux/yum-update.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>使用Yum 升级OS</span><!--]--><!----></a><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-6b5fd0a9 data-v-a4c57a06><div class="VPDoc has-sidebar" data-v-a4c57a06 data-v-79ca2460><div class="container" data-v-79ca2460><div class="aside" data-v-79ca2460><div class="aside-curtain" data-v-79ca2460></div><div class="aside-container" data-v-79ca2460><div class="aside-content" data-v-79ca2460><div class="VPDocAside" data-v-79ca2460 data-v-779d834d><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-779d834d data-v-51e5a8ce><div class="content" data-v-51e5a8ce><div class="outline-marker" data-v-51e5a8ce></div><div class="outline-title" data-v-51e5a8ce>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-51e5a8ce><span class="visually-hidden" id="doc-outline-aria-label" data-v-51e5a8ce> Table of Contents for current page </span><ul class="root" data-v-51e5a8ce><!--[--><li style="" data-v-51e5a8ce><a class="outline-link" href="#bios启动" data-v-51e5a8ce>bios启动</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#grub启动" data-v-51e5a8ce>grub启动</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#initramfs启动" data-v-51e5a8ce>initramfs启动</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#切换到真实的根目录" data-v-51e5a8ce>切换到真实的根目录</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#与kdump相关的initramfs知识" data-v-51e5a8ce>与kdump相关的initramfs知识</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#参考" data-v-51e5a8ce>参考</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-779d834d></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-79ca2460><div class="content-container" data-v-79ca2460><!--[--><!--]--><main class="main" data-v-79ca2460><div style="position:relative;" class="vp-doc _linux_linux-boot" data-v-79ca2460><div><p>记录linux启动过程的总结</p><h2 id="bios启动" tabindex="-1">bios启动 <a class="header-anchor" href="#bios启动" aria-hidden="true">#</a></h2><p>磁盘的前512字节内容也叫也叫Master boot record, 简称MBR 主板里的bios会扫描设备/磁盘MBR的最后两个字节是不是<code>aa55</code>,如果是则认为是可启动设备. 会按照配置的启动顺序挨个尝试启动.</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># xxd -l 512 /dev/sda</span></span>
<span class="line"><span style="color:#A6ACCD;">0000000: eb63 9010 8ed0 bc00 b0b8 0000 8ed8 8ec0  .c..............</span></span>
<span class="line"><span style="color:#A6ACCD;">0000010: fbbe 007c bf00 06b9 0002 f3a4 ea21 0600  ...</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">.........</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">..</span></span>
<span class="line"><span style="color:#A6ACCD;">0000020: 00be be07 3804 750b 83c6 1081 fefe 0775  ....8.u........u</span></span>
<span class="line"><span style="color:#A6ACCD;">0000030: f3eb 16b4 02b0 01bb 007c b280 8a74 018b  .........</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">...t..</span></span>
<span class="line"><span style="color:#A6ACCD;">0000040: 4c02 cd13 ea00 7c00 00eb fe00 0000 0000  L.....</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">.........</span></span>
<span class="line"><span style="color:#A6ACCD;">0000050: 0000 0000 0000 0000 0000 0080 0100 0000  ................</span></span>
<span class="line"><span style="color:#A6ACCD;">0000060: 0000 0000 fffa 9090 f6c2 8074 05f6 c270  ...........t...p</span></span>
<span class="line"><span style="color:#A6ACCD;">0000070: 7402 b280 ea79 7c00 0031 c08e d88e d0bc  t....y</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">..1......</span></span>
<span class="line"><span style="color:#A6ACCD;">0000080: 0020 fba0 647c 3cff 7402 88c2 52be 057c  </span><span style="color:#82AAFF;">.</span><span style="color:#A6ACCD;"> ..d</span><span style="color:#89DDFF;">|&lt;</span><span style="color:#A6ACCD;">.t...R..</span><span style="color:#89DDFF;">|</span></span>
<span class="line"><span style="color:#A6ACCD;">0000090: b441 bbaa 55cd 135a 5272 3d81 fb55 aa75  .A..U..ZRr=..U.u</span></span>
<span class="line"><span style="color:#A6ACCD;">00000a0: 3783 e101 7432 31c0 8944 0440 8844 ff89  7...t21..D.@.D..</span></span>
<span class="line"><span style="color:#A6ACCD;">00000b0: 4402 c704 1000 668b 1e5c 7c66 895c 0866  D.....f..\|f.\.f</span></span>
<span class="line"><span style="color:#A6ACCD;">00000c0: 8b1e 607c 6689 5c0c c744 0600 70b4 42cd  ..</span><span style="color:#89DDFF;">`|</span><span style="color:#C3E88D;">f.</span><span style="color:#A6ACCD;">\.</span><span style="color:#C3E88D;">.D..p.B.</span></span>
<span class="line"><span style="color:#C3E88D;">00000d0: 1372 05bb 0070 eb76 b408 cd13 730d 5a84  .r...p.v....s.Z.</span></span>
<span class="line"><span style="color:#C3E88D;">00000e0: d20f 83de 00be 857d e982 0066 0fb6 c688  .......}...f....</span></span>
<span class="line"><span style="color:#C3E88D;">00000f0: 64ff 4066 8944 040f b6d1 c1e2 0288 e888  d.@f.D..........</span></span>
<span class="line"><span style="color:#C3E88D;">0000100: f440 8944 080f b6c2 c0e8 0266 8904 66a1  .@.D.......f..f.</span></span>
<span class="line"><span style="color:#C3E88D;">0000110: 607c 6609 c075 4e66 a15c 7c66 31d2 66f7  </span><span style="color:#89DDFF;">`</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">f..uNf.\|f1.f.</span></span>
<span class="line"><span style="color:#A6ACCD;">0000120: 3488 d131 d266 f774 043b 4408 7d37 fec1  4..1.f.t.</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">D.}7..</span></span>
<span class="line"><span style="color:#A6ACCD;">0000130: 88c5 30c0 c1e8 0208 c188 d05a 88c6 bb00  ..0........Z....</span></span>
<span class="line"><span style="color:#A6ACCD;">0000140: 708e c331 dbb8 0102 cd13 721e 8cc3 601e  p..1......r...</span><span style="color:#89DDFF;">`</span><span style="color:#C3E88D;">.</span></span>
<span class="line"><span style="color:#C3E88D;">0000150: b900 018e db31 f6bf 0080 8ec6 fcf3 a51f  .....1..........</span></span>
<span class="line"><span style="color:#C3E88D;">0000160: 61ff 265a 7cbe 807d eb03 be8f 7de8 3400  a.</span><span style="color:#89DDFF;">&amp;</span><span style="color:#C3E88D;">Z</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">..}....}.4.</span></span>
<span class="line"><span style="color:#C3E88D;">0000170: be94 7de8 2e00 cd18 ebfe 4752 5542 2000  ..}.......GRUB </span><span style="color:#82AAFF;">.</span></span>
<span class="line"><span style="color:#C3E88D;">0000180: 4765 6f6d 0048 6172 6420 4469 736b 0052  Geom.Hard Disk.R</span></span>
<span class="line"><span style="color:#C3E88D;">0000190: 6561 6400 2045 7272 6f72 0d0a 00bb 0100  ead. Error......</span></span>
<span class="line"><span style="color:#C3E88D;">00001a0: b40e cd10 ac3c 0075 f4c3 0000 0000 0000  .....</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">.u........</span></span>
<span class="line"><span style="color:#C3E88D;">00001b0: 0000 0000 0000 0000 ab83 0a00 0000 8020  ...............</span></span>
<span class="line"><span style="color:#C3E88D;">00001c0: 2100 83fe ffff 0008 0000 dfc7 8102 0000  </span><span style="color:#89DDFF;">!</span><span style="color:#C3E88D;">...............</span></span>
<span class="line"><span style="color:#C3E88D;">00001d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span>
<span class="line"><span style="color:#C3E88D;">00001e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span>
<span class="line"><span style="color:#C3E88D;">00001f0: 0000 0000 0000 0000 0000 0000 0000 55aa  ..............U.</span></span>
<span class="line"></span></code></pre></div><p>MBR里还有分区表信息, 从偏移量<code>446</code>开始, 最多放4个主分区, 下面显示只有一个主分区</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># xxd -s 446 -l 64 /dev/sda</span></span>
<span class="line"><span style="color:#A6ACCD;">00001be: 8020 2100 83fe ffff 0008 0000 dfc7 8102  </span><span style="color:#82AAFF;">.</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">.............</span></span>
<span class="line"><span style="color:#A6ACCD;">00001ce: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span>
<span class="line"><span style="color:#A6ACCD;">00001de: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span>
<span class="line"><span style="color:#A6ACCD;">00001ee: 0000 0000 0000 0000 0000 0000 0000 0000  ................</span></span>
<span class="line"></span></code></pre></div><p>如果分区损坏, 可使用testdisk尝试修复, 有linux和window两个版本. 主页: <a href="http://www.cgsecurity.org" target="_blank" rel="noopener noreferrer">www.cgsecurity.org</a></p><p>在qemu+libvirt下, bios启动会打印<code>Booting from Hard Disk...</code>信息.代码如下:</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">switch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ie</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">type</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> IPL_TYPE_FLOPPY</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Booting from Floppy...</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">boot_disk</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0x00</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> CheckFloppySig</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">case</span><span style="color:#F07178;"> IPL_TYPE_HARDDISK</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Booting from Hard Disk...</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">boot_disk</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0x80</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p>如果检查发现<code>mbr</code>的512字节处不是<code>55aa</code>, 则无法启动虚拟机, 界面显示<code>Boot failed: not a bootable disk</code>, 对应代码如下</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">GET_FARVAR</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">bootseg</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> mbr</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">signature</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> MBR_SIGNATURE</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Boot failed: not a bootable disk</span><span style="color:#A6ACCD;">\n\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">            </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>所以VNC遇到如上两个信息, 需要检查底层问题.</p><p>以上代码来自https://www.seabios.org/downloads/, 是qemu默认的bios启动程序</p><h2 id="grub启动" tabindex="-1">grub启动 <a class="header-anchor" href="#grub启动" aria-hidden="true">#</a></h2><p>bios读取MBR后,然后执行里面的代码, 这样将控制权交到grub2. 这块代码也叫<code>bootloader</code>.<br> 通常运行<code>grub2-install /dev/sda</code>将<code>bootloader</code>写入MBR. 当然还会在512字节后面继续写入一些文件 可以加参数<code>--debug</code>看到更详细的信息</p><p>如果发现grub损坏, 可以尝试挂盘并chroot到根目录, 执行<code>grub2-install /dev/xxxx</code>. /dev/xxx为具体的盘符名<br> 如果能看到grub的shell命令行, 说明可能grub.cfg配置有误, 导致无法选择具体的引导项. 可以手工指定具体的引导信息, 尝试启动<br> 以下是参考样例, 可以找一台完全一样的主机配置会修复故障机<br><code>ls</code>命令可以查看当前设备及里面的文件, 用于确定文件是否真的存在. 也能判断分区信息<br><code>tab</code>可用于命令联想</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> root=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">hd0,msdos1</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        linux16 /boot/vmlinuz-3.10.0-1062.el7.x86_64 root=UUID=5de1c8df-9b03-4830-9b56-b96a2290b78f ro vconsole.keymap=us crashkernel=auto</span></span>
<span class="line"><span style="color:#A6ACCD;">        initrd16 /boot/initramfs-3.10.0-1062.el7.x86_64.img</span></span>
<span class="line"></span></code></pre></div><p>有时挂盘修复时choot后好多特殊的文件系统找不到, 可以提前手工挂载下, 然后chroot<br> 如下命令仅供参考, 假设要修复的系统盘已经挂在<code>mnt</code></p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;"># mount --bind /dev /mnt/dev</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># mount -t proc proc /mnt/proc</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># mount -t sysfs none /mnt/sys</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># chroot /mnt /bin/bash</span></span>
<span class="line"></span></code></pre></div><p>有时我们需要检查磁盘或者分区当前的文件系统, 下面列出三种方法:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># lsblk -f</span></span>
<span class="line"><span style="color:#A6ACCD;">NAME   FSTYPE LABEL UUID                                 MOUNTPOINT</span></span>
<span class="line"><span style="color:#A6ACCD;">sda</span></span>
<span class="line"><span style="color:#A6ACCD;">└─sda1 ext4         5de1c8df-9b03-4830-9b56-b96a2290b78f /</span></span>
<span class="line"><span style="color:#A6ACCD;">sr0</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># blkid</span></span>
<span class="line"><span style="color:#A6ACCD;">/dev/sda1: UUID=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">5de1c8df-9b03-4830-9b56-b96a2290b78f</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> TYPE=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ext4</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># file -s /dev/sda1</span></span>
<span class="line"><span style="color:#A6ACCD;">/dev/sda1: Linux rev 1.0 ext4 filesystem data, UUID=5de1c8df-9b03-4830-9b56-b96a2290b78f </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">needs journal recovery</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">extents</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">64bit</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">large files</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">huge files</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>这几个命令都是通过直接读取该块设备的十六进制数据来判断的, 具体的规则可参考:<br><a href="https://github.com/file/file/blob/master/magic/Magdir/filesystems" target="_blank" rel="noopener noreferrer">https://github.com/file/file/blob/master/magic/Magdir/filesystems</a></p><h2 id="initramfs启动" tabindex="-1">initramfs启动 <a class="header-anchor" href="#initramfs启动" aria-hidden="true">#</a></h2><p>grub2找到kernel和initramfs后, 控制权交给kernel, 然后解压缩initramfs在内存中创建一个rootfs 在这个初始的小型文件系统里,加载一些基本的内核模块, 使OS能识别一些关键的外围设备. 比方说virtio块设备, virtio网络设备 这就是为什么在CentOS7下要将kvm驱动通过<code>dracut</code>打入initramfs的原理. 如果无法识别硬盘, 那么就无法真正的mount到磁盘的根目录.<br> 当initramfs文件系统挂在后, kernel将控制权交给pid为1的进程, centos7下是systemd.<br> VNC屏幕打印<code>Welcome to XXXX</code>意味着initramfs里的systemd已经开始运行. 之后出现的问题和内核就没多大关系了</p><p><a href="https://github.com/systemd/systemd/blob/4444e8533fea1640cc9d9b1d1a493ffcbee8a13d/src/core/main.c" target="_blank" rel="noopener noreferrer">https://github.com/systemd/systemd/blob/4444e8533fea1640cc9d9b1d1a493ffcbee8a13d/src/core/main.c</a></p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">log_get_show_color</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">status_printf</span><span style="color:#89DDFF;">(NULL,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                     </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">\n</span><span style="color:#C3E88D;">Welcome to </span><span style="color:#A6ACCD;">\x1B</span><span style="color:#C3E88D;">[%sm%s</span><span style="color:#A6ACCD;">\x1B</span><span style="color:#C3E88D;">[0m!</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                     </span><span style="color:#82AAFF;">isempty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ansi_color</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> ansi_color</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                                     </span><span style="color:#82AAFF;">isempty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pretty_name</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Linux</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> pretty_name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p>大致的顺序如下:</p><ol><li>dracut-cmdline解析<code>/proc/cmdline</code>, 找到真实root的信息</li><li>udev启动,识别所有的设备, 特别是硬盘,在/dev/下生成相应的信息, 这里当识别到新设备时会加载相应的驱动<br> bus驱动通过特殊的ID(设备厂商ID, 子系统ID等)识别新设备, 这个也叫MODALIAS<br> 然后modprobe MODALIAS, 会读取/lib/module/xxxx/modules.alias, 找到对应的驱动来加载驱动.<br> 对应的规则为<code>/lib/udev/rules.d/80-drivers.rules:ENV{MODALIAS}==&quot;?*&quot;, RUN{builtin}+=&quot;kmod load $env{MODALIAS}&quot;</code></li><li>initqueue阶段,有很多循环, 不停地检查一些关键任务是否完成, 比如root设备是否已识别并在<code>/dev/</code>下完成相关文件创建</li><li>mount和fsck root设备</li><li>清理就切换到真实的root设备</li></ol><p>可以在Grub菜单里给内核加参数<code>rd.break</code>使系统停留在initramfs创建后, 切换到真正的root文件系统前. 用于学习和排障<br><code>rd</code>就是<code>ramdisk</code>的缩写, 即<code>the initial ramdisk (initrd) environment</code><br><code>rd.debug</code> 可以输出详细的日志. dracut许多命令都是shell脚本. 打印详细日志的大致两种:<br> 脚本里加<code>set -x</code></p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">$ cat sleep.sh</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#!/usr/bin/bash</span></span>
<span class="line"><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> -x</span></span>
<span class="line"><span style="color:#A6ACCD;">sleep 3</span></span>
<span class="line"><span style="color:#A6ACCD;">$ ./sleep.sh</span></span>
<span class="line"><span style="color:#A6ACCD;">+ sleep 3</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"></span></code></pre></div><p>再<code>set -x</code>的基础上,继续增加<code>export &#39;PS4=${BASH_SOURCE}@${LINENO}(${FUNCNAME[0]}): &#39;</code> 可打印具体的行数和函数名</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">$ cat sleep.sh</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#!/usr/bin/bash</span></span>
<span class="line"><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> -x</span></span>
<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">PS4=${BASH_SOURCE}@${LINENO}(${FUNCNAME[0]}): </span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">sleep 3</span></span>
<span class="line"><span style="color:#A6ACCD;">$ ./sleep.sh</span></span>
<span class="line"><span style="color:#A6ACCD;">+ </span><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">PS4=${BASH_SOURCE}@${LINENO}(${FUNCNAME[0]}): </span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">+ PS4=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">${BASH_SOURCE}@${LINENO}(${FUNCNAME[0]}): </span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#82AAFF;">./sleep.sh@4</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">: sleep 3</span></span>
<span class="line"></span></code></pre></div><p>如下文档介绍了bash下面PS相关变量可以实现的一些特殊功能<br><a href="https://www.thegeekstuff.com/2008/09/bash-shell-take-control-of-ps1-ps2-ps3-ps4-and-prompt_command/" target="_blank" rel="noopener noreferrer">https://www.thegeekstuff.com/2008/09/bash-shell-take-control-of-ps1-ps2-ps3-ps4-and-prompt_command/</a></p><p><code>rd.udev.debug </code> 可以输入udev的详细日志</p><p>centos7还支持如下参数, 可以在特定的阶段打断OS的正常运行.</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># grep -r &quot;rd.break=&quot; /lib/dracut/modules.d/*systemd/*service</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/dracut/modules.d/98systemd/dracut-cmdline.service:ConditionKernelCommandLine=</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">rd.break=cmdline</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/dracut/modules.d/98systemd/dracut-initqueue.service:ConditionKernelCommandLine=</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">rd.break=initqueue</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/dracut/modules.d/98systemd/dracut-mount.service:ConditionKernelCommandLine=</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">rd.break=mount</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/dracut/modules.d/98systemd/dracut-pre-mount.service:ConditionKernelCommandLine=</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">rd.break=pre-mount</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/dracut/modules.d/98systemd/dracut-pre-trigger.service:ConditionKernelCommandLine=</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">rd.break=pre-trigger</span></span>
<span class="line"><span style="color:#A6ACCD;">/lib/dracut/modules.d/98systemd/dracut-pre-udev.service:ConditionKernelCommandLine=</span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">rd.break=pre-udev</span></span>
<span class="line"></span></code></pre></div><p>initramfs大部分问题都可以通过重建initramfs解决</p><p>提取initramfs文件的命令:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">mkdir /tmp/initrd</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> /tmp/initrd</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/lib/dracut/skipcpio /boot/initramfs-</span><span style="color:#89DDFF;">$(</span><span style="color:#C3E88D;">uname -r</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">.img </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> gunzip -c </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> cpio -idmv</span></span>
<span class="line"></span></code></pre></div><p><a href="https://access.redhat.com/solutions/2037313" target="_blank" rel="noopener noreferrer">https://access.redhat.com/solutions/2037313</a></p><p>查看initramfs文件里包含的文件列表, 使用<code>lsinitrd xxx</code>, 如果要查看具体文件的内容,用如下命令:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">$ lsinitrd /boot/initramfs-3.10.0-1062.el7.x86_64.img -f /etc/machine-id</span></span>
<span class="line"><span style="color:#A6ACCD;">ab80e79ed1cf4e9aa1108082dd40f5bc</span></span>
<span class="line"></span></code></pre></div><p>挂盘到一个虚拟机里, chroot到对应的root目录, 已3.10.0-1062.el7.x86_64为例,命令为:<br><code>dracut initramfs-3.10.0-1062.el7.x86_64.img 3.10.0-1062.el7.x86_64</code><br> 不要不加参数执行<code>dracut</code>, 因为它默认会使用当前的内核生成文件. 当前内核可能不是故障虚拟机里的内核版本</p><p>单用户 reboot, 可以使用reboot -f</p><p>运行initrd-switch-root.service完成其他工作并改变根目录为/sysroot, 系统打印如下:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">Apr 20 21:33:52 localhost.localdomain systemd</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: Starting Switch Root...</span></span>
<span class="line"><span style="color:#A6ACCD;">Apr 20 21:33:52 localhost.localdomain systemd</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: Switching root.</span></span>
<span class="line"></span></code></pre></div><h2 id="切换到真实的根目录" tabindex="-1">切换到真实的根目录 <a class="header-anchor" href="#切换到真实的根目录" aria-hidden="true">#</a></h2><p>此时会remount根目录, 然后依照依赖关系并发的启动各种功能服务<br> systemd与传统sysint不同, 随OS启动的服务如果之前没有依赖关系, 是可以同时启动的. 这有别于sysinit的串行一个一个执行, 但对于定位启动类卡住问题却带来的难度. 不能简单的通过控制台显示的最后一行信息来判断是否该服务出问题</p><p>正常启动的情况下, 我们看到一个登陆界面, 让输入用户名和密码, 这个是因为getty服务正常运行了</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># systemctl status getty@tty1.service</span></span>
<span class="line"><span style="color:#A6ACCD;">● getty@tty1.service - Getty on tty1</span></span>
<span class="line"><span style="color:#A6ACCD;">   Loaded: loaded </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">/usr/lib/systemd/system/getty@.service</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> enabled</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> vendor preset: enabled</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   Active: active </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">running</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> since Mon 2020-04-20 22:01:32 HKT</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> 24s ago</span></span>
<span class="line"><span style="color:#A6ACCD;">     Docs: man:agetty</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">8</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">           man:systemd-getty-generator</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">8</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">           http://0pointer.de/blog/projects/serial-console.html</span></span>
<span class="line"><span style="color:#A6ACCD;"> Main PID: 5474 </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">agetty</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   CGroup: /system.slice/system-getty.slice/getty@tty1.service</span></span>
<span class="line"><span style="color:#A6ACCD;">           └─5474 /sbin/agetty --noclear tty1 linux</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">Apr 20 22:01:32 localhost.localdomain systemd</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: Stopped Getty on tty1.</span></span>
<span class="line"><span style="color:#A6ACCD;">Apr 20 22:01:32 localhost.localdomain systemd</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;">: Started Getty on tty1.</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># lsof -p 5474 | grep tty1</span></span>
<span class="line"><span style="color:#A6ACCD;">agetty  5474 root    0u   CHR    4,1       0t0  5636 /dev/tty1</span></span>
<span class="line"><span style="color:#A6ACCD;">agetty  5474 root    1u   CHR    4,1       0t0  5636 /dev/tty1</span></span>
<span class="line"><span style="color:#A6ACCD;">agetty  5474 root    2u   CHR    4,1       0t0  5636 /dev/tty1</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"></span></code></pre></div><p>如果系统卡住没有看到这个界面, 则继续等待几分钟, 观察是否自动进入应急模式:<br> 如果进入, 则输入root后, 运行<code>journalctl</code>查看具体的问题<br> 如果无法进入, 重新启动, 输入内核参数<code>systemd.debug-shell=1</code>, 它会在systemd启动的早期在tty9运行一个shell, 用户在vnc上运行<code>CTRL+ALT+F9</code>可登陆, 运行<code>systemctl list-jobs</code>查看具体哪个服务卡住</p><p><code>systemctl list-jobs</code> 打印状态可以是&quot;starting&quot;或者&quot;waiting&quot;<br> &quot;starting&quot;的服务是可能引发问题的服务, 正式因为它一直运行, 所有其他相关服务处于&quot;waiting&quot;状态</p><p>当并未切换到真实目录时,即界面卡在&quot;Switch root&quot;, 此时是无法启动上面的debug-shell, 需要开启systemd自身的debug日志级别<br> 同时这也说明initramfs里面的systemd是OK的, 只是启动真实跟盘上的systemd出现异常了, 可以在initramfs阶段 手工chroot到/sysroot里执行 <code>rpm -V systemd</code>, <code>rpm -V glibc</code>, <code>rpm -V bash</code> 等命令查询下基础组件是否有损坏</p><h2 id="与kdump相关的initramfs知识" tabindex="-1">与kdump相关的initramfs知识 <a class="header-anchor" href="#与kdump相关的initramfs知识" aria-hidden="true">#</a></h2><p>有两个方法判断是否crashkernel生效</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">$ dmesg -T </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> grep </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">for crashkernel</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">Wed Sep  9 22:24:54 2020</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> Reserving 128MB of memory at 720MB </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> crashkernel </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">System RAM: 1535MB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">$ cat /sys/kernel/kexec_crash_size</span></span>
<span class="line"><span style="color:#A6ACCD;">134217728</span></span>
<span class="line"></span></code></pre></div><p><code>systemctl start kdump</code>的作用是检查内核参数, 生成含kdump相关功能的initramfs.<br> 通过IN_KDUMP这个环境变量,使重建的initramfs里含有kdump所有的脚本和命令. 这样一旦转储,新的initramfs里就可以sava vmcore了</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">]</span><span style="color:#676E95;font-style:italic;"># head /sbin/mkdumprd</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#!/bin/bash --norc</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># New mkdumprd</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Copyright 2011 Red Hat, Inc.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Written by Cong Wang &lt;amwang@redhat.com&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">.</span><span style="color:#A6ACCD;"> /lib/kdump/kdump-lib.sh</span></span>
<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> IN_KDUMP=1</span></span>
<span class="line"></span></code></pre></div><p><code>/etc/kdump.conf</code>是关于kdump的配置项, 可给initramfs添加文件或者内核参数,调整转储失败时的动作等.</p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h2><ul><li><a href="https://freedesktop.org/wiki/Software/systemd/Debugging/" target="_blank" rel="noopener noreferrer">https://freedesktop.org/wiki/Software/systemd/Debugging/</a></li><li><a href="https://www.freedesktop.org/software/systemd/man/bootup.html" target="_blank" rel="noopener noreferrer">https://www.freedesktop.org/software/systemd/man/bootup.html</a></li><li><a href="https://www.freedesktop.org/software/systemd/man/systemctl.html" target="_blank" rel="noopener noreferrer">https://www.freedesktop.org/software/systemd/man/systemctl.html</a></li><li><a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html" target="_blank" rel="noopener noreferrer">https://www.freedesktop.org/software/systemd/man/systemd.service.html</a></li><li><a href="https://www.linux.com/training-tutorials/understanding-and-using-systemd/" target="_blank" rel="noopener noreferrer">https://www.linux.com/training-tutorials/understanding-and-using-systemd/</a></li><li><a href="https://people.redhat.com/harald/dracut.html" target="_blank" rel="noopener noreferrer">https://people.redhat.com/harald/dracut.html</a></li><li><a href="https://man7.org/linux/man-pages/man8/dracut.8.html" target="_blank" rel="noopener noreferrer">https://man7.org/linux/man-pages/man8/dracut.8.html</a></li><li><a href="https://fedoraproject.org/wiki/How_to_debug_Dracut_problems" target="_blank" rel="noopener noreferrer">https://fedoraproject.org/wiki/How_to_debug_Dracut_problems</a></li><li><a href="https://documentation.suse.com/sles/12-SP4/html/SLES-all/cha-udev.html" target="_blank" rel="noopener noreferrer">https://documentation.suse.com/sles/12-SP4/html/SLES-all/cha-udev.html</a></li><li><a href="https://wiki.archlinux.org/index.php/udev" target="_blank" rel="noopener noreferrer">https://wiki.archlinux.org/index.php/udev</a></li></ul></div></div></main><footer class="VPDocFooter" data-v-79ca2460 data-v-04568844><div class="edit-info" data-v-04568844><!----><div class="last-updated" data-v-04568844><p class="VPLastUpdated" data-v-04568844 data-v-0ce8c960>Last updated: <time datatime="2022-07-14T14:54:09.000Z" data-v-0ce8c960></time></p></div></div><div class="prev-next" data-v-04568844><div class="pager" data-v-04568844><a class="pager-link prev" href="/linux/dns.html" data-v-04568844><span class="desc" data-v-04568844>Previous page</span><span class="title" data-v-04568844>DNS学习总结</span></a></div><div class="has-prev pager" data-v-04568844><a class="pager-link next" href="/linux/linux-common-commands.html" data-v-04568844><span class="desc" data-v-04568844>Next page</span><span class="title" data-v-04568844>Linux 下常用命令与技巧汇总</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-6b5fd0a9 data-v-5b331722><div class="container" data-v-5b331722><p class="message" data-v-5b331722>Released under the MIT License.</p><p class="copyright" data-v-5b331722>Copyright © 2022-present xixiliguo</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_algorithm-dfs.md\":\"a73dea67\",\"algorithm_binary-index-tree.md\":\"8bc3e51f\",\"algorithm_radix-tree.md\":\"6b75afb6\",\"algorithm_segment-tree.md\":\"c689b78e\",\"algorithm_unionfind.md\":\"a646711f\",\"golang_golang-exec.md\":\"357621ac\",\"golang_strings-algorithm-golang.md\":\"57a20191\",\"index.md\":\"27757f36\",\"k8s_runc.md\":\"09e5ae92\",\"kernel_kernel-cgroup-namespace.md\":\"4a81fd3c\",\"kernel_kernel-crash.md\":\"27a485e9\",\"kernel_kernel-irq.md\":\"0bfc9b45\",\"kernel_kernel-memory.md\":\"1c2cf851\",\"kernel_kernel-syscall-sched.md\":\"29c8373b\",\"kernel_linux-trap.md\":\"ae6473f3\",\"linux_atop.md\":\"6cfa95b0\",\"linux_bandersnatch-pypi.md\":\"dee4724b\",\"linux_cloud-init.md\":\"e0bc6141\",\"linux_dns.md\":\"ccf3bd81\",\"linux_linux-boot.md\":\"459acaa4\",\"linux_linux-common-commands.md\":\"c3e4942a\",\"linux_linux-shadow.md\":\"4d01a795\",\"linux_multi-queue.md\":\"9db1b9ad\",\"linux_ntp.md\":\"0f26af7e\",\"linux_yum-update.md\":\"67a0bf95\",\"network_libvirt-network.md\":\"90682305\",\"network_tcp.md\":\"2211909d\",\"network_tcpdump-wireshark.md\":\"a2fe5423\",\"others_code_segment.md\":\"f0f03c59\",\"others_lua-implemention-gc.md\":\"80382876\",\"others_lua-implemention-type-value.md\":\"e4816df1\"}")</script>
    <script type="module" async src="/assets/app.526dca4e.js"></script>
    
  </body>
</html>
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <link rel="icon" type="image/jpg" href="/img/coast.jpg"><title>Tcpdump与Wireshark点滴记录 | xixiliguo</title><meta name="description" content="stay hungry stay foolish"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.443127ae.js" as="script"><link rel="preload" href="/assets/css/styles.d5a7f181.css" as="style"><link rel="preload" href="/assets/js/838.91c535db.js" as="script"><link rel="preload" href="/assets/js/app.1ace75fc.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.d5a7f181.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/" class=""><!----><span class="site-name">xixiliguo</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/linux/atop.md" class="nav-link" aria-label="Linux运维"><!--[--><!--]--> Linux运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/network/tcpdump-wireshark.md" class="nav-link" aria-label="网络协议"><!--[--><!--]--> 网络协议 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/golang/golang-exec.md" class="nav-link" aria-label="Golang笔记"><!--[--><!--]--> Golang笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/k8s/runc.md" class="nav-link" aria-label="容器与k8s"><!--[--><!--]--> 容器与k8s <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/algorithm/radix-tree.md" class="nav-link" aria-label="算法笔记"><!--[--><!--]--> 算法笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/kernel/linux-trap.md" class="nav-link" aria-label="内核分析"><!--[--><!--]--> 内核分析 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/others/lua-implemention-gc.md" class="nav-link" aria-label="杂项"><!--[--><!--]--> 杂项 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/linux/atop.md" class="nav-link" aria-label="Linux运维"><!--[--><!--]--> Linux运维 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/network/tcpdump-wireshark.md" class="nav-link" aria-label="网络协议"><!--[--><!--]--> 网络协议 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/golang/golang-exec.md" class="nav-link" aria-label="Golang笔记"><!--[--><!--]--> Golang笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/k8s/runc.md" class="nav-link" aria-label="容器与k8s"><!--[--><!--]--> 容器与k8s <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/algorithm/radix-tree.md" class="nav-link" aria-label="算法笔记"><!--[--><!--]--> 算法笔记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/kernel/linux-trap.md" class="nav-link" aria-label="内核分析"><!--[--><!--]--> 内核分析 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/others/lua-implemention-gc.md" class="nav-link" aria-label="杂项"><!--[--><!--]--> 杂项 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">网络协议</p><ul class=""><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="Tcpdump与Wireshark点滴记录"><!--[--><!--]--> Tcpdump与Wireshark点滴记录 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#tcpdump-基本介绍" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="tcpdump 基本介绍"><!--[--><!--]--> tcpdump 基本介绍 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#常用语法" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="常用语法"><!--[--><!--]--> 常用语法 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#常用过滤语法" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="常用过滤语法"><!--[--><!--]--> 常用过滤语法 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#wireshark-介绍" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="wireshark 介绍"><!--[--><!--]--> wireshark 介绍 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#显示过滤器" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="显示过滤器"><!--[--><!--]--> 显示过滤器 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#三板斧" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="三板斧"><!--[--><!--]--> 三板斧 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#wireshark提示消息解释" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Wireshark提示消息解释"><!--[--><!--]--> Wireshark提示消息解释 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#其他技巧" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="其他技巧"><!--[--><!--]--> 其他技巧 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#tcp协议" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="TCP协议"><!--[--><!--]--> TCP协议 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#知识学习" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="知识学习"><!--[--><!--]--> 知识学习 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/network/tcpdump-wireshark.html#问题记录" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="问题记录"><!--[--><!--]--> 问题记录 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a href="/network/tcp.html" class="nav-link sidebar-item" aria-label="TCP协议栈笔记"><!--[--><!--]--> TCP协议栈笔记 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/network/libvirt-network.html" class="nav-link sidebar-item" aria-label="Libvirt Network 笔记"><!--[--><!--]--> Libvirt Network 笔记 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p>记录Tcpdump相关知识和Wireshark技巧</p><h2 id="tcpdump-基本介绍" tabindex="-1"><a class="header-anchor" href="#tcpdump-基本介绍" aria-hidden="true">#</a> tcpdump 基本介绍</h2><h3 id="常用语法" tabindex="-1"><a class="header-anchor" href="#常用语法" aria-hidden="true">#</a> 常用语法</h3><ul><li>指定网卡(eth0), 如果要抓取所有网卡的包, 使用<code>any</code></li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0
tcpdump -i any
</code></pre></div><ul><li>使用<code>-nnv</code>, 不解析协议和端口,同时多打印写详细信息(IP头)</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -nnv
    <span class="token number">10.211</span>.55.9.22 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.2.63376: Flags <span class="token punctuation">[</span>P.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x84ff <span class="token punctuation">(</span>incorrect -<span class="token operator">&gt;</span> 0x0ec3<span class="token punctuation">)</span>, <span class="token function">seq</span> <span class="token number">935672</span>:935968, ack <span class="token number">761</span>, win <span class="token number">385</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">102595534</span> ecr <span class="token number">1564236582</span><span class="token punctuation">]</span>, length <span class="token number">296</span>
<span class="token number">22</span>:53:54.006694 IP <span class="token punctuation">(</span>tos 0x10, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">59224</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto TCP <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, length <span class="token number">52</span><span class="token punctuation">)</span>
    <span class="token number">10.211</span>.55.2.63376 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.9.22: Flags <span class="token punctuation">[</span>.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x8bf2 <span class="token punctuation">(</span>correct<span class="token punctuation">)</span>, ack <span class="token number">935672</span>, win <span class="token number">8139</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">1564236582</span> ecr <span class="token number">102595534</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">22</span>:53:54.006746 IP <span class="token punctuation">(</span>tos 0x10, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">25202</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto TCP <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, length <span class="token number">52</span><span class="token punctuation">)</span>
    <span class="token number">10.211</span>.55.2.63376 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.9.22: Flags <span class="token punctuation">[</span>.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x8adc <span class="token punctuation">(</span>correct<span class="token punctuation">)</span>, ack <span class="token number">935968</span>, win <span class="token number">8121</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">1564236582</span> ecr <span class="token number">102595534</span><span class="token punctuation">]</span>, length <span class="token number">0</span>
<span class="token number">22</span>:53:54.006895 IP <span class="token punctuation">(</span>tos 0x10, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">57471</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto TCP <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, length <span class="token number">924</span><span class="token punctuation">)</span>
    <span class="token number">10.211</span>.55.9.22 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.2.63376: Flags <span class="token punctuation">[</span>P.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x873f <span class="token punctuation">(</span>incorrect -<span class="token operator">&gt;</span> 0x2d02<span class="token punctuation">)</span>, <span class="token function">seq</span> <span class="token number">935968</span>:936840, ack <span class="token number">761</span>, win <span class="token number">385</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">102595534</span> ecr <span class="token number">1564236582</span><span class="token punctuation">]</span>, length <span class="token number">872</span>
</code></pre></div><ul><li>使用<code>-e</code>可以打印MAC地址</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -e
tcpdump: verbose output suppressed, use -v or -vv <span class="token keyword">for</span> full protocol decode
listening on eth0, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes
<span class="token number">22</span>:56:22.708510 00:1c:42:13:d0:f5 <span class="token punctuation">(</span>oui Unknown<span class="token punctuation">)</span> <span class="token operator">&gt;</span> 00:1c:42:00:00:08 <span class="token punctuation">(</span>oui Unknown<span class="token punctuation">)</span>, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">266</span>: linux.ssh <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.2.63376: Flags <span class="token punctuation">[</span>P.<span class="token punctuation">]</span>, <span class="token function">seq</span> <span class="token number">3187876880</span>:3187877080, ack <span class="token number">2645742059</span>, win <span class="token number">385</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">102744236</span> ecr <span class="token number">1564384779</span><span class="token punctuation">]</span>, length <span class="token number">200</span>
</code></pre></div><ul><li>使用<code>-w</code>将信息保存到文件, 下列命令将包信息保存到<code>abc.cap</code>. <code>-C</code> 配合<code>-w</code>使用, 进一步指定文件的最大size, 一旦超过, 会新建文件继续写入</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -w abc.cap
</code></pre></div><h3 id="常用过滤语法" tabindex="-1"><a class="header-anchor" href="#常用过滤语法" aria-hidden="true">#</a> 常用过滤语法</h3><p>不带过滤器, 则默认抓取指定网卡所有的包(接受和发送)</p><ul><li>抓取所有经过eth1，目的或源地址是192.168.1.1的网络数据</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 <span class="token function">host</span> <span class="token number">192.168</span>.1.1
</code></pre></div><ul><li>抓取所有经过eth1，目的或源网络为192.168.XXX.XXX的网络数据</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 net <span class="token number">192.168</span>
</code></pre></div><ul><li>指定源地址或者目的地址</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 src <span class="token function">host</span> <span class="token number">192.168</span>.1.1
tcpdump -i eth1 dst <span class="token function">host</span> <span class="token number">192.168</span>.1.1
</code></pre></div><ul><li>抓取所有经过eth1，目的或源端口是25的网络数据, 如果要指定过滤源端口, 可使用 <code>src port 25</code>. 目的端口类似</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 port <span class="token number">25</span>
</code></pre></div><ul><li>抓取所有经过eth1的所有icmp包, tcp, arp包语法类似</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 arp
tcpdump -i eth1 <span class="token function">ip</span>
tcpdump -i eth1 tcp
tcpdump -i eth1 udp
tcpdump -i eth1 icmp
</code></pre></div><ul><li>逻辑表达式</li></ul><div class="language-text ext-text"><pre class="language-text"><code>非 : ! or &quot;not&quot; (去掉双引号)  
且 : &amp;&amp; or &quot;and&quot;  
或 : || or &quot;or&quot;

多个表达式整体用单引号或者双引号引用起来, 单个最好用括号这样更清晰 
</code></pre></div><ul><li>抓取所有经过eth1，目的网络是192.168，但目的主机不是192.168.1.200的TCP数据</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 <span class="token string">&#39;((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))&#39;</span>
</code></pre></div><blockquote><p>详细的过滤指导请参考: https://wiki.wireshark.org/CaptureFilters</p></blockquote><h2 id="wireshark-介绍" tabindex="-1"><a class="header-anchor" href="#wireshark-介绍" aria-hidden="true">#</a> wireshark 介绍</h2><h3 id="显示过滤器" tabindex="-1"><a class="header-anchor" href="#显示过滤器" aria-hidden="true">#</a> 显示过滤器</h3><p>默认wireshark打开文件后,显示所有的包. 可以指定相应的显示过滤器, 显示特定部分</p><ul><li><p>比如想显示所有经过端口80的数据包, 使用 <code>tcp.port == 80</code></p></li><li><p>显示所有经过 192.168这个网段的包,使用 <code>ip.addr == 192.168.0.0/16</code></p></li><li><p>仍然可以组合多个过滤条件</p></li></ul><blockquote><p>and, &amp;&amp; 逻辑与<br> or, || 逻辑或<br> not, ! 逻辑否</p></blockquote><p>下面是具体的例子:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcp.port <span class="token operator">==</span> <span class="token number">80</span> and ip.src <span class="token operator">==</span> <span class="token number">192.168</span>.2.1
not llc
http and frame<span class="token punctuation">[</span><span class="token number">100</span>-199<span class="token punctuation">]</span> contains <span class="token string">&quot;wireshark&quot;</span>
<span class="token punctuation">(</span>ipx.src.net <span class="token operator">==</span> 0xbad <span class="token operator">&amp;&amp;</span> ipx.src.node <span class="token operator">==</span> <span class="token number">0.0</span>.0.0.0.1<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">ip</span>

</code></pre></div><ul><li>两个特殊的过滤操作<code>contains</code> 和 <code>match</code></li></ul><p><code>ip.addr contains &quot;192.168&quot;</code>是指过滤所有ip地址里包含&quot;192.168&quot;这几个字符的数据包<br><code>http contains &quot;www.163.com&quot;</code> 过滤所有http消息里包含&quot;www.163.com&quot;字符串的数据包<br><code>match</code> 用法类似, 不过它支持perl的正则表达式, 而且是大小写不敏感</p><p><code>contains</code> 后面可以是带双引号的字符串, 字节数组, 单字节(类c语言风格). 其他的如&quot;tcp.port&quot; 也可以跟这些 下面的表达式都是正确的:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token string">&quot;www.163.com&quot;</span>
<span class="token number">56</span>:98:47    <span class="token punctuation">(</span>十六进制<span class="token punctuation">)</span>
<span class="token number">68</span>
</code></pre></div><p>如下的过滤都是等价的:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>http.request.method <span class="token operator">==</span> <span class="token string">&quot;<span class="token entity" title="\x47">\x47</span>ET&quot;</span>
http.request.method <span class="token operator">==</span> <span class="token string">&quot;GET&quot;</span>
http.request.method <span class="token operator">==</span> <span class="token number">47.45</span>.54
http.request.method <span class="token operator">==</span> <span class="token number">47</span>:45:54
http.request.method <span class="token operator">==</span> <span class="token number">47</span>-45-54
</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code>frame.pkt_len <span class="token operator">&gt;</span> <span class="token number">10</span>
frame.pkt_len <span class="token operator">&gt;</span> 012
frame.pkt_len <span class="token operator">&gt;</span> 0xa
frame.pkt_len <span class="token operator">&gt;</span> <span class="token string">&#39;\n&#39;</span>
frame.pkt_len <span class="token operator">&gt;</span> <span class="token string">&#39;\xa&#39;</span>
frame.pkt_len <span class="token operator">&gt;</span> <span class="token string">&#39;\012&#39;</span>
</code></pre></div><ul><li>还有很多切片,字节操作等高级操作, 可以进一步查看如下两个文档</li></ul><blockquote><p>https://wiki.wireshark.org/DisplayFilters<br> https://www.wireshark.org/docs/man-pages/wireshark-filter.html</p></blockquote><h3 id="三板斧" tabindex="-1"><a class="header-anchor" href="#三板斧" aria-hidden="true">#</a> 三板斧</h3><p>处理linux主机性能问题, 我们通常有三个方面是必查的. CPU, 内存 和 IO 使用率<br> 通过wireshark分析网络问题, 也有类似的3个必查项</p><ul><li>统计 --&gt; 对话</li></ul><p>已<code>TCP</code>为例, 每一行代表一个TCP连接.他统计了流量和速率(每个方向和两个方向交互的总和) <code>rel start</code> 是该连接上第一条TCP包与该cap文件的第一条数据的时间相对值, 勾选绝对开始时间, 可显示包发送的绝对时间. 例如<code>23:17:95</code></p><p><img src="/img/wireshark_info.png" alt="统计--&gt;对话框"></p><ul><li>分析 --&gt; 专家信息</li></ul><p>Wireshark会自动分析整个文件, 然后分严重等级罗列出每一项分析结果和对应出现的次数<br> 一定要多关注错误和警告级别的, 根据出现的次数和文件总的<code>packet</code>数计算其出现的比例. 比如重传大于10%对性能影响就非常严重了</p><p><img src="/img/wireshark_expertinfo.png" alt="分析 --&gt; 专家信息"></p><ul><li>统计 --&gt; TCP流图形 --&gt; 时间序列(Steven)</li></ul><p>该图可以显示一个TCP连接上某个方向序列号的变化, 以此查看发送性能</p><p><img src="/img/wireshark_tcpseq.png" alt="统计 --&gt; TCP流图形 --&gt; 时间序列"></p><h3 id="wireshark提示消息解释" tabindex="-1"><a class="header-anchor" href="#wireshark提示消息解释" aria-hidden="true">#</a> Wireshark提示消息解释</h3><ul><li>[Packet size limited during capture]<br> 表示该包没有抓全, 比如包是大小是1024, 结果tcpdump抓时只了1000. 通常这是抓包是<code>-s</code>值太小造成的</li><li>[TCP Previous segment not captured]<br> TCP连接上后一包的seq大于前一个包的seq+eln, 说明中间缺失数据. 给出这个提示</li><li>[TCP ACKed unseen segment]<br> 该报文里的ACK确认的seq在整个抓包里没有找到</li><li>[TCP Out-of-Order]<br> 后一个包的seq小于前一个包的seq+len, 认为乱序</li><li>[TCP Dup ACK]<br> 后一个包的ack和前一个包里的ack指一样.</li><li>[TCP Fast Retransmission]<br> 当Dup ACK发生3次, 发送端启动快速重传</li><li>[TCP Retransmission]<br> 包丢且也没有触发Dup ACK, 则RTO超时过后启动重传</li><li>[TCP zerowindow]<br> win为0, 表示接受方暂时无法接受新包</li><li>[TCP window Full]<br> 表示发送方已经将接受串口占满, 可对比接受方发的窗口和发送方的<code>byte in flight</code></li></ul><blockquote><p>可进一步查看官方文档: https://www.wireshark.org/docs/wsug_html_chunked/ChAdvTCPAnalysis.html<br> 有兴趣的话, 可以进一步查看源码: https://github.com/boundary/wireshark/blob/master/epan/dissectors/packet-tcp.c</p></blockquote><h3 id="其他技巧" tabindex="-1"><a class="header-anchor" href="#其他技巧" aria-hidden="true">#</a> 其他技巧</h3><ul><li><p>如果包在英国的某台服务器上生成, 在中国打开时, 会发现并不是英国当地的发生时间. 需要做timeshift<br> 在<code>编辑 --&gt; 时间平移</code> 将时间通过<code>08:00:00</code>或者<code>-08:00:00</code>这样的格式进行调整</p></li><li><p>推荐两个讲解Wireshark的书:<br> &lt;&lt; Wireshark网络分析就这么简单&gt;&gt; 和 &lt;&lt; Wireshark网络分析的艺术 &gt;&gt;</p></li><li><p>iRTT 与 RTT<br> https://osqa-ask.wireshark.org/questions/21813/how-is-rtt-calculated</p></li></ul><h2 id="tcp协议" tabindex="-1"><a class="header-anchor" href="#tcp协议" aria-hidden="true">#</a> TCP协议</h2><h3 id="知识学习" tabindex="-1"><a class="header-anchor" href="#知识学习" aria-hidden="true">#</a> 知识学习</h3><p>这块非常复杂, 推荐如下书籍或文章: TCP/IP详解卷1<br> TCP 的那些事儿:<br> https://coolshell.cn/articles/11564.html<br> https://coolshell.cn/articles/11609.html<br> TCP/IP Guide:<br> http://www.tcpipguide.com/free/index.htm 免费电子书</p><h3 id="问题记录" tabindex="-1"><a class="header-anchor" href="#问题记录" aria-hidden="true">#</a> 问题记录</h3><ul><li><p>网卡eth1收到包, 根据路由要从网卡eth0发出去, 但从抓包上却没有看到回包<br> 通过设置参数<code>net.ipv4.conf.all.rp_filter</code>为0 可解决 默认为1, 是严格模式, 不允许回程路由和先前的不一样, 同时<code>nstat | grep IPReversePathFilter</code>可观察到包被丢弃后,计数器增加 具体解释看:<br> https://access.redhat.com/solutions/53031<br> https://www.slashroot.in/linux-kernel-rpfilter-settings-reverse-path-filtering<br> https://access.redhat.com/solutions/53031<br> 同时可以打开内核参数<code>net.ipv4.conf.all.log_martians</code>,将OS认为的martians报文打印到系统日志里<br> 具体解释:<br> https://serverfault.com/questions/570980/what-is-the-usefulness-of-logging-of-martians-packet-e-g-net-ipv4-conf-all-lo</p></li><li><p>NAT场景下内网机器配置所有消息转发到一台nat服务器上, 但有时通过<code>ip route get xxx</code> 会显示路由指向默认网关. 并且有<code>cache redirect</code>字样<br> 路由分为静态路由和动态的. 动态是通过智能学的, 例如<code>icmp</code>的重定向会影响的动态路由. NAT场景下要关闭ICMP的重定向功能</p></li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>net.ipv4.conf.all.accept_redirects<span class="token operator">=</span><span class="token number">0</span>
net.ipv4.conf.all.secure_redirects<span class="token operator">=</span><span class="token number">0</span>
net.ipv4.conf.all.send_redirects<span class="token operator">=</span><span class="token number">0</span>
</code></pre></div><ul><li>多网卡一般配置不同的网段, 但有时会将同一网段的IP配置在两个网卡上, 这样回复消息只会从一个网卡出去. 需要通过策略路由解决:<br> 为每一个网卡配置单独的路由表<br> 默认任意一个网卡会对自己所有的 ip 地址在 ARP 请求上作出响应, 所有对端学到的这两个IP的mac地址可能是一样的, 解决方案如下:</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>net.ipv4.conf.all.arp_announce <span class="token operator">=</span> <span class="token number">2</span>
net.ipv4.conf.all.arp_ignore <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><ul><li><p>经常处理tcp各种超时问题, 如下文章总结了大部分tcp下的超时情况和对应的参数控制<br> http://blog.qiusuo.im/blog/2014/03/19/tcp-timeout/</p></li><li><p>服务端收到包, 在tcp层会校验checksum, 如果错误, 则直接丢弃该包. 用<code>nstat</code>可以看到<code>TcpInCsumErrors</code>增大</p></li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">7/18/2021, 6:56:35 AM</span></div><!----></footer><nav class="page-nav"><p class="inner"><!----><span class="next"><a href="/network/tcp.html" class="nav-link" aria-label="TCP协议栈笔记"><!--[--><!--]--> TCP协议栈笔记 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.443127ae.js" defer></script><script src="/assets/js/838.91c535db.js" defer></script><script src="/assets/js/app.1ace75fc.js" defer></script>
  </body>
</html>

(self.webpackChunkvuepress_blog=self.webpackChunkvuepress_blog||[]).push([[881],{6399:(s,n,a)=>{"use strict";a.r(n),a.d(n,{data:()=>e});const e={key:"v-14c7a7ea",path:"/network/tcpdump-wireshark.html",title:"Tcpdump与Wireshark点滴记录",lang:"en-US",frontmatter:{title:"Tcpdump与Wireshark点滴记录",author:"Peter Wang",tags:["NetWork"],date:"2018-08-16T14:41:37.000Z",draft:!1},excerpt:"",headers:[{level:2,title:"tcpdump 基本介绍",slug:"tcpdump-基本介绍",children:[{level:3,title:"常用语法",slug:"常用语法",children:[]},{level:3,title:"常用过滤语法",slug:"常用过滤语法",children:[]}]},{level:2,title:"wireshark 介绍",slug:"wireshark-介绍",children:[{level:3,title:"显示过滤器",slug:"显示过滤器",children:[]},{level:3,title:"三板斧",slug:"三板斧",children:[]},{level:3,title:"Wireshark提示消息解释",slug:"wireshark提示消息解释",children:[]},{level:3,title:"其他技巧",slug:"其他技巧",children:[]}]},{level:2,title:"TCP协议",slug:"tcp协议",children:[{level:3,title:"知识学习",slug:"知识学习",children:[]},{level:3,title:"问题记录",slug:"问题记录",children:[]}]}],filePathRelative:"network/tcpdump-wireshark.md",git:{updatedTime:1626591395e3,contributors:[]}}},8238:(s,n,a)=>{"use strict";a.r(n),a.d(n,{default:()=>t});const e=(0,a(6252).uE)('<p>记录Tcpdump相关知识和Wireshark技巧</p><h2 id="tcpdump-基本介绍" tabindex="-1"><a class="header-anchor" href="#tcpdump-基本介绍" aria-hidden="true">#</a> tcpdump 基本介绍</h2><h3 id="常用语法" tabindex="-1"><a class="header-anchor" href="#常用语法" aria-hidden="true">#</a> 常用语法</h3><ul><li>指定网卡(eth0), 如果要抓取所有网卡的包, 使用<code>any</code></li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0\ntcpdump -i any\n</code></pre></div><ul><li>使用<code>-nnv</code>, 不解析协议和端口,同时多打印写详细信息(IP头)</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -nnv\n    <span class="token number">10.211</span>.55.9.22 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.2.63376: Flags <span class="token punctuation">[</span>P.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x84ff <span class="token punctuation">(</span>incorrect -<span class="token operator">&gt;</span> 0x0ec3<span class="token punctuation">)</span>, <span class="token function">seq</span> <span class="token number">935672</span>:935968, ack <span class="token number">761</span>, win <span class="token number">385</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">102595534</span> ecr <span class="token number">1564236582</span><span class="token punctuation">]</span>, length <span class="token number">296</span>\n<span class="token number">22</span>:53:54.006694 IP <span class="token punctuation">(</span>tos 0x10, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">59224</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto TCP <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, length <span class="token number">52</span><span class="token punctuation">)</span>\n    <span class="token number">10.211</span>.55.2.63376 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.9.22: Flags <span class="token punctuation">[</span>.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x8bf2 <span class="token punctuation">(</span>correct<span class="token punctuation">)</span>, ack <span class="token number">935672</span>, win <span class="token number">8139</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">1564236582</span> ecr <span class="token number">102595534</span><span class="token punctuation">]</span>, length <span class="token number">0</span>\n<span class="token number">22</span>:53:54.006746 IP <span class="token punctuation">(</span>tos 0x10, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">25202</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto TCP <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, length <span class="token number">52</span><span class="token punctuation">)</span>\n    <span class="token number">10.211</span>.55.2.63376 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.9.22: Flags <span class="token punctuation">[</span>.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x8adc <span class="token punctuation">(</span>correct<span class="token punctuation">)</span>, ack <span class="token number">935968</span>, win <span class="token number">8121</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">1564236582</span> ecr <span class="token number">102595534</span><span class="token punctuation">]</span>, length <span class="token number">0</span>\n<span class="token number">22</span>:53:54.006895 IP <span class="token punctuation">(</span>tos 0x10, ttl <span class="token number">64</span>, <span class="token function">id</span> <span class="token number">57471</span>, offset <span class="token number">0</span>, flags <span class="token punctuation">[</span>DF<span class="token punctuation">]</span>, proto TCP <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>, length <span class="token number">924</span><span class="token punctuation">)</span>\n    <span class="token number">10.211</span>.55.9.22 <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.2.63376: Flags <span class="token punctuation">[</span>P.<span class="token punctuation">]</span>, <span class="token function">cksum</span> 0x873f <span class="token punctuation">(</span>incorrect -<span class="token operator">&gt;</span> 0x2d02<span class="token punctuation">)</span>, <span class="token function">seq</span> <span class="token number">935968</span>:936840, ack <span class="token number">761</span>, win <span class="token number">385</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">102595534</span> ecr <span class="token number">1564236582</span><span class="token punctuation">]</span>, length <span class="token number">872</span>\n</code></pre></div><ul><li>使用<code>-e</code>可以打印MAC地址</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -e\ntcpdump: verbose output suppressed, use -v or -vv <span class="token keyword">for</span> full protocol decode\nlistening on eth0, link-type EN10MB <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>, capture size <span class="token number">262144</span> bytes\n<span class="token number">22</span>:56:22.708510 00:1c:42:13:d0:f5 <span class="token punctuation">(</span>oui Unknown<span class="token punctuation">)</span> <span class="token operator">&gt;</span> 00:1c:42:00:00:08 <span class="token punctuation">(</span>oui Unknown<span class="token punctuation">)</span>, ethertype IPv4 <span class="token punctuation">(</span>0x0800<span class="token punctuation">)</span>, length <span class="token number">266</span>: linux.ssh <span class="token operator">&gt;</span> <span class="token number">10.211</span>.55.2.63376: Flags <span class="token punctuation">[</span>P.<span class="token punctuation">]</span>, <span class="token function">seq</span> <span class="token number">3187876880</span>:3187877080, ack <span class="token number">2645742059</span>, win <span class="token number">385</span>, options <span class="token punctuation">[</span>nop,nop,TS val <span class="token number">102744236</span> ecr <span class="token number">1564384779</span><span class="token punctuation">]</span>, length <span class="token number">200</span>\n</code></pre></div><ul><li>使用<code>-w</code>将信息保存到文件, 下列命令将包信息保存到<code>abc.cap</code>. <code>-C</code> 配合<code>-w</code>使用, 进一步指定文件的最大size, 一旦超过, 会新建文件继续写入</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -w abc.cap\n</code></pre></div><h3 id="常用过滤语法" tabindex="-1"><a class="header-anchor" href="#常用过滤语法" aria-hidden="true">#</a> 常用过滤语法</h3><p>不带过滤器, 则默认抓取指定网卡所有的包(接受和发送)</p><ul><li>抓取所有经过eth1，目的或源地址是192.168.1.1的网络数据</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 <span class="token function">host</span> <span class="token number">192.168</span>.1.1\n</code></pre></div><ul><li>抓取所有经过eth1，目的或源网络为192.168.XXX.XXX的网络数据</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 net <span class="token number">192.168</span>\n</code></pre></div><ul><li>指定源地址或者目的地址</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 src <span class="token function">host</span> <span class="token number">192.168</span>.1.1\ntcpdump -i eth1 dst <span class="token function">host</span> <span class="token number">192.168</span>.1.1\n</code></pre></div><ul><li>抓取所有经过eth1，目的或源端口是25的网络数据, 如果要指定过滤源端口, 可使用 <code>src port 25</code>. 目的端口类似</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 port <span class="token number">25</span>\n</code></pre></div><ul><li>抓取所有经过eth1的所有icmp包, tcp, arp包语法类似</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 arp\ntcpdump -i eth1 <span class="token function">ip</span>\ntcpdump -i eth1 tcp\ntcpdump -i eth1 udp\ntcpdump -i eth1 icmp\n</code></pre></div><ul><li>逻辑表达式</li></ul><div class="language-text ext-text"><pre class="language-text"><code>非 : ! or &quot;not&quot; (去掉双引号)  \n且 : &amp;&amp; or &quot;and&quot;  \n或 : || or &quot;or&quot;\n\n多个表达式整体用单引号或者双引号引用起来, 单个最好用括号这样更清晰 \n</code></pre></div><ul><li>抓取所有经过eth1，目的网络是192.168，但目的主机不是192.168.1.200的TCP数据</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 <span class="token string">&#39;((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))&#39;</span>\n</code></pre></div><blockquote><p>详细的过滤指导请参考: https://wiki.wireshark.org/CaptureFilters</p></blockquote><h2 id="wireshark-介绍" tabindex="-1"><a class="header-anchor" href="#wireshark-介绍" aria-hidden="true">#</a> wireshark 介绍</h2><h3 id="显示过滤器" tabindex="-1"><a class="header-anchor" href="#显示过滤器" aria-hidden="true">#</a> 显示过滤器</h3><p>默认wireshark打开文件后,显示所有的包. 可以指定相应的显示过滤器, 显示特定部分</p><ul><li><p>比如想显示所有经过端口80的数据包, 使用 <code>tcp.port == 80</code></p></li><li><p>显示所有经过 192.168这个网段的包,使用 <code>ip.addr == 192.168.0.0/16</code></p></li><li><p>仍然可以组合多个过滤条件</p></li></ul><blockquote><p>and, &amp;&amp; 逻辑与<br> or, || 逻辑或<br> not, ! 逻辑否</p></blockquote><p>下面是具体的例子:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcp.port <span class="token operator">==</span> <span class="token number">80</span> and ip.src <span class="token operator">==</span> <span class="token number">192.168</span>.2.1\nnot llc\nhttp and frame<span class="token punctuation">[</span><span class="token number">100</span>-199<span class="token punctuation">]</span> contains <span class="token string">&quot;wireshark&quot;</span>\n<span class="token punctuation">(</span>ipx.src.net <span class="token operator">==</span> 0xbad <span class="token operator">&amp;&amp;</span> ipx.src.node <span class="token operator">==</span> <span class="token number">0.0</span>.0.0.0.1<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">ip</span>\n\n</code></pre></div><ul><li>两个特殊的过滤操作<code>contains</code> 和 <code>match</code></li></ul><p><code>ip.addr contains &quot;192.168&quot;</code>是指过滤所有ip地址里包含&quot;192.168&quot;这几个字符的数据包<br><code>http contains &quot;www.163.com&quot;</code> 过滤所有http消息里包含&quot;www.163.com&quot;字符串的数据包<br><code>match</code> 用法类似, 不过它支持perl的正则表达式, 而且是大小写不敏感</p><p><code>contains</code> 后面可以是带双引号的字符串, 字节数组, 单字节(类c语言风格). 其他的如&quot;tcp.port&quot; 也可以跟这些 下面的表达式都是正确的:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token string">&quot;www.163.com&quot;</span>\n<span class="token number">56</span>:98:47    <span class="token punctuation">(</span>十六进制<span class="token punctuation">)</span>\n<span class="token number">68</span>\n</code></pre></div><p>如下的过滤都是等价的:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>http.request.method <span class="token operator">==</span> <span class="token string">&quot;<span class="token entity" title="\\x47">\\x47</span>ET&quot;</span>\nhttp.request.method <span class="token operator">==</span> <span class="token string">&quot;GET&quot;</span>\nhttp.request.method <span class="token operator">==</span> <span class="token number">47.45</span>.54\nhttp.request.method <span class="token operator">==</span> <span class="token number">47</span>:45:54\nhttp.request.method <span class="token operator">==</span> <span class="token number">47</span>-45-54\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code>frame.pkt_len <span class="token operator">&gt;</span> <span class="token number">10</span>\nframe.pkt_len <span class="token operator">&gt;</span> 012\nframe.pkt_len <span class="token operator">&gt;</span> 0xa\nframe.pkt_len <span class="token operator">&gt;</span> <span class="token string">&#39;\\n&#39;</span>\nframe.pkt_len <span class="token operator">&gt;</span> <span class="token string">&#39;\\xa&#39;</span>\nframe.pkt_len <span class="token operator">&gt;</span> <span class="token string">&#39;\\012&#39;</span>\n</code></pre></div><ul><li>还有很多切片,字节操作等高级操作, 可以进一步查看如下两个文档</li></ul><blockquote><p>https://wiki.wireshark.org/DisplayFilters<br> https://www.wireshark.org/docs/man-pages/wireshark-filter.html</p></blockquote><h3 id="三板斧" tabindex="-1"><a class="header-anchor" href="#三板斧" aria-hidden="true">#</a> 三板斧</h3><p>处理linux主机性能问题, 我们通常有三个方面是必查的. CPU, 内存 和 IO 使用率<br> 通过wireshark分析网络问题, 也有类似的3个必查项</p><ul><li>统计 --&gt; 对话</li></ul><p>已<code>TCP</code>为例, 每一行代表一个TCP连接.他统计了流量和速率(每个方向和两个方向交互的总和) <code>rel start</code> 是该连接上第一条TCP包与该cap文件的第一条数据的时间相对值, 勾选绝对开始时间, 可显示包发送的绝对时间. 例如<code>23:17:95</code></p><p><img src="/img/wireshark_info.png" alt="统计--&gt;对话框"></p><ul><li>分析 --&gt; 专家信息</li></ul><p>Wireshark会自动分析整个文件, 然后分严重等级罗列出每一项分析结果和对应出现的次数<br> 一定要多关注错误和警告级别的, 根据出现的次数和文件总的<code>packet</code>数计算其出现的比例. 比如重传大于10%对性能影响就非常严重了</p><p><img src="/img/wireshark_expertinfo.png" alt="分析 --&gt; 专家信息"></p><ul><li>统计 --&gt; TCP流图形 --&gt; 时间序列(Steven)</li></ul><p>该图可以显示一个TCP连接上某个方向序列号的变化, 以此查看发送性能</p><p><img src="/img/wireshark_tcpseq.png" alt="统计 --&gt; TCP流图形 --&gt; 时间序列"></p><h3 id="wireshark提示消息解释" tabindex="-1"><a class="header-anchor" href="#wireshark提示消息解释" aria-hidden="true">#</a> Wireshark提示消息解释</h3><ul><li>[Packet size limited during capture]<br> 表示该包没有抓全, 比如包是大小是1024, 结果tcpdump抓时只了1000. 通常这是抓包是<code>-s</code>值太小造成的</li><li>[TCP Previous segment not captured]<br> TCP连接上后一包的seq大于前一个包的seq+eln, 说明中间缺失数据. 给出这个提示</li><li>[TCP ACKed unseen segment]<br> 该报文里的ACK确认的seq在整个抓包里没有找到</li><li>[TCP Out-of-Order]<br> 后一个包的seq小于前一个包的seq+len, 认为乱序</li><li>[TCP Dup ACK]<br> 后一个包的ack和前一个包里的ack指一样.</li><li>[TCP Fast Retransmission]<br> 当Dup ACK发生3次, 发送端启动快速重传</li><li>[TCP Retransmission]<br> 包丢且也没有触发Dup ACK, 则RTO超时过后启动重传</li><li>[TCP zerowindow]<br> win为0, 表示接受方暂时无法接受新包</li><li>[TCP window Full]<br> 表示发送方已经将接受串口占满, 可对比接受方发的窗口和发送方的<code>byte in flight</code></li></ul><blockquote><p>可进一步查看官方文档: https://www.wireshark.org/docs/wsug_html_chunked/ChAdvTCPAnalysis.html<br> 有兴趣的话, 可以进一步查看源码: https://github.com/boundary/wireshark/blob/master/epan/dissectors/packet-tcp.c</p></blockquote><h3 id="其他技巧" tabindex="-1"><a class="header-anchor" href="#其他技巧" aria-hidden="true">#</a> 其他技巧</h3><ul><li><p>如果包在英国的某台服务器上生成, 在中国打开时, 会发现并不是英国当地的发生时间. 需要做timeshift<br> 在<code>编辑 --&gt; 时间平移</code> 将时间通过<code>08:00:00</code>或者<code>-08:00:00</code>这样的格式进行调整</p></li><li><p>推荐两个讲解Wireshark的书:<br> &lt;&lt; Wireshark网络分析就这么简单&gt;&gt; 和 &lt;&lt; Wireshark网络分析的艺术 &gt;&gt;</p></li><li><p>iRTT 与 RTT<br> https://osqa-ask.wireshark.org/questions/21813/how-is-rtt-calculated</p></li></ul><h2 id="tcp协议" tabindex="-1"><a class="header-anchor" href="#tcp协议" aria-hidden="true">#</a> TCP协议</h2><h3 id="知识学习" tabindex="-1"><a class="header-anchor" href="#知识学习" aria-hidden="true">#</a> 知识学习</h3><p>这块非常复杂, 推荐如下书籍或文章: TCP/IP详解卷1<br> TCP 的那些事儿:<br> https://coolshell.cn/articles/11564.html<br> https://coolshell.cn/articles/11609.html<br> TCP/IP Guide:<br> http://www.tcpipguide.com/free/index.htm 免费电子书</p><h3 id="问题记录" tabindex="-1"><a class="header-anchor" href="#问题记录" aria-hidden="true">#</a> 问题记录</h3><ul><li><p>网卡eth1收到包, 根据路由要从网卡eth0发出去, 但从抓包上却没有看到回包<br> 通过设置参数<code>net.ipv4.conf.all.rp_filter</code>为0 可解决 默认为1, 是严格模式, 不允许回程路由和先前的不一样, 同时<code>nstat | grep IPReversePathFilter</code>可观察到包被丢弃后,计数器增加 具体解释看:<br> https://access.redhat.com/solutions/53031<br> https://www.slashroot.in/linux-kernel-rpfilter-settings-reverse-path-filtering<br> https://access.redhat.com/solutions/53031<br> 同时可以打开内核参数<code>net.ipv4.conf.all.log_martians</code>,将OS认为的martians报文打印到系统日志里<br> 具体解释:<br> https://serverfault.com/questions/570980/what-is-the-usefulness-of-logging-of-martians-packet-e-g-net-ipv4-conf-all-lo</p></li><li><p>NAT场景下内网机器配置所有消息转发到一台nat服务器上, 但有时通过<code>ip route get xxx</code> 会显示路由指向默认网关. 并且有<code>cache redirect</code>字样<br> 路由分为静态路由和动态的. 动态是通过智能学的, 例如<code>icmp</code>的重定向会影响的动态路由. NAT场景下要关闭ICMP的重定向功能</p></li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>net.ipv4.conf.all.accept_redirects<span class="token operator">=</span><span class="token number">0</span>\nnet.ipv4.conf.all.secure_redirects<span class="token operator">=</span><span class="token number">0</span>\nnet.ipv4.conf.all.send_redirects<span class="token operator">=</span><span class="token number">0</span>\n</code></pre></div><ul><li>多网卡一般配置不同的网段, 但有时会将同一网段的IP配置在两个网卡上, 这样回复消息只会从一个网卡出去. 需要通过策略路由解决:<br> 为每一个网卡配置单独的路由表<br> 默认任意一个网卡会对自己所有的 ip 地址在 ARP 请求上作出响应, 所有对端学到的这两个IP的mac地址可能是一样的, 解决方案如下:</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>net.ipv4.conf.all.arp_announce <span class="token operator">=</span> <span class="token number">2</span>\nnet.ipv4.conf.all.arp_ignore <span class="token operator">=</span> <span class="token number">1</span>\n</code></pre></div><ul><li><p>经常处理tcp各种超时问题, 如下文章总结了大部分tcp下的超时情况和对应的参数控制<br> http://blog.qiusuo.im/blog/2014/03/19/tcp-timeout/</p></li><li><p>服务端收到包, 在tcp层会校验checksum, 如果错误, 则直接丢弃该包. 用<code>nstat</code>可以看到<code>TcpInCsumErrors</code>增大</p></li></ul>',69),t={render:function(s,n){return e}}}}]);
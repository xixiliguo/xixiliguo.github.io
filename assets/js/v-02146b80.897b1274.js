(self.webpackChunkvuepress_blog=self.webpackChunkvuepress_blog||[]).push([[25],{8994:(n,s,a)=>{"use strict";a.r(s),a.d(s,{data:()=>p});const p={key:"v-02146b80",path:"/linux/yum-update.html",title:"使用Yum 升级OS",lang:"en-US",frontmatter:{title:"使用Yum 升级OS",author:"Peter Wang",tags:["yum"],date:"2019-06-11T16:12:08.000Z",draft:!1},excerpt:"",headers:[{level:2,title:"创建Repo源的操作",slug:"创建repo源的操作",children:[]},{level:2,title:"rpmsave与rpmnew",slug:"rpmsave与rpmnew",children:[]},{level:2,title:"查询依赖关系",slug:"查询依赖关系",children:[]},{level:2,title:"SPEC文件",slug:"spec文件",children:[]},{level:2,title:"其他",slug:"其他",children:[]},{level:2,title:"history相关操作",slug:"history相关操作",children:[]},{level:2,title:"yum update 与 yum update-to 的区别",slug:"yum-update-与-yum-update-to-的区别",children:[]},{level:2,title:"yum update",slug:"yum-update",children:[]},{level:2,title:"yum downgrade",slug:"yum-downgrade",children:[]},{level:2,title:"其他",slug:"其他-1",children:[]}],filePathRelative:"linux/yum-update.md",git:{updatedTime:1626591395e3,contributors:[]}}},149:(n,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>t});const p=(0,a(6252).uE)('<p>主要介绍使用yum 升级OS软件包的一些细节</p><h1 id="repo源" tabindex="-1"><a class="header-anchor" href="#repo源" aria-hidden="true">#</a> Repo源</h1><p>每个源下面有个<code>repodata</code>这个文件夹, 该文件夹存放着软件包的元数据(包名,路径,版本,依赖关系)<br> 比如<code>https://mirrors.tuna.tsinghua.edu.cn/centos/7.6.1810/os/x86_64/</code><br> 下面的repodata里 <code>25cd2c29e5adb2b6f8a5b091237dd9f760e97815b37f2557f2cd1c12a5f294f0-primary.xml.gz</code> 文件就是元数据文件</p><h2 id="创建repo源的操作" tabindex="-1"><a class="header-anchor" href="#创建repo源的操作" aria-hidden="true">#</a> 创建Repo源的操作</h2><p>已<code>/opt/mirrors/CentOS7</code>为例:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">mkdir</span> -p CentOS7/Packages\n</code></pre></div><p>将所有软件rpm包上传到文件夹<code>Packages</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /opt/mirrors/CentOS7\ncreaterepo <span class="token builtin class-name">.</span>\n</code></pre></div><p>该操作会生成<code>yum</code>会用到的元数据,并放入到<code>repodata</code>目录.<br> 并不一定非要创建<code>Packages</code>目录, <code>createrepo</code>会自动查找指定目录及其子目录. <code>Packages</code>是个很好的约定,方便管理<br> rpm包是集合, 含有二进制文件, 版本信息, 依赖关系等. <code>createrepo</code>通过读取每个rpm的信息,并生成元数据.<br> 这样<code>yum</code>在分析时只需要下载元数据,就可以得知该源有哪个软件,什么版本等.不必每次下载源里的包.</p><p>我们使用<code>yum checkupdate</code>等命令时, 假设访问<code>xxx/CentOS7</code>, <code>yum</code>会检查是否有<code>xxx/CentOS7/repodata</code>这个目录,并获取相应的元数据.</p><h1 id="rpm相关操作" tabindex="-1"><a class="header-anchor" href="#rpm相关操作" aria-hidden="true">#</a> rpm相关操作</h1><h2 id="rpmsave与rpmnew" tabindex="-1"><a class="header-anchor" href="#rpmsave与rpmnew" aria-hidden="true">#</a> rpmsave与rpmnew</h2><p>rpm的spec文件里可以指定新版配置文件的升级方式<br> 默认升级时旧版本有改动,则用新版本替换旧版本的文件. 旧版本的文件改名为XXXX.rpmsave<br> 如果spec文件里指定为<code>%config(noreplace)</code>, 则升级时旧版本有改动, 保留旧文件,新版本文件改为XXXX.rpmnew<br> 这里的改动指新版本的rpm里对比旧版本rpm里的默认文件. 并非拿可能被用户修改过的文件和新版本里的文件对比<br> 如果文件不存在(比如人为删除), 升级时会重新生成该文件， 不管是configfile还是 noconfigfile</p><p>卸载时对于<code>%config(noreplace)</code>的文件,如果有改动,则不会删除,改名为XXXX.rpmsave</p><p>https://blog.csdn.net/xukunddp/article/details/6409795 有相关解释<br> https://www.cl.cam.ac.uk/~jw35/docs/rpm_config.html 描述了各种改动场景下的结果</p><p>如果没有spec文件, 可通过如下步骤从已安装的软件包确认下配置文件的覆盖方式<br> 比较文件的flags是否 第5个Bit位位1. 即 XX &amp; (1&lt;&lt;4) 是否非0<br> 显示<code>/etc/pam.d/sshd</code>,<code>/etc/ssh/sshd_config</code>,<code>/etc/sysconfig/sshd</code>的属性是 %config(noreplace)</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># rpm -q --qf &#39;[%{filenames}: %{fileflags}\\n]&#39; openssh-server</span>\n/etc/pam.d/sshd: <span class="token number">17</span>\n/etc/ssh/sshd_config: <span class="token number">17</span>\n/etc/sysconfig/sshd: <span class="token number">17</span>\n/usr/lib/systemd/system/sshd-keygen.service: <span class="token number">0</span>\n/usr/lib/systemd/system/sshd.service: <span class="token number">0</span>\n/usr/lib/systemd/system/sshd.socket: <span class="token number">0</span>\n/usr/lib/systemd/system/sshd@.service: <span class="token number">0</span>\n/usr/lib64/fipscheck/sshd.hmac: <span class="token number">0</span>\n/usr/libexec/openssh/sftp-server: <span class="token number">0</span>\n/usr/sbin/sshd: <span class="token number">0</span>\n/usr/sbin/sshd-keygen: <span class="token number">0</span>\n/usr/share/man/man5/moduli.5.gz: <span class="token number">2</span>\n/usr/share/man/man5/sshd_config.5.gz: <span class="token number">2</span>\n/usr/share/man/man8/sftp-server.8.gz: <span class="token number">2</span>\n/usr/share/man/man8/sshd.8.gz: <span class="token number">2</span>\n/var/empty/sshd: <span class="token number">0</span>\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># grep -r RPMFILE_NOREPLACE /usr/include/</span>\n/usr/include/rpm/rpmfi.h:    RPMFILE_NOREPLACE\t<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">4</span><span class="token punctuation">)</span>,\t/*<span class="token operator">!</span><span class="token operator">&lt;</span> from %%config<span class="token punctuation">(</span>noreplace<span class="token punctuation">)</span> */\n</code></pre></div><p>参考: https://www.redhat.com/archives/rpm-list/2003-October/msg00140.html</p><h2 id="查询依赖关系" tabindex="-1"><a class="header-anchor" href="#查询依赖关系" aria-hidden="true">#</a> 查询依赖关系</h2><p>检查软件提供哪些capability</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># rpm -q --provides openssh-server</span>\nconfig<span class="token punctuation">(</span>openssh-server<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span>.4p1-16.el7\nopenssh-server <span class="token operator">=</span> <span class="token number">7</span>.4p1-16.el7\nopenssh-server<span class="token punctuation">(</span>x86-64<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span>.4p1-16.el7\n</code></pre></div><p>检查软件需要哪些capability</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># rpm -q --requires openssh-server</span>\n/bin/bash\n/bin/sh\n/bin/sh\n/bin/sh\n/bin/sh\n/usr/sbin/useradd\nconfig<span class="token punctuation">(</span>openssh-server<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span>.4p1-16.el7\nfipscheck-lib<span class="token punctuation">(</span>x86-64<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">1.3</span>.0\nlibaudit.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.14<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.16<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.17<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.2.5<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.3<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.3.4<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.4<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibc.so.6<span class="token punctuation">(</span>GLIBC_2.8<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcom_err.so.2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcrypt.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcrypt.so.1<span class="token punctuation">(</span>GLIBC_2.2.5<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcrypto.so.10<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcrypto.so.10<span class="token punctuation">(</span>OPENSSL_1.0.1_EC<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcrypto.so.10<span class="token punctuation">(</span>OPENSSL_1.0.2<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibcrypto.so.10<span class="token punctuation">(</span>libcrypto.so.10<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibdl.so.2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibfipscheck.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibgssapi_krb5.so.2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibgssapi_krb5.so.2<span class="token punctuation">(</span>gssapi_krb5_2_MIT<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibk5crypto.so.3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibkrb5.so.3<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibkrb5.so.3<span class="token punctuation">(</span>krb5_3_MIT<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nliblber-2.4.so.2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibldap-2.4.so.2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibpam.so.0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibpam.so.0<span class="token punctuation">(</span>LIBPAM_1.0<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibresolv.so.2<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibselinux.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibsystemd.so.0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibsystemd.so.0<span class="token punctuation">(</span>LIBSYSTEMD_209<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibutil.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibutil.so.1<span class="token punctuation">(</span>GLIBC_2.2.5<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibwrap.so.0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nlibz.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\nopenssh <span class="token operator">=</span> <span class="token number">7</span>.4p1-16.el7\npam <span class="token operator">&gt;=</span> <span class="token number">1.0</span>.1-3\nrpmlib<span class="token punctuation">(</span>CompressedFileNames<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">3.0</span>.4-1\nrpmlib<span class="token punctuation">(</span>FileDigests<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">4.6</span>.0-1\nrpmlib<span class="token punctuation">(</span>PayloadFilesHavePrefix<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">4.0</span>-1\nrtld<span class="token punctuation">(</span>GNU_HASH<span class="token punctuation">)</span>\nsystemd-units\nsystemd-units\nsystemd-units\nrpmlib<span class="token punctuation">(</span>PayloadIsXz<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">5.2</span>-1\n</code></pre></div><p>根据capability,查询哪个包提供</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># rpm -q --whatprovides pam</span>\npam-1.1.8-22.el7.x86_64\n<span class="token comment"># rpm -q --whatprovides libsystemd.so.0\\(\\)\\(64bit\\)</span>\nsystemd-libs-219-62.el7_6.6.x86_64\n</code></pre></div><p>查询哪个包需要某个特定的capability</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># rpm -q --whatrequires pam</span>\npasswd-0.79-4.el7.x86_64\ncronie-1.4.11-20.el7_6.x86_64\nutil-linux-2.23.2-59.el7_6.1.x86_64\nopenssh-server-7.4p1-16.el7.x86_64\nauthconfig-6.2.8-30.el7.x86_64\n<span class="token comment"># rpm -q --whatrequires libsystemd.so.0\\(\\)\\(64bit\\)</span>\ndbus-libs-1.10.24-13.el7_6.x86_64\ndbus-1.10.24-13.el7_6.x86_64\npolkit-0.112-18.el7_6.1.x86_64\nutil-linux-2.23.2-59.el7_6.1.x86_64\nopenssh-server-7.4p1-16.el7.x86_64\nrsyslog-8.24.0-34.el7.x86_64\nprocps-ng-3.3.10-23.el7.x86_64\n</code></pre></div><p>如果要查询本地rpm软件包的信息, 需要使用<code>-p</code><br> 比如之前是<code>rpm -ql bpftool</code>, 要改为<code>rpm -ql -p bpftool-3.10.0-957.el7.x86_64.rpm</code></p><p>如果要查询的包,文件或者capability, 不在本地已安装的包里, 可以使用<code>repoquery</code>从已知源中查询<br> 例如查询哪个包提供了<code>strace</code>这个capability:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ repoquery --whatprovides <span class="token function">strace</span>\nstrace-0:4.12-9.el7.x86_64\n</code></pre></div><p>repoquery不仅支持从源中查,还会从本地已安装的信息来查.</p><h2 id="spec文件" tabindex="-1"><a class="header-anchor" href="#spec文件" aria-hidden="true">#</a> SPEC文件</h2><p>rpm的构建过程需要源代码和<code>spec</code>文件. <code>spec</code>文件用于描述rpm的元数据信息和指导如何编译,打包,封装为二进制的rpm文件</p><p>跟着如下教程, 自己可以从xxx.src.rpm编译出xxx.rpm文件. 常用于问题定位,增加日志等.<br> https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/</p><p>下面两篇文章介绍了SPEC的语法:<br> https://fedoraproject.org/wiki/How_to_create_am_RPM_package/zh-cn<br> https://rpm-packaging-guide.github.io</p><h2 id="其他" tabindex="-1"><a class="header-anchor" href="#其他" aria-hidden="true">#</a> 其他</h2><p>本地rpm包解压缩</p><div class="language-bash ext-sh"><pre class="language-bash"><code>rpm2cpio xxx.rpm <span class="token operator">|</span> cpio -div\n</code></pre></div><h1 id="yum相关操作" tabindex="-1"><a class="header-anchor" href="#yum相关操作" aria-hidden="true">#</a> yum相关操作</h1><p><code>yum</code>的主要代码在<code>/usr/lib/python2.7/site-packages/yum/</code><br><code>class YumBase</code> 是主要的类, 含大部分操作</p><div class="language-python ext-py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">YumBase</span><span class="token punctuation">(</span>depsolve<span class="token punctuation">.</span>Depsolve<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token triple-quoted-string string">&quot;&quot;&quot;This is a primary structure and base class. It houses the\n    objects and methods needed to perform most things in yum. It is\n    almost an abstract class in that you will need to add your own\n    class above it for most real use.\n    &quot;&quot;&quot;</span>\n</code></pre></div><p>yum所有的操作,都是分析具体的操作(删除,更新,新安装),进而分析相关的依赖, 比如更新时,检查依赖是否满足,不满足也要将依赖的包进程更新.<br> 分析完后将对应包和状态(比如updated, erase等)放入事务中,然后执行具体的操作</p><p>查询特定软件依赖哪些包</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># yum deplist rsync</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * base: mirrors.cqu.edu.cn\n * extras: mirror.jdcloud.com\n * updates: mirrors.aliyun.com\npackage: rsync.x86_64 <span class="token number">3.1</span>.2-6.el7_6.1\n  dependency: /bin/sh\n   provider: bash.x86_64 <span class="token number">4.2</span>.46-31.el7\n  dependency: libacl.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libacl.x86_64 <span class="token number">2.2</span>.51-14.el7\n  dependency: libacl.so.1<span class="token punctuation">(</span>ACL_1.0<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libacl.x86_64 <span class="token number">2.2</span>.51-14.el7\n  dependency: libattr.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libattr.x86_64 <span class="token number">2.4</span>.46-13.el7\n  dependency: libattr.so.1<span class="token punctuation">(</span>ATTR_1.0<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libattr.x86_64 <span class="token number">2.4</span>.46-13.el7\n  dependency: libc.so.6<span class="token punctuation">(</span>GLIBC_2.15<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: glibc.x86_64 <span class="token number">2.17</span>-260.el7_6.5\n  dependency: libpopt.so.0<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: popt.x86_64 <span class="token number">1.13</span>-16.el7\n  dependency: libpopt.so.0<span class="token punctuation">(</span>LIBPOPT_0<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: popt.x86_64 <span class="token number">1.13</span>-16.el7\n  dependency: rtld<span class="token punctuation">(</span>GNU_HASH<span class="token punctuation">)</span>\n   provider: glibc.x86_64 <span class="token number">2.17</span>-260.el7_6.5\n   provider: glibc.i686 <span class="token number">2.17</span>-260.el7_6.5\n  dependency: systemd-units\n   provider: systemd.x86_64 <span class="token number">219</span>-62.el7_6.6\n  dependency: zlib\n   provider: zlib.x86_64 <span class="token number">1.2</span>.7-18.el7\n   provider: zlib.i686 <span class="token number">1.2</span>.7-18.el7\n</code></pre></div><h2 id="history相关操作" tabindex="-1"><a class="header-anchor" href="#history相关操作" aria-hidden="true">#</a> history相关操作</h2><p>https://www.cyberciti.biz/faq/yum-history-command</p><h2 id="yum-update-与-yum-update-to-的区别" tabindex="-1"><a class="header-anchor" href="#yum-update-与-yum-update-to-的区别" aria-hidden="true">#</a> yum update 与 yum update-to 的区别</h2><p>yum 有两种升级命令， yum update 和 yum update-to<br> yum update kernel 会升级Repo里的最新版<br> yum update kernel-3.10.0-327.62.59.83.h108.x86_64 会升级到指定版本。 但如果这个指定版本就是当前已安装的版本， 则自动升级到repo里的最新版。</p><p>yum update-to kernel-3.10.0-327.62.59.83.h108.x86_64 升级到指定版本， 如果这个指定版本就是当前已安装的版本， 则不升级<br> 但是yum update-to kernel则会升级多个高版本的内核。 因为yum update-to 一般要求就是软件包的版本信息</p><h2 id="yum-update" tabindex="-1"><a class="header-anchor" href="#yum-update" aria-hidden="true">#</a> yum update</h2><p>没有指定的软件包,则升级所有软件, 主要逻辑代码在<code>/usr/lib/python2.7/site-packages/yum/__init__.py</code>里类<code>YumBase</code>的函数<code>update</code><br> 加<code>-v</code>可打印详细的日志</p><ol><li>使用rpm模块, 通过<code>dbMatch</code>获取已安装软件的所有信息</li><li>连接repo, 获取所有availble 的软件包信息</li><li>精简newpkg的列表,比如只保留软件包的最新版本</li><li>完成依赖关系检查, 主要是检查依赖项和冲突项</li><li>用户确认OK后,执行下载,升级操作</li></ol><p>如下下yum的包状态, 打印Debug日志时可以对照分析</p><div class="language-text ext-text"><pre class="language-text"><code>           i = the package will be installed\n           u = the package will be an update\n           e = the package will be erased\n           r = the package will be reinstalled\n           d = the package will be a downgrade\n           o = the package will be obsoleting another package\n           ud = the package will be updated\n           od = the package will be obsoleted\n</code></pre></div><h2 id="yum-downgrade" tabindex="-1"><a class="header-anchor" href="#yum-downgrade" aria-hidden="true">#</a> yum downgrade</h2><p><code>yum history undo</code>, 这里undo的是升级事务, 则内部调用的是<code>yum downgrader</code><br> 主要执行入口在类<code>YumBase</code>的函数<code>history_redo</code></p><div class="language-python ext-py"><pre class="language-python"><code><span class="token keyword">for</span> pkg <span class="token keyword">in</span> transaction<span class="token punctuation">.</span>trans_data<span class="token punctuation">:</span>\n            <span class="token keyword">if</span> pkg<span class="token punctuation">.</span>state <span class="token operator">==</span> <span class="token string">&#39;Updated&#39;</span><span class="token punctuation">:</span>\n                <span class="token keyword">try</span><span class="token punctuation">:</span>\n                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>downgrade<span class="token punctuation">(</span>pkgtup<span class="token operator">=</span>pkg<span class="token punctuation">.</span>pkgtup<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                        done <span class="token operator">=</span> <span class="token boolean">True</span>\n                <span class="token keyword">except</span> yum<span class="token punctuation">.</span>Errors<span class="token punctuation">.</span>DowngradeError<span class="token punctuation">:</span>\n                    self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>critical<span class="token punctuation">(</span>_<span class="token punctuation">(</span><span class="token string">&#39;Failed to downgrade: %s&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pkg<span class="token punctuation">)</span>\n</code></pre></div><p>加<code>-v</code>可打印详细的日志<br> 主要是删除已安装的包, 然后<code>yum update</code>指定的新包.<br> 这里删除已安装的包, 很容易删掉其他依赖包. 导致问题. 如下是删除包的一些描述</p><div class="language-text ext-text"><pre class="language-text"><code>Are  used  to  remove  the  specified packages from the system as well as removing any packages which depend on the package being removed. remove operates on\n              groups, files, provides and filelists just like the &quot;install&quot; command.(See Specifying package names for more information)\n\n              Note that &quot;yum&quot; is included in the protected_packages configuration, by default.  So you can&#39;t accidentally remove yum itself.\n\n              The remove_leaf_only configuration changes the behaviour of this command to only remove packages which aren&#39;t required by something else.\n\n              The clean_requirements_on_remove configuration changes the behaviour of this command to also remove packages that are only dependencies of this package.\n\n              Because remove does a lot of work to make it as easy as possible to use, there are also a few specific remove commands &quot;remove-n&quot;, &quot;remove-na&quot;  and  &quot;remove-\n              nevra&quot;. These only work on package names, and do not process wildcards etc.\n</code></pre></div><h2 id="其他-1" tabindex="-1"><a class="header-anchor" href="#其他-1" aria-hidden="true">#</a> 其他</h2><p><code>yum list installed</code>的结果并不等于<code>rpm -qa</code>. <code>rpm -qa</code>会多<code>gpg-pubkey</code>这个软件包. 解释如下:<br> https://unix.stackexchange.com/questions/190203/what-are-gpg-pubkey-packages</p><p>可以使用python库<code>rpm</code>来比较软件包的版本. <code>rpm.labelCompare((an,av,ar),(bn,bv,br))</code><br> 返回值1 表示a较新. 0 相等. -1 b较新. 下面是具体的例子:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># python</span>\nPython <span class="token number">2.7</span>.5 <span class="token punctuation">(</span>default, Apr  <span class="token number">9</span> <span class="token number">2019</span>, <span class="token number">14</span>:30:50<span class="token punctuation">)</span>\n<span class="token punctuation">[</span>GCC <span class="token number">4.8</span>.5 <span class="token number">20150623</span> <span class="token punctuation">(</span>Red Hat <span class="token number">4.8</span>.5-36<span class="token punctuation">)</span><span class="token punctuation">]</span> on linux2\nType <span class="token string">&quot;help&quot;</span>, <span class="token string">&quot;copyright&quot;</span>, <span class="token string">&quot;credits&quot;</span> or <span class="token string">&quot;license&quot;</span> <span class="token keyword">for</span> <span class="token function">more</span> information.\n<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token function">import</span> <span class="token function">rpm</span>\n<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> rpm.labelCompare<span class="token variable"><span class="token punctuation">((</span>&quot;systemd&quot;<span class="token punctuation">,</span>&quot;<span class="token number">219</span>&quot;<span class="token punctuation">,</span>&quot;<span class="token number">62.</span>el7_6.<span class="token number">6</span>&quot;<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;systemd&quot;<span class="token punctuation">,</span>&quot;<span class="token number">219</span>&quot;<span class="token punctuation">,</span>&quot;<span class="token number">63.</span>el7_6.<span class="token number">6</span>&quot;<span class="token punctuation">))</span></span>\n-1\n<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> exit<span class="token punctuation">(</span><span class="token punctuation">)</span>\n</code></pre></div><p>https://stackoverflow.com/questions/3206319/how-do-i-compare-rpm-versions-in-python</p><h1 id="升级前检查" tabindex="-1"><a class="header-anchor" href="#升级前检查" aria-hidden="true">#</a> 升级前检查</h1><ul><li>检查repo里是否有当前OS已安装的软件包. 方便回退.<br> 以下两个命令等价</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>package-cleanup --orphans\nyum list extras\n</code></pre></div><p>代码看是通过<code>/usr/share/yum-cli/cli.py</code>里类<code>YumBaseCli</code>的函数<code>returnPkgLists</code>, 进一步调用类<code>YumBase</code>的函数<code>doPackageLists</code> 实现</p><ul><li>检查本地rpm数据库是否由依赖问题, 相当于升级前校验</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>package-cleanup --problems\n</code></pre></div><p>通过<code>rpmdb.check_dependencies()</code>实现</p><ul><li>模拟<code>yum update</code>但不真正升级, 检查是否报错. 相当于dry-run. 原理是对每次确认选择都是<code>no</code></li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>yum update --assumeno \n</code></pre></div><p>使用<code>echo $?</code>检查上述命令的返回码. 非零表明有异常.</p><h1 id="升级" tabindex="-1"><a class="header-anchor" href="#升级" aria-hidden="true">#</a> 升级</h1><ul><li>升级命令</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code>yum update -y\n</code></pre></div><h1 id="升级后检查" tabindex="-1"><a class="header-anchor" href="#升级后检查" aria-hidden="true">#</a> 升级后检查</h1><ul><li>检查哪些进程需要重启,才能使用新的软件包或者库</li></ul><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># needs-restarting</span>\n<span class="token number">1</span> <span class="token builtin class-name">:</span> /usr/lib/systemd/systemd --system --deserialize <span class="token number">16</span>\n<span class="token number">443</span> <span class="token builtin class-name">:</span> login -- root\n<span class="token number">3838</span> <span class="token builtin class-name">:</span> sshd: root@pts/3\n<span class="token number">1009</span> <span class="token builtin class-name">:</span> /sbin/dhclient -H localhost -1 -q -lf /var/lib/dhclient/dhclient--eth0.lease -pf /var/run/dhclient-eth0.pid eth0\n<span class="token number">2221</span> <span class="token builtin class-name">:</span> sshd: root@pts/0\n</code></pre></div><p>原理:<br> 在<code>/proc</code>下遍历所有<code>pid</code>下面的<code>smaps</code>文件, 获取所有打开文件的信息<br> 检查这些文件对应的rpm包的安装时间<br> 和进程的启动时间对比, 如果rpm的时间晚,则打印出来<br> 具体可以查看<code>/usr/bin/needs-restarting</code>, 它是一个py脚本</p><p>细节:<br> 通过<code>/proc/[pid]/stat</code>下的信息和os的<code>boot_time</code>来计算进程的启动时间</p><div class="language-python ext-py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_process_time</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> boot_time<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    ps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n    ps_stat <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;/proc/%d/stat&quot;</span> <span class="token operator">%</span> pid<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token comment"># Filename of the executable might contain spaces, so we throw it away</span>\n    ps_stat <span class="token operator">=</span> ps_stat<span class="token punctuation">[</span>ps_stat<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>\n    ps<span class="token punctuation">[</span><span class="token string">&#39;utime&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> jiffies_to_seconds<span class="token punctuation">(</span>ps_stat<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    ps<span class="token punctuation">[</span><span class="token string">&#39;stime&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> jiffies_to_seconds<span class="token punctuation">(</span>ps_stat<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    ps<span class="token punctuation">[</span><span class="token string">&#39;cutime&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> jiffies_to_seconds<span class="token punctuation">(</span>ps_stat<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    ps<span class="token punctuation">[</span><span class="token string">&#39;cstime&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> jiffies_to_seconds<span class="token punctuation">(</span>ps_stat<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    ps<span class="token punctuation">[</span><span class="token string">&#39;start_time&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> boot_time <span class="token operator">+</span> jiffies_to_seconds<span class="token punctuation">(</span>ps_stat<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n    ps<span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;R&#39;</span> <span class="token punctuation">:</span> _<span class="token punctuation">(</span><span class="token string">&#39;Running&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                   <span class="token string">&#39;S&#39;</span> <span class="token punctuation">:</span> _<span class="token punctuation">(</span><span class="token string">&#39;Sleeping&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                   <span class="token string">&#39;D&#39;</span> <span class="token punctuation">:</span> _<span class="token punctuation">(</span><span class="token string">&#39;Uninterruptible&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                   <span class="token string">&#39;Z&#39;</span> <span class="token punctuation">:</span> _<span class="token punctuation">(</span><span class="token string">&#39;Zombie&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n                   <span class="token string">&#39;T&#39;</span> <span class="token punctuation">:</span> _<span class="token punctuation">(</span><span class="token string">&#39;Traced/Stopped&#39;</span><span class="token punctuation">)</span>\n                   <span class="token punctuation">}</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>ps_stat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _<span class="token punctuation">(</span><span class="token string">&#39;Unknown&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n</code></pre></div><p>通过rpmdb库里的<code>searchFiles</code>函数获取打开文件对应的包, 进而获取安装时间,即<code>installtime</code></p><p>进程属于哪个systemd service的方法是 获取该pid的cgroup, 如果有<code>name=systemd</code>则说明它是一个服务, 然后已<code>/</code>为分隔符后的最后一个字段就是对应的service</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /proc/3656/cgroup\n<span class="token number">11</span>:blkio:/\n<span class="token number">10</span>:cpuset:/\n<span class="token number">9</span>:net_prio,net_cls:/\n<span class="token number">8</span>:perf_event:/\n<span class="token number">7</span>:hugetlb:/\n<span class="token number">6</span>:freezer:/\n<span class="token number">5</span>:memory:/\n<span class="token number">4</span>:devices:/\n<span class="token number">3</span>:pids:/\n<span class="token number">2</span>:cpuacct,cpu:/\n<span class="token number">1</span>:name<span class="token operator">=</span>systemd:/system.slice/sshd.service\n</code></pre></div><ul><li>检查是否重启OS才能使相应更新后的软件包生效. 当然OS能正常运行.只是不重启无法使用新的功能或者特性.<br> 原理是检查升级的包是否在如下列表里</li></ul><div class="language-text ext-text"><pre class="language-text"><code> &#39;kernel&#39;, &#39;glibc&#39;, &#39;linux-firmware&#39;, &#39;systemd&#39;, &#39;udev&#39;,\n `openssl-libs&#39;, &#39;gnutls&#39;, &#39;dbus&#39;\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># needs-restarting -r</span>\nCore libraries or services have been updated:\n  systemd -<span class="token operator">&gt;</span> <span class="token number">219</span>-62.el7_6.6\n\nReboot is required to ensure that your system benefits from these updates.\nMore information:\nhttps://access.redhat.com/solutions/27943\n</code></pre></div><p>如下命令打印哪些服务需要重启</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># needs-restarting -s</span>\nnetwork.service\n</code></pre></div><h1 id="回退" tabindex="-1"><a class="header-anchor" href="#回退" aria-hidden="true">#</a> 回退</h1><p>使用<code>yum history</code>查询要回退事务的ID, 比如<code>213</code>. 然后运行<code>yum history undo 213</code><br> 先查询指定的事务里的包状态信息, 然后反方向生成事务, 再次执行. 比如之前是更新, 那么新事务就是卸载新包,安装旧包</p><h1 id="其他-2" tabindex="-1"><a class="header-anchor" href="#其他-2" aria-hidden="true">#</a> 其他</h1><p>查询本地软件包来自哪个repo</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># find-repos-of-install kernel</span>\nLoaded plugins: fastestmirror\nkernel-3.10.0-123.el7.x86_64 from repo anaconda\nkernel-3.10.0-957.21.2.el7.x86_64 from repo updates\n</code></pre></div><p>使用<code>yum repolist -v</code>查询repo详情</p><h1 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h1><p>How to use yum history to roll back an update in Red Hat Enterprise Linux 6 , 7<br> https://access.redhat.com/solutions/64069<br> How to use yum to downgrade or rollback some package updates<br> https://access.redhat.com/solutions/29617</p>',100),t={render:function(n,s){return p}}}}]);
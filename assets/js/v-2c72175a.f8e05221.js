(self.webpackChunkvuepress_blog=self.webpackChunkvuepress_blog||[]).push([[842],{9373:(n,a,s)=>{"use strict";s.r(a),s.d(a,{data:()=>t});const t={key:"v-2c72175a",path:"/linux/bandersnatch-pypi.html",title:"使用Bandersnatch搭建私有Pypi源",lang:"en-US",frontmatter:{title:"使用Bandersnatch搭建私有Pypi源",author:"Peter Wang",tags:["Pypi","Bandersnatch"],date:"2018-01-02T14:14:04.000Z",draft:!1},excerpt:"",headers:[{level:2,title:"获取安装包",slug:"获取安装包",children:[]},{level:2,title:"解压缩tar包",slug:"解压缩tar包",children:[]},{level:2,title:"使用pip安装",slug:"使用pip安装",children:[]},{level:2,title:"首次运行创建配置文件",slug:"首次运行创建配置文件",children:[]},{level:2,title:"修改配置文件",slug:"修改配置文件",children:[]},{level:2,title:"启动同步",slug:"启动同步",children:[]}],filePathRelative:"linux/bandersnatch-pypi.md",git:{updatedTime:1626591395e3,contributors:[]}}},6676:(n,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>p});const t=(0,s(6252).uE)('<p>经常使用python的公司,考虑到pypi.python.org不稳定,都会自己搭建私有的Pypi源.这里简单介绍下方法.</p><p>现在流行使用Bandersnatch作为同步工具, 如下演示在centos7.4环境下通过</p><h1 id="安装virtualenv" tabindex="-1"><a class="header-anchor" href="#安装virtualenv" aria-hidden="true">#</a> 安装virtualenv</h1><p>virtualenv 可以为一个应用创建一套“隔离”的Python运行环境。所有依赖包在自己独立的环境,不会影响其他python程序,更不会放到系统默认的site-packages里</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ yum <span class="token function">install</span> python-virtualenv\n</code></pre></div><h1 id="创建独立python环境" tabindex="-1"><a class="header-anchor" href="#创建独立python环境" aria-hidden="true">#</a> 创建独立Python环境</h1><div class="language-bash ext-sh"><pre class="language-bash"><code>$ virtualenv Bandersnatch\nNew python executable <span class="token keyword">in</span> Bandersnatch/bin/python\nPlease <span class="token function">make</span> sure you remove any previous custom paths from your /root/.pydistutils.cfg file.\nInstalling Setuptools<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.done.\nInstalling Pip<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>done.\n$\n</code></pre></div><h1 id="激活独立python环境" tabindex="-1"><a class="header-anchor" href="#激活独立python环境" aria-hidden="true">#</a> 激活独立Python环境</h1><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span>$ <span class="token builtin class-name">source</span> Bandersnatch/bin/activate\n<span class="token punctuation">(</span>Bandersnatch<span class="token punctuation">)</span><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span><span class="token comment">#</span>\n</code></pre></div><p>当指示符前显示 <code>(Bandersnatch)</code> 字样, 意味着所有python的操作,都只限于独立环境, 系统Python环境不受任何影响</p><h1 id="安装bandersnatch" tabindex="-1"><a class="header-anchor" href="#安装bandersnatch" aria-hidden="true">#</a> 安装Bandersnatch</h1><p>最新版的<code>Bandersnatch 2.0</code>支持python3, 但目前的环境是python2.7.5, 所以需要下载其他版本. 这里取<code>1.11</code>版</p><h2 id="获取安装包" tabindex="-1"><a class="header-anchor" href="#获取安装包" aria-hidden="true">#</a> 获取安装包</h2><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token punctuation">(</span>Bandersnatch<span class="token punctuation">)</span><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span>$ <span class="token function">wget</span> https://bitbucket.org/pypa/bandersnatch/get/1.11.tar.gz\n--2018-01-02 <span class="token number">22</span>:39:22--  https://bitbucket.org/pypa/bandersnatch/get/1.11.tar.gz\nResolving bitbucket.org <span class="token punctuation">(</span>bitbucket.org<span class="token punctuation">)</span><span class="token punctuation">..</span>. <span class="token number">104.192</span>.143.3, <span class="token number">104.192</span>.143.2, <span class="token number">104.192</span>.143.1, <span class="token punctuation">..</span>.\nConnecting to bitbucket.org <span class="token punctuation">(</span>bitbucket.org<span class="token punctuation">)</span><span class="token operator">|</span><span class="token number">104.192</span>.143.3<span class="token operator">|</span>:443<span class="token punctuation">..</span>. connected.\nHTTP request sent, awaiting response<span class="token punctuation">..</span>. <span class="token number">200</span> OK\nLength: <span class="token number">25988</span> <span class="token punctuation">(</span>25K<span class="token punctuation">)</span> <span class="token punctuation">[</span>application/x-tar-gz<span class="token punctuation">]</span>\nSaving to: ‘1.11.tar.gz.1’\n\n<span class="token number">100</span>%<span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">]</span> <span class="token number">25,988</span>      <span class="token number">72</span>.9KB/s   <span class="token keyword">in</span> <span class="token number">0</span>.3s\n\n<span class="token number">2018</span>-01-02 <span class="token number">22</span>:39:24 <span class="token punctuation">(</span><span class="token number">72.9</span> KB/s<span class="token punctuation">)</span> - ‘1.11.tar.gz.1’ saved <span class="token punctuation">[</span><span class="token number">25988</span>/25988<span class="token punctuation">]</span>\n</code></pre></div><h2 id="解压缩tar包" tabindex="-1"><a class="header-anchor" href="#解压缩tar包" aria-hidden="true">#</a> 解压缩tar包</h2><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token punctuation">(</span>Bandersnatch<span class="token punctuation">)</span><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span>$ <span class="token function">tar</span> -xzvf <span class="token number">1.11</span>.tar.gz\npypa-bandersnatch-76b72f3ebd6c/.hg_archival.txt\npypa-bandersnatch-76b72f3ebd6c/.coveragerc\npypa-bandersnatch-76b72f3ebd6c/.hgignore\npypa-bandersnatch-76b72f3ebd6c/.hgtags\npypa-bandersnatch-76b72f3ebd6c/CHANGES.txt\npypa-bandersnatch-76b72f3ebd6c/DEVELOPMENT\npypa-bandersnatch-76b72f3ebd6c/LICENSE\npypa-bandersnatch-76b72f3ebd6c/MANIFEST.in\npypa-bandersnatch-76b72f3ebd6c/README\npypa-bandersnatch-76b72f3ebd6c/buildout.cfg\npypa-bandersnatch-76b72f3ebd6c/pytest.ini\npypa-bandersnatch-76b72f3ebd6c/requirements.txt\npypa-bandersnatch-76b72f3ebd6c/setup.py\npypa-bandersnatch-76b72f3ebd6c/src/bandersnatch/__init__.py\n`````````````````````````<span class="token punctuation">(</span>此处省略若干字<span class="token punctuation">)</span>\n</code></pre></div><h2 id="使用pip安装" tabindex="-1"><a class="header-anchor" href="#使用pip安装" aria-hidden="true">#</a> 使用pip安装</h2><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token punctuation">(</span>Bandersnatch<span class="token punctuation">)</span><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span>$ pip <span class="token function">install</span> -r pypa-bandersnatch-76b72f3ebd6c/requirements.txt\nDownloading/unpacking <span class="token assign-left variable">coverage</span><span class="token operator">==</span><span class="token number">3.7</span>.1 <span class="token punctuation">(</span>from -r pypa-bandersnatch-76b72f3ebd6c/requirements.txt <span class="token punctuation">(</span>line <span class="token number">2</span><span class="token punctuation">))</span>\n  Downloading coverage-3.7.1.tar.gz <span class="token punctuation">(</span>284kB<span class="token punctuation">)</span>: 284kB downloaded\n  Running setup.py egg_info <span class="token keyword">for</span> package coverage\n\n    warning: no previously-included files matching <span class="token string">&#39;*.pyc&#39;</span> found anywhere <span class="token keyword">in</span> distribution\nDownloading/unpacking <span class="token assign-left variable">pyparsing</span><span class="token operator">==</span><span class="token number">2.1</span>.3 <span class="token punctuation">(</span>from -r pypa-bandersnatch-76b72f3ebd6c/requirements.txt <span class="token punctuation">(</span>line <span class="token number">3</span><span class="token punctuation">))</span>\n  Downloading pyparsing-2.1.3.tar.gz <span class="token punctuation">(</span><span class="token number">1</span>.1MB<span class="token punctuation">)</span>: <span class="token number">1</span>.1MB downloaded\n  Running setup.py egg_info <span class="token keyword">for</span> package pyparsing\n\nDownloading/unpacking <span class="token assign-left variable">py</span><span class="token operator">==</span><span class="token number">1.4</span>.26 <span class="token punctuation">(</span>from -r pypa-bandersnatch-76b72f3ebd6c/requirements.txt <span class="token punctuation">(</span>line <span class="token number">4</span><span class="token punctuation">))</span>\n  Downloading py-1.4.26.tar.gz <span class="token punctuation">(</span>190kB<span class="token punctuation">)</span>: 190kB downloaded\n  Running setup.py egg_info <span class="token keyword">for</span> package py\n<span class="token punctuation">(</span>此处省略若干字<span class="token punctuation">)</span>\n      Installing bandersnatch script to /root/Bandersnatch/bin\n  Could not <span class="token function">find</span> .egg-info directory <span class="token keyword">in</span> <span class="token function">install</span> record <span class="token keyword">for</span> <span class="token assign-left variable">bandersnatch</span><span class="token operator">==</span><span class="token number">1.11</span> <span class="token punctuation">(</span>from -r pypa-bandersnatch-76b72f3ebd6c/requirements.txt <span class="token punctuation">(</span>line <span class="token number">22</span><span class="token punctuation">))</span>\nSuccessfully installed coverage pyparsing py pyflakes pep8 pytest cov-core execnet python-dateutil six setuptools mock packaging pytest-capturelog pytest-codecheckers pytest-cov pytest-timeout pytest-cache requests xmlrpc2 bandersnatch\nCleaning up<span class="token punctuation">..</span>.\n<span class="token punctuation">(</span>Bandersnatch<span class="token punctuation">)</span><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span>$\n</code></pre></div><h1 id="配置bandersnatch并运行" tabindex="-1"><a class="header-anchor" href="#配置bandersnatch并运行" aria-hidden="true">#</a> 配置Bandersnatch并运行</h1><h2 id="首次运行创建配置文件" tabindex="-1"><a class="header-anchor" href="#首次运行创建配置文件" aria-hidden="true">#</a> 首次运行创建配置文件</h2><div class="language-text ext-text"><pre class="language-text"><code>(Bandersnatch)[root@abc ~]$ bandersnatch mirror\n2018-01-02 22:43:37,985 WARNING: Config file &#39;/etc/bandersnatch.conf&#39; missing, creating default config.\n2018-01-02 22:43:37,985 WARNING: Please review the config file, then run &#39;bandersnatch&#39; again.\n(Bandersnatch)[root@abc ~]$\n</code></pre></div><p>这一步,会创建默认的配置文件/etc/bandersnatch.conf.</p><h2 id="修改配置文件" tabindex="-1"><a class="header-anchor" href="#修改配置文件" aria-hidden="true">#</a> 修改配置文件</h2><p><code>vi /etc/bandersnatch.conf</code><br> 修改directory为存放文件的目标文件夹. 其他选项通常不需要修改.</p><div class="language-ini ext-ini"><pre class="language-ini"><code><span class="token header"><span class="token punctuation">[</span><span class="token section-name selector">mirror</span><span class="token punctuation">]</span></span>\n<span class="token comment">; The directory where the mirror data will be stored.</span>\n<span class="token key attr-name">directory</span> <span class="token punctuation">=</span> <span class="token value attr-value">/srv/pypi</span>\n</code></pre></div><h2 id="启动同步" tabindex="-1"><a class="header-anchor" href="#启动同步" aria-hidden="true">#</a> 启动同步</h2><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token punctuation">(</span>Bandersnatch<span class="token punctuation">)</span><span class="token punctuation">[</span>root@abc ~<span class="token punctuation">]</span>$ bandersnatch  mirror\n<span class="token number">2018</span>-01-02 <span class="token number">22</span>:45:44,376 INFO: bandersnatch/1.11 <span class="token punctuation">(</span>CPython <span class="token number">2.7</span>.5-final0, Linux <span class="token number">3.10</span>.0-693.2.2.el7.x86_64 x86_64<span class="token punctuation">)</span>\n<span class="token number">2018</span>-01-02 <span class="token number">22</span>:45:44,376 INFO: Status <span class="token function">file</span> missing. Starting over.\n<span class="token number">2018</span>-01-02 <span class="token number">22</span>:45:44,376 INFO: Syncing with https://pypi.python.org.\n<span class="token number">2018</span>-01-02 <span class="token number">22</span>:45:44,376 INFO: Current mirror serial: <span class="token number">0</span>\n<span class="token number">2018</span>-01-02 <span class="token number">22</span>:45:44,376 INFO: Syncing all packages.\n<span class="token punctuation">(</span>此处省略若干字<span class="token punctuation">)</span>\n</code></pre></div><h1 id="其他说明" tabindex="-1"><a class="header-anchor" href="#其他说明" aria-hidden="true">#</a> 其他说明</h1><p>因为使用了<code>virtualenv</code>, 将程序移植也很方便, 使用<code>tar -czvf Bandersnatch.tar.gz Bandersnatch </code>将文件夹打包,在其他主机(需要有python2)的相同目录下解包即可直接运行</p><p>如果要系统定期自动同步, 则创建<code>/etc/cron.d/bandersnatch</code>文件, 将下面内容写入</p><div class="language-bash ext-sh"><pre class="language-bash"><code>*/2 * * * * root bandersnatch mirror <span class="token operator">|&amp;</span> logger -t bandersnatch<span class="token punctuation">[</span>mirror<span class="token punctuation">]</span>\n</code></pre></div><p>该定时任务会将运行日志写入到系统日志里. <code>|&amp;</code> 代表 前者的标准输出和标准错误都作为后者的标准输入</p><p>本文主要参考了 https://pypi.python.org/pypi/bandersnatch</p>',33),p={render:function(n,a){return t}}}}]);
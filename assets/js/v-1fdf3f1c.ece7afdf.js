(self.webpackChunkvuepress_blog=self.webpackChunkvuepress_blog||[]).push([[112],{5937:(s,n,a)=>{"use strict";a.r(n),a.d(n,{data:()=>e});const e={key:"v-1fdf3f1c",path:"/linux/linux-common-commands.html",title:"Linux 下常用命令与技巧汇总",lang:"en-US",frontmatter:{title:"Linux 下常用命令与技巧汇总",author:"Peter Wang",tags:["linux","command"],date:"2018-01-07T10:10:50.000Z",draft:!1},excerpt:"",headers:[{level:3,title:"1. 查询系统准确的启动时间",slug:"_1-查询系统准确的启动时间",children:[]},{level:3,title:"2. 查询所有进程的准确启动时间和运行时长",slug:"_2-查询所有进程的准确启动时间和运行时长",children:[]},{level:3,title:"3. 设置时间",slug:"_3-设置时间",children:[]},{level:3,title:"4. 同步OS与硬件时间",slug:"_4-同步os与硬件时间",children:[]},{level:3,title:"5. 查看硬件信息",slug:"_5-查看硬件信息",children:[]},{level:3,title:"6 锁定文件,不被任何程序修改",slug:"_6-锁定文件-不被任何程序修改",children:[]},{level:3,title:"7. stat 查看文件详细元数据信息, 特别是inode",slug:"_7-stat-查看文件详细元数据信息-特别是inode",children:[]},{level:3,title:"8. xxd查看二进制文件",slug:"_8-xxd查看二进制文件",children:[]},{level:3,title:"9. 批量修改文件名",slug:"_9-批量修改文件名",children:[]},{level:3,title:"10. df 查询文件系统挂载点信息",slug:"_10-df-查询文件系统挂载点信息",children:[]},{level:3,title:"11. du 命令",slug:"_11-du-命令",children:[]},{level:3,title:"12. find删除查找到的文件",slug:"_12-find删除查找到的文件",children:[]},{level:3,title:"13. xargs 命令",slug:"_13-xargs-命令",children:[]},{level:3,title:"14. grep查询文本",slug:"_14-grep查询文本",children:[]},{level:3,title:"15. tail 查看文件指定行信息",slug:"_15-tail-查看文件指定行信息",children:[]},{level:3,title:"16. 批量创建目录",slug:"_16-批量创建目录",children:[]},{level:3,title:"17. echo 相关命令",slug:"_17-echo-相关命令",children:[]},{level:3,title:"18. nohup与标准输出,标准错误输出",slug:"_18-nohup与标准输出-标准错误输出",children:[]},{level:3,title:"19. Linux模块的安装和卸载",slug:"_19-linux模块的安装和卸载",children:[]},{level:3,title:"20. column格式化输出",slug:"_20-column格式化输出",children:[]},{level:3,title:"21. 通过pid查看进程的环境变量信息",slug:"_21-通过pid查看进程的环境变量信息",children:[]},{level:3,title:"22. 通过pid查看进程对应可执行文件的绝对路径",slug:"_22-通过pid查看进程对应可执行文件的绝对路径",children:[]},{level:3,title:"23. 通过pid查看进程的当前工作目录",slug:"_23-通过pid查看进程的当前工作目录",children:[]},{level:3,title:"24. lsof 一切皆文件",slug:"_24-lsof-一切皆文件",children:[]},{level:3,title:"25. fuser 查找访问文件系统的进程",slug:"_25-fuser-查找访问文件系统的进程",children:[]},{level:3,title:"26. dd 测试磁盘或者文件读写",slug:"_26-dd-测试磁盘或者文件读写",children:[]},{level:3,title:"27. rpm 安装/更新/卸载软件包",slug:"_27-rpm-安装-更新-卸载软件包",children:[]},{level:3,title:"28. yum 安装/更新/卸载软件包",slug:"_28-yum-安装-更新-卸载软件包",children:[]},{level:3,title:"29. 解压缩命令",slug:"_29-解压缩命令",children:[]},{level:3,title:"30. systemd 管理命令",slug:"_30-systemd-管理命令",children:[]},{level:3,title:"31. Ubuntu/Debian 检查已经安装好的软件包的更新日志",slug:"_31-ubuntu-debian-检查已经安装好的软件包的更新日志",children:[]},{level:3,title:"32. 搜索含有指定字符的手册页",slug:"_32-搜索含有指定字符的手册页",children:[]},{level:3,title:"33. 快速删除大量小文件",slug:"_33-快速删除大量小文件",children:[]},{level:3,title:"34. sysctl 管理系统参数",slug:"_34-sysctl-管理系统参数",children:[]},{level:3,title:"35. 清空文件内容",slug:"_35-清空文件内容",children:[]},{level:3,title:"36. 查询系统调用",slug:"_36-查询系统调用",children:[]},{level:3,title:"37. 查看磁盘uuid和文件系统类型",slug:"_37-查看磁盘uuid和文件系统类型",children:[]},{level:3,title:"38. 创建软连接",slug:"_38-创建软连接",children:[]},{level:3,title:"39. history查看历史记录",slug:"_39-history查看历史记录",children:[]},{level:3,title:"40. 查看进程的父子调用关系",slug:"_40-查看进程的父子调用关系",children:[]},{level:3,title:"41. rsync文件",slug:"_41-rsync文件",children:[]},{level:3,title:"42. 查询的动态库链接信息",slug:"_42-查询的动态库链接信息",children:[]},{level:3,title:"43. 查询ascii编码表",slug:"_43-查询ascii编码表",children:[]},{level:3,title:"44. iptable 内置防火墙",slug:"_44-iptable-内置防火墙",children:[]},{level:3,title:"45. tcpdump 抓包",slug:"_45-tcpdump-抓包",children:[]},{level:3,title:"46. DNS查询工具",slug:"_46-dns查询工具",children:[]},{level:3,title:"47. NTP时间同步",slug:"_47-ntp时间同步",children:[]},{level:3,title:"48. netstat查询网络连接信息",slug:"_48-netstat查询网络连接信息",children:[]},{level:3,title:"49. ethtool 网卡查询工具",slug:"_49-ethtool-网卡查询工具",children:[]},{level:3,title:"50. ip 网络维护",slug:"_50-ip-网络维护",children:[]},{level:3,title:"51. who 查看当前登录用户",slug:"_51-who-查看当前登录用户",children:[]},{level:3,title:"52. 使用iftop查看主机实时网络流量",slug:"_52-使用iftop查看主机实时网络流量",children:[]},{level:3,title:"53. Bash相关环境变量",slug:"_53-bash相关环境变量",children:[]},{level:3,title:"54. 查本机的公网IP",slug:"_54-查本机的公网ip",children:[]},{level:3,title:"55. 查询linux系统的一些限制信息",slug:"_55-查询linux系统的一些限制信息",children:[]},{level:3,title:"56. 判断虚拟化类型的N种方法",slug:"_56-判断虚拟化类型的n种方法",children:[]},{level:3,title:"57. cpu信息解读",slug:"_57-cpu信息解读",children:[]},{level:3,title:"58. taskset指定进程的CPU亲和性",slug:"_58-taskset指定进程的cpu亲和性",children:[]},{level:3,title:"59. Linux系统最大文件数量",slug:"_59-linux系统最大文件数量",children:[]},{level:3,title:"60. ss 查询socket连接信息",slug:"_60-ss-查询socket连接信息",children:[]},{level:3,title:"61. 消除用户被锁的错误登录记录",slug:"_61-消除用户被锁的错误登录记录",children:[]},{level:3,title:"62. 估计RSS总和的大小",slug:"_62-估计rss总和的大小",children:[]},{level:3,title:"63. 文件系统修复",slug:"_63-文件系统修复",children:[]},{level:3,title:"64. 非交互式修改密码",slug:"_64-非交互式修改密码",children:[]},{level:3,title:"66. udev管理",slug:"_66-udev管理",children:[]},{level:3,title:"67. 一条命令启动web服务器",slug:"_67-一条命令启动web服务器",children:[]},{level:3,title:"68. dpkg,apt-get包管理命令",slug:"_68-dpkg-apt-get包管理命令",children:[]},{level:3,title:"69. 主机安全入侵盘查",slug:"_69-主机安全入侵盘查",children:[]},{level:3,title:"70. top命令",slug:"_70-top命令",children:[]},{level:3,title:"71. ping命令",slug:"_71-ping命令",children:[]},{level:3,title:"72. ping和curl常见的网络报错",slug:"_72-ping和curl常见的网络报错",children:[]},{level:3,title:"73. 一些常用的内存统计命令",slug:"_73-一些常用的内存统计命令",children:[]},{level:3,title:"74. 不同OS的文件编码",slug:"_74-不同os的文件编码",children:[]},{level:3,title:"75. 一些shell循环命令",slug:"_75-一些shell循环命令",children:[]},{level:3,title:"76. dhcp持续请求配置",slug:"_76-dhcp持续请求配置",children:[]},{level:3,title:"77. 解析/proc/[pid]/status里关于信号的字段",slug:"_77-解析-proc-pid-status里关于信号的字段",children:[]},{level:3,title:"78. 审计谁杀了进程",slug:"_78-审计谁杀了进程",children:[]},{level:3,title:"79. 修改字符集的命令",slug:"_79-修改字符集的命令",children:[]},{level:3,title:"80. bash脚本的退出码",slug:"_80-bash脚本的退出码",children:[]},{level:3,title:"81. 模拟不断增加内存致使触发oom的程序",slug:"_81-模拟不断增加内存致使触发oom的程序",children:[]},{level:3,title:"82. vi实现十六进制编辑功能",slug:"_82-vi实现十六进制编辑功能",children:[]},{level:3,title:"83. iproute软件包里的一些常用命令",slug:"_83-iproute软件包里的一些常用命令",children:[]},{level:3,title:"84. 链接跟踪",slug:"_84-链接跟踪",children:[]},{level:3,title:"85. 一些汇编语法",slug:"_85-一些汇编语法",children:[]},{level:3,title:"86. 使用crash分析内核coredump的一些文章",slug:"_86-使用crash分析内核coredump的一些文章",children:[]},{level:3,title:"87. Linux内核模块相关",slug:"_87-linux内核模块相关",children:[]},{level:3,title:"88. ssh连接保活配置",slug:"_88-ssh连接保活配置",children:[]},{level:3,title:"89. 使用auditd审计功能",slug:"_89-使用auditd审计功能",children:[]},{level:3,title:"90. 分析磁盘性能",slug:"_90-分析磁盘性能",children:[]},{level:3,title:"91. Grub相关问题",slug:"_91-grub相关问题",children:[]},{level:3,title:"92. SLAB相关的知识",slug:"_92-slab相关的知识",children:[]},{level:3,title:"93. nfs相关的知识",slug:"_93-nfs相关的知识",children:[]},{level:3,title:"94. fork创建进程时的几个报错说明",slug:"_94-fork创建进程时的几个报错说明",children:[]}],filePathRelative:"linux/linux-common-commands.md",git:{updatedTime:1626591395e3,contributors:[]}}},5798:(s,n,a)=>{"use strict";a.r(n),a.d(n,{default:()=>p});const e=(0,a(6252).uE)('<p>收集自己常用到的linux命令与技巧,方便后续查找.不定期更新.</p><h3 id="_1-查询系统准确的启动时间" tabindex="-1"><a class="header-anchor" href="#_1-查询系统准确的启动时间" aria-hidden="true">#</a> 1. 查询系统准确的启动时间</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">date</span> -d <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">awk</span> -F. <span class="token string">&#39;{print $1}&#39;</span> /proc/uptime<span class="token variable">)</span></span> second ago&quot;</span> +<span class="token string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>\n<span class="token number">2018</span>-01-17 <span class="token number">22</span>:27:55\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">who</span> -b\n         system boot  <span class="token number">2018</span>-01-17 <span class="token number">22</span>:27\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">uptime</span> -s\n<span class="token number">2019</span>-09-04 00:40:58\n</code></pre></div><h3 id="_2-查询所有进程的准确启动时间和运行时长" tabindex="-1"><a class="header-anchor" href="#_2-查询所有进程的准确启动时间和运行时长" aria-hidden="true">#</a> 2. 查询所有进程的准确启动时间和运行时长</h3><p>-e 表示查询所有进程<br> -o 表示按指定的格式输出<br> lstart 为进程启动时间<br> etime可以显示已经运行了多长时间<br> args 为具体的命令行参数</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ps</span> -e -o pid,lstart,etime,args\n</code></pre></div><p><code>ps -efL</code> 加 <code>-L</code> 则显示线程</p><h3 id="_3-设置时间" tabindex="-1"><a class="header-anchor" href="#_3-设置时间" aria-hidden="true">#</a> 3. 设置时间</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">date</span> -s <span class="token string">&quot;dd/mm/yyyy hh:mm:ss&quot;</span>\n</code></pre></div><p>也可以在centos7下使用</p><div class="language-bash ext-sh"><pre class="language-bash"><code>timedatectl set-time <span class="token string">&quot;2012-10-30 18:17:16&quot;</span>\n</code></pre></div><h3 id="_4-同步os与硬件时间" tabindex="-1"><a class="header-anchor" href="#_4-同步os与硬件时间" aria-hidden="true">#</a> 4. 同步OS与硬件时间</h3><p>将OS系统时间同步到硬件(RTC)</p><div class="language-bash ext-sh"><pre class="language-bash"><code>hwclock –-systohc\n</code></pre></div><p>将硬件时间同步到OS</p><div class="language-bash ext-sh"><pre class="language-bash"><code>hwclock --hctosys\n</code></pre></div><h3 id="_5-查看硬件信息" tabindex="-1"><a class="header-anchor" href="#_5-查看硬件信息" aria-hidden="true">#</a> 5. 查看硬件信息</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>lscpu               <span class="token comment">#查看CPU信息</span>\nlspci               <span class="token comment">#查看PCI信息</span>\nlsusb               <span class="token comment">#查看外设USB</span>\nlsscsi              <span class="token comment">#查看SCSI设备</span>\nlsblk               <span class="token comment">#查看块设备</span>\ndmidecode -t memory <span class="token comment">#查内存槽位信息. 不跟 -t , 查全量processor, Memory, BIOS</span>\n</code></pre></div><h3 id="_6-锁定文件-不被任何程序修改" tabindex="-1"><a class="header-anchor" href="#_6-锁定文件-不被任何程序修改" aria-hidden="true">#</a> 6 锁定文件,不被任何程序修改</h3><p>chattr 可以改变文件扩展属性, <code>chattr +i</code> 可以防止任何程序修改该文件. 即使有root权限.<br> 常用于锁定dns配置,防止dhcp程序自动修改. <code>lsattr</code> 查看当前的扩展属性. <code>man chattr</code> 查看所有参数含义.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>chattr +i /etc/resolv.conf\n</code></pre></div><h3 id="_7-stat-查看文件详细元数据信息-特别是inode" tabindex="-1"><a class="header-anchor" href="#_7-stat-查看文件详细元数据信息-特别是inode" aria-hidden="true">#</a> 7. stat 查看文件详细元数据信息, 特别是inode</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">stat</span> messages\n  File: ‘messages’\n  Size: <span class="token number">0</span>         \tBlocks: <span class="token number">0</span>          IO Block: <span class="token number">4096</span>   regular empty <span class="token function">file</span>\nDevice: fd01h/64769d\tInode: <span class="token number">528438</span>      Links: <span class="token number">1</span>\nAccess: <span class="token punctuation">(</span>0600/-rw-------<span class="token punctuation">)</span>  Uid: <span class="token punctuation">(</span>    <span class="token number">0</span>/    root<span class="token punctuation">)</span>   Gid: <span class="token punctuation">(</span>    <span class="token number">0</span>/    root<span class="token punctuation">)</span>\nContext: system_u:object_r:var_log_t:s0\nAccess: <span class="token number">2018</span>-01-14 <span class="token number">21</span>:32:01.977218590 +0800\nModify: <span class="token number">2018</span>-01-14 <span class="token number">21</span>:32:01.977218590 +0800\nChange: <span class="token number">2018</span>-01-14 <span class="token number">21</span>:32:01.977218590 +0800\n Birth: -\n</code></pre></div><h3 id="_8-xxd查看二进制文件" tabindex="-1"><a class="header-anchor" href="#_8-xxd查看二进制文件" aria-hidden="true">#</a> 8. xxd查看二进制文件</h3><p>-s 指定起始位置(不指定则从0开始), -l 指定打印多少个字节</p><div class="language-bash ext-sh"><pre class="language-bash"><code>xxd  -s <span class="token number">1</span> -l <span class="token number">5</span> /etc/hosts\n</code></pre></div><p>当将js,或其他文本类信息嵌入到C程序时, <code>xxd -i</code> 非常实用.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ xxd a.js\n0000000: <span class="token number">7661</span> <span class="token number">7220</span> <span class="token number">6120</span> 3d20 310a                 var a <span class="token operator">=</span> <span class="token number">1</span>.\n$ xxd -i a.js\nunsigned char a_js<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n  0x76, 0x61, 0x72, 0x20, 0x61, 0x20, 0x3d, 0x20, 0x31, 0x0a\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\nunsigned int a_js_len <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>\n</code></pre></div><h3 id="_9-批量修改文件名" tabindex="-1"><a class="header-anchor" href="#_9-批量修改文件名" aria-hidden="true">#</a> 9. 批量修改文件名</h3><p>用法:<code>rename 原字符串 目标字符串 文件</code><br> 含义:<br> 原字符串：将文件名需要替换的字符串；<br> 目标字符串：将文件名中含有的原字符替换成目标字符串；<br> 文件：指定要改变文件名的文件列</p><div class="language-text ext-text"><pre class="language-text"><code>rename支持通配符\n?    可替代单个字符\n*    可替代多个字符\n[charset]    可替代charset集中的任意单个字符\n</code></pre></div><p>将所有已<code>yum</code>开头的文件的后缀名从<code>.yumtx</code>改为<code>.txt</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rename</span> .yumtx .txt yum*\n</code></pre></div><h3 id="_10-df-查询文件系统挂载点信息" tabindex="-1"><a class="header-anchor" href="#_10-df-查询文件系统挂载点信息" aria-hidden="true">#</a> 10. df 查询文件系统挂载点信息</h3><p><code>-h</code> 使容量的大小显示更人性化 <code>-T</code> 显示文件系统类型</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">df</span> -hT\nFilesystem                   Type      Size  Used Avail Use% Mounted on\n/dev/mapper/VolGroup-lv_root ext4       50G  <span class="token number">8</span>.0G   39G  <span class="token number">18</span>% /\ndevtmpfs                     devtmpfs  484M     <span class="token number">0</span>  484M   <span class="token number">0</span>% /dev\ntmpfs                        tmpfs     495M     <span class="token number">0</span>  495M   <span class="token number">0</span>% /dev/shm\ntmpfs                        tmpfs     495M  460K  494M   <span class="token number">1</span>% /run\ntmpfs                        tmpfs     495M     <span class="token number">0</span>  495M   <span class="token number">0</span>% /sys/fs/cgroup\n/dev/sda1                    ext4      477M  234M  215M  <span class="token number">53</span>% /boot\n/dev/mapper/VolGroup-lv_home ext4       12G   41M   11G   <span class="token number">1</span>% /home\ntmpfs                        tmpfs      99M     <span class="token number">0</span>   99M   <span class="token number">0</span>% /run/user/0\n</code></pre></div><p><code>-i</code> 显示inode容量</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">df</span> -hi\nFilesystem                   Inodes IUsed IFree IUse% Mounted on\n/dev/mapper/VolGroup-lv_root   <span class="token number">3</span>.2M  170K  <span class="token number">3</span>.0M    <span class="token number">6</span>% /\ndevtmpfs                       121K   <span class="token number">389</span>  121K    <span class="token number">1</span>% /dev\ntmpfs                          124K     <span class="token number">1</span>  124K    <span class="token number">1</span>% /dev/shm\ntmpfs                          124K   <span class="token number">498</span>  124K    <span class="token number">1</span>% /run\ntmpfs                          124K    <span class="token number">16</span>  124K    <span class="token number">1</span>% /sys/fs/cgroup\n/dev/sda1                      126K   <span class="token number">358</span>  125K    <span class="token number">1</span>% /boot\n/dev/mapper/VolGroup-lv_home   740K    <span class="token number">31</span>  740K    <span class="token number">1</span>% /home\ntmpfs                          124K     <span class="token number">1</span>  124K    <span class="token number">1</span>% /run/user/0\n</code></pre></div><h3 id="_11-du-命令" tabindex="-1"><a class="header-anchor" href="#_11-du-命令" aria-hidden="true">#</a> 11. du 命令</h3><p>单位是KB 如下获取/tmp下所有文件的大小, 并按降序排列</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">du</span> -xs /tmp/* <span class="token operator">|</span> <span class="token function">sort</span> -rn -k1\n<span class="token number">8</span>\tsystemd-private-415928f8a9ee431abb4fdb7f6265aa87-chronyd.service-uw9sq7\n<span class="token number">4</span>\t<span class="token builtin class-name">test</span>\n<span class="token number">4</span>\tempty\n<span class="token number">4</span>\ta.tar.gz\n</code></pre></div><h3 id="_12-find删除查找到的文件" tabindex="-1"><a class="header-anchor" href="#_12-find删除查找到的文件" aria-hidden="true">#</a> 12. find删除查找到的文件</h3><p>find命令经常会用到, <code>-type f</code>表示只返回文件, <code>-exec</code> 可将已找到的结果作为标准输入执行其他命令.</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">find</span> <span class="token operator">&lt;</span><span class="token environment constant">PATH</span><span class="token operator">&gt;</span> -type f -exec <span class="token function">rm</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>    <span class="token comment"># 删除查找到的文件, 将 path 改为实际要查找的目录</span>\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">find</span> <span class="token punctuation">[</span><span class="token environment constant">PATH</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>option<span class="token punctuation">]</span> <span class="token punctuation">[</span>action<span class="token punctuation">]</span>  \n\n-mtime n <span class="token builtin class-name">:</span> n为数字，意思为在n天之前的“一天内”被更改过的文件；  \n-mtime +n <span class="token builtin class-name">:</span> 列出在n天之前（不含n天本身）被更改过的文件名；  \n-mtime -n <span class="token builtin class-name">:</span> 列出在n天之内（含n天本身）被更改过的文件名；  \n-newer <span class="token function">file</span> <span class="token builtin class-name">:</span> 列出比file还要新的文件名  \n例如：  \n<span class="token function">find</span> /root -mtime <span class="token number">0</span> <span class="token comment"># 在当前目录下查找今天之内有改动的文件  </span>\n  \n与文件权限及名称有关的参数：  \n-name filename ：找出文件名为filename的文件  \n-size <span class="token punctuation">[</span>+-<span class="token punctuation">]</span>SIZE ：找出比SIZE还要大（+）或小（-）的文件  \n-tpye TYPE ：查找文件的类型为TYPE的文件，TYPE的值主要有：一般文件（f<span class="token punctuation">)</span>、设备文件（b、c）、  \n             目录（d）、连接文件（l）、socket（s）、FIFO管道文件（p）；  \n-perm mode ：查找文件权限刚好等于mode的文件，mode用数字表示，如0755；  \n-perm -mode ：查找文件权限必须要全部包括mode权限的文件，mode用数字表示  \n-perm +mode ：查找文件权限包含任一mode的权限的文件，mode用数字表示  \n例如：  \n<span class="token function">find</span> / -name <span class="token function">passwd</span> <span class="token comment"># 查找文件名为passwd的文件  </span>\n<span class="token function">find</span> <span class="token builtin class-name">.</span> -perm 0755 <span class="token comment"># 查找当前目录中文件权限的0755的文件  </span>\n<span class="token function">find</span> <span class="token builtin class-name">.</span> -size +12k <span class="token comment"># 查找当前目录中大于12KB的文件，注意c表示byte  </span>\n</code></pre></div><h3 id="_13-xargs-命令" tabindex="-1"><a class="header-anchor" href="#_13-xargs-命令" aria-hidden="true">#</a> 13. xargs 命令</h3><p>该命令可以将一个命令的输出作为参数传递给另一个命令。<br> 区别于管道符<code>|</code>是将将输出作为另一个命令的标准输入传递.</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">find</span> /tmp -name *.png -type f <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">tar</span> -cvzf images.tar.gz\n</code></pre></div><p>默认是将内容放到参数的最后面, 如果要放到指定位置,需要使用 <code>-i</code> 和 <code>{}</code><br> 如下所示，将第一个命令的输出放到<code>{}</code>出现的位置</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ls</span> /etc/*.conf <span class="token operator">|</span> <span class="token function">xargs</span> -i <span class="token function">cp</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> /home/likegeeks/Desktop/out\n</code></pre></div><h3 id="_14-grep查询文本" tabindex="-1"><a class="header-anchor" href="#_14-grep查询文本" aria-hidden="true">#</a> 14. grep查询文本</h3><p>在文件中查找字符串(不区分大小写)</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">grep</span> -i <span class="token string">&quot;the&quot;</span> /etc/hosts\n</code></pre></div><p>输出成功匹配的行，以及该行之后的三行. -B 表示前三行. -C 指前后三行</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">grep</span> -A <span class="token number">3</span> <span class="token string">&quot;localhost&quot;</span> /etc/hosts\n</code></pre></div><p>在一个文件夹中递归查询包含指定字符串的文件</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">grep</span> -r <span class="token string">&quot;abc&quot;</span> /etc\n</code></pre></div><p>查找不包含 127 的所有行</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">grep</span> -v <span class="token string">&quot;127&quot;</span> /etc/hosts\n</code></pre></div><p>递归搜索时忽略二进制文件,加参数<code>-I</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">grep</span> -r <span class="token string">&quot;abc&quot;</span> -I /etc\n</code></pre></div><h3 id="_15-tail-查看文件指定行信息" tabindex="-1"><a class="header-anchor" href="#_15-tail-查看文件指定行信息" aria-hidden="true">#</a> 15. tail 查看文件指定行信息</h3><p>显示最后3行记录</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">tail</span> -3 /var/log/yum.log-20180101\nDec <span class="token number">10</span> 00:35:55 Installed: libvirt-debuginfo-3.2.0-14.el7_4.3.x86_64\nDec <span class="token number">10</span> <span class="token number">18</span>:52:40 Installed: cloud-init-0.7.9-9.el7.centos.2.x86_64\nDec <span class="token number">10</span> <span class="token number">19</span>:50:30 Erased: cloud-init-0.7.9-9.el7.centos.2.x86_64\n</code></pre></div><p>从第770行开始显示</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">tail</span> -n +770 /var/log/yum.log-20180101\nDec <span class="token number">10</span> <span class="token number">18</span>:52:40 Installed: cloud-init-0.7.9-9.el7.centos.2.x86_64\nDec <span class="token number">10</span> <span class="token number">19</span>:50:30 Erased: cloud-init-0.7.9-9.el7.centos.2.x86_64\n</code></pre></div><h3 id="_16-批量创建目录" tabindex="-1"><a class="header-anchor" href="#_16-批量创建目录" aria-hidden="true">#</a> 16. 批量创建目录</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">mkdir</span> -p new_folder/<span class="token punctuation">{</span>folder_1,folder_2,folder_3,folder_4,folder_5<span class="token punctuation">}</span>\n</code></pre></div><h3 id="_17-echo-相关命令" tabindex="-1"><a class="header-anchor" href="#_17-echo-相关命令" aria-hidden="true">#</a> 17. echo 相关命令</h3><p>显示当前使用哪个shell</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token variable">$0</span>\n-bash\n</code></pre></div><p>显示最近一个命令执行的结果码</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>\n<span class="token number">0</span>\n</code></pre></div><h3 id="_18-nohup与标准输出-标准错误输出" tabindex="-1"><a class="header-anchor" href="#_18-nohup与标准输出-标准错误输出" aria-hidden="true">#</a> 18. nohup与标准输出,标准错误输出</h3><p><code>nohup</code>配和<code>&amp;</code>可以让进程在后台运行, 如果没有显示指定, 默认将标准输出和错误输出重定向到 nohup.out<br><code>1&gt;/dev/null</code> 首先表示标准输出重定向到空设备文件，也就是不输出任何信息到终端，不显示任何信息<br><code>2&gt;&amp;1</code> 表示标准错误输出重定向等同于标准输出，因为之前标准输出已经重定向到了空设备文件，所以标准错误输出也重定向到空设备文件<br> 常用使用方式为:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">nohup</span> COMMAND  <span class="token operator">&gt;</span>output.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>\n</code></pre></div><h3 id="_19-linux模块的安装和卸载" tabindex="-1"><a class="header-anchor" href="#_19-linux模块的安装和卸载" aria-hidden="true">#</a> 19. Linux模块的安装和卸载</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>lsmod                               <span class="token comment">#显示当前装入的内核模块</span>\nmodinfo module_name                 <span class="token comment">#显示模块信息</span>\nmodprobe -c                         <span class="token comment">#显示模块的配置信息       </span>\nmodprobe --show-depends module_name <span class="token comment">#显示模块的依赖信息</span>\nmodprobe module_name                <span class="token comment">#手动加载模块</span>\nrmmod module_name                   <span class="token comment">#卸载模块</span>\n</code></pre></div><p>systemd 读取 /etc/modules-load.d/ 中的配置加载额外的内核模块。配置文件名称通常为 <code>/etc/modules-load.d/&lt;program&gt;.conf</code>。如：</p><div class="language-text ext-text"><pre class="language-text"><code>$ cat /etc/modules-load.d/bonding.conf\nbonding\n</code></pre></div><p>使用 /etc/modprobe.d/中的文件来配置传递参数，如:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ /etc/modprobe.d/bonding.conf\noptions bonding <span class="token assign-left variable">mode</span><span class="token operator">=</span><span class="token number">1</span>\n</code></pre></div><p>别名</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /etc/modprobe.d/myalias.conf\n<span class="token comment"># Lets you use &#39;mymod&#39; in MODULES, instead of &#39;really_long_module_name&#39;</span>\n<span class="token builtin class-name">alias</span> mymod really_long_module_name\n</code></pre></div><p>如果模块直接编译进内核，也可以通过启动管理器(GRUB, LILO 或 Syslinux)的内核行加入参数： <code>modname.parametername=parametercontents</code></p><p>列出直接编译到内核的模块列表</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /lib/modules/<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -r<span class="token variable">)</span></span>/modules.builtin\nkernel/lib/zlib_deflate/zlib_deflate.ko\nkernel/lib/zlib_inflate/zlib_inflate.ko\nkernel/lib/crc16.ko\nkernel/lib/crc32.ko\n</code></pre></div><h3 id="_20-column格式化输出" tabindex="-1"><a class="header-anchor" href="#_20-column格式化输出" aria-hidden="true">#</a> 20. column格式化输出</h3><p>可以让一些命令的输出看起来更舒服些. 例如<code>blkid</code>,<code>mount</code>,<code>cat /etc/fstab</code>.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ blkid\n/dev/sda1: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;04f8e14d-906d-475a-bacc-7d4be966f670&quot;</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext4&quot;</span>\n/dev/sda2: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;8pXbJg-c7bG-CzS4-Xs9Y-SdBD-TYOJ-0r9hgF&quot;</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;LVM2_member&quot;</span>\n/dev/mapper/VolGroup-lv_swap: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;c058935d-34e0-403c-82f6-435b1c8194ce&quot;</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;swap&quot;</span>\n/dev/mapper/VolGroup-lv_root: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;e9fe20ee-5d6f-4610-98ca-7cbed5d012ad&quot;</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext4&quot;</span>\n/dev/mapper/VolGroup-lv_home: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;43578ba0-a809-4274-931d-b92f881196ad&quot;</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext4&quot;</span>\n$ blkid <span class="token operator">|</span> <span class="token function">column</span> -t\n/dev/sda1:                     <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;04f8e14d-906d-475a-bacc-7d4be966f670&quot;</span>    <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext4&quot;</span>\n/dev/sda2:                     <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;8pXbJg-c7bG-CzS4-Xs9Y-SdBD-TYOJ-0r9hgF&quot;</span>  <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;LVM2_member&quot;</span>\n/dev/mapper/VolGroup-lv_swap:  <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;c058935d-34e0-403c-82f6-435b1c8194ce&quot;</span>    <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;swap&quot;</span>\n/dev/mapper/VolGroup-lv_root:  <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;e9fe20ee-5d6f-4610-98ca-7cbed5d012ad&quot;</span>    <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext4&quot;</span>\n/dev/mapper/VolGroup-lv_home:  <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;43578ba0-a809-4274-931d-b92f881196ad&quot;</span>    <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext4&quot;</span>\n</code></pre></div><p><code>-s </code>参数指定可以指定分隔符. 默认是空格</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">grep</span> -E <span class="token string">&quot;sshd|qemu&quot;</span> /etc/passwd <span class="token operator">|</span> <span class="token function">column</span> -t -s:\nsshd  x  <span class="token number">74</span>   <span class="token number">74</span>   Privilege-separated SSH  /var/empty/sshd  /sbin/nologin\nqemu  x  <span class="token number">107</span>  <span class="token number">107</span>  qemu user                /                /sbin/nologin\n</code></pre></div><h3 id="_21-通过pid查看进程的环境变量信息" tabindex="-1"><a class="header-anchor" href="#_21-通过pid查看进程的环境变量信息" aria-hidden="true">#</a> 21. 通过pid查看进程的环境变量信息</h3><p>使用strings, 可以格式化打印</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ strings /proc/1158/environ\n<span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>en_US.UTF-8\n<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin\n<span class="token assign-left variable">NOTIFY_SOCKET</span><span class="token operator">=</span>/run/systemd/notify\n<span class="token assign-left variable">SSH_USE_STRONG_RNG</span><span class="token operator">=</span><span class="token number">0</span>\n</code></pre></div><h3 id="_22-通过pid查看进程对应可执行文件的绝对路径" tabindex="-1"><a class="header-anchor" href="#_22-通过pid查看进程对应可执行文件的绝对路径" aria-hidden="true">#</a> 22. 通过pid查看进程对应可执行文件的绝对路径</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>readlink /proc/<span class="token punctuation">[</span>pid<span class="token punctuation">]</span>/exe\n</code></pre></div><h3 id="_23-通过pid查看进程的当前工作目录" tabindex="-1"><a class="header-anchor" href="#_23-通过pid查看进程的当前工作目录" aria-hidden="true">#</a> 23. 通过pid查看进程的当前工作目录</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>pwdx <span class="token punctuation">[</span>pid<span class="token punctuation">]</span>\n</code></pre></div><h3 id="_24-lsof-一切皆文件" tabindex="-1"><a class="header-anchor" href="#_24-lsof-一切皆文件" aria-hidden="true">#</a> 24. lsof 一切皆文件</h3><p><code>-p [PID]</code> 只显示该进程打开的所有文件. 不带参数显示所有已打开的文件<br><code>-d</code> 对<code>FD</code>有效, 用于筛选文件列表. <code>^txt</code> 显示除txt 其他所有类型的文件. <code>1</code> 显示所有fd为1的文件. 可以使用<code>,</code>逗号连接多个选择<br><code>-a</code> 表示两个参数都必须满足 (AND)。如果没有 -a 标志，缺省的情况是显示匹配任何一个参数 (OR) 的文件<br><code>-n</code> 阻止网络地址转换<br><code>-P</code> 阻止端口号到端口名的转换<br><code>-i protocol:@ip:port</code> protocol 包括 tcp 和 udp. 显示符合该地址的文件列表 <code>-u s</code> s为用户名或者用户ID, 选择该用户下的文件</p><p><code>lsof [name]</code><br> name是 mount point或者文件系统对应的设备文件, 则显示在该文件系统上打开的所有文件列表<br> name是 文件夹(非mount point), 则显示所有将该文件夹作为正常文件打开的列表. 例如 cwd, rtd. 如果 <code>+d</code> 打印所有在该目录下已打开的文件,但不递归查找子目录. <code>+D </code>则允许递归查找</p><p>谁在使用 /var/log/audit/audit.log</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">lsof</span> /var/log/audit/audit.log\nCOMMAND PID <span class="token environment constant">USER</span>   FD   TYPE DEVICE SIZE/OFF   NODE NAME\nauditd  <span class="token number">669</span> root    5w   REG  <span class="token number">253,1</span>  <span class="token number">2027785</span> <span class="token number">524474</span> /var/log/audit/audit.log\n</code></pre></div><p>显示文件系统<code>/</code>下所有已打开的文件列表. 和<code>fuser /</code>效果一样</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">lsof</span> /\n</code></pre></div><p>所有在/var下已打开的文件</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">lsof</span> +D /var/spool/\nCOMMAND  PID    <span class="token environment constant">USER</span>   FD   TYPE DEVICE SIZE/OFF   NODE NAME\nmaster  <span class="token number">1297</span>    root  cwd    DIR  <span class="token number">253,1</span>     <span class="token number">4096</span> <span class="token number">524402</span> /var/spool/postfix\nmaster  <span class="token number">1297</span>    root   10uW  REG  <span class="token number">253,1</span>       <span class="token number">33</span> <span class="token number">524591</span> /var/spool/postfix/pid/master.pid\nqmgr    <span class="token number">1301</span> postfix  cwd    DIR  <span class="token number">253,1</span>     <span class="token number">4096</span> <span class="token number">524402</span> /var/spool/postfix\npickup  <span class="token number">4178</span> postfix  cwd    DIR  <span class="token number">253,1</span>     <span class="token number">4096</span> <span class="token number">524402</span> /var/spool/postfix\n</code></pre></div><p>列出tcpdump这个用户打开的所有文件</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">lsof</span> -u tcpdump\nCOMMAND   PID    <span class="token environment constant">USER</span>   FD   TYPE DEVICE SIZE/OFF    NODE NAME\ntcpdump <span class="token number">17905</span> tcpdump  cwd    DIR  <span class="token number">253,1</span>     <span class="token number">4096</span> <span class="token number">2752513</span> /root\ntcpdump <span class="token number">17905</span> tcpdump  rtd    DIR  <span class="token number">253,1</span>     <span class="token number">4096</span>       <span class="token number">2</span> /\ntcpdump <span class="token number">17905</span> tcpdump  txt    REG  <span class="token number">253,1</span>   <span class="token number">929928</span> <span class="token number">1323976</span> /usr/sbin/tcpdump\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>    <span class="token number">62184</span> <span class="token number">1328951</span> /usr/lib64/libnss_files-2.17.so\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG    <span class="token number">0,7</span>           <span class="token number">231120</span> socket:<span class="token punctuation">[</span><span class="token number">231120</span><span class="token punctuation">]</span> <span class="token punctuation">(</span>stat: No such <span class="token function">file</span> or directory<span class="token punctuation">)</span>\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>    <span class="token number">90664</span> <span class="token number">1311459</span> /usr/lib64/libz.so.1.2.7\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>    <span class="token number">19776</span> <span class="token number">1328757</span> /usr/lib64/libdl-2.17.so\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>  <span class="token number">2127336</span> <span class="token number">1314561</span> /usr/lib64/libc-2.17.so\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>   <span class="token number">266496</span> <span class="token number">1312167</span> /usr/lib64/libpcap.so.1.5.3\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>  <span class="token number">2512448</span> <span class="token number">1312014</span> /usr/lib64/libcrypto.so.1.0.2k\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>    <span class="token number">23968</span> <span class="token number">1311919</span> /usr/lib64/libcap-ng.so.0.0.0\ntcpdump <span class="token number">17905</span> tcpdump  mem    REG  <span class="token number">253,1</span>   <span class="token number">164264</span> <span class="token number">1311451</span> /usr/lib64/ld-2.17.so\ntcpdump <span class="token number">17905</span> tcpdump    0u   CHR  <span class="token number">136,1</span>      0t0       <span class="token number">4</span> /dev/pts/1\ntcpdump <span class="token number">17905</span> tcpdump    1u   CHR  <span class="token number">136,1</span>      0t0       <span class="token number">4</span> /dev/pts/1\ntcpdump <span class="token number">17905</span> tcpdump    2u   CHR  <span class="token number">136,1</span>      0t0       <span class="token number">4</span> /dev/pts/1\ntcpdump <span class="token number">17905</span> tcpdump    3u  pack <span class="token number">231120</span>      0t0     ALL <span class="token assign-left variable">type</span><span class="token operator">=</span>SOCK_RAW\ntcpdump <span class="token number">17905</span> tcpdump    4w   REG  <span class="token number">253,1</span>   <span class="token number">864256</span> <span class="token number">2756467</span> /root/abc2\n</code></pre></div><h3 id="_25-fuser-查找访问文件系统的进程" tabindex="-1"><a class="header-anchor" href="#_25-fuser-查找访问文件系统的进程" aria-hidden="true">#</a> 25. fuser 查找访问文件系统的进程</h3><p><code>-v</code> 显示具体的进程名和用户</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">fuser</span> -v /\n                     <span class="token environment constant">USER</span>        PID ACCESS COMMAND\n/:                   root     kernel <span class="token function">mount</span> /\n                     root          <span class="token number">1</span> .rc<span class="token punctuation">..</span> systemd\n                     root          <span class="token number">2</span> .rc<span class="token punctuation">..</span> kthreadd\n                     root          <span class="token number">3</span> .rc<span class="token punctuation">..</span> ksoftirqd/0\n                     root          <span class="token number">5</span> .rc<span class="token punctuation">..</span> kworker/0:0H\n</code></pre></div><p><code>-k</code> kill掉访问该文件系统的所有进程.慎用. 先使用上述命令查询</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">fuser</span> -k /\n</code></pre></div><h3 id="_26-dd-测试磁盘或者文件读写" tabindex="-1"><a class="header-anchor" href="#_26-dd-测试磁盘或者文件读写" aria-hidden="true">#</a> 26. dd 测试磁盘或者文件读写</h3><p>高危命令, <code>of</code>一定要指向正确的文件, 不要指 <code>/</code>, <code>/dev/vda</code>, <code>/dev/vda1</code>等系统重要设备.<br> 该命令要在测试环境验证充分.<br><code>if</code> 表示从哪个设备/文件读<br><code>of</code> 表示写到哪个设备/文件<br><code>bs</code> 表示一次读写多少字节. 也可以使用 1K, 1M这样带单位的<br><code>count</code> 表示最多读写多少次. 总的读写量为 <code>bs * count</code><br><code>/dev/zero</code> 可以无限读取<code>\\0</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/tmp/abc.txt <span class="token assign-left variable">bs</span><span class="token operator">=</span>1M <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">10</span>\n</code></pre></div><h3 id="_27-rpm-安装-更新-卸载软件包" tabindex="-1"><a class="header-anchor" href="#_27-rpm-安装-更新-卸载软件包" aria-hidden="true">#</a> 27. rpm 安装/更新/卸载软件包</h3><p>查询系统已安装的所有软件包</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -qa\n</code></pre></div><p>查询某个文件所属的软件包名. 文件必须是绝对路径</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -qf /etc/ssh/sshd_config\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -qf <span class="token variable"><span class="token variable">`</span><span class="token function">which</span> <span class="token function">strace</span><span class="token variable">`</span></span>\n</code></pre></div><p>查询包所含有的文件</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -ql <span class="token function">strace</span>\n</code></pre></div><p>查询包里的配置文件</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -qc openssh-server\n</code></pre></div><p>查询包里的文档</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -qd openssh-server\n</code></pre></div><p>查询软件包里的脚本信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">rpm</span> -q --scripts openssh-server\npreinstall scriptlet <span class="token punctuation">(</span>using /bin/sh<span class="token punctuation">)</span>:\ngetent group sshd <span class="token operator">&gt;</span>/dev/null <span class="token operator">||</span> <span class="token function">groupadd</span> -g <span class="token number">74</span> -r sshd <span class="token operator">||</span> <span class="token builtin class-name">:</span>\ngetent <span class="token function">passwd</span> sshd <span class="token operator">&gt;</span>/dev/null <span class="token operator">||</span> <span class="token punctuation">\\</span>\n  <span class="token function">useradd</span> -c <span class="token string">&quot;Privilege-separated SSH&quot;</span> -u <span class="token number">74</span> -g sshd <span class="token punctuation">\\</span>\n  -s /sbin/nologin -r -d /var/empty/sshd sshd <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> /dev/null <span class="token operator">||</span> <span class="token builtin class-name">:</span>\npostinstall scriptlet <span class="token punctuation">(</span>using /bin/sh<span class="token punctuation">)</span>:\n\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$1</span> -eq <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token comment"># Initial installation</span>\n        systemctl preset sshd.service sshd.socket <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">:</span>\n<span class="token keyword">fi</span>\npreuninstall scriptlet <span class="token punctuation">(</span>using /bin/sh<span class="token punctuation">)</span>:\n\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$1</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token comment"># Package removal, not upgrade</span>\n        systemctl --no-reload disable sshd.service sshd.socket <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">:</span>\n        systemctl stop sshd.service sshd.socket <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">:</span>\n<span class="token keyword">fi</span>\npostuninstall scriptlet <span class="token punctuation">(</span>using /bin/sh<span class="token punctuation">)</span>:\n\nsystemctl daemon-reload <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">:</span>\n<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$1</span> -ge <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>\n        <span class="token comment"># Package upgrade, not uninstall</span>\n        systemctl try-restart sshd.service <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token builtin class-name">:</span>\n<span class="token keyword">fi</span>\n</code></pre></div><p>查询包,自定义输出的格式和地段</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -qa --queryformat <span class="token string">&quot;%-35{NAME} %{VERSION} %{RELEASE} %{INSTALLTIME:date}<span class="token entity" title="\\n">\\n</span>&quot;</span>\njzlib                               <span class="token number">1.1</span>.1 <span class="token number">6</span>.el7 Thu <span class="token number">27</span> Jun <span class="token number">2019</span> <span class="token number">11</span>:30:01 AM HKT\nnss                                 <span class="token number">3.36</span>.0 <span class="token number">7.1</span>.el7_6 Tue <span class="token number">11</span> Jun <span class="token number">2019</span> <span class="token number">11</span>:13:42 PM HKT\nhamcrest                            <span class="token number">1.3</span> <span class="token number">6</span>.el7 Thu <span class="token number">27</span> Jun <span class="token number">2019</span> <span class="token number">11</span>:30:01 AM HKT\ndhcp-libs                           <span class="token number">4.2</span>.5 <span class="token number">68</span>.el7.centos.1 Tue <span class="token number">11</span> Jun <span class="token number">2019</span> <span class="token number">11</span>:13:43 PM HKT\n</code></pre></div><p>查询当前包的changelog. 常用于查看已解决的CVE列表</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -q --changelog openssh-server\n</code></pre></div><p>查询包所能提供的CAPABILITY</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -q --provides glibc\n</code></pre></div><p>查询哪些包依赖某个CAPABILITY</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -q --whatrequires <span class="token punctuation">[</span>CAPABILITY<span class="token punctuation">]</span>\n</code></pre></div><p>查询包所依赖的CAPABILITY</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -q -R glibc\n</code></pre></div><p>查询包所有提供的CAPABILITY</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -q --whatprovides <span class="token punctuation">[</span>CAPABILITY<span class="token punctuation">]</span>\n</code></pre></div><p>校验当前包与原始状态的差别.<br> 5 -- MD5 校验和<br> S -- 文件长度<br> L -- 符号链接<br> T -- 文件修改日期<br> D -- 设备<br> U -- 用户<br> G -- 用户组<br> M -- 模式 (包含许可和文件类型)<br> ? -- 不可读文件<br> 如下标志文件的md5, 文件长度, 修改日志有变化</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">rpm</span>  -V openssh-server\nS.5<span class="token punctuation">..</span><span class="token punctuation">..</span>T.  c /etc/ssh/sshd_config\n</code></pre></div><p>安装本地包 <code>-vh</code> 获得一个详细的安装进程 <code>--nodeps</code> 忽略依赖关系</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -ivh abc.rpm\n</code></pre></div><p>卸载包</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -e abc.rpm\n</code></pre></div><p>升级包</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -Uvh abc.rpm\n</code></pre></div><p>查询本地包的信息,要加<code>-p</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rpm</span> -ql -p abc.rpm\n</code></pre></div><h3 id="_28-yum-安装-更新-卸载软件包" tabindex="-1"><a class="header-anchor" href="#_28-yum-安装-更新-卸载软件包" aria-hidden="true">#</a> 28. yum 安装/更新/卸载软件包</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>yum <span class="token function">install</span> a            <span class="token comment">#安装软件包a   (加上-y选项，可以在安装软件包时，不弹出是否继续的提示)</span>\nyum <span class="token function">install</span> xxx --downloadonly --downloaddir<span class="token operator">=</span>/xxx  <span class="token comment">#只下载,不安装.</span>\nyum reinstall xxx        <span class="token comment">#重装</span>\nyum remove a             <span class="token comment">#卸载软件包a</span>\nyum <span class="token function">groups</span> list          <span class="token comment">#查看已安装的软件组和可用的软件组</span>\nyum <span class="token function">groups</span>  <span class="token function">install</span> <span class="token string">&quot;Basic Web Server&quot;</span>    <span class="token comment">#安装软件组</span>\nyum <span class="token function">groups</span> remove <span class="token string">&quot;Basic Web Server&quot;</span>      <span class="token comment">#卸载软件组</span>\nyum info a               <span class="token comment">#查看软件包a的相关信息，如大小，版本等...</span>\nyum update a             <span class="token comment">#更新软件包a</span>\nyum update               <span class="token comment">#整体更新所有可更新的软件包</span>\nyum provides 文件或目录    <span class="token comment">#查看文件由哪个rpm包提供的</span>\nyum search tree          <span class="token comment">#从仓库中搜索关键词为tree的包</span>\nyum <span class="token function">history</span>              <span class="token comment">#查看yum运行历史记录</span>\n</code></pre></div><blockquote><p>查找某个文件属于哪个包的方法有:<br> 如果文件已经安装在本机, 则<code>rpm -qf xxx</code><br> 如果文件没有在本机安装, 则<code>yum provides XXX</code> XXX 可以是文件名, 也可以使用glob这样的通配符去查找<br> 比如安装某rpm包, 提示文件没找到, 则可以使用 <code>yum provices xxx</code>. 比如文件名为 abc.txt, 用<code>yum provides *abc.txt</code>去查找</p></blockquote><p>查询当前在repo里指定包的所有可用版本, 可用于升级到特定版本. <code>yum update systemd</code>默认升级到最新版</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ yum list --showduplicates systemd\nInstalled Packages\nsystemd.x86_64                  <span class="token number">219</span>-42.el7_4.1                  @updates\nAvailable Packages\nsystemd.x86_64                  <span class="token number">219</span>-42.el7                      base\nsystemd.x86_64                  <span class="token number">219</span>-42.el7_4.1                  updates\nsystemd.x86_64                  <span class="token number">219</span>-42.el7_4.4                  updates\n</code></pre></div><p>升级指定包到特定的版本</p><div class="language-bash ext-sh"><pre class="language-bash"><code>yum <span class="token function">install</span> systemd-219-42.el7_4.4\n</code></pre></div><p>具体查看某次事务中安装,更新,删除的包列表</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ yum <span class="token function">history</span> info <span class="token number">307</span>\nLoaded plugins: auto-update-debuginfo, fastestmirror\nTransaction ID <span class="token builtin class-name">:</span> <span class="token number">307</span>\nBegin <span class="token function">time</span>     <span class="token builtin class-name">:</span> Sat Dec  <span class="token number">9</span> <span class="token number">20</span>:24:11 <span class="token number">2017</span>\nBegin rpmdb    <span class="token builtin class-name">:</span> <span class="token number">700</span>:b36eb7acc22b3ab4b107097d0b740dc6bfd84a58\nEnd <span class="token function">time</span>       <span class="token builtin class-name">:</span>            <span class="token number">20</span>:24:12 <span class="token number">2017</span> <span class="token punctuation">(</span><span class="token number">1</span> seconds<span class="token punctuation">)</span>\nEnd rpmdb      <span class="token builtin class-name">:</span> <span class="token number">701</span>:df2089f95d28d6f1f19561b39352bf3dd7a98c75\nUser           <span class="token builtin class-name">:</span> root <span class="token operator">&lt;</span>root<span class="token operator">&gt;</span>\nReturn-Code    <span class="token builtin class-name">:</span> Success\nCommand Line   <span class="token builtin class-name">:</span> <span class="token function">install</span> qemu-kvm\nTransaction performed with:\n    Installed     rpm-4.11.3-25.el7.x86_64                      @base\n    Installed     yum-3.4.3-154.el7.centos.noarch               @base\n    Installed     yum-plugin-fastestmirror-1.1.31-42.el7.noarch @base\nPackages Altered:\n    Updated qemu-img-10:1.5.3-141.el7_4.2.x86_64        @updates\n    Update           <span class="token number">10</span>:1.5.3-141.el7_4.4.x86_64        @updates\n    Install qemu-kvm-10:1.5.3-141.el7_4.4.x86_64        @updates\n    Updated qemu-kvm-common-10:1.5.3-141.el7_4.2.x86_64 @updates\n    Update                  <span class="token number">10</span>:1.5.3-141.el7_4.4.x86_64 @updates\n<span class="token function">history</span> info\n</code></pre></div><p>查询某个软件包的所有历史变更记录</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ yum <span class="token function">history</span> list  cloud-init\nLoaded plugins: auto-update-debuginfo, fastestmirror\nID     <span class="token operator">|</span> Command line             <span class="token operator">|</span> Date and <span class="token function">time</span>    <span class="token operator">|</span> Action<span class="token punctuation">(</span>s<span class="token punctuation">)</span>      <span class="token operator">|</span> Altered\n-------------------------------------------------------------------------------\n   <span class="token number">312</span> <span class="token operator">|</span> erase cloud-init         <span class="token operator">|</span> <span class="token number">2018</span>-01-11 00:07 <span class="token operator">|</span> Erase          <span class="token operator">|</span>    <span class="token number">1</span>\n   <span class="token number">311</span> <span class="token operator">|</span> <span class="token function">install</span> cloud-init       <span class="token operator">|</span> <span class="token number">2018</span>-01-11 00:01 <span class="token operator">|</span> Install        <span class="token operator">|</span>    <span class="token number">1</span>\n   <span class="token number">310</span> <span class="token operator">|</span> erase cloud-init         <span class="token operator">|</span> <span class="token number">2017</span>-12-10 <span class="token number">19</span>:50 <span class="token operator">|</span> Erase          <span class="token operator">|</span>    <span class="token number">1</span>\n   <span class="token number">309</span> <span class="token operator">|</span> <span class="token function">install</span> cloud-init       <span class="token operator">|</span> <span class="token number">2017</span>-12-10 <span class="token number">18</span>:52 <span class="token operator">|</span> Install        <span class="token operator">|</span>    <span class="token number">1</span>\n   <span class="token number">306</span> <span class="token operator">|</span> erase cloud-init         <span class="token operator">|</span> <span class="token number">2017</span>-12-09 <span class="token number">13</span>:09 <span class="token operator">|</span> Erase          <span class="token operator">|</span>    <span class="token number">1</span>\n   <span class="token number">301</span> <span class="token operator">|</span> <span class="token function">install</span> cloud-init       <span class="token operator">|</span> <span class="token number">2017</span>-10-14 <span class="token number">11</span>:49 <span class="token operator">|</span> Install        <span class="token operator">|</span>    <span class="token number">5</span>\n<span class="token function">history</span> list\n</code></pre></div><p>查询包的依赖关系</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ yum deplist <span class="token function">strace</span>\npackage: strace.x86_64 <span class="token number">4.12</span>-4.el7\n  dependency: /bin/sh\n   provider: bash.x86_64 <span class="token number">4.2</span>.46-29.el7_4\n  dependency: libc.so.6<span class="token punctuation">(</span>GLIBC_2.15<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: glibc.x86_64 <span class="token number">2.17</span>-196.el7_4.2\n  dependency: libgcc_s.so.1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libgcc.x86_64 <span class="token number">4.8</span>.5-16.el7_4.1\n  dependency: libgcc_s.so.1<span class="token punctuation">(</span>GCC_3.0<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libgcc.x86_64 <span class="token number">4.8</span>.5-16.el7_4.1\n  dependency: libgcc_s.so.1<span class="token punctuation">(</span>GCC_3.3.1<span class="token punctuation">)</span><span class="token punctuation">(</span>64bit<span class="token punctuation">)</span>\n   provider: libgcc.x86_64 <span class="token number">4.8</span>.5-16.el7_4.1\n  dependency: rtld<span class="token punctuation">(</span>GNU_HASH<span class="token punctuation">)</span>\n   provider: glibc.x86_64 <span class="token number">2.17</span>-196.el7_4.2\n   provider: glibc.i686 <span class="token number">2.17</span>-196.el7_4.2\n</code></pre></div><h3 id="_29-解压缩命令" tabindex="-1"><a class="header-anchor" href="#_29-解压缩命令" aria-hidden="true">#</a> 29. 解压缩命令</h3><p>tar.gz</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">tar</span> -xzvf abc.tar.gz               <span class="token comment">#解压缩</span>\n<span class="token function">tar</span> -xzvf abc.tar.gz -C /path      <span class="token comment">#解压缩到制动的path目录下</span>\n<span class="token function">tar</span> -tzvf abc.tar.gz               <span class="token comment">#不解压,只查看文件列表</span>\n<span class="token function">tar</span> -czvf abc.tar.gz a.txt b.txt   <span class="token comment">#将 a.txt 和 b.txt 压缩为 abc.tar.gz</span>\n</code></pre></div><p>.gz</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">gzip</span> -d FileName.gz      <span class="token comment">#解压</span>\n<span class="token function">gzip</span> FileName            <span class="token comment">#压缩</span>\n</code></pre></div><p>.bz .bz2</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">bzip2</span> -d FileName.bz2    <span class="token comment">#解压</span>\n</code></pre></div><p>.tar.bz .tar.bz2</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">tar</span> jxvf FileName.tar.bz2 <span class="token comment">#解压</span>\n</code></pre></div><p>.Z</p><div class="language-bash ext-sh"><pre class="language-bash"><code>uncompress FileName.Z    <span class="token comment">#解压</span>\ncompress FileName        <span class="token comment">#压缩</span>\n</code></pre></div><p>.zip</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">unzip</span> FileName.zip       <span class="token comment">#解压</span>\n<span class="token function">zip</span> FileName.zip DirName <span class="token comment">#压缩</span>\n</code></pre></div><p>.rar</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rar</span> x FileName.rar                <span class="token comment">#解压</span>\n<span class="token function">rar</span> a FileName.rar DirName        <span class="token comment">#压缩</span>\n</code></pre></div><p>.rpm</p><div class="language-bash ext-sh"><pre class="language-bash"><code>rpm2cpio FileName.rpm <span class="token operator">|</span> cpio -div   <span class="token comment">#解包</span>\n</code></pre></div><p>.deb</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ar p FileName.deb data.tar.gz <span class="token operator">|</span> <span class="token function">tar</span> -xzvf  <span class="token comment">#解包</span>\n</code></pre></div><h3 id="_30-systemd-管理命令" tabindex="-1"><a class="header-anchor" href="#_30-systemd-管理命令" aria-hidden="true">#</a> 30. systemd 管理命令</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>systemctl    -t <span class="token builtin class-name">help</span>            <span class="token comment">#列出所有的单元类型</span>\nsystemctl --type <span class="token string">&quot;unit&quot;</span>         <span class="token comment">#查看指定单元类型的状况, 替换 unit 为 &quot;mount&quot;, &quot;service&quot;, &quot;socket&quot;等</span>\nsystemctl --failed              <span class="token comment">#查看所有加载失败的单元信息</span>\nsystemctl status sshd           <span class="token comment">#查看sshd服务单元状况</span>\nsystemctl start sshd            <span class="token comment">#启动sshd服务单元</span>\nsystemctl stop sshd             <span class="token comment">#停止sshd服务单元</span>\nsystemctl restart sshd          <span class="token comment">#重启sshd服务单元</span>\nsystemctl <span class="token builtin class-name">enable</span> sshd           <span class="token comment">#配置sshd服务单元开机自动启动</span>\nsystemctl disable sshd          <span class="token comment">#配置sshd服务单元开机不启动</span>\nsystemctl reload sshd           <span class="token comment">#重新加载sshd服务单元的配置文件</span>\nsystemctl mask sshd             <span class="token comment">#彻底屏蔽sshd服务单元</span>\nsystemctl unmask sshd           <span class="token comment">#取消屏蔽sshd服务单元</span>\nsystemctl list-units            <span class="token comment">#列出当前所有的单元, 这是 systemctl 的默认命令</span>\nsystemctl get-default           <span class="token comment">#查看系统默认启动的Target</span>\nsystemctl set-default multi-user.target  <span class="token comment"># 设置系统默认的target为 多用户模式</span>\nsystemctl list-dependencies multi-user.target  <span class="token comment">#查看该target下所有的unit</span>\nsystemctl list-dependencies sshd   <span class="token comment"># 查看一个service所依赖的所有unit</span>\nsystemctl list-dependencies --reverse sshd   <span class="token comment"># 查看哪个unit依赖该服务</span>\nsystemctl list-dependencies --before sshd   <span class="token comment"># 查看所有unit after sshd, 也就是 sshd 配置里的before=</span>\nsystemctl list-dependencies --after sshd   <span class="token comment"># 查看所有unit before sshd</span>\nsystemctl <span class="token function">cat</span> sshd              <span class="token comment">#查看service的配置文件</span>\nsystemctl show sshd             <span class="token comment">#查看service的配置参数, 不带 service则显示默认的配置. 可用来查询nofile, noproc等限制资源参数</span>\nsystemctl list-jobs             <span class="token comment">#查看有哪些job仍在运行或者等待运行</span>\n</code></pre></div><blockquote><p>/etc/security/limits.conf无法设置systemd服务的资源限制. 参见:<br> http://smilejay.com/2016/06/centos-7-systemd-conf-limits/</p></blockquote><p>列出当前旧的LSB脚本</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemctl <span class="token operator">|</span> <span class="token function">grep</span> LSB\n  network.service       loaded active running   LSB: Bring up/down networking\n  prl-x11.service       loaded active exited    LSB: Autostart script <span class="token keyword">for</span> Parallels <span class="token function">service</span>\n  prltoolsd.service     loaded active running   LSB: Autostart script <span class="token keyword">for</span> guest tools service.\n</code></pre></div><p>查询systemd 版本</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemctl --version\nsystemd <span class="token number">219</span>\n+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ -LZ4 -SECCOMP +BLKID +ELFUTILS +KMOD +IDN\n</code></pre></div><p>查看启动耗时</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemd-analyze\nStartup finished <span class="token keyword">in</span> 579ms <span class="token punctuation">(</span>kernel<span class="token punctuation">)</span> + <span class="token number">2</span>.964s <span class="token punctuation">(</span>initrd<span class="token punctuation">)</span> + <span class="token number">8</span>.899s <span class="token punctuation">(</span>userspace<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">12</span>.442s\n</code></pre></div><p>查看每个服务的启动耗时,并打印TOP5</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemd-analyze blame <span class="token operator">|</span> <span class="token function">head</span> -5\n          <span class="token number">4</span>.949s NetworkManager-wait-online.service\n          <span class="token number">3</span>.379s network.service\n           987ms postfix.service\n           656ms dev-mapper-VolGroup<span class="token punctuation">\\</span>x2dlv_root.device\n           591ms lvm2-monitor.service\n</code></pre></div><p>打印最耗时的一条启动链, 后面跟指定的service, 则打印该服务的启动链</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemd-analyze critical-chain\nThe <span class="token function">time</span> after the unit is active or started is printed after the <span class="token string">&quot;@&quot;</span> character.\nThe <span class="token function">time</span> the unit takes to start is printed after the <span class="token string">&quot;+&quot;</span> character.\n\nmulti-user.target @8.863s\n└─postfix.service @7.864s +987ms\n  └─network.target @7.856s\n    └─NetworkManager.service @2.459s +64ms\n      └─network-pre.target @2.458s\n        └─firewalld.service @1.934s +523ms\n          └─polkit.service @1.724s +203ms\n            └─basic.target @1.721s\n              └─sockets.target @1.721s\n                └─iscsiuio.socket @1.721s\n                  └─sysinit.target @1.709s\n                    └─systemd-update-utmp.service @1.700s +8ms\n                      └─auditd.service @1.426s +272ms\n                        └─systemd-tmpfiles-setup.service @1.358s +58ms\n                          └─rhel-import-state.service @1.303s +52ms\n                            └─local-fs.target @1.299s\n                              └─home.mount @1.283s +15ms\n                                └─systemd-fsck@dev-mapper-VolGroup<span class="token punctuation">\\</span>x2dlv_home.service @1.266s +14ms\n                                  └─dev-mapper-VolGroup<span class="token punctuation">\\</span>x2dlv_home.device @1.265s\n</code></pre></div><p>生成启动瀑布图, 使用chrome浏览器打开 a.svg. 分析启动性能更加直观</p><div class="language-bash ext-sh"><pre class="language-bash"><code>systemd-analyze plot <span class="token operator">&gt;</span>a.svg\n</code></pre></div><p>启动瀑布图<br><img src="/img/systemd_plot.svg" alt="启动瀑布图"></p><p>journalctl 相关操作</p><div class="language-bash ext-sh"><pre class="language-bash"><code>journalctl                       <span class="token comment"># 查看所有日志（默认情况下 ，显示所有可以查看的日志）</span>\njournalctl -k                    <span class="token comment"># 查看内核日志（不显示应用日志）</span>\njournalctl -b                    <span class="token comment"># 查看系统本次启动的日志                 </span>\njournalctl -b -1                 <span class="token comment"># 查看上一次启动的日志（需更改设置）</span>\njournalctl -f               <span class="token comment"># 实时滚动显示最新日志</span>\njournalctl /usr/lib/systemd/systemd <span class="token comment"># 查看指定可执行文件的日志, 必须指定绝对路径</span>\njournalctl <span class="token assign-left variable">_PID</span><span class="token operator">=</span><span class="token number">1</span>                <span class="token comment"># 查看指定进程的日志</span>\njournalctl -u sshd               <span class="token comment"># 查看某个 Unit 的日志</span>\njournalctl --disk-usage          <span class="token comment"># 显示日志占据的硬盘空间</span>\njournalctl --list-boots          <span class="token comment"># 显示每次启动的id和时间</span>\n</code></pre></div><p>查看指定时间的日志</p><div class="language-bash ext-sh"><pre class="language-bash"><code>journalctl --since <span class="token string">&quot;2012-10-30 18:17:16&quot;</span>\njournalctl --since <span class="token string">&quot;2020-10-01&quot;</span>\njournalctl --since <span class="token string">&quot;20 min ago&quot;</span>\njournalctl --since <span class="token string">&quot;-5m&quot;</span>\njournalctl --since <span class="token string">&quot;-5d&quot;</span>\njournalctl --since yesterday\njournalctl --since <span class="token string">&quot;2015-01-10&quot;</span> --until <span class="token string">&quot;2015-01-11 03:00&quot;</span>\njournalctl --since 09:00 --until <span class="token string">&quot;1 hour ago&quot;</span>\n</code></pre></div><p>时间格式可参考<code>man journalctl</code>或者<code>man 7 systemd.time</code></p><h3 id="_31-ubuntu-debian-检查已经安装好的软件包的更新日志" tabindex="-1"><a class="header-anchor" href="#_31-ubuntu-debian-检查已经安装好的软件包的更新日志" aria-hidden="true">#</a> 31. Ubuntu/Debian 检查已经安装好的软件包的更新日志</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>zless /usr/share/doc/<span class="token operator">&lt;</span>package -name<span class="token operator">&gt;</span>/changelog.Debian.gz\nzless /usr/share/doc/<span class="token operator">&lt;</span>package -name<span class="token operator">&gt;</span>/changelog.gz\n</code></pre></div><h3 id="_32-搜索含有指定字符的手册页" tabindex="-1"><a class="header-anchor" href="#_32-搜索含有指定字符的手册页" aria-hidden="true">#</a> 32. 搜索含有指定字符的手册页</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">man</span> -k <span class="token function">logrotate</span>\ndh_installlogrotate <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> - <span class="token function">install</span> <span class="token function">logrotate</span> config files\n<span class="token function">logrotate</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> - rotates, compresses, and mails system logs\nlogrotate.conf <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> - rotates, compresses, and mails system logs\n</code></pre></div><h3 id="_33-快速删除大量小文件" tabindex="-1"><a class="header-anchor" href="#_33-快速删除大量小文件" aria-hidden="true">#</a> 33. 快速删除大量小文件</h3><p>使用<code>rsync</code>, 速度快但占用大量IO, 业务量低时使用. 高危命令</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">mkdir</span> empty_dir\n<span class="token function">rsync</span> -a --delete empty_dir/    yourdirectory/\n</code></pre></div><p>使用<code>find</code>, 速度慢但消耗IO少. <code>rm</code>会遇到<code>Argument list too long</code>报错</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">find</span> /tmp -type f -exec <span class="token function">rm</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>      <span class="token comment">#删除/tmp目录下所有文件</span>\n</code></pre></div><h3 id="_34-sysctl-管理系统参数" tabindex="-1"><a class="header-anchor" href="#_34-sysctl-管理系统参数" aria-hidden="true">#</a> 34. sysctl 管理系统参数</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>sysctl -a                                       <span class="token comment">#打印当前参数</span>\nsysctl -w net.ipv4.tcp_fin_timeout<span class="token operator">=</span><span class="token number">30</span>           <span class="token comment">#实时更新一个系统参数, 高危. 要验证好</span>\nsysctl -p                                       <span class="token comment">#读取/etc/sysctl.conf和 /etc/sysctl.d/下配置文件信息,使其生效  </span>\n</code></pre></div><h3 id="_35-清空文件内容" tabindex="-1"><a class="header-anchor" href="#_35-清空文件内容" aria-hidden="true">#</a> 35. 清空文件内容</h3><p>假设文件名为 abc.txt, 以下方法都可以清空该文件的内容</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> abc.txt\n<span class="token function">cp</span> /dev/null abc.txt\n</code></pre></div><h3 id="_36-查询系统调用" tabindex="-1"><a class="header-anchor" href="#_36-查询系统调用" aria-hidden="true">#</a> 36. 查询系统调用</h3><p>跟踪命令<code>ls -rlt</code>的系统调用, 将信息输出到<code>a.txt</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">strace</span> -ftT -o a.txt <span class="token function">ls</span> -rlt\n</code></pre></div><p>统计命令进行的系统调用信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">strace</span> -c <span class="token function">ls</span>\n</code></pre></div><p>跟踪具体的进程</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">strace</span> -p <span class="token punctuation">[</span>pid<span class="token punctuation">]</span>\n</code></pre></div><p>过滤系统调用</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">strace</span> -e <span class="token assign-left variable">trace</span><span class="token operator">=</span>open <span class="token function">ls</span>\n<span class="token function">strace</span> -e <span class="token assign-left variable">trace</span><span class="token operator">=</span>open,write <span class="token function">ls</span>\n</code></pre></div><h3 id="_37-查看磁盘uuid和文件系统类型" tabindex="-1"><a class="header-anchor" href="#_37-查看磁盘uuid和文件系统类型" aria-hidden="true">#</a> 37. 查看磁盘uuid和文件系统类型</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>$ lsblk -f\nNAME   FSTYPE LABEL UUID                                 MOUNTPOINT\nvda\n└─vda1 ext3         32236b41-fcde-460e-8c34-ba50515b33f2 /\n$ blkid\n/dev/vda1: <span class="token assign-left variable">UUID</span><span class="token operator">=</span><span class="token string">&quot;32236b41-fcde-460e-8c34-ba50515b33f2&quot;</span> <span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token string">&quot;ext3&quot;</span>\n</code></pre></div><h3 id="_38-创建软连接" tabindex="-1"><a class="header-anchor" href="#_38-创建软连接" aria-hidden="true">#</a> 38. 创建软连接</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ln</span> -s regular_file softlink          创建软连接\n</code></pre></div><h3 id="_39-history查看历史记录" tabindex="-1"><a class="header-anchor" href="#_39-history查看历史记录" aria-hidden="true">#</a> 39. history查看历史记录</h3><p>如果直接执行<code>history</code>没有显示时间戳,可以使用下面的命令</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token assign-left variable">HISTTIMEFORMAT</span><span class="token operator">=</span><span class="token string">&quot;%d/%m/%y %T&quot;</span>\n<span class="token function">history</span>\n</code></pre></div><h3 id="_40-查看进程的父子调用关系" tabindex="-1"><a class="header-anchor" href="#_40-查看进程的父子调用关系" aria-hidden="true">#</a> 40. 查看进程的父子调用关系</h3><p><code>-p</code> 显示pid信息. {}表示线程</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ pstree -p\nsystemd<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>─┬─agetty<span class="token punctuation">(</span><span class="token number">1176</span><span class="token punctuation">)</span>\n           ├─auditd<span class="token punctuation">(</span><span class="token number">669</span><span class="token punctuation">)</span>───<span class="token punctuation">{</span>auditd<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">670</span><span class="token punctuation">)</span>\n           ├─avahi-daemon<span class="token punctuation">(</span><span class="token number">701</span><span class="token punctuation">)</span>───avahi-daemon<span class="token punctuation">(</span><span class="token number">720</span><span class="token punctuation">)</span>\n           ├─chronyd<span class="token punctuation">(</span><span class="token number">721</span><span class="token punctuation">)</span>\n           ├─crond<span class="token punctuation">(</span><span class="token number">1169</span><span class="token punctuation">)</span>\n           ├─dbus-daemon<span class="token punctuation">(</span><span class="token number">702</span><span class="token punctuation">)</span>───<span class="token punctuation">{</span>dbus-daemon<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">730</span><span class="token punctuation">)</span>\n           ├─dhclient<span class="token punctuation">(</span><span class="token number">4673</span><span class="token punctuation">)</span>\n           ├─dnsmasq<span class="token punctuation">(</span><span class="token number">1344</span><span class="token punctuation">)</span>───dnsmasq<span class="token punctuation">(</span><span class="token number">1345</span><span class="token punctuation">)</span>\n           ├─firewalld<span class="token punctuation">(</span><span class="token number">776</span><span class="token punctuation">)</span>───<span class="token punctuation">{</span>firewalld<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">952</span><span class="token punctuation">)</span>\n           ├─gssproxy<span class="token punctuation">(</span><span class="token number">714</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">{</span>gssproxy<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">724</span><span class="token punctuation">)</span>\n           │               ├─<span class="token punctuation">{</span>gssproxy<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">725</span><span class="token punctuation">)</span>\n           │               ├─<span class="token punctuation">{</span>gssproxy<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">726</span><span class="token punctuation">)</span>\n           │               ├─<span class="token punctuation">{</span>gssproxy<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">727</span><span class="token punctuation">)</span>\n           │               └─<span class="token punctuation">{</span>gssproxy<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">728</span><span class="token punctuation">)</span>\n</code></pre></div><h3 id="_41-rsync文件" tabindex="-1"><a class="header-anchor" href="#_41-rsync文件" aria-hidden="true">#</a> 41. rsync文件</h3><p>rsync [OPTION]... SRC [SRC]... DEST<br> 在指定复制源时，路径是否有最后的 “/” 有不同的含义，例如：<br> /data ：表示将整个 /data 目录复制到目标目录<br> /data/ ：表示将 /data/ 目录中的所有内容复制到目标目录<br><code>--stats</code> : 输出文件传输的状态<br><code>--progress</code> : 输出文件传输的进度<br><code>-a</code>归档模式, 递归且保留符号链接，保留权限信息，时间戳，以及owner,group信息<br><code>-z</code> 打开压缩功能<br><code>-v</code> verbose更多打印信息<br> 本地同步</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rsync</span> -azv /var/opt/installation/inventory/ /root/temp/\n</code></pre></div><p>从本地到远端</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">rsync</span> -avz /root/temp/ thegeekstuff@192.168.200.10:/home/thegeekstuff/temp/\n</code></pre></div><h3 id="_42-查询的动态库链接信息" tabindex="-1"><a class="header-anchor" href="#_42-查询的动态库链接信息" aria-hidden="true">#</a> 42. 查询的动态库链接信息</h3><p>查询python这个程序依赖的所有动态库</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ ldd <span class="token variable"><span class="token variable">`</span><span class="token function">which</span> python<span class="token variable">`</span></span>\n\tlinux-vdso.so.1 <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token punctuation">(</span>0x00007fffb1fb4000<span class="token punctuation">)</span>\n\tlibpython2.7.so.1.0 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib64/libpython2.7.so.1.0 <span class="token punctuation">(</span>0x00007f5dee201000<span class="token punctuation">)</span>\n\tlibpthread.so.0 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib64/libpthread.so.0 <span class="token punctuation">(</span>0x00007f5dedfe5000<span class="token punctuation">)</span>\n\tlibdl.so.2 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib64/libdl.so.2 <span class="token punctuation">(</span>0x00007f5dedde0000<span class="token punctuation">)</span>\n\tlibutil.so.1 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib64/libutil.so.1 <span class="token punctuation">(</span>0x00007f5dedbdd000<span class="token punctuation">)</span>\n\tlibm.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib64/libm.so.6 <span class="token punctuation">(</span>0x00007f5ded8db000<span class="token punctuation">)</span>\n\tlibc.so.6 <span class="token operator">=</span><span class="token operator">&gt;</span> /lib64/libc.so.6 <span class="token punctuation">(</span>0x00007f5ded517000<span class="token punctuation">)</span>\n\t/lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x0000561b940b0000<span class="token punctuation">)</span>\n<span class="token punctuation">[</span>root@linux /tmp/new_folder<span class="token punctuation">]</span><span class="token comment">#</span>\n</code></pre></div><h3 id="_43-查询ascii编码表" tabindex="-1"><a class="header-anchor" href="#_43-查询ascii编码表" aria-hidden="true">#</a> 43. 查询ascii编码表</h3><p>速查编码信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">man</span> ascii\n</code></pre></div><h3 id="_44-iptable-内置防火墙" tabindex="-1"><a class="header-anchor" href="#_44-iptable-内置防火墙" aria-hidden="true">#</a> 44. iptable 内置防火墙</h3><p>iptables内置了4个表，即raw表、filter表、nat表和mangle表，默认操作filter表.</p><p>规则表之间的优先顺序如下：</p><div class="language-text ext-text"><pre class="language-text"><code>     Raw      --&gt;    mangle       -&gt;        nat    --&gt;      filter\nprerouting          prerouting          prerouting        input\noutput              postrouting         postrouting       output\n                    input               output            forward\n                    output\n                    forward\n</code></pre></div><p>查询表中的规则,当时打印匹配该规则的包和字节数</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -nvL\n</code></pre></div><p><code>REJECT</code> 拦阻该数据包，并返回数据包通知对方，可以返回的数据包有几个选择：ICMP port-unreachable、ICMP echo-reply 或是tcp-reset（这个数据包包会要求对方关闭联机），进行完此处理动作后，将不再比对其它规则，直接中断过滤程序。 范例如下：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -A  INPUT -p TCP --dport <span class="token number">22</span> -j REJECT --reject-with ICMP echo-reply\n</code></pre></div><p><code>DROP</code> 丢弃数据包不予处理，进行完此处理动作后，将不再比对其它规则，直接中断过滤程序。 <code>REDIRECT</code> 将封包重新导向到另一个端口（PNAT），进行完此处理动作后，将会继续比对其它规则。这个功能可以用来实作透明代理 或用来保护web 服务器。例如：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -t nat -A PREROUTING -p tcp --dport <span class="token number">80</span> -j REDIRECT--to-ports <span class="token number">8081</span>\n</code></pre></div><p><code>MASQUERADE</code> 改写封包来源IP为防火墙的IP，可以指定port 对应的范围，进行完此处理动作后，直接跳往下一个规则链（mangle:postrouting）。这个功能与SNAT略有不同，当进行IP 伪装时，不需指定要伪装成哪个 IP，IP 会从网卡直接读取，当使用拨接连线时，IP 通常是由ISP公司的DHCP服务器指派的，这个时候MASQUERADE特别有用。范例如下：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -t nat -A POSTROUTING -p TCP -j MASQUERADE --to-ports <span class="token number">21000</span>-31000\n</code></pre></div><p><code>LOG</code> 将数据包相关信息纪录在 /var/log 中，详细位置请查阅 /etc/syslog.conf 配置文件，进行完此处理动作后，将会继续比对其它规则。例如：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -A INPUT -p tcp -j LOG --log-prefix <span class="token string">&quot;input packet&quot;</span>\n</code></pre></div><p><code>SNAT</code> 改写封包来源IP为某特定IP或IP范围，可以指定port对应的范围，进行完此处理动作后，将直接跳往下一个规则炼（mangle:postrouting）.范例如下：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -t nat -A POSTROUTING -p tcp -o eth0 -j SNAT --to-source <span class="token number">192.168</span>.10.15-192.168.10.160:2100-3200\n</code></pre></div><p><code>DNAT</code> 改写数据包包目的地 IP 为某特定 IP 或 IP 范围，可以指定 port 对应的范围，进行完此处理动作后，将会直接跳往下一个规则链（filter:input 或 filter:forward）。范例如下：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -t nat -A PREROUTING -p tcp -d <span class="token number">15.45</span>.23.67 --dport <span class="token number">80</span> -j DNAT --to-destination <span class="token number">192.168</span>.10.1-192.168.10.10:80-100\n</code></pre></div><p><code>MIRROR</code> 镜像数据包，也就是将来源 IP与目的地IP对调后，将数据包返回，进行完此处理动作后，将会中断过滤程序。 <code>QUEUE</code> 中断过滤程序，将封包放入队列，交给其它程序处理。透过自行开发的处理程序，可以进行其它应用，例如：计算联机费用.......等。 <code>RETURN</code> 结束在目前规则链中的过滤程序，返回主规则链继续过滤，如果把自订规则炼看成是一个子程序，那么这个动作，就相当于提早结束子程序并返回到主程序中。 <code>MARK</code> 将封包标上某个代号，以便提供作为后续过滤的条件判断依据，进行完此处理动作后，将会继续比对其它规则。范例如下：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -t mangle -A PREROUTING -p tcp --dport <span class="token number">22</span> -j MARK --set-mark <span class="token number">22</span>\n</code></pre></div><p>清空iptables规则</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># set ACCEPT for default action</span>\niptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\n<span class="token comment"># flush all chains</span>\niptables -F\n<span class="token comment"># delete all  user-defined chains</span>\niptables -X\n</code></pre></div><p>丢弃TCP访问21端口的包</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -A INPUT -p tcp --dport <span class="token number">21</span> -j DROP\n</code></pre></div><p>加<code>--line-numbers</code>参数可以打印规则序号. 删除时用</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -nvL --line-numbers\n</code></pre></div><p>删除INPUT链里的第三个规则</p><div class="language-bash ext-sh"><pre class="language-bash"><code>iptables -D INPUT <span class="token number">3</span>\n</code></pre></div><p>https://blog.csdn.net/htmlxx/article/details/51412750<br> 这里记录了一些常用的iptables规则操作</p><h3 id="_45-tcpdump-抓包" tabindex="-1"><a class="header-anchor" href="#_45-tcpdump-抓包" aria-hidden="true">#</a> 45. tcpdump 抓包</h3><p>常用表达式:<br> 非 : ! or &quot;not&quot; (去掉双引号)<br> 且 : &amp;&amp; or &quot;and&quot;<br> 或 : || or &quot;or&quot;<br><code>-nn</code> 不转换地址和端口号 <code>-v</code> 打印详情</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -nnv\n</code></pre></div><p>抓取所有经过eth1，地址是192.168.1.1且端口号为25的所有包</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth1 <span class="token function">host</span> <span class="token number">192.168</span>.1.1 and port <span class="token number">25</span>\n</code></pre></div><p>-c count 抓取指定数目的包后退出</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -c <span class="token number">1000</span>\n</code></pre></div><p>-C file_size 循环抓包,当文件达到指定的大小后,将包写入到新文件.举例如下:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -i eth0 -C <span class="token number">1</span> -w abc\n$ <span class="token function">ls</span> -rlt abc*\n-rw-r--r--. <span class="token number">1</span> tcpdump tcpdump <span class="token number">1001078</span> Jan <span class="token number">14</span> <span class="token number">23</span>:33 abc\n-rw-r--r--. <span class="token number">1</span> tcpdump tcpdump  <span class="token number">647168</span> Jan <span class="token number">14</span> <span class="token number">23</span>:33 abc1\n</code></pre></div><p>抓取本机eth0网卡发往公网ip的数据包</p><div class="language-bash ext-sh"><pre class="language-bash"><code>tcpdump -n -i eth0 <span class="token string">&#39;not net 10.0.0.0/8 and not net 192.168.0.0/16 and not net 172.16.0.0/12&#39;</span>\n</code></pre></div><h3 id="_46-dns查询工具" tabindex="-1"><a class="header-anchor" href="#_46-dns查询工具" aria-hidden="true">#</a> 46. DNS查询工具</h3><p>指定DNS服务器递归查</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">dig</span> www.baidu.com @8.8.8.8\n\n<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> DiG <span class="token number">9.9</span>.4-RedHat-9.9.4-51.el7 <span class="token operator">&lt;&lt;</span><span class="token operator">&gt;&gt;</span> www.baidu.com @8.8.8.8\n<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd\n<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:\n<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">&gt;&gt;</span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">4712</span>\n<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">3</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>\n\n<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:\n<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">512</span>\n<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:\n<span class="token punctuation">;</span>www.baidu.com.\t\t\tIN\tA\n\n<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:\nwww.baidu.com.\t\t<span class="token number">1043</span>\tIN\tCNAME\twww.a.shifen.com.\nwww.a.shifen.com.\t<span class="token number">218</span>\tIN\tA\t<span class="token number">220.181</span>.112.244\nwww.a.shifen.com.\t<span class="token number">218</span>\tIN\tA\t<span class="token number">220.181</span>.111.188\n\n<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">78</span> msec\n<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">8.8</span>.8.8<span class="token comment">#53(8.8.8.8)</span>\n<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Mon Jan <span class="token number">15</span> 00:03:09 HKT <span class="token number">2018</span>\n<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">101</span>\n</code></pre></div><p>反解析</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">dig</span> -x <span class="token number">74.125</span>.135.105\n<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:\n<span class="token punctuation">;</span><span class="token number">105.135</span>.125.74.in-addr.arpa.   IN      PTR\n\n<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:\n<span class="token number">105.135</span>.125.74.in-addr.arpa. <span class="token number">83205</span> IN   PTR     ni-in-f105.1e100.net.\n</code></pre></div><p>全过程迭代跟踪</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">dig</span> +trace www.baidu.com\n</code></pre></div><h3 id="_47-ntp时间同步" tabindex="-1"><a class="header-anchor" href="#_47-ntp时间同步" aria-hidden="true">#</a> 47. NTP时间同步</h3><p>ntpdate 手工校准时间, 加 <code>-q</code> 只查询, 不同步时间, 加 <code>-d</code> 打开Debug模式, 但不真正更新时间</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ ntpdate ntp1.aliyun.com\n<span class="token number">15</span> Jan <span class="token number">23</span>:18:51 ntpdate<span class="token punctuation">[</span><span class="token number">18981</span><span class="token punctuation">]</span>: adjust <span class="token function">time</span> server <span class="token number">182.92</span>.12.11 offset <span class="token number">0.000643</span> sec\n</code></pre></div><p>安装<code>ntpd</code>时查询ntp同步状态的命令为<code>ntpq -p</code><br> 如果使用<code>chronyd</code>(centos7默认)是命令为<code>chronyc sources -v</code></p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ chronyc sources -v\n<span class="token number">210</span> Number of sources <span class="token operator">=</span> <span class="token number">2</span>\n\n  .-- Source mode  <span class="token string">&#39;^&#39;</span> <span class="token operator">=</span> server, <span class="token string">&#39;=&#39;</span> <span class="token operator">=</span> peer, <span class="token string">&#39;#&#39;</span> <span class="token operator">=</span> <span class="token builtin class-name">local</span> clock.\n / .- Source state <span class="token string">&#39;*&#39;</span> <span class="token operator">=</span> current synced, <span class="token string">&#39;+&#39;</span> <span class="token operator">=</span> combined , <span class="token string">&#39;-&#39;</span> <span class="token operator">=</span> not combined,\n<span class="token operator">|</span> /   <span class="token string">&#39;?&#39;</span> <span class="token operator">=</span> unreachable, <span class="token string">&#39;x&#39;</span> <span class="token operator">=</span> <span class="token function">time</span> may be <span class="token keyword">in</span> error, <span class="token string">&#39;~&#39;</span> <span class="token operator">=</span> <span class="token function">time</span> too variable.\n<span class="token operator">||</span>                                                 .- xxxx <span class="token punctuation">[</span> yyyy <span class="token punctuation">]</span> +/- zzzz\n<span class="token operator">||</span>      Reachability register <span class="token punctuation">(</span>octal<span class="token punctuation">)</span> -.           <span class="token operator">|</span>  xxxx <span class="token operator">=</span> adjusted offset,\n<span class="token operator">||</span>      Log2<span class="token punctuation">(</span>Polling interval<span class="token punctuation">)</span> --.      <span class="token operator">|</span>          <span class="token operator">|</span>  yyyy <span class="token operator">=</span> measured offset,\n<span class="token operator">||</span>                                <span class="token punctuation">\\</span>     <span class="token operator">|</span>          <span class="token operator">|</span>  zzzz <span class="token operator">=</span> estimated error.\n<span class="token operator">||</span>                                 <span class="token operator">|</span>    <span class="token operator">|</span>           <span class="token punctuation">\\</span>\nMS Name/IP address         Stratum Poll Reach LastRx Last sample\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>\n^* time5.aliyun.com              <span class="token number">2</span>   <span class="token number">6</span>    <span class="token number">37</span>    <span class="token number">41</span>  +2394ns<span class="token punctuation">[</span>+1057us<span class="token punctuation">]</span> +/-   15ms\n^- <span class="token number">120.25</span>.115.19                 <span class="token number">2</span>   <span class="token number">6</span>    <span class="token number">37</span>    <span class="token number">40</span>  -2559us<span class="token punctuation">[</span>-2559us<span class="token punctuation">]</span> +/-   67ms\n</code></pre></div><h3 id="_48-netstat查询网络连接信息" tabindex="-1"><a class="header-anchor" href="#_48-netstat查询网络连接信息" aria-hidden="true">#</a> 48. netstat查询网络连接信息</h3><p>查看所有tcp下监听端口, p表示打印相应的进程</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">netstat</span> -lntp\n</code></pre></div><p>查看所有已经建立的连接</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">netstat</span> -antp\n</code></pre></div><p>查看路由表</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">netstat</span> -rn\n</code></pre></div><p>查看网络统计信息进程</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">netstat</span> -s\n</code></pre></div><h3 id="_49-ethtool-网卡查询工具" tabindex="-1"><a class="header-anchor" href="#_49-ethtool-网卡查询工具" aria-hidden="true">#</a> 49. ethtool 网卡查询工具</h3><p><code>-i</code> 查网卡驱动信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ethtool</span> -i  eth0\ndriver: virtio_net\nversion: <span class="token number">1.0</span>.0\nfirmware-version:\nexpansion-rom-version:\nbus-info: 0000:00:05.0\nsupports-statistics: no\nsupports-test: no\nsupports-eeprom-access: no\nsupports-register-dump: no\nsupports-priv-flags: no\n</code></pre></div><p>不跟参数,显示速率,全双工模式等信息(虚拟机下没有)<br> Link 为<code>yes</code>表示 网线连接正常</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ethtool</span> eth0\nSettings <span class="token keyword">for</span> eth0:\n\tLink detected: <span class="token function">yes</span>\n</code></pre></div><h3 id="_50-ip-网络维护" tabindex="-1"><a class="header-anchor" href="#_50-ip-网络维护" aria-hidden="true">#</a> 50. ip 网络维护</h3><p>启用接口</p><div class="language-text ext-text"><pre class="language-text"><code>ip link set &lt;接口名&gt; up\n</code></pre></div><p>禁用接口</p><div class="language-text ext-text"><pre class="language-text"><code>ip link set &lt;接口名&gt; down\n</code></pre></div><p>设置接口MAC地址（设置前请先禁用接口）</p><div class="language-text ext-text"><pre class="language-text"><code>ip link set &lt;接口名&gt; address &lt;值&gt;\n</code></pre></div><p>设置接口MTU（设置前请先禁用接口） 例：把ens33的MTU改成9000并检查。</p><div class="language-text ext-text"><pre class="language-text"><code># ip link show dev ens33 #修改前\n\n2: ens33: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast state DOWN mode DEFAULT qlen 1000\n    link/ether 88:32:9b:ca:3f:49 brd ff:ff:ff:ff:ff:ff\n# ip link set ens33 mtu 9000\n\n# ip link show dev ens33  #修改后\n\n2: ens33: &lt;BROADCAST,MULTICAST&gt; mtu 9000 qdisc pfifo_fast state DOWN mode DEFAULT qlen 1000\n    link/ether 88:32:9b:ca:3f:49 brd ff:ff:ff:ff:ff:ff\n</code></pre></div><p>查看网卡的详细信息, 比如是bridge还是veth等类型</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> --details <span class="token function">link</span>\n<span class="token function">ip</span> <span class="token function">link</span>  show <span class="token builtin class-name">type</span> bridge  <span class="token comment">#显示所有的桥接设备</span>\n</code></pre></div><p>下面脚本可以显示每个链路的类型, 除了以太网</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token operator">!</span>/bin/bash\n\n<span class="token comment"># Arguments: $1: Interface (&#39;grep&#39;-regexp).</span>\n\n<span class="token comment"># Static list of types (from `ip link help`):</span>\n<span class="token assign-left variable">TYPES</span><span class="token operator">=</span><span class="token punctuation">(</span>bond bond_slave bridge dummy gre gretap ifb ip6gre ip6gretap ip6tnl ipip ipoib ipvlan macvlan macvtap nlmon sit vcan veth vlan vti vxlan tun tap<span class="token punctuation">)</span>\n\n<span class="token assign-left variable">iface</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">$1</span>&quot;</span>\n\n<span class="token keyword">for</span> <span class="token for-or-select variable">type</span> <span class="token keyword">in</span> <span class="token string">&quot;<span class="token variable">${TYPES<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>&quot;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>\n  <span class="token function">ip</span> <span class="token function">link</span> show <span class="token builtin class-name">type</span> <span class="token string">&quot;<span class="token variable">${type}</span>&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">&#39;^[0-9]+:&#39;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">&#39;:&#39;</span> -f <span class="token number">2</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&#39;s|^[[:space:]]*||&#39;</span> <span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> _if<span class="token punctuation">;</span> <span class="token keyword">do</span>\n    <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${_if}</span>:<span class="token variable">${type}</span>&quot;</span>\n  <span class="token keyword">done</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;^<span class="token variable">${iface}</span>&quot;</span>\n<span class="token keyword">done</span>\n</code></pre></div><p>查看网卡状态和对应的IP信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> addr\n</code></pre></div><p>给接口eth0赋予地址10.211.55.10 掩码是255.255.255.0(24代表掩码中1的个数)，广播地址是10.211.55.255</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.211</span>.55.10/24 dev eth0\n</code></pre></div><p>删除eth0上的 10.211.55.10</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> addr del <span class="token number">10.211</span>.55.10/24 dev eth0\n</code></pre></div><p>查看路由表信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ip</span> route\ndefault via <span class="token number">10.211</span>.55.1 dev eth0\n<span class="token number">10.211</span>.55.0/24 dev eth0 proto kernel scope <span class="token function">link</span> src <span class="token number">10.211</span>.55.9\n<span class="token number">192.168</span>.122.0/24 dev virbr0 proto kernel scope <span class="token function">link</span> src <span class="token number">192.168</span>.122.1\n</code></pre></div><p>查询目的地为<code>192.168.1.1</code>时选择的路由情况</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ip</span> route get <span class="token number">192.168</span>.1.1\n<span class="token number">192.168</span>.1.1 via <span class="token number">10.211</span>.55.1 dev eth0 src <span class="token number">10.211</span>.55.9\n    cache\n</code></pre></div><p>增加默认路由</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">20.0</span>.0.1\n</code></pre></div><p>策略性路由相对于传统的路由算法主要是引入了多路由表以及规则的概念。<br> 例如一个子网通过一个路由器与外界相连，路由器与外界有两条线路相连，其中一条的速度比较快，一条的速度比较慢。对于子网内的大多数用户来说对速度并没有特殊的要求，所以可以让他们用比较慢的路由；但是子网内有一些特殊的用户却是对速度的要求比较苛刻，所以他们需要使用速度比较快的路由。如果使用一张路由表上述要求是无法实现的，而如果根据源地址或其它参数，对不同的用户使用不同的路由表，这样就可以大大提高路由器的性能。<br> 优先级别越高的规则越先匹配（数值越小优先级别越高）。</p><p>系统内置3张表:</p><div class="language-text ext-text"><pre class="language-text"><code>表255 本地路由表（Local table）本地接口地址，广播地址，已及NAT地址都放在这个表。该路由表由系统自动维护，管理员不能直接修改。\n表254 主路由表（Main table）如果没有指明路由所属的表，所有的路由都默认都放在这个表里，route）所添加的路由都会加到这个表。\n表253 默认路由表（Default table）一般来说默认的路由都放在这张表，但是如果特别指明放的也可以是所有的网关路由。\n</code></pre></div><p>查看路由规则, <code>32766</code>表示优先级, 越小优先级越高.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ip</span> rule list\n<span class="token number">0</span>:\tfrom all lookup <span class="token builtin class-name">local</span>\n<span class="token number">32766</span>:\tfrom all lookup main\n<span class="token number">32767</span>:\tfrom all lookup default\n</code></pre></div><p>创建一个新的路由表, 原地址为<code>192.168.2.0/24</code>的消息全部路由到这张表里</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token builtin class-name">echo</span> <span class="token string">&quot;250 test&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/iproute2/rt_tables\n$ <span class="token function">ip</span> rule <span class="token function">add</span> from <span class="token number">192.168</span>.2.0/24 table <span class="token builtin class-name">test</span>\n</code></pre></div><p>上面的配置如果要持久化, 可以将命令写入<code>/etc/rc.d/rc.local</code>, 并给该文件可执行权限. <code>chmod +x /etc/rc.d/rc.local</code></p><p>查看某一张表里的路由信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ip</span> route list table main\n</code></pre></div><p>规则匹配的对象是所有的数据包，动作是选用路由表1的路由，这条规则的优先级是32800</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ip</span> rule <span class="token function">add</span> from <span class="token number">0</span>/0 table <span class="token number">1</span> pref <span class="token number">32800</span>\n</code></pre></div><p>规则匹配的对象是IP为192.168.3.112，tos等于0x10的包，使用路由表2，这条规则的优先级是1500</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> rule <span class="token function">add</span> from <span class="token number">192.168</span>.3.112/32 <span class="token punctuation">[</span>tos 0x10<span class="token punctuation">]</span> table ２ pref <span class="token number">1500</span>\n</code></pre></div><p>在table test里添加一条默认路由</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ip</span> route <span class="token function">add</span> default via <span class="token number">182.169</span>.1.1 table <span class="token builtin class-name">test</span>\n</code></pre></div><p>上面的规则是以源地址为关键字，作为是否匹配的依据的。除了源地址外，还可以用以下的信息：</p><div class="language-text ext-text"><pre class="language-text"><code>from -- 源地址\nto -- 目的地址（这里是选择规则时使用，查找路由表时也使用）\ntos -- IP包头的TOS（type of sevice）域\ndev -- 物理接口\nfwmark -- 防火墙参数\n</code></pre></div><p>采取的动作除了指定表，还可以指定下面的动作：</p><div class="language-text ext-text"><pre class="language-text"><code>Table 指明所使用的表\nNat 透明网关\nAction prohibit 丢弃该包，并发送 COMM.ADM.PROHIITED的ICMP信息\nReject 单纯丢弃该包\nUnreachable丢弃该包，并发送 NET UNREACHABLE的ICMP信息\n</code></pre></div><p>实际场景中尽量使用<code>ip rule to xxxx table xxx</code>针对目的IP指定路由表. 这样无论是收到请求后回复,或者主动发起请求都能匹配</p><p>具体的语法可参考<code>man ip-rule</code>和<code>man ip-route</code><br> https://www.redhat.com/sysadmin/beginners-guide-network-troubleshooting-linux<br> http://www.microhowto.info/troubleshooting/troubleshooting_the_routing_table.html</p><p>ip netns操作<br> https://www.cnblogs.com/sparkdev/p/9253409.html</p><h3 id="_51-who-查看当前登录用户" tabindex="-1"><a class="header-anchor" href="#_51-who-查看当前登录用户" aria-hidden="true">#</a> 51. who 查看当前登录用户</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">who</span>\nroot     pts/0        <span class="token number">2018</span>-01-17 <span class="token number">22</span>:28 <span class="token punctuation">(</span><span class="token number">10.211</span>.55.2<span class="token punctuation">)</span>\n</code></pre></div><h3 id="_52-使用iftop查看主机实时网络流量" tabindex="-1"><a class="header-anchor" href="#_52-使用iftop查看主机实时网络流量" aria-hidden="true">#</a> 52. 使用iftop查看主机实时网络流量</h3><p>类似top这样的交互式界面<br> 监控网卡的实时流量,反向解析IP,同时还显示具体每个连接接受和发送的流量<br> 注意显示流量的单位为b. 例如 <code>8Mb = 1MB</code>. 所有流量值都是 per second<br> 按<code>n</code>关闭主机名解析, 按<code>N</code>关闭端口号解析, 按<code>p</code>显示连接的端口号<br><code>iftop -f &quot;port 22&quot;</code>过滤只显示端口为22的连接的流量信息, 过滤语法跟<code>tcpdump</code>一样<br> 直接运行<code>iftop</code>, 得到如下信息:</p><blockquote><p>第一行类似刻度尺的刻度，为显示流量图形的长条作标尺用的。<br> &lt;= =&gt;这两个左右箭头，表示的是流量的方向。<br> TX：发送流量<br> RX：接收流量<br> TOTAL：总流量<br> Cumm：运行iftop到目前时间的总流量<br> peak：流量峰值<br> rates：分别表示过去 2s 10s 40s 的平均流量</p></blockquote><p><img src="/img/iftop.png" alt="iftop交互图"></p><h3 id="_53-bash相关环境变量" tabindex="-1"><a class="header-anchor" href="#_53-bash相关环境变量" aria-hidden="true">#</a> 53. Bash相关环境变量</h3><p>历史信息显示时间格式<br> 如下设置后, 使用<code>history</code>就会显示具体命令的具体执行时间.<br> 可以直接将其写在 .bashrc文件里</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token assign-left variable">HISTTIMEFORMAT</span><span class="token operator">=</span><span class="token string">&quot;%d/%m/%y %T &quot;</span>\n</code></pre></div><p>PS1变量 设置登录提示符, 如下带颜色显示当前用户, 主机名和当前目录的绝对路径.</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token assign-left variable"><span class="token environment constant">PS1</span></span><span class="token operator">=</span><span class="token string">&quot;[<span class="token entity" title="\\e">\\e</span>[1;31m\\u@\\h <span class="token entity" title="\\e">\\e</span>[0;34m<span class="token variable">${<span class="token environment constant">PWD</span>}</span><span class="token entity" title="\\e">\\e</span>[0m]<span class="token entity" title="\\\\">\\\\</span>$ &quot;</span>\n</code></pre></div><h3 id="_54-查本机的公网ip" tabindex="-1"><a class="header-anchor" href="#_54-查本机的公网ip" aria-hidden="true">#</a> 54. 查本机的公网IP</h3><p>通常我们的主机都在内网, 访问互联网是都是换成公网IP后去连接的<br> 如下是查询我们主机的公网IP</p><ol><li>打开百度 www.baidu.com</li><li>输出两个字符 <code>ip</code>, 敲回车</li><li>新页面显示的本机IP就是公网IP</li></ol><h3 id="_55-查询linux系统的一些限制信息" tabindex="-1"><a class="header-anchor" href="#_55-查询linux系统的一些限制信息" aria-hidden="true">#</a> 55. 查询linux系统的一些限制信息</h3><p>如下文章详细列举了redhat/centos各版本操作系统的重要限制信息.<br> 比如ext4限制, 最大cpu, 最大Memory<br> https://access.redhat.com/articles/rhel-limits</p><h3 id="_56-判断虚拟化类型的n种方法" tabindex="-1"><a class="header-anchor" href="#_56-判断虚拟化类型的n种方法" aria-hidden="true">#</a> 56. 判断虚拟化类型的N种方法</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>$ dmidecode -s system-manufacturer\nOpenStack Foundation\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemd-detect-virt\nkvm\n</code></pre></div><div class="language-bash ext-sh"><pre class="language-bash"><code>$ virt-what\nkvm\n</code></pre></div><h3 id="_57-cpu信息解读" tabindex="-1"><a class="header-anchor" href="#_57-cpu信息解读" aria-hidden="true">#</a> 57. cpu信息解读</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>$ lscpu\nArchitecture:          x86_64              // 架构 \nCPU op-mode<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:        <span class="token number">32</span>-bit, <span class="token number">64</span>-bit      // 位数\nByte Order:            Little Endian       // 小端\nCPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:                <span class="token number">2</span>                   // 逻辑cpu数\nOn-line CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span> list:   <span class="token number">0,1</span>\nThread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per core:    <span class="token number">1</span>                   // 一个核有一个线程. \nCore<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per socket:    <span class="token number">2</span>                   // 一个插槽有两个核\nSocket<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:             <span class="token number">1</span>                   // 总共一个插槽\nNUMA node<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:          <span class="token number">1</span>\nVendor ID:             GenuineIntel\nCPU family:            <span class="token number">6</span>\nModel:                 <span class="token number">69</span>\nModel name:            Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i5-4260U CPU @ <span class="token number">1</span>.40GHz\nStepping:              <span class="token number">1</span>\nCPU MHz:               <span class="token number">2000.000</span>\nBogoMIPS:              <span class="token number">4000.00</span>\nHypervisor vendor:     KVM                 // 虚拟化类型\nVirtualization type:   full                // 全虚拟化\nL1d cache:             32K\nL1i cache:             32K\nL2 cache:              256K\nL3 cache:              3072K\nNUMA node0 CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:     <span class="token number">0,1</span>\n<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>\n</code></pre></div><h3 id="_58-taskset指定进程的cpu亲和性" tabindex="-1"><a class="header-anchor" href="#_58-taskset指定进程的cpu亲和性" aria-hidden="true">#</a> 58. taskset指定进程的CPU亲和性</h3><p>返回的mask为十六进制, 3 代表 0x11 即绑定在cpu 0 和 1 上面. 最低位代表第一个cpu<br> taskset -p pid 返回pid对应进程当前的亲和性</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ taskset -p <span class="token number">691</span>\npid <span class="token number">691</span>&#39;s current affinity mask: <span class="token number">3</span>\n</code></pre></div><p><code>taskset -p mask pid</code>设置进程的cpu亲和性<br> 也可以使用数字代替mask, 比如 <code>taskset -c 0,1 -p 1</code> 表示为pid为1的进程绑定cpu0和1</p><p><code>taskset 1 ls</code> 执行ls命令是直接绑定到cpu0上.</p><p><code>/proc/[pid]/status</code>也可以查询, 举例:</p><blockquote><p>Cpus_allowed: 3<br> Cpus_allowed_list: 0-1<br> 解释:<br> Cpus_allowed:3指出该进程可以使用CPU的亲和性掩码,因为我们指定为两块CPU,所以这里就是3,如果该进程指定为4个CPU(如果有话),这里就是F(1111).<br> Cpus_allowed_list:0-1指出该进程可以使用CPU的列表,这里是0-1.</p></blockquote><p>进程运行时设置的亲和性并不影响其他线程, 如果要对java这样的多线程设置, 需要ps -efL 找到所有线程, 然后逐一设置<br><code>taskset 1 java</code>启动java命令时的绑定, 会应用到所有线程, 因为cpu的亲和性具有继承性</p><h3 id="_59-linux系统最大文件数量" tabindex="-1"><a class="header-anchor" href="#_59-linux系统最大文件数量" aria-hidden="true">#</a> 59. Linux系统最大文件数量</h3><p><code>ulimit -n</code>返回当前user单进程可打开的最大进程数<br><code>/proc/[pid]/limits</code> 查询该进程的资源限制数据<br><code>ls -rlt /proc/[pid]/fd | wc -l</code> 查询该进程当前已打开的文件数<br><code>lsof -p [pid] | wc -l </code> 也可查询, 但要过滤掉cwd, 动态库等<br><code>ulimit -n unlimited</code>是无效的, 进程级的文件句柄不支持<code>unlimited</code>, 最大值为 <code>/proc/sys/fs/nr_open</code>, 该值默认为1048576.</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># ulimit -n 1048577</span>\n-bash: ulimit: op<span class="token punctuation">]</span>en files: cannot modify limit: Operation not permitted\n<span class="token comment"># ulimit -n unlimited</span>\n-bash: ulimit: <span class="token function">open</span> files: cannot modify limit: Operation not permitted\n<span class="token comment"># cat /proc/sys/fs/nr_open</span>\n<span class="token number">1048576</span>\n</code></pre></div><p>在centos7上<code>nr_open</code>的最大值可调整为2147483584</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># sysctl -w fs.nr_open=2147483585</span>\nsysctl: setting key <span class="token string">&quot;fs.nr_open&quot;</span><span class="token builtin class-name">:</span> Invalid argument\nfs.nr_open <span class="token operator">=</span> <span class="token number">2147483585</span>\n<span class="token comment"># sysctl -w fs.nr_open=2147483584</span>\nfs.nr_open <span class="token operator">=</span> <span class="token number">2147483584</span>\n</code></pre></div><p>查询整个OS当前的文件数使用情况:<br> file-max显示所有进程的最大文件数, 可通过<code>echo 100000 &gt; /proc/sys/fs/file-max</code>提高</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /proc/sys/fs/file-max\n<span class="token number">97703</span>\n</code></pre></div><p>file-nr是只读的, 第一个字段代表已分配(即已打开)文件数, 第二个字段从2.6开始一直为0, 第三个字段等于file-max</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /proc/sys/fs/file-nr\n<span class="token number">1344</span>\t<span class="token number">0</span>\t<span class="token number">97703</span>\n</code></pre></div><p>列出每个进程的已打开的文件数, 用于找到当前哪个进程占用最多文件数<br><code>-d</code> 用于排除cwd, 动态库之类的信息<br><code>-n</code> 不用协议解析, 加快命令运行速度<br><code>lsof -n -d0-999999 | awk &#39;{print $2}&#39; | sort | uniq -c | sort -k1 -n</code></p><h3 id="_60-ss-查询socket连接信息" tabindex="-1"><a class="header-anchor" href="#_60-ss-查询socket连接信息" aria-hidden="true">#</a> 60. ss 查询socket连接信息</h3><p>类似于<code>netstat</code>, 使用了netlink, 性能更好</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ss -s                <span class="token comment">#显示各socket的统计信息</span>\nss -ntlp             <span class="token comment">#-n 不解析, -t 显示tcp连接  -l 显示监听socket, -p 显示使用的进程名</span>\nss -t -a             <span class="token comment">#查看所有tcp连接, 不带-a则指显示 Established 连接</span>\nss -to               <span class="token comment">#查看tcp的keepalive信息</span>\nss -ti               <span class="token comment">#查看tcp的内部信息,比如拥塞算法,rto,rtt,cwnd,ssthresh等</span>\nss -tm               <span class="token comment">#查看tcp的内存使用信息, 比如收发缓冲区的大小</span>\n</code></pre></div><p>还有一些高级的过滤用法</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ss  -A raw,packet_raw  -a -p                             <span class="token comment">#查看raw socket的信息</span>\nss -tn  state listening                                  <span class="token comment">#显示处于listening状态的连接</span>\nss -tn  state established                                <span class="token comment">#显示处于established状态的连接</span>\nss -tn  state listening  <span class="token string">&#39;( sport == 22 )&#39;</span>               <span class="token comment">#显示处于listening状态且源端口为22的连接</span>\nss -tn <span class="token string">&#39;( sport == 22 )&#39;</span>                                 <span class="token comment">#显示源端口为22的连接</span>\nss -tn <span class="token string">&#39;( sport != 22 )&#39;</span>                                 <span class="token comment">#显示源端口不为22的连接</span>\nss -tn <span class="token string">&#39;( sport == 22 || dport == 22 )&#39;</span>                  <span class="token comment">#显示源端口为22或者目标端口为22的连接</span>\nss -tn <span class="token string">&#39;( dst 10.211.55.2 &amp;&amp; dport == 58181 )&#39;</span>           <span class="token comment">#显示目标ip为10.211.55.2且目标端口为58181的连接</span>\nss -tn <span class="token string">&#39;( src 127.0.0.1 )&#39;</span>                               <span class="token comment">#显示源ip为 127.0.0.1的连接</span>\nss -tn <span class="token string">&#39;( ! dst 10.211.55.2 &amp;&amp; dport != 58181 )&#39;</span>         <span class="token comment">#显示目标ip不是10.211.55.2且目标端口不是58181的连接</span>\n</code></pre></div><p>state后面支持的TCP状态如下:</p><div class="language-c ext-c"><pre class="language-c"><code>\t<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span> sstate_namel<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>\n\t\t<span class="token string">&quot;UNKNOWN&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_ESTABLISHED<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;established&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_SYN_SENT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;syn-sent&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_SYN_RECV<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;syn-recv&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_FIN_WAIT1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;fin-wait-1&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_FIN_WAIT2<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;fin-wait-2&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_TIME_WAIT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;time-wait&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_CLOSE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;unconnected&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_CLOSE_WAIT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;close-wait&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_LAST_ACK<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;last-ack&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_LISTEN<span class="token punctuation">]</span> <span class="token operator">=</span>\t<span class="token string">&quot;listening&quot;</span><span class="token punctuation">,</span>\n\t\t<span class="token punctuation">[</span>SS_CLOSING<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;closing&quot;</span><span class="token punctuation">,</span>\n\t<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre></div><p>更多使用介绍请参考:<br> https://www.cyberciti.biz/tips/linux-investigate-sockets-network-connections.html<br> https://man7.org/linux/man-pages/man8/ss.8.html<br> https://github.com/shemminger/iproute2/blob/main/misc/ssfilter.y</p><h3 id="_61-消除用户被锁的错误登录记录" tabindex="-1"><a class="header-anchor" href="#_61-消除用户被锁的错误登录记录" aria-hidden="true">#</a> 61. 消除用户被锁的错误登录记录</h3><p>通常管理员会配置pam_faillock或者pam_tally2, 当用户使用错误密码满足一定条件, 就将用户锁定一段时间. 如下是即时清除错误记录的命令</p><div class="language-bash ext-sh"><pre class="language-bash"><code>faillock --reset\npam_tally2 -r -u <span class="token punctuation">[</span>username<span class="token punctuation">]</span>\n</code></pre></div><h3 id="_62-估计rss总和的大小" tabindex="-1"><a class="header-anchor" href="#_62-估计rss总和的大小" aria-hidden="true">#</a> 62. 估计RSS总和的大小</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{sum+=$6} END {print sum / 1024}&#39;</span>\n</code></pre></div><p>如下脚本也可以:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> rss.sh\n<span class="token comment">#/bin/bash</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">PROC</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span>  /proc/<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">&quot;^[0-9]&quot;</span><span class="token variable">`</span></span>\n<span class="token keyword">do</span>\n  <span class="token keyword">if</span> <span class="token punctuation">[</span> -f /proc/<span class="token variable">$PROC</span>/statm <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>\n      <span class="token assign-left variable">TEP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /proc/$PROC/statm <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print ($2)}&#39;</span><span class="token variable">`</span></span>\n      <span class="token assign-left variable">RSS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> $RSS + $TEP<span class="token variable">`</span></span>\n  <span class="token keyword">fi</span>\n<span class="token keyword">done</span>\n<span class="token assign-left variable">RSS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">expr</span> $RSS <span class="token punctuation">\\</span>* <span class="token number">4</span><span class="token variable">`</span></span>\n<span class="token builtin class-name">echo</span> <span class="token variable">$RSS</span><span class="token string">&quot;KB&quot;</span>\n</code></pre></div><h3 id="_63-文件系统修复" tabindex="-1"><a class="header-anchor" href="#_63-文件系统修复" aria-hidden="true">#</a> 63. 文件系统修复</h3><p>针对xfs, 使用<code>xfs_repair</code>命令:<br><code>-n</code> 表示不修复, 只扫描并显示错误</p><div class="language-bash ext-sh"><pre class="language-bash"><code>xfs_repair -n -v /dev/mapper/vg-home\n</code></pre></div><p>不带<code>-n</code>, 执行修复. <code>-v</code>表示显示详情</p><div class="language-bash ext-sh"><pre class="language-bash"><code>xfs_repair -v /dev/mapper/vg-home\n</code></pre></div><p>最后方法：损失部分数据的修复方法<br> 根据打印消息，修复失败时：<br> 先执行xfs_repair -L /dev/sdd(清空日志，会丢失文件)，再执行xfs_repair /dev/sdd，再执行xfs_check /dev/sdd 检查文件系统是否修复成功。</p><blockquote><p>-L是修复xfs文件系统的最后手段，慎重选择，它会清空日志，会丢失用户数据和文件。</p></blockquote><h3 id="_64-非交互式修改密码" tabindex="-1"><a class="header-anchor" href="#_64-非交互式修改密码" aria-hidden="true">#</a> 64. 非交互式修改密码</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;Linux@123&quot;</span> <span class="token operator">|</span><span class="token function">passwd</span> --stdin root\n</code></pre></div><h3 id="_66-udev管理" tabindex="-1"><a class="header-anchor" href="#_66-udev管理" aria-hidden="true">#</a> 66. udev管理</h3><p>查询设备的信息, 主要是环境变量</p><div class="language-bash ext-sh"><pre class="language-bash"><code>udevadm info /dev/sda1\nP: /devices/pci0000:00/0000:00:1f.2/ata1/host0/target0:0:0/0:0:0:0/block/sda/sda1\nN: sda1\nS: disk/by-id/ata-CentOS_Linux-0_SSD_FFACPKN8NC9MK3EX3N4R-part1\nS: disk/by-uuid/5de1c8df-9b03-4830-9b56-b96a2290b78f\nE: <span class="token assign-left variable">DEVLINKS</span><span class="token operator">=</span>/dev/disk/by-id/ata-CentOS_Linux-0_SSD_FFACPKN8NC9MK3EX3N4R-part1 /dev/disk/by-uuid/5de1c8df-9b03-4830-9b56-b96a2290b78f\nE: <span class="token assign-left variable">DEVNAME</span><span class="token operator">=</span>/dev/sda1\nE: <span class="token assign-left variable">DEVPATH</span><span class="token operator">=</span>/devices/pci0000:00/0000:00:1f.2/ata1/host0/target0:0:0/0:0:0:0/block/sda/sda1\nE: <span class="token assign-left variable">DEVTYPE</span><span class="token operator">=</span>partition\nE: <span class="token assign-left variable">ID_ATA</span><span class="token operator">=</span><span class="token number">1</span>\nE: <span class="token assign-left variable">ID_ATA_ROTATION_RATE_RPM</span><span class="token operator">=</span><span class="token number">0</span>\nE: <span class="token assign-left variable">ID_ATA_SATA</span><span class="token operator">=</span><span class="token number">1</span>\nE: <span class="token assign-left variable">ID_ATA_SATA_SIGNAL_RATE_GEN1</span><span class="token operator">=</span><span class="token number">1</span>\n</code></pre></div><p>加参数<code>-a</code>, 主要是设备的属性.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>udevadm info -a /dev/sda1\nP: /devices/pci0000:00/0000:00:1f.2/ata1/host0/target0:0:0/0:0:0:0/block/sda/sda1\nN: sda1\nS: disk/by-id/ata-CentOS_Linux-0_SSD_FFACPKN8NC9MK3EX3N4R-part1\nS: disk/by-uuid/5de1c8df-9b03-4830-9b56-b96a2290b78f\nE: <span class="token assign-left variable">DEVLINKS</span><span class="token operator">=</span>/dev/disk/by-id/ata-CentOS_Linux-0_SSD_FFACPKN8NC9MK3EX3N4R-part1 /dev/disk/by-uuid/5de1c8df-9b03-4830-9b56-b96a2290b78f\nE: <span class="token assign-left variable">DEVNAME</span><span class="token operator">=</span>/dev/sda1\nE: <span class="token assign-left variable">DEVPATH</span><span class="token operator">=</span>/devices/pci0000:00/0000:00:1f.2/ata1/host0/target0:0:0/0:0:0:0/block/sda/sda1\nE: <span class="token assign-left variable">DEVTYPE</span><span class="token operator">=</span>partition\nE: <span class="token assign-left variable">ID_ATA</span><span class="token operator">=</span><span class="token number">1</span>\nE: <span class="token assign-left variable">ID_ATA_ROTATION_RATE_RPM</span><span class="token operator">=</span><span class="token number">0</span>\nE: <span class="token assign-left variable">ID_ATA_SATA</span><span class="token operator">=</span><span class="token number">1</span>\nE: <span class="token assign-left variable">ID_ATA_SATA_SIGNAL_RATE_GEN1</span><span class="token operator">=</span><span class="token number">1</span>\n</code></pre></div><p><code>udevadmin monitor</code>用于实时监控udev实践,定位热插拔设备时特别有用.<br><code>udevadmin test xxxx</code>用于测试匹配设备的规则执行动作.<br> xxx可以是<code>/sys/class/block/sda</code>,<code>/sys/class/net/eth0</code>, 也可以是<code>/sys/devices</code>下面的设备</p><p>修改<code>/etc/udev/udev.conf</code>里的<code>udev_log=&quot;debug&quot;</code>可以打开更详细的日志<br> 使用<code>journalctl -u systemd-udevd</code>查看</p><h3 id="_67-一条命令启动web服务器" tabindex="-1"><a class="header-anchor" href="#_67-一条命令启动web服务器" aria-hidden="true">#</a> 67. 一条命令启动web服务器</h3><p>查询设备的信息, 主要是环境变量</p><div class="language-bash ext-sh"><pre class="language-bash"><code>python -m SimpleHTTPServer <span class="token number">8000</span>\n</code></pre></div><h3 id="_68-dpkg-apt-get包管理命令" tabindex="-1"><a class="header-anchor" href="#_68-dpkg-apt-get包管理命令" aria-hidden="true">#</a> 68. dpkg,apt-get包管理命令</h3><p>查询所有包</p><div class="language-bash ext-sh"><pre class="language-bash"><code>dpkg -l\n</code></pre></div><p>查询某个文件属于哪个包</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ dpkg -S /usr/bin/growpart\ncloud-guest-utils: /usr/bin/growpart\n</code></pre></div><p>查询使用apt-get安装的历史记录</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /var/log/apt/history.log\n</code></pre></div><h3 id="_69-主机安全入侵盘查" tabindex="-1"><a class="header-anchor" href="#_69-主机安全入侵盘查" aria-hidden="true">#</a> 69. 主机安全入侵盘查</h3><p>检查<code>LD_PRELOAD</code>环境变量<br> 使用<code>vi</code>打开<code>/etc/ld.so.preload</code>这个文件是否有内容<br> 使用<code>cat /proc/$$/mountinfo</code> 或者<code>cat /proc/mounts </code> 看<code>proc</code> 是否被挂载到其他目录<br> 使用<code>strace</code>检查普通命令的系统调用<br> 如下个三个安全相关的分析案例:<br> https://www.anquanke.com/post/id/160843<br> https://superuser.com/questions/1183037/what-is-does-ld-so-preload-do<br> https://www.jianshu.com/p/31e487daa79d</p><h3 id="_70-top命令" tabindex="-1"><a class="header-anchor" href="#_70-top命令" aria-hidden="true">#</a> 70. top命令</h3><p>top默认3秒刷新一次信息, 导致一些即时启动并结束的进程无法观察到, 可以用如下参数指定间隔:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">top</span> -d <span class="token number">0.1</span>\n</code></pre></div><p>上面是以100ms为间隔, 也可进入交互模式后按<code>d</code>进行动态调整<br> 交互模式下按<code>1</code>显示每个cpu的使用率信息, 按<code>M</code> 进程按内存排序, 按<code>H</code>显示线程信息</p><p>top进程级的默认字段如果不够, 可以按<code>f</code>选择要显示的字段,比如<code>last cpu used</code>, 然后按<code>q</code>返回显示<br><code>f</code>后不仅可以增加,删除,调整字段顺序, 还可以按<code>s</code>将当前选中的字段作为排序的字段. 比如按内存排序<br> 如果要过滤进程, 比如只显示cmdline 包含字符abc的进程, 按<code>o</code>后输入<code>COMMAND=abc</code>, 碰到java这种进程, 可以按<code>c</code>显示完整的命令行</p><p>查看单个进程的所有线程信息, 对java程序特别有用</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">top</span> -Hp <span class="token number">4592</span>\nThreads:  <span class="token number">11</span> total,   <span class="token number">0</span> running,  <span class="token number">11</span> sleeping,   <span class="token number">0</span> stopped,   <span class="token number">0</span> zombie\n%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:  <span class="token number">0.0</span> us,  <span class="token number">0.0</span> sy,  <span class="token number">0.0</span> ni, <span class="token number">98.4</span> id,  <span class="token number">0.0</span> wa,  <span class="token number">1.6</span> hi,  <span class="token number">0.0</span> si,  <span class="token number">0.0</span> st\nMiB Mem <span class="token builtin class-name">:</span>   <span class="token number">7809.8</span> total,   <span class="token number">5711.5</span> free,    <span class="token number">910.8</span> used,   <span class="token number">1187.6</span> buff/cache\nMiB Swap:      <span class="token number">0.0</span> total,      <span class="token number">0.0</span> free,      <span class="token number">0.0</span> used.   <span class="token number">6748.4</span> avail Mem\n\n    PID <span class="token environment constant">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n   <span class="token number">4592</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:06.87 gopls\n   <span class="token number">4593</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:06.01 gopls\n   <span class="token number">4594</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:00.68 gopls\n   <span class="token number">4595</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:07.53 gopls\n   <span class="token number">4596</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:00.58 gopls\n   <span class="token number">4597</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:00.00 gopls\n   <span class="token number">4598</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:06.96 gopls\n   <span class="token number">4605</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:06.64 gopls\n   <span class="token number">4644</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:06.70 gopls\n   <span class="token number">4647</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:00.01 gopls\n   <span class="token number">4818</span> root      <span class="token number">20</span>   <span class="token number">0</span> <span class="token number">1810424</span> <span class="token number">372332</span>  <span class="token number">14820</span> S   <span class="token number">0.0</span>   <span class="token number">4.7</span>   <span class="token number">0</span>:00.27 gopls\n</code></pre></div><h3 id="_71-ping命令" tabindex="-1"><a class="header-anchor" href="#_71-ping命令" aria-hidden="true">#</a> 71. ping命令</h3><p><code>-i</code>指定两次ping之前的间隔, 默认是1s</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">ping</span> -i <span class="token number">0.1</span> www.163.com\n</code></pre></div><p><code>-s</code>指定ping包的大小, 默认是64bytes</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">ping</span> -s <span class="token number">1024</span> www.163.com\nPING z163ipv6.v.bsgslb.cn <span class="token punctuation">(</span><span class="token number">117.23</span>.1.15<span class="token punctuation">)</span> <span class="token number">1024</span><span class="token punctuation">(</span><span class="token number">1052</span><span class="token punctuation">)</span> bytes of data.\n<span class="token number">1032</span> bytes from <span class="token number">117.23</span>.1.15: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">128</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">7.03</span> ms\n<span class="token number">1032</span> bytes from <span class="token number">117.23</span>.1.15: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">128</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">7.77</span> ms\n</code></pre></div><h3 id="_72-ping和curl常见的网络报错" tabindex="-1"><a class="header-anchor" href="#_72-ping和curl常见的网络报错" aria-hidden="true">#</a> 72. ping和curl常见的网络报错</h3><p>ping ip 报错：<br><code>connect: Network is unreachable</code> 原因是OS里没有相关路由导致<br><code>From 192.168.100.1 icmp_seq=1 Destination Port Unreachable</code> 原因是收到icmp reponse, 端口不可达， 中间设备或者iptable reject</p><p>cur ip 一些报错:<br><code>curl: (7) Failed to connect to 114.114.114.114: Network is unreachable</code> 原因是OS里没有相关路由导致 很快返回<code>curl: (7) Failed connect to 114.114.114.114:80; Connection refused</code> 因为Curl收到icmp 应答消息 80端口不可达， 可能是中间设备iptable发送或者收到服务端rst消息， 80端口没有处于监听状态</p><h3 id="_73-一些常用的内存统计命令" tabindex="-1"><a class="header-anchor" href="#_73-一些常用的内存统计命令" aria-hidden="true">#</a> 73. 一些常用的内存统计命令</h3><p>统计所有进程占用的物理内存</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment"># 使用 grep 查找 Pss 指标后，再用 awk 计算累加值</span>\n$ <span class="token function">grep</span> Pss /proc/<span class="token punctuation">[</span><span class="token number">1</span>-9<span class="token punctuation">]</span>*/smaps <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{total+=$2}; END {printf &quot;%d kB\\n&quot;, total }&#39;</span>\n<span class="token number">391266</span> kB\n</code></pre></div><p>有时smaps文件会看到没有读写权限的内存段,但有p这个权限,即是内存,往往发生在libc这样的共享库和java程序.<br> 如下文章解释了具体的目的, java程序的情况下经常占用了很大的内存, 只要是为了预留一段连续的内存快<br> 这些内存是不会计算到<code>Rss</code>或者<code>Pss</code>里面, 但却实实在在占用了内存.<br> https://unix.stackexchange.com/questions/226283/shared-library-mappings-in-proc-pid-maps<br> https://unix.stackexchange.com/questions/353676/what-is-the-purpose-of-seemingly-unusable-memory-mappings-in-linux/353685#353685</p><div class="language-bash ext-sh"><pre class="language-bash"><code>7fae7db9f000-7fae7dc8f000 r-xp 00000000 08:05 <span class="token number">536861</span>                     /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20\n7fae7dc8f000-7fae7de8f000 ---p 000f0000 08:05 <span class="token number">536861</span>                     /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20\n7fae7de8f000-7fae7de97000 r--p 000f0000 08:05 <span class="token number">536861</span>                     /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20\n7fae7de97000-7fae7de99000 rw-p 000f8000 08:05 <span class="token number">536861</span>                     /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.20\n</code></pre></div><p>这篇文章详细地介绍了<code>/proc/meminfo</code>里的每一个字段的含义和一些有用的公式.<br> http://linuxperf.com/?p=142</p><h3 id="_74-不同os的文件编码" tabindex="-1"><a class="header-anchor" href="#_74-不同os的文件编码" aria-hidden="true">#</a> 74. 不同OS的文件编码</h3><p>linux显示文件内容的编码方式</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">file</span> -i old.txt\nold.txt: text/plain<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>us-ascii\n</code></pre></div><p>将文件abc.txt 编����方式从iso8859-1改为utf-8</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">iconv</span> -f iso8859-1 -t utf-8 abc.txt <span class="token operator">&gt;</span> abc.txt.utf8\n</code></pre></div><p>讲当前文件夹所有文件的文件名编码从GBK改为UTF-8, <code>-r</code>表示递归所有子文件夹</p><div class="language-bash ext-sh"><pre class="language-bash"><code>convmv -f GBk -t UTF-8 --notest -r *，这\n</code></pre></div><p>参考: http://kuring.me/post/windows_linux_code/</p><h3 id="_75-一些shell循环命令" tabindex="-1"><a class="header-anchor" href="#_75-一些shell循环命令" aria-hidden="true">#</a> 75. 一些shell循环命令</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">cat</span> /proc/stat  <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;cpu &quot;</span> <span class="token punctuation">;</span> <span class="token function">sleep</span> <span class="token number">30</span><span class="token punctuation">;</span> <span class="token keyword">done</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">n</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">touch</span> a<span class="token variable">$n</span><span class="token punctuation">;</span> <span class="token function">rm</span> -rf a<span class="token variable">$n</span><span class="token punctuation">;</span> <span class="token keyword">done</span>\n<span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -1 /proc/<span class="token punctuation">[</span><span class="token number">1</span>-9<span class="token punctuation">]</span>*/status<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">grep</span> Name <span class="token variable">$file</span><span class="token punctuation">;</span> <span class="token keyword">done</span>\n</code></pre></div><h3 id="_76-dhcp持续请求配置" tabindex="-1"><a class="header-anchor" href="#_76-dhcp持续请求配置" aria-hidden="true">#</a> 76. dhcp持续请求配置</h3><p>Network管理时, 如果要在dhcp获取ip失败后不断重试,则在<code>ifcfg-ethX</code>文件里增加<code>PERSISTENT_DHCLIENT=yes</code><br> 默认是1分钟后超时, 不重试,日志打印<code>no dhcpoffers received</code><br> 如果加参数, 1分钟超时, 然后一个随机的时间间隔后再次重试. 一直重试到成功获取ip,日志打印如下:</p><div class="language-bash ext-sh"><pre class="language-bash"><code>no dhcpoffers received\nno working leases <span class="token keyword">in</span> persistent database - sleeping\n</code></pre></div><p>如果底层网卡有down, up动作, dhcp进程还在, 只显示一条报错信息<code>receive_packet failed on eth0: Network is down</code><br> 当通过dhcp获取ip失败后, 如果配置了持续获取, 那么下次发起请求的时间间隔是个随机值,大致为150s~450s之间.<br> 具体的代码如下, <code>retry_interval</code>默认是300s,且不可调整<br> https://github.com/42wim/isc-dhcp/blob/f54a146c7fe88889d60f0c1aa8e6f04707f95223/client/dhclient.c</p><div class="language-c ext-c"><pre class="language-c"><code>\t<span class="token function">log_info</span> <span class="token punctuation">(</span><span class="token string">&quot;No working leases in persistent database - sleeping.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\t<span class="token function">script_init</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">&quot;FAIL&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">string_list</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\t<span class="token keyword">if</span> <span class="token punctuation">(</span>client <span class="token operator">-&gt;</span> alias<span class="token punctuation">)</span>\n\t\t<span class="token function">script_write_params</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">&quot;alias_&quot;</span><span class="token punctuation">,</span> client <span class="token operator">-&gt;</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\t<span class="token function">script_go</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\tclient <span class="token operator">-&gt;</span> state <span class="token operator">=</span> S_INIT<span class="token punctuation">;</span>\n\ttv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> cur_tv<span class="token punctuation">.</span>tv_sec <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>client<span class="token operator">-&gt;</span>config<span class="token operator">-&gt;</span>retry_interval <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span>\n\t\t    <span class="token punctuation">(</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> client<span class="token operator">-&gt;</span>config<span class="token operator">-&gt;</span>retry_interval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ttv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tv<span class="token punctuation">.</span>tv_sec <span class="token operator">-</span> cur_tv<span class="token punctuation">.</span>tv_sec<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span>\n\t\t\t<span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000000</span> <span class="token operator">:</span> cur_tv<span class="token punctuation">.</span>tv_usec<span class="token punctuation">;</span>\n\t<span class="token function">add_timeout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tv<span class="token punctuation">,</span> state_init<span class="token punctuation">,</span> client<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\t<span class="token function">detach</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre></div><p>NetworkManager管理时, 两个方法配置持久化:<br> 使用类似命令修改<code>nmcli connection modify enps1s0 ipv4.dhcp-timeout infinity</code><br> 在<code>ifcfg-ethX</code>里增加<code>IPV4_DHCP_TIMEOUT=2147483647</code><br> 参考 https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/configuring_the_dhcp_client_behavior</p><h3 id="_77-解析-proc-pid-status里关于信号的字段" tabindex="-1"><a class="header-anchor" href="#_77-解析-proc-pid-status里关于信号的字段" aria-hidden="true">#</a> 77. 解析/proc/[pid]/status里关于信号的字段</h3><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token comment">#read -p &quot;PID=&quot; pid</span>\n<span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token variable">$1</span>\n<span class="token function">cat</span> /proc/<span class="token variable">$pid</span>/status<span class="token operator">|</span><span class="token function">egrep</span> <span class="token string">&#39;(Sig|Shd)(Pnd|Blk|Ign|Cgt)&#39;</span><span class="token operator">|</span><span class="token keyword">while</span> <span class="token builtin class-name">read</span> name mask<span class="token punctuation">;</span><span class="token keyword">do</span>\n    <span class="token assign-left variable">bin</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;ibase=16; obase=2; <span class="token variable">${mask<span class="token operator">^^</span>*}</span>&quot;</span><span class="token operator">|</span><span class="token function">bc</span><span class="token variable">)</span></span>\n    <span class="token builtin class-name">echo</span> -n <span class="token string">&quot;<span class="token variable">$name</span> <span class="token variable">$mask</span> <span class="token variable">$bin</span> &quot;</span>\n    <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>\n    <span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$bin</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">do</span>\n        <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${bin<span class="token operator">:</span>(-1)}</span> -eq <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>\n            <span class="token function">kill</span> -l <span class="token variable">$i</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">&#39;\\n&#39;</span> <span class="token string">&#39; &#39;</span>\n        <span class="token keyword">fi</span>\n        <span class="token assign-left variable">bin</span><span class="token operator">=</span><span class="token variable">${bin<span class="token operator">:</span><span class="token operator">:-</span>1}</span>\n        <span class="token builtin class-name">set</span> <span class="token variable"><span class="token variable">$((</span>i<span class="token operator">++</span><span class="token variable">))</span></span>\n    <span class="token keyword">done</span>\n    <span class="token builtin class-name">echo</span>\n<span class="token keyword">done</span>\n<span class="token comment"># vim:et:sw=4:ts=4:sts=4:</span>\n</code></pre></div><p>参考链接: https://stackoverflow.com/questions/4155483/proc-pidstatus-sigign-field</p><h3 id="_78-审计谁杀了进程" tabindex="-1"><a class="header-anchor" href="#_78-审计谁杀了进程" aria-hidden="true">#</a> 78. 审计谁杀了进程</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>auditctl -a always,exit -F <span class="token assign-left variable">arch</span><span class="token operator">=</span>b64 -F <span class="token assign-left variable">a1</span><span class="token operator">=</span><span class="token number">15</span> -S <span class="token function">kill</span> -k log_kill\nauditctl -a always,exit -F <span class="token assign-left variable">arch</span><span class="token operator">=</span>b64 -F <span class="token assign-left variable">a1</span><span class="token operator">=</span><span class="token number">9</span> -S <span class="token function">kill</span> -k log_kill\n</code></pre></div><p>参考: https://jotdownux.wordpress.com/2016/01/23/whos-killing-that-process-whos-dumping-prelink-files-in-tmp-linux-auditd-to-the-rescue/</p><h3 id="_79-修改字符集的命令" tabindex="-1"><a class="header-anchor" href="#_79-修改字符集的命令" aria-hidden="true">#</a> 79. 修改字符集的命令</h3><div class="language-bash ext-sh"><pre class="language-bash"><code>localectl set-locale <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>en_US.UTF-8\nlocalectl set-locale <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>zh_CN.UTF-8\nlocalectl list-locales\n</code></pre></div><h3 id="_80-bash脚本的退出码" tabindex="-1"><a class="header-anchor" href="#_80-bash脚本的退出码" aria-hidden="true">#</a> 80. bash脚本的退出码</h3><p>脚本退出码是有特殊含义的,比如常见的<code>127</code>代表脚本里的命令没找到,<code>130</code>代表用户按了<code>ctrl+c</code>导致脚本停止</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ abc\n-bash: abc: <span class="token builtin class-name">command</span> not found\n$ <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>\n<span class="token number">127</span>\n$ <span class="token function">sleep</span> <span class="token number">1000</span>\n^C\n$ <span class="token builtin class-name">echo</span> <span class="token variable">$?</span>\n<span class="token number">130</span>\n</code></pre></div><p>更详细的退出码含义请参见 https://tldp.org/LDP/abs/html/exitcodes.html</p><h3 id="_81-模拟不断增加内存致使触发oom的程序" tabindex="-1"><a class="header-anchor" href="#_81-模拟不断增加内存致使触发oom的程序" aria-hidden="true">#</a> 81. 模拟不断增加内存致使触发oom的程序</h3><div class="language-c ext-c"><pre class="language-c"><code> <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>\n <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>\n\n <span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  \n         <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  \n\n         <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  \n                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  \n                         <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;malloc failure after %d MiB\\n&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>  \n                         <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  \n                 <span class="token punctuation">}</span>  \n                 <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">&quot;got %d MiB\\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">++</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  \n         <span class="token punctuation">}</span>  \n <span class="token punctuation">}</span>  \n\n\n\n $ gcc memtest1<span class="token punctuation">.</span>c  \n $ <span class="token punctuation">.</span><span class="token operator">/</span>a<span class="token punctuation">.</span>out  \n\n got <span class="token number">570528</span> MiB  \n got <span class="token number">570529</span> MiB  \n got <span class="token number">570530</span> MiB  \n got <span class="token number">570531</span> MiBKilled\n</code></pre></div><p>具体的详细测试步骤: https://access.redhat.com/solutions/47692</p><h3 id="_82-vi实现十六进制编辑功能" tabindex="-1"><a class="header-anchor" href="#_82-vi实现十六进制编辑功能" aria-hidden="true">#</a> 82. vi实现十六进制编辑功能</h3><p>vim配合xxd对文件进行十六进制的编辑,达到类似UltraEdit的效果</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">vi</span> abc.txt\n:%<span class="token operator">!</span>xxd\n修改完后,运行下面的命令. 注意左边改动会生效,右边的文本改动不生效\n:%<span class="token operator">!</span>xxd -r\n</code></pre></div><p>更详细的请看 https://www.cnblogs.com/meibenjin/archive/2012/12/06/2806396.html</p><h3 id="_83-iproute软件包里的一些常用命令" tabindex="-1"><a class="header-anchor" href="#_83-iproute软件包里的一些常用命令" aria-hidden="true">#</a> 83. iproute软件包里的一些常用命令</h3><p><code>ifstat</code>打印网卡的一些统计信息,类似<code>ifconfig</code>里的输出,但每次运行时输出从上次运行之后这段时间的统计,而<code>ifconfig</code>是打印的从网卡up以来的累积值<br><code>-a</code>则忽略历史文件,打印从网卡up后的累积值,<code>-j</code>表示输出格式是json.方便二次处理</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ ifstat\n<span class="token comment">#kernel</span>\nInterface        RX Pkts/Rate    TX Pkts/Rate    RX Data/Rate    TX Data/Rate\n                 RX Errs/Drop    TX Errs/Drop    RX Over/Rate    TX Coll/Rate\nlo                    <span class="token number">14</span> <span class="token number">0</span>            <span class="token number">14</span> <span class="token number">0</span>           <span class="token number">819</span> <span class="token number">0</span>           <span class="token number">819</span> <span class="token number">0</span>\n                       <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>\neth0                  <span class="token number">25</span> <span class="token number">0</span>            <span class="token number">18</span> <span class="token number">0</span>          <span class="token number">2058</span> <span class="token number">0</span>          <span class="token number">2784</span> <span class="token number">0</span>\n                       <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>\nvirbr0                 <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>\n                       <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>\ndocker0                <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>\n                       <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>             <span class="token number">0</span> <span class="token number">0</span>\n</code></pre></div><p><code>nstat</code>打印协议栈里的一些统计计数,类似<code>netstat -s</code>的输出,与内核代码里的相关变量名更贴近,容易分析比较<br><code>-r</code>则忽略历史文件,打印从网卡up后的累积值,<code>-z</code>表示非0值的字段也输出</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ nstat\n<span class="token comment">#kernel</span>\nIpInReceives                    <span class="token number">8297</span>               <span class="token number">0.0</span>\nIpInDelivers                    <span class="token number">8297</span>               <span class="token number">0.0</span>\nIpOutRequests                   <span class="token number">7789</span>               <span class="token number">0.0</span>\nIcmpInMsgs                      <span class="token number">6</span>                  <span class="token number">0.0</span>\nIcmpInErrors                    <span class="token number">3</span>                  <span class="token number">0.0</span>\nIcmpInDestUnreachs              <span class="token number">6</span>                  <span class="token number">0.0</span>\nIcmpOutMsgs                     <span class="token number">6</span>                  <span class="token number">0.0</span>\nIcmpOutDestUnreachs             <span class="token number">6</span>                  <span class="token number">0.0</span>\n</code></pre></div><p><code>TcpExtListenOverflows</code>和<code>TcpExtListenDrops</code> 代表全队列或者半队列满了<br><code>TcpInCsumErrors</code>代表接受的包在tcp层的checksum校验不通过,被丢弃</p><p>所有的计数项解释 https://www.kernel.org/doc/html/latest/networking/snmp_counter.html</p><p><code>lnstat</code>周期性输入一些内核统计数据, <code>-d</code>显示支持的具体文件和项</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ lnstat -d\n/proc/net/stat/nf_conntrack:\n\t <span class="token number">1</span>: entries\n\t <span class="token number">2</span>: searched\n\t <span class="token number">3</span>: found\n\t <span class="token number">4</span>: new\n\t <span class="token number">5</span>: invalid\n\t <span class="token number">6</span>: ignore\n\t <span class="token number">7</span>: delete\n\t <span class="token number">8</span>: delete_list\n\t <span class="token number">9</span>: insert\n\t<span class="token number">10</span>: insert_failed\n\t<span class="token number">11</span>: drop\n\t<span class="token number">12</span>: early_drop\n\t<span class="token number">13</span>: icmp_error\n\t<span class="token number">14</span>: expect_new\n\t<span class="token number">15</span>: expect_create\n\t<span class="token number">16</span>: expect_delete\n\t<span class="token number">17</span>: search_restart\n/proc/net/stat/ndisc_cache:\n\t <span class="token number">1</span>: entries\n\t <span class="token number">2</span>: allocs\n\t <span class="token number">3</span>: destroys\n\t <span class="token number">4</span>: hash_grows\n\t <span class="token number">5</span>: lookups\n\t <span class="token number">6</span>: hits\n\t <span class="token number">7</span>: res_failed\n\t <span class="token number">8</span>: rcv_probes_mcast\n\t <span class="token number">9</span>: rcv_probes_ucast\n\t<span class="token number">10</span>: periodic_gc_runs\n\t<span class="token number">11</span>: forced_gc_runs\n\t<span class="token number">12</span>: unresolved_discards\n</code></pre></div><p><code>-k</code>可输出特定项的信息</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ lnstat -k <span class="token string">&quot;entries,insert_failed&quot;</span>\nnf_connt<span class="token operator">|</span>nf_connt<span class="token operator">|</span>\n entries<span class="token operator">|</span>insert_f<span class="token operator">|</span>\n        <span class="token operator">|</span>   ailed<span class="token operator">|</span>\n       <span class="token number">7</span><span class="token operator">|</span>       <span class="token number">0</span><span class="token operator">|</span>\n       <span class="token number">7</span><span class="token operator">|</span>       <span class="token number">0</span><span class="token operator">|</span>\n       <span class="token number">7</span><span class="token operator">|</span>       <span class="token number">0</span><span class="token operator">|</span>\n</code></pre></div><p>这里的entris和<code>conntrack -L</code>的信息是一样的</p><p><code>tc</code>可以模拟网络延迟,限速等功能, 下面是查看当前策略的命令</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ tc -s qdisc\n$ tc -s qdisc <span class="token function">ls</span> dev eth0\n</code></pre></div><h3 id="_84-链接跟踪" tabindex="-1"><a class="header-anchor" href="#_84-链接跟踪" aria-hidden="true">#</a> 84. 链接跟踪</h3><p><code>conntrack -L</code>可显示当前的所有链接信息, 需要安装<code>conntrack-tools</code>后才可以使用</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ conntrack -L\ntcp      <span class="token number">6</span> <span class="token number">430950</span> ESTABLISHED <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token number">10.211</span>.55.22 <span class="token assign-left variable">dst</span><span class="token operator">=</span><span class="token number">10.211</span>.55.2 <span class="token assign-left variable">sport</span><span class="token operator">=</span><span class="token number">22</span> <span class="token assign-left variable">dport</span><span class="token operator">=</span><span class="token number">51568</span> <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token number">10.211</span>.55.2 <span class="token assign-left variable">dst</span><span class="token operator">=</span><span class="token number">10.211</span>.55.22 <span class="token assign-left variable">sport</span><span class="token operator">=</span><span class="token number">51568</span> <span class="token assign-left variable">dport</span><span class="token operator">=</span><span class="token number">22</span> <span class="token punctuation">[</span>ASSURED<span class="token punctuation">]</span> <span class="token assign-left variable">mark</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">use</span><span class="token operator">=</span><span class="token number">1</span>\ntcp      <span class="token number">6</span> <span class="token number">5</span> TIME_WAIT <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token number">10.211</span>.55.22 <span class="token assign-left variable">dst</span><span class="token operator">=</span><span class="token number">113.142</span>.161.250 <span class="token assign-left variable">sport</span><span class="token operator">=</span><span class="token number">48530</span> <span class="token assign-left variable">dport</span><span class="token operator">=</span><span class="token number">80</span> <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token number">113.142</span>.161.250 <span class="token assign-left variable">dst</span><span class="token operator">=</span><span class="token number">10.211</span>.55.22\n</code></pre></div><p>查看当前链接跟踪表里的数目</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /proc/sys/net/netfilter/nf_conntrack_count\n<span class="token number">4</span>\n</code></pre></div><p>查看当前生效的最大值</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ <span class="token function">cat</span> /proc/sys/net/netfilter/nf_conntrack_max\n<span class="token number">65536</span>\n</code></pre></div><p>如果内核出现<code>nf_conntrack: table full, dropping packet.</code>, 则需要增加链接跟踪表的最大连接数</p><div class="language-bash ext-sh"><pre class="language-bash"><code>sysctl -w net.nf_conntrack_max<span class="token operator">=</span>xxxxx\n</code></pre></div><p>还可以通过在加载模块时指定hashsize解决</p><p>https://access.redhat.com/solutions/972673 介绍了针对匹配的包不进行连接跟踪的方法<br> 更详细的一些文章:<br> https://blog.csdn.net/u010472499/article/details/78292811<br> https://access.redhat.com/solutions/8721<br> https://access.redhat.com/solutions/974723<br> https://access.redhat.com/solutions/8721</p><p><code>sysctl -a | grep nf_</code> 查看和链接跟踪所有的内核参数<br> 具体解释: https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt</p><p>下面的规则是用于跟踪对应连接的TCP状态, 每次连接都有自己的超时时间, 如果配置不当会导致丢包.<br> 比如<code>ESTABLISHED</code>的超时时间时5天, 如果改为5分钟, 且这5分钟该TCP没有任何报文交互, 则 iptables会将该连接置为invalid.<br> 这样即使用<code>ss</code>或者<code>netstat</code>查看该连接仍是<code>ESTABLISHED</code>, 任何发到该连接的报文全部会被丢弃.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>    <span class="token number">0</span>     <span class="token number">0</span> ACCEPT     all  --  *      virbr0  <span class="token number">0.0</span>.0.0/0            <span class="token number">192.168</span>.122.0/24     ctstate RELATED,ESTABLISHED\n</code></pre></div><p>具体的信息见`man iptables-extensions</p><p>一些介绍链接跟踪,iptables的文章<br> https://www.cnblogs.com/liushaodong/archive/2013/02/26/2933593.html<br> http://arthurchiao.art/blog/conntrack-design-and-implementation/</p><h3 id="_85-一些汇编语法" tabindex="-1"><a class="header-anchor" href="#_85-一些汇编语法" aria-hidden="true">#</a> 85. 一些汇编语法</h3><p>如下文章介绍了x86_64下许多寄存器的用途<br> http://abcdxyzk.github.io/blog/2012/11/23/assembly-args/</p><h3 id="_86-使用crash分析内核coredump的一些文章" tabindex="-1"><a class="header-anchor" href="#_86-使用crash分析内核coredump的一些文章" aria-hidden="true">#</a> 86. 使用crash分析内核coredump的一些文章</h3><p>https://irmbor.co.rs/~dspalovic/assets/docsOracle/E41138/html/ch10s02.html<br> https://www.slideshare.net/PaulVNovarese/linux-crash-dump-capture-and-analysis<br> https://serverfault.com/questions/475721/how-to-use-kdump-crash-to-investigate-an-oom-issue<br> https://www.redhat.com/archives/crash-utility/2012-December/msg00029.html</p><p>最主要还是看crash的官方主页: https://crash-utility.github.io/</p><h3 id="_87-linux内核模块相关" tabindex="-1"><a class="header-anchor" href="#_87-linux内核模块相关" aria-hidden="true">#</a> 87. Linux内核模块相关</h3><p>使用weak-modules实现外部开发的内核模块在多个内核(KABI兼容的情况下)都可以使用, 这篇文章介绍了具体的方法<br> https://www.cnblogs.com/xingmuxin/p/9092344.html</p><h3 id="_88-ssh连接保活配置" tabindex="-1"><a class="header-anchor" href="#_88-ssh连接保活配置" aria-hidden="true">#</a> 88. ssh连接保活配置</h3><p>编辑 /etc/ssh/sshd_config, 添加如下两行, 重启sshd服务生效</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ClientAliveInterval <span class="token number">60</span> \nClientAliveCountMax <span class="token number">3</span> \n</code></pre></div><h3 id="_89-使用auditd审计功能" tabindex="-1"><a class="header-anchor" href="#_89-使用auditd审计功能" aria-hidden="true">#</a> 89. 使用auditd审计功能</h3><p>直接使用<code>systemctl restart auditd</code>重启auditd是失败.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ systemctl restart auditd\nFailed to restart auditd.service: Operation refused, unit auditd.service may be requested by dependency only <span class="token punctuation">(</span>it is configured to refuse manual start/stop<span class="token punctuation">)</span>.\nSee system logs and <span class="token string">&#39;systemctl status auditd.service&#39;</span> <span class="token keyword">for</span> details.\n</code></pre></div><p>可以使用<code>service auditd status/start/stop/restart</code><br> 参见: https://access.redhat.com/solutions/2664811</p><p>启动/重启auditd 报错&quot;Not able to start Auditd service with pid file exists error&quot;<br> 原因是有其他程序占用了kernel的audit功能, 可以使用<code>auditctl -s</code>查看其他程序的pid<br> https://access.redhat.com/solutions/5431221</p><p><code>/var/log/audit/audit.log</code>里的日志格式, 默认不够人性化, 具体字段含义参见:<br> https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/security_guide/sec-understanding_audit_log_files</p><p>打印今天的审计摘要</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ aureport --start 01/10/2020 07:00:00 --end 01/10/2020 <span class="token number">19</span>:00:00\n\nSummary Report\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>\nRange of <span class="token function">time</span> <span class="token keyword">in</span> logs: 04/27/2019 <span class="token number">20</span>:30:36.683 - 01/01/1970 08:00:00.000\nSelected <span class="token function">time</span> <span class="token keyword">for</span> report: 01/10/2020 07:00:00 - 01/10/2020 <span class="token number">19</span>:00:00\nNumber of changes <span class="token keyword">in</span> configuration: <span class="token number">0</span>\nNumber of changes to accounts, groups, or roles: <span class="token number">0</span>\nNumber of logins: <span class="token number">0</span>\nNumber of failed logins: <span class="token number">0</span>\nNumber of authentications: <span class="token number">0</span>\nNumber of failed authentications: <span class="token number">0</span>\nNumber of users: <span class="token number">0</span>\nNumber of terminals: <span class="token number">0</span>\nNumber of <span class="token function">host</span> names: <span class="token number">0</span>\nNumber of executables: <span class="token number">0</span>\nNumber of commands: <span class="token number">0</span>\nNumber of files: <span class="token number">0</span>\n</code></pre></div><p>昨天到今天这个时间段里的审计摘要</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ aureport --start yesterday --end today\n\nSummary Report\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>\nRange of <span class="token function">time</span> <span class="token keyword">in</span> logs: 04/27/2019 <span class="token number">20</span>:30:36.683 - <span class="token number">10</span>/01/2020 <span class="token number">13</span>:10:43.415\nSelected <span class="token function">time</span> <span class="token keyword">for</span> report: 09/30/2020 00:00:00 - <span class="token number">10</span>/01/2020 <span class="token number">13</span>:12:35\nNumber of changes <span class="token keyword">in</span> configuration: <span class="token number">46</span>\nNumber of changes to accounts, groups, or roles: <span class="token number">0</span>\nNumber of logins: <span class="token number">25</span>\nNumber of failed logins: <span class="token number">2</span>\nNumber of authentications: <span class="token number">80</span>\nNumber of failed authentications: <span class="token number">1</span>\nNumber of users: <span class="token number">2</span>\nNumber of terminals: <span class="token number">16</span>\nNumber of <span class="token function">host</span> names: <span class="token number">3</span>\nNumber of executables: <span class="token number">14</span>\nNumber of commands: <span class="token number">11</span>\nNumber of files: <span class="token number">2</span>\n</code></pre></div><p>从昨天开始事件统计摘要, <code>-i</code>让输出更人性化.</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ aureport --start yesterday -e -i --summary\n\nEvent Summary Report\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>\ntotal  <span class="token builtin class-name">type</span>\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>\n<span class="token number">14485</span>  CRYPTO_KEY_USER\n<span class="token number">8076</span>  USER_START\n<span class="token number">7639</span>  USER_END\n<span class="token number">6762</span>  CRED_ACQ\n<span class="token number">6761</span>  USER_ACCT\n<span class="token number">6753</span>  LOGIN\n<span class="token number">6704</span>  CRED_REFR\n<span class="token number">6527</span>  CRED_DISP\n<span class="token number">4966</span>  NETFILTER_CFG\n</code></pre></div><p>统计可执行文件的摘要</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ aureport -x -i --summary\n\nExecutable Summary Report\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>\ntotal  <span class="token function">file</span>\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>\n<span class="token number">33791</span>  /usr/sbin/sshd\n<span class="token number">31880</span>  /usr/sbin/crond\n<span class="token number">7432</span>  /usr/lib/systemd/systemd\n<span class="token number">4370</span>  /usr/sbin/xtables-multi\n<span class="token number">651</span>  ?\n<span class="token number">627</span>  /usr/bin/python2.7\n<span class="token number">608</span>  /usr/bin/login\n<span class="token number">309</span>  /usr/bin/kmod\n<span class="token number">232</span>  /usr/lib/systemd/systemd-update-utmp\n<span class="token number">204</span>  /\n<span class="token number">102</span>  /usr/sbin/libvirtd\n<span class="token number">94</span>  /usr/sbin/tcpdump\n<span class="token number">60</span>  /usr/bin/su\n<span class="token number">50</span>  /usr/bin/dockerd-current\n<span class="token number">42</span>  /usr/sbin/groupadd\n</code></pre></div><p>显示每个audit日志记录的对应时间段</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ aureport -t\n\nLog Time Range Report\n<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>\n/var/log/audit/audit.log.2: 04/27/2019 <span class="token number">20</span>:30:36.683 - <span class="token number">12</span>/01/2019 <span class="token number">10</span>:40:01.857\n/var/log/audit/audit.log.1: <span class="token number">12</span>/01/2019 <span class="token number">10</span>:40:01.858 - 06/08/2020 <span class="token number">12</span>:20:01.343\n/var/log/audit/audit.log: 06/08/2020 <span class="token number">12</span>:20:01.358 - <span class="token number">10</span>/01/2020 <span class="token number">13</span>:42:52.455\n</code></pre></div><p>搜索今天所有的日志</p><div class="language-bash ext-sh"><pre class="language-bash"><code>$ ausearch --start today -i\n</code></pre></div><p>搜索今天所有的事件为系统调用的日志<br> 所有的事件列表参见: https://access.redhat.com/articles/4409591</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ausearch --start today -i  -m syscall\n</code></pre></div><p>搜索今天所有的关键字为xxxx的日志</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ausearch --start today -i  -k xxxx\n</code></pre></div><p>搜索今天所有的涉及文件/etc/passwd的日志</p><div class="language-bash ext-sh"><pre class="language-bash"><code>ausearch --start today -i  -f /etc/passwd\n</code></pre></div><p>其他一些参考资料:<br> https://cloud.tencent.com/developer/article/1359606</p><h3 id="_90-分析磁盘性能" tabindex="-1"><a class="header-anchor" href="#_90-分析磁盘性能" aria-hidden="true">#</a> 90. 分析磁盘性能</h3><p>blktrace -d /dev/vda blkparse -i vda -d vda.blktrace.bin btt -i vda.blktrace.bin -l vda.d2c_latency</p><p>参考:<br> https://developer.aliyun.com/article/698568<br> https://tunnelix.com/debugging-disk-issues-with-blktrace-blkparse-btrace-and-btt-in-linux-environment/</p><p><code>iostat</code>里<code>await</code>和<code>svctm</code>相关解释<br> https://access.redhat.com/solutions/2039133<br> https://access.redhat.com/articles/524353<br> https://access.redhat.com/solutions/112613</p><h3 id="_91-grub相关问题" tabindex="-1"><a class="header-anchor" href="#_91-grub相关问题" aria-hidden="true">#</a> 91. Grub相关问题</h3><p>CentOS 6 和7 如何重装grub<br> https://access.redhat.com/solutions/1521</p><h3 id="_92-slab相关的知识" tabindex="-1"><a class="header-anchor" href="#_92-slab相关的知识" aria-hidden="true">#</a> 92. SLAB相关的知识</h3><p>统计slab内各项的内存占用并降序排列TOP 10</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token function">awk</span> <span class="token string">&#39;{printf &quot;  %6i MB %s \\n&quot;,$6*$15/256,$1}&#39;</span> /proc/slabinfo <span class="token operator">|</span> <span class="token function">sort</span> -nrk1 <span class="token operator">|</span> <span class="token function">head</span> -10\n</code></pre></div><h3 id="_93-nfs相关的知识" tabindex="-1"><a class="header-anchor" href="#_93-nfs相关的知识" aria-hidden="true">#</a> 93. nfs相关的知识</h3><p>nfs Debug<br> https://access.redhat.com/solutions/262213<br> https://access.redhat.com/solutions/1460313<br> https://access.redhat.com/solutions/4253191<br> https://access.redhat.com/solutions/2948091<br> https://access.redhat.com/solutions/3765711<br> https://access.redhat.com/solutions/28211</p><p>nfs, rpc相关的Debug开关<br> https://wiki.archlinux.org/index.php/NFS/Troubleshooting#RPC_debug_flags</p><h3 id="_94-fork创建进程时的几个报错说明" tabindex="-1"><a class="header-anchor" href="#_94-fork创建进程时的几个报错说明" aria-hidden="true">#</a> 94. fork创建进程时的几个报错说明</h3><p>有两个常见的报错:</p><div class="language-bash ext-sh"><pre class="language-bash"><code><span class="token number">11</span>: Resource temporarily unavailable\n<span class="token number">12</span>: Cannot allocate memory\n</code></pre></div><p>在fork等创建进程的操作里, 当达到<code>nproc</code>的限制， 即用户的最大进程数， 报错<code>Resource temporarily unavailable</code> （这条规则对root用户无效） 如果在文件里对<code>nproc</code>配置为<code>ulimited</code> 这个值是根据内存算出来的， 公式可参考<br> https://thelinuxcluster.com/2020/05/14/how-is-the-nproc-hard-limit-calculated-and-how-do-we-change-the-value-on-centos-7/</p><p>当达到系统级参数pid_max限制，无法分配出pid时， 报错为<code>Cannot allocate memory</code></p><p><code>sysctl kernel.pid_max</code>查询当前的最大值, pid_max默认是32768， 64位系统， 最大可配置为4百万左右<br><code>kernel.threads-max</code> 也控制系统能创建的最大进程/线程数, 因为它的默认值非常大. 一般都没关注过. 总是<code>kernel.pid_max</code>先超出限制.<br> 如下是相关代码: linux-3.10.0-957.21.3.el7\\include\\linux\\threads.h</p><div class="language-c ext-c"><pre class="language-c"><code><span class="token comment">/*\n * This controls the default maximum pid allocated to a process\n */</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PID_MAX_DEFAULT</span> <span class="token expression"><span class="token punctuation">(</span>CONFIG_BASE_SMALL <span class="token operator">?</span> <span class="token number">0x1000</span> <span class="token operator">:</span> <span class="token number">0x8000</span><span class="token punctuation">)</span></span></span>\n\n<span class="token comment">/*\n * A maximum of 4 million PIDs should be enough for a while.\n * [NOTE: PID/TIDs are limited to 2^29 ~= 500+ million, see futex.h.]\n */</span>\n<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PID_MAX_LIMIT</span> <span class="token expression"><span class="token punctuation">(</span>CONFIG_BASE_SMALL <span class="token operator">?</span> PAGE_SIZE <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">:</span> </span><span class="token punctuation">\\</span>\n\t<span class="token expression"><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">4</span> <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">:</span> PID_MAX_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>\n</code></pre></div>',590),p={render:function(s,n){return e}}}}]);
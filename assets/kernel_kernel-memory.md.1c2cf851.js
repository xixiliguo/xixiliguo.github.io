import{_ as s,c as a,o as n,a as l}from"./app.526dca4e.js";const i=JSON.parse('{"title":"\u5185\u5B58\u7BA1\u7406","description":"","frontmatter":{"title":"\u5185\u5B58\u7BA1\u7406","date":"2021-10-17T11:37:59.000Z","draft":false},"headers":[{"level":2,"title":"\u5206\u6BB5","slug":"\u5206\u6BB5"},{"level":2,"title":"\u865A\u62DF\u5730\u5740\u6620\u5C04","slug":"\u865A\u62DF\u5730\u5740\u6620\u5C04"},{"level":2,"title":"\u8FDB\u7A0B\u7A7A\u95F4","slug":"\u8FDB\u7A0B\u7A7A\u95F4"},{"level":3,"title":"\u7528\u6237\u6001","slug":"\u7528\u6237\u6001"},{"level":3,"title":"\u5185\u6838\u6001","slug":"\u5185\u6838\u6001"},{"level":2,"title":"\u7269\u7406\u5206\u914D","slug":"\u7269\u7406\u5206\u914D"}],"relativePath":"kernel/kernel-memory.md","lastUpdated":1657810449000}'),p={name:"kernel/kernel-memory.md"},e=l(`<h2 id="\u5206\u6BB5" tabindex="-1">\u5206\u6BB5 <a class="header-anchor" href="#\u5206\u6BB5" aria-hidden="true">#</a></h2><p>linux\u5E76\u6CA1\u6709\u5229\u7528\u5206\u6BB5\u5B9E\u73B0\u865A\u62DF\u5185\u5B58, \u4F46\u662F\u5374\u5229\u7528\u4E86dpl\u529F\u80FD\u5B9E\u73B0\u4E86\u6743\u9650\u63A7\u5236. \u7528\u6237\u6001DPL\u662F3, \u5185\u6838\u6001DPL\u662F0, \u5F53\u7528\u6237\u6001\u7A0B\u5E8F CPL\u4E3A3\u65F6\u76F4\u63A5\u8BBF\u95EE\u5185\u6838\u6001\u7684\u5730\u5740\u65F6\uFF0C\u4F1A\u56E0\u6743\u9650\u4E0D\u8DB3\u800C\u62A5\u9519\u3002\u6240\u4EE5\u8981\u901A\u8FC7syscal, int\u7B49\u7279\u522B\u6307\u4EE4\u89E6\u53D1\u5207\u6362, \u8FD9\u4E9B\u6307\u4EE4\u4F1A\u6539\u53D8CPL\u503C</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#82AAFF;">DEFINE_PER_CPU_PAGE_ALIGNED</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> gdt_page</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> gdt_page</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> .gdt </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * We need valid kernel segments for data and code in long mode too</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * IRET will check the segment types  kkeil 2000/10/28</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Also sysret mandates a special GDT layout</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * TLS descriptors are currently at a different place compared to i386.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Hopefully nobody expects them at a fixed place (Wine?)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_KERNEL32_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc09b</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_KERNEL_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xa09b</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_KERNEL_DS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc093</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_DEFAULT_USER32_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">	</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc0fb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_DEFAULT_USER_DS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">	</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc0f3</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_DEFAULT_USER_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">	</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xa0fb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="\u865A\u62DF\u5730\u5740\u6620\u5C04" tabindex="-1">\u865A\u62DF\u5730\u5740\u6620\u5C04 <a class="header-anchor" href="#\u865A\u62DF\u5730\u5740\u6620\u5C04" aria-hidden="true">#</a></h2><p>x86_64\u4E0B\u9762\u5206\u9875\u673A\u5236\u91C7\u7528\u56DB\u7EA7\u76EE\u5F55, \u76F8\u5173\u6570\u636E\u7ED3\u6784\u5728<code>arch/x86/include/asm/pgtable_64_types.h</code> \u5982\u679Ccpu\u652F\u63015\u7EA7\u5206\u9875, \u5F53\u524Dcentos9\u4F1A\u81EA\u52A8\u6FC0\u6D3B\u8FD9\u4E2A\u7279\u6027</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PGDIR_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">39</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PGD</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 3rd level page</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PUD_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">30</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PUD</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * PMD_SHIFT determines the size of the area a middle-level</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * page table can map</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PMD_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">21</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PMD</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * entries per page directory level</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PTE</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PMD_SIZE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> PMD_SHIFT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PMD_MASK</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(~(</span><span style="color:#A6ACCD;">PMD_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PUD_SIZE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> PUD_SHIFT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PUD_MASK</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(~(</span><span style="color:#A6ACCD;">PUD_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PGDIR_SIZE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> PGDIR_SHIFT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PGDIR_MASK</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(~(</span><span style="color:#A6ACCD;">PGDIR_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre></div><p>x86_64\u7684\u865A\u62DF\u5730\u5740\u662F64\u4F4D, \u4F46\u53EA\u4F7F\u752848\u4F4D\u7528\u4E8E\u6620\u5C04\u5230\u7269\u7406\u5730\u5740.\u56E0\u4E3A\u5904\u7406\u5668\u5730\u5740\u53EA\u670948\u6761,\u8981\u6C42\u5185\u5B58\u5730\u574048\u4F4D\u523063\u4F4D\u5FC5\u987B\u76F8\u540C, \u5177\u4F53\u56DB\u7EA7\u76EE\u5F55\u7528\u5230\u7684\u4F4D\u6570\u5982\u4E0B:<br> PGD(9) + PUD(9) + PMD(9) + PTE(9) + \u9875\u5185\u504F\u79FB(12)</p><p>\u67E5\u8BE2\u5F53\u524D\u7CFB\u7EDF\u4E00\u9875\u7684\u5927\u5C0F</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># getconf PAGE_SIZE</span></span>
<span class="line"><span style="color:#A6ACCD;">4096</span></span>
<span class="line"></span></code></pre></div><h2 id="\u8FDB\u7A0B\u7A7A\u95F4" tabindex="-1">\u8FDB\u7A0B\u7A7A\u95F4 <a class="header-anchor" href="#\u8FDB\u7A0B\u7A7A\u95F4" aria-hidden="true">#</a></h2><p>\u8FDB\u7A0B\u7A7A\u95F4\u5206\u4E3A\u7528\u6237\u6001\u5730\u5740\u7A7A\u95F4\u548C\u5185\u6838\u6001\u5730\u5740\u7A7A\u95F4, 32\u4F4D\u4E0B\u9762\u7528\u6237\u6001\u7A7A\u95F4\u662F3G, \u5185\u6838\u6001\u65F61G. \u5206\u754C\u7EBF\u4E3A\u5B8F<code>#define TASK_SIZE</code>, \u8FD9\u4E2A\u5B9A\u4E49\u4E86\u7528\u6237\u6001\u7A7A\u95F4\u7684\u6700\u5927\u5730\u5740, \u6839\u636E\u4E0B\u9762\u7684\u5B8F, \u8BA1\u7B97\u51FAx86_64\u4E0B\u9762\u4E3A<code>0x00007FFFFFFFF000</code></p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_SIZE</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">test_thread_flag</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TIF_ADDR32</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">					IA32_PAGE_OFFSET </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> TASK_SIZE_MAX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_SIZE_MAX</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">1UL</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> __VIRTUAL_MASK_SHIFT</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> PAGE_SIZE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_X86_5LEVEL</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__VIRTUAL_MASK_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">pgtable_l5_enabled</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">56</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">47</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__VIRTUAL_MASK_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">47</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span></code></pre></div><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; struct mm_struct -x 0xffff99da00e79540 | grep size</span></span>
<span class="line"><span style="color:#A6ACCD;">    task_size = 0x7ffffffff000,</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>x86_64\u4E0B<br> \u7528\u6237\u7A7A\u95F4 0x0000000000000000 ~ 0x00007FFFFFFFF000 128T<br> \u5185\u6838\u7A7A\u95F4 0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFF 128T<br> 0x00007FFFFFFFF000 \u5230 0xFFFF800000000000 \u4E3A\u7A7A\u6D1E\u533A\u57DF</p><p>\u5728execve\u65F6,\u5C06\u8BE5\u503C\u8BBE\u7F6E\u5230mm_struct\u4E0A\u9762\u53BB</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* Set the new mm task size. We have to do that late because it may</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * depend on TIF_32BIT which is only updated in flush_thread() on</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * some architectures like powerpc</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	current</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">mm</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">task_size </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> TASK_SIZE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> struct mm_struct.task_size -x 0xffff9f814be29f80</span></span>
<span class="line"><span style="color:#A6ACCD;">    task_size = 0x7ffffffff000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>\u5728x86_64, \u5185\u6838\u6001\u4ECE<code>0xffff888000000000</code> \u5F00\u59CB\u6620\u5C04\u6574\u4E2A\u7269\u7406\u5185\u5B58</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__PAGE_OFFSET_BASE_L4</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xffff888000000000</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_DYNAMIC_MEMORY_LAYOUT</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__PAGE_OFFSET</span><span style="color:#A6ACCD;">           page_offset_base</span></span>
<span class="line"></span></code></pre></div><p>\u5982\u679C\u6253\u5F00\u4E86kaslr, \u5728<code>kernel_randomize_memory</code>\u91CC\u4F1A\u5BF9<code>page_offset_base</code>\u968F\u673A\u5411\u4E0A\u504F\u79FB\u4E00\u4E9B\u4F4D\u7F6E, \u5982\u4E0B\u662F\u5B9E\u9645\u8FD0\u884C\u7684cents8\u91CC\u7684\u503C:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> px page_offset_base</span></span>
<span class="line"><span style="color:#A6ACCD;">page_offset_base = </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">20 = 0xffff9f7f40000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>\u53C2\u8003\u6587\u6863: Documentation/x86/x86_64/mm.txt</p><h3 id="\u7528\u6237\u6001" tabindex="-1">\u7528\u6237\u6001 <a class="header-anchor" href="#\u7528\u6237\u6001" aria-hidden="true">#</a></h3><p>\u5728load_elf_binary\u51FD\u6570\u91CC <code>setup_new_exec</code>\u91CC\u8BBE\u7F6Emm-&gt;mmap_base\u548Cmm-&gt;task_size, <code>kernel.randomize_va_space = 2</code>\u8868\u793A\u9700\u8981\u968F\u673A\u5316\u90E8\u5206\u533A\u57DF\u7684\u8D77\u59CB\u5730\u5740, \u5305\u62ECmmap, stack\u7B49<br><code>setup_arg_pages</code>\u91CC\u8BBE\u7F6Emm-&gt;arg_start\u548Cmm-&gt;start_stack, \u6B64\u65F6\u8FD9\u4E24\u4E2A\u503C\u4E00\u6837<br><code>create_elf_tables</code> \u91CD\u65B0\u8BBE\u7F6E\u4E86mm-&gt;start_stack<br> start_stack\u6307\u6808\u5E95, \u5B83\u4E0Earg_start\u4E4B\u524D\u5B58\u653E\u4E86\u4E00\u4E9B\u4FE1\u606F, \u6BD4\u5982\u6267\u884C\u547D\u4EE4\u7684\u53C2\u6570\u4E2A\u6570\u548C\u6BCF\u4E00\u4E2A\u53C2\u6570\u7684\u5177\u4F53\u5B57\u7B26\u4E32\u6307\u9488, \u6BCF\u4E00\u4E2A\u73AF\u5883\u53D8\u91CF\u7684\u6307\u9488. arg_start ~ arg_end, env_start ~ env_end \u4E4B\u95F4\u624D\u662F\u771F\u6B63\u5B58\u653E\u8FD9\u4E9B\u6570\u636E\u7684\u5730\u65B9. \u5728\u7A0B\u5E8F\u5185\u90E8\u6539\u53D8\u8FD9\u4E9B\u6307\u9488\u503C\u5C31\u80FD\u6539\u53D8\u53C2\u6570\u548C\u73AF\u5883\u53D8\u91CF\u4FE1\u606F</p><h3 id="\u5185\u6838\u6001" tabindex="-1">\u5185\u6838\u6001 <a class="header-anchor" href="#\u5185\u6838\u6001" aria-hidden="true">#</a></h3><p>page_offset_base\u5F00\u59CB\u768464T\u8303\u56F4\u5185\u662F\u76F4\u63A5\u6620\u5C04\u5185\u5B58, \u8FD9\u4E9B\u865A\u62DF\u5730\u5740\u5BF9\u5E94\u7684\u7269\u7406\u5730\u5740\u5C31\u662F \u51CF\u53BBpage_offset_base<br> page_offset_base\u9ED8\u8BA4\u662F0xffff888000000000, \u5982\u679C<code>CONFIG_RANDOMIZE_MEMORY=y</code>\u5219\u4F1A\u968F\u673A\u504F\u79FB\u4E9B<br> \u6BCF\u4E2A\u8FDB\u7A0B\u5BF9\u5E94\u7684task_struct\u5206\u914D\u5728\u8FD9\u4E2A\u533A\u57DF, \u53EF\u4EE5\u51CF\u53BBpage_offset_base\u76F4\u63A5\u5F97\u5230\u7269\u7406\u5730\u5740</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; vtop ffff9e68002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;">VIRTUAL           PHYSICAL</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9e68002398c0  1002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">PGD DIRECTORY: ffffffffb2e10000</span></span>
<span class="line"><span style="color:#A6ACCD;">PAGE DIRECTORY: 1c601067</span></span>
<span class="line"><span style="color:#A6ACCD;">   PUD: 1c601d00 =&gt; 1c606067</span></span>
<span class="line"><span style="color:#A6ACCD;">   PMD: 1c606008 =&gt; 1057a9063</span></span>
<span class="line"><span style="color:#A6ACCD;">   PTE: 1057a91c8 =&gt; 8000000100239063</span></span>
<span class="line"><span style="color:#A6ACCD;">  PAGE: 100239000</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">      PTE         PHYSICAL   FLAGS</span></span>
<span class="line"><span style="color:#A6ACCD;">8000000100239063  100239000  (PRESENT|RW|ACCESSED|DIRTY|NX)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">      PAGE        PHYSICAL      MAPPING       INDEX CNT FLAGS</span></span>
<span class="line"><span style="color:#A6ACCD;">ffffdba004008e40 100239000 dead000000000008        0  0 17ffffc0000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; px page_offset_base</span></span>
<span class="line"><span style="color:#A6ACCD;">page_offset_base = $15 = 0xffff9e6700000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; eval ffff9e68002398c0 - 0xffff9e6700000000</span></span>
<span class="line"><span style="color:#A6ACCD;">hexadecimal: 1002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;">    decimal: 4297300160</span></span>
<span class="line"><span style="color:#A6ACCD;">      octal: 40010714300</span></span>
<span class="line"><span style="color:#A6ACCD;">     binary: 0000000000000000000000000000000100000000001000111001100011000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>vmalloc_base\u4ECE 0xffffc90000000000UL\u5F00\u59CB, \u968F\u673A\u504F\u79FB\u540E, \u53EF\u901A\u8FC7\u5982\u4E0B\u547D\u4EE4\u83B7\u53D6\u5F53\u524D\u503C</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; px vmalloc_base</span></span>
<span class="line"><span style="color:#A6ACCD;">vmalloc_base = $16 = 0xffffb9cb00000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>vmemmap_base\u4ECE 0xffffea0000000000UL\u5F00\u59CB, \u968F\u673A\u504F\u79FB\u540E, \u53EF\u901A\u8FC7\u5982\u4E0B\u547D\u4EE4\u83B7\u53D6\u5F53\u524D\u503C, \u5B58\u653E struct page</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; px vmemmap_base</span></span>
<span class="line"><span style="color:#A6ACCD;">vmemmap_base = $17 = 0xffffdba000000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>\u5185\u6838\u7684\u4EE3\u7801\u6BB5\u4ECE__START_KERNEL_map\u5F00\u59CB, \u5BF9\u5E94\u7684\u7269\u7406\u5730\u5740\u662F\u51CF\u53BB __START_KERNEL_map \u52A0\u4E0A phys_base</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__START_KERNEL_map</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xffffffff80000000</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h2 id="\u7269\u7406\u5206\u914D" tabindex="-1">\u7269\u7406\u5206\u914D <a class="header-anchor" href="#\u7269\u7406\u5206\u914D" aria-hidden="true">#</a></h2><p>\u5F53\u524D\u4E3B\u6D41\u90FD\u662Fnuma\u7ED3\u6784, \u5373\u4E00\u4E2ACPU\u5BF9\u5E94\u672C\u5730\u5185\u5B58, \u5F53\u672C\u5730\u5185\u5B58\u4E0D\u591F, \u518D\u901A\u8FC7\u603B\u7EBF\u8BBF\u95EE\u5176\u4ED6\u8282\u70B9\u7684\u5185\u5B58. \u5185\u5B58\u7BA1\u7406\u7684\u6700\u5C0F\u5355\u4F4D\u662F\u9875, \u901A\u5E38\u662F4K, \u5B83\u5C5E\u4E8EZone, Zone\u5C5E\u4E8Enode\u8282\u70B9\u8282. node\u8282\u70B9\u5C31\u662Fnuma\u8282\u70B9</p><p>\u5982\u4E0B\u8868\u793A\u8BE5OS\u53EF\u4EE5\u652F\u6301 1&lt;&lt; 10 == 1024\u4E2Anuma\u8282\u70B9</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># grep CONFIG_NODES_SHIFT /boot/config-5.14.0-22.el9.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">CONFIG_NODES_SHIFT=10</span></span>
<span class="line"></span></code></pre></div><p>\u4E00\u53F04u8G\u7684\u673A\u5668, \u53EA\u6709\u4E00\u4E2Anuma. cpu0~3\u5C5E\u4E8Enode0</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># lscpu | grep NUMA</span></span>
<span class="line"><span style="color:#A6ACCD;">NUMA node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">:                    1</span></span>
<span class="line"><span style="color:#A6ACCD;">NUMA node0 CPU</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">:               0-3</span></span>
<span class="line"></span></code></pre></div><p>node0\u91CC\u9762\u7684\u8DDF\u7269\u7406\u5185\u5B58\u7684\u76F8\u5173\u7684\u6570\u636E\u5982\u4E0B</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> pglist_data </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">node_data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">MAX_NUMNODES</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> __read_mostly</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">EXPORT_SYMBOL</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node_data</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; p node_data[0]</span></span>
<span class="line"><span style="color:#A6ACCD;">$22 = (pg_data_t *) 0xffff94e6dffd1000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;  struct pg_data_t.node_id,nr_zones,node_start_pfn,node_present_pages,node_spanned_pages -x 0xffff94e6dffd1000</span></span>
<span class="line"><span style="color:#A6ACCD;">  node_id = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  nr_zones = 0x3,</span></span>
<span class="line"><span style="color:#A6ACCD;">  node_start_pfn = 0x1,              //\u4ECE\u9875\u53F71\u5F00\u59CB</span></span>
<span class="line"><span style="color:#A6ACCD;">  node_present_pages = 0x1fff8e,     //\u8BE5node\u7BA1\u74060x1fff8e\u4E2A\u53EF\u7528\u7684\u9875. </span></span>
<span class="line"><span style="color:#A6ACCD;">  node_spanned_pages = 0x21ffff,     //\u7BA1\u74060x21ffff\u9875(8G), \u9664\u4E86\u5305\u542Bpresent_pages, \u8FD8\u5305\u542B\u4E86\u7A7A\u6D1E\u7684\u7269\u7406\u5730\u5740. \u8FD9\u4E9B\u9875\u4E0D\u53EF\u7528.</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; struct zone.name,zone_start_pfn,spanned_pages,present_pages,managed_pages -x ffff94e6dffd1000 5</span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9fa3ed3 &quot;DMA&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x1,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0xfff,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0xf9e,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0xf00</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f4c32c &quot;DMA32&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x1000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0xff000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0xdeff0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0xcaff0</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f4c222 &quot;Normal&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x100000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0x120000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0x120000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0x1145ec</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f4c229 &quot;Movable&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0x0</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f9924d &quot;Device&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0x0</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>0x1fff8e\u4E2A\u53EF\u7528\u9875\u7B49\u4E8E 8388152K</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost ~]# dmesg -T | grep Mem</span></span>
<span class="line"><span style="color:#A6ACCD;">[Sun Dec 26 11:12:09 2021] Memory: 3442876K/8388152K available (14345K kernel code, 5931K rwdata, 8944K rodata, 2656K init, 5448K bss, 556100K reserved, 0K cma-reserved)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>\u4E0A\u9762\u53EF\u4EE5\u770B\u523064\u4F4D\u4E0B\u6709\u4E09\u4E2Azone, \u5206\u522B\u662F DMA, DMA32, Normal<br> struct page\u4EE3\u8868\u4E00\u9875, \u9875\u901A\u8FC7\u4F19\u4F34\u7CFB\u7EDF\u7BA1\u7406. \u6240\u6709\u7A7A\u95F2\u9875\u6302\u572811\u4E2A\u9875\u5757\u94FE\u8868\u4E0A. \u6BCF\u4E2A\u94FE\u8868\u5305\u542B\u76F8\u540C\u8FDE\u7EED\u9875\u7684\u5730\u5740. \u6709 1\u30012\u30014\u30018\u300116\u300132\u300164\u3001128\u3001256\u3001512 \u548C 1024. \u6240\u4EE5\u4E00\u6B21\u6700\u5927\u53EF\u7533\u8BF71024\u4E2A\u7269\u7406\u5730\u5740\u8FDE\u7EED\u7684\u9875(\u53734M\u7684\u5185\u5B58). \u8FD9\u4E9B\u94FE\u8868\u5B58\u5728struct zone.free_area<br> \u7B2C i \u4E2A\u9875\u5757\u94FE\u8868\u4E2D\uFF0C\u9875\u5757\u4E2D\u9875\u7684\u6570\u76EE\u4E3A 2^i</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_ORDER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">11</span></span>
<span class="line"></span></code></pre></div><p>order\u4E3Ai\u65F6, \u610F\u5473\u7740\u7533\u8BF7 2 ^ i \u4E2A\u8FDE\u7EED\u9875, \u5982\u679Cfree_area[i]\u6CA1\u6709, \u5219\u53BBfree_area[i+1]\u91CC\u9762\u627E, \u4F9D\u6B21\u7C7B\u63A8</p>`,47),o=[e];function c(t,r,y,D,A,F){return n(),a("div",null,o)}var f=s(p,[["render",c]]);export{i as __pageData,f as default};

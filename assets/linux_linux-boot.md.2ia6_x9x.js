import{_ as s,c as i,o as a,a2 as h}from"./chunks/framework.YBtj1D-X.js";const C=JSON.parse('{"title":"Linux Boot过程总结","description":"","frontmatter":{"title":"Linux Boot过程总结","author":"Peter Wang","tags":["linux","boot","systemd"],"date":"2020-04-19T07:17:50.000Z","draft":false},"headers":[],"relativePath":"linux/linux-boot.md","filePath":"linux/linux-boot.md","lastUpdated":1739199086000}'),n={name:"linux/linux-boot.md"},k=h(`<p>记录linux启动过程的总结</p><h2 id="bios启动" tabindex="-1">bios启动 <a class="header-anchor" href="#bios启动" aria-label="Permalink to &quot;bios启动&quot;">​</a></h2><p>磁盘的前512字节内容也叫也叫Master boot record, 简称MBR 主板里的bios会扫描设备/磁盘MBR的最后两个字节是不是<code>aa55</code>,如果是则认为是可启动设备. 会按照配置的启动顺序挨个尝试启动.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# xxd -l 512 /dev/sda</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000000:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eb63</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9010</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8ed0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bc00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b0b8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8ed8</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8ec0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .c..............</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000010:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fbbe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 007c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bf00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 06b9</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0002</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f3a4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ea21</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.........</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000020:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 00be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> be07</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3804</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 750b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 83c6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1081</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fefe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0775</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ....8.u........u</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000030:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f3eb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 16b4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 02b0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 01bb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 007c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b280</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8a74</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 018b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .........</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.t.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000040:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 4c02</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ea00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7c00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 00eb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fe00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  L.....</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.........</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000050:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0080</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0100</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ................</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000060:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fffa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9090</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f6c2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8074</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 05f6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c270</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ...........t...p</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000070:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7402</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b280</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ea79</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7c00</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0031</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c08e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> d88e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> d0bc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  t....y</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.1.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.....</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000080:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0020</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fba0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 647c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 3cff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7402</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 88c2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 52be</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 057c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..d</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.t...R..</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000090:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b441</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bbaa</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 55cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 135a</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5272</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 3d81</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fb55</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aa75</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .A..U..ZRr=..U.u</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00000a0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3783</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> e101</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7432</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 31c0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8944</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0440</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8844</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ff89</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  7...t21..D.@.D..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00000b0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4402</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c704</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 668b</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1e5c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7c66</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 895c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0866</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  D.....f..</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\|</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">f.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">f</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00000c0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8b1e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 607c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6689</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 5c0c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c744</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 70b4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 42cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ..\`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f.\\..D..p.B.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00000d0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1372</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 05bb </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0070</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eb76 b408 cd13 730d 5a84  .r...p.v....s.Z.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00000e0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> d20f 83de 00be 857d e982 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0066</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 0fb6 c688  .......}...f....</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00000f0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 64ff </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4066</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8944</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 040f b6d1 c1e2 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0288</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> e888  d.@f.D..........</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000100:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f440 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8944</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 080f b6c2 c0e8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0266</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8904</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 66a1  .@.D.......f..f.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000110:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 607c </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6609</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c075 4e66 a15c 7c66 31d2 66f7  \`</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f..uNf.\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">|f1.f.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000120:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3488</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> d131</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> d266</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f774</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 043b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4408</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 7d37</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> fec1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  4..1.f.t.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">D.}7..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000130:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 88c5</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 30c0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c1e8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0208</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c188</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> d05a</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 88c6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bb00</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ..0........Z....</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000140:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 708e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> c331</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dbb8</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0102</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cd13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 721e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8cc3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 601e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  p..1......r...\`</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000150:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b900 018e db31 f6bf </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0080</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 8ec6 fcf3 a51f  .....1..........</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000160:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 61ff 265a 7cbe 807d eb03 be8f 7de8 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3400</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  a.&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Z</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">..</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">....</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">.4.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000170:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> be94 7de8 2e00 cd18 ebfe </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4752</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5542</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ..}.......GRUB .</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000180:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4765</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 6f6d </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0048</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6172</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6420</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4469</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 736b </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0052</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  Geom.Hard Disk.R</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">0000190:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6561</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6400</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2045</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7272</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 6f72 0d0a 00bb </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ead. Error......</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001a0:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> b40e cd10 ac3c </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0075</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> f4c3 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .....</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.u........</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001b0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ab83 0a00 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8020</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ...............</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001c0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 83fe ffff </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0008</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dfc7 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">8102</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  !...............</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001d0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ................</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001e0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ................</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001f0:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 55aa  ..............U.</span></span></code></pre></div><p>MBR里还有分区表信息, 从偏移量<code>446</code>开始, 最多放4个主分区, 下面显示只有一个主分区</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# xxd -s 446 -l 64 /dev/sda</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001be:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8020</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 83fe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ffff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0008</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dfc7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8102</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  .</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> !.............</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001ce:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ................</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001de:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ................</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">00001ee:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0000</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  ................</span></span></code></pre></div><p>如果分区损坏, 可使用testdisk尝试修复, 有linux和window两个版本. 主页: www.cgsecurity.org</p><p>在qemu+libvirt下, bios启动会打印<code>Booting from Hard Disk...</code>信息.代码如下:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ie-&gt;type) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPL_TYPE_FLOPPY:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Booting from Floppy...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        boot_disk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">00</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, CheckFloppySig);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IPL_TYPE_HARDDISK:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Booting from Hard Disk...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        boot_disk</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">80</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>如果检查发现<code>mbr</code>的512字节处不是<code>55aa</code>, 则无法启动虚拟机, 界面显示<code>Boot failed: not a bootable disk</code>, 对应代码如下</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GET_FARVAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bootseg, mbr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">signature</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MBR_SIGNATURE) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Boot failed: not a bootable disk</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span></code></pre></div><p>所以VNC遇到如上两个信息, 需要检查底层问题.</p><p>以上代码来自<a href="https://www.seabios.org/downloads/" target="_blank" rel="noreferrer">https://www.seabios.org/downloads/</a>, 是qemu默认的bios启动程序</p><h2 id="grub启动" tabindex="-1">grub启动 <a class="header-anchor" href="#grub启动" aria-label="Permalink to &quot;grub启动&quot;">​</a></h2><p>bios读取MBR后,然后执行里面的代码, 这样将控制权交到grub2. 这块代码也叫<code>bootloader</code>.<br> 通常运行<code>grub2-install /dev/sda</code>将<code>bootloader</code>写入MBR. 当然还会在512字节后面继续写入一些文件 可以加参数<code>--debug</code>看到更详细的信息</p><p>如果发现grub损坏, 可以尝试挂盘并chroot到根目录, 执行<code>grub2-install /dev/xxxx</code>. /dev/xxx为具体的盘符名<br> 如果能看到grub的shell命令行, 说明可能grub.cfg配置有误, 导致无法选择具体的引导项. 可以手工指定具体的引导信息, 尝试启动<br> 以下是参考样例, 可以找一台完全一样的主机配置会修复故障机<br><code>ls</code>命令可以查看当前设备及里面的文件, 用于确定文件是否真的存在. 也能判断分区信息<br><code>tab</code>可用于命令联想</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root=&#39;hd0,msdos1&#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        linux16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/vmlinuz-3.10.0-1062.el7.x86_64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root=UUID=5de1c8df-9b03-4830-9b56-b96a2290b78f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ro</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vconsole.keymap=us</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> crashkernel=auto</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        initrd16</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs-3.10.0-1062.el7.x86_64.img</span></span></code></pre></div><p>有时挂盘修复时choot后好多特殊的文件系统找不到, 可以提前手工挂载下, 然后chroot<br> 如下命令仅供参考, 假设要修复的系统盘已经挂在<code>mnt</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># mount --bind /dev /mnt/dev</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># mount -t proc proc /mnt/proc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># mount -t sysfs none /mnt/sys</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># chroot /mnt /bin/bash</span></span></code></pre></div><p>有时我们需要检查磁盘或者分区当前的文件系统, 下面列出三种方法:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# lsblk -f</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   FSTYPE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LABEL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UUID</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                 MOUNTPOINT</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sda</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">└─sda1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ext4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">         5de1c8df-9b03-4830-9b56-b96a2290b78f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sr0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# blkid</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/dev/sda1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UUID=&quot;5de1c8df-9b03-4830-9b56-b96a2290b78f&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TYPE=&quot;ext4&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# file -s /dev/sda1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/dev/sda1:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Linux</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rev</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ext4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> filesystem</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> data,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> UUID=5de1c8df-9b03-4830-9b56-b96a2290b78f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (needs </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">journal</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> recovery</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">extents</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">64bit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">large</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">huge</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>这几个命令都是通过直接读取该块设备的十六进制数据来判断的, 具体的规则可参考:<br><a href="https://github.com/file/file/blob/master/magic/Magdir/filesystems" target="_blank" rel="noreferrer">https://github.com/file/file/blob/master/magic/Magdir/filesystems</a></p><h2 id="initramfs启动" tabindex="-1">initramfs启动 <a class="header-anchor" href="#initramfs启动" aria-label="Permalink to &quot;initramfs启动&quot;">​</a></h2><p>grub2找到kernel和initramfs后, 控制权交给kernel, 然后解压缩initramfs在内存中创建一个rootfs 在这个初始的小型文件系统里,加载一些基本的内核模块, 使OS能识别一些关键的外围设备. 比方说virtio块设备, virtio网络设备 这就是为什么在CentOS7下要将kvm驱动通过<code>dracut</code>打入initramfs的原理. 如果无法识别硬盘, 那么就无法真正的mount到磁盘的根目录.<br> 当initramfs文件系统挂在后, kernel将控制权交给pid为1的进程, centos7下是systemd.<br> VNC屏幕打印<code>Welcome to XXXX</code>意味着initramfs里的systemd已经开始运行. 之后出现的问题和内核就没多大关系了</p><p><a href="https://github.com/systemd/systemd/blob/4444e8533fea1640cc9d9b1d1a493ffcbee8a13d/src/core/main.c" target="_blank" rel="noreferrer">https://github.com/systemd/systemd/blob/4444e8533fea1640cc9d9b1d1a493ffcbee8a13d/src/core/main.c</a></p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log_get_show_color</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> status_printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                                     &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">Welcome to </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\x1B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\x1B</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">[0m!</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                     isempty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ansi_color) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;1&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ansi_color,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                                     isempty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(pretty_name) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Linux&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pretty_name);</span></span></code></pre></div><p>大致的顺序如下:</p><ol><li>dracut-cmdline解析<code>/proc/cmdline</code>, 找到真实root的信息</li><li>udev启动,识别所有的设备, 特别是硬盘,在/dev/下生成相应的信息, 这里当识别到新设备时会加载相应的驱动<br> bus驱动通过特殊的ID(设备厂商ID, 子系统ID等)识别新设备, 这个也叫MODALIAS<br> 然后modprobe MODALIAS, 会读取/lib/module/xxxx/modules.alias, 找到对应的驱动来加载驱动.<br> 对应的规则为<code>/lib/udev/rules.d/80-drivers.rules:ENV{MODALIAS}==&quot;?*&quot;, RUN{builtin}+=&quot;kmod load $env{MODALIAS}&quot;</code></li><li>initqueue阶段,有很多循环, 不停地检查一些关键任务是否完成, 比如root设备是否已识别并在<code>/dev/</code>下完成相关文件创建</li><li>mount和fsck root设备</li><li>清理就切换到真实的root设备</li></ol><p>可以在Grub菜单里给内核加参数<code>rd.break</code>使系统停留在initramfs创建后, 切换到真正的root文件系统前. 用于学习和排障<br><code>rd</code>就是<code>ramdisk</code>的缩写, 即<code>the initial ramdisk (initrd) environment</code><br><code>rd.debug</code> 可以输出详细的日志. dracut许多命令都是shell脚本. 打印详细日志的大致两种:<br> 脚本里加<code>set -x</code></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep.sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/usr/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -x</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./sleep.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]#</span></span></code></pre></div><p>再<code>set -x</code>的基础上,继续增加<code>export &#39;PS4=\${BASH_SOURCE}@\${LINENO}(\${FUNCNAME[0]}): &#39;</code> 可打印具体的行数和函数名</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sleep.sh</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/usr/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -x</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;PS4=\${BASH_SOURCE}@\${LINENO}(\${FUNCNAME[0]}): &#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./sleep.sh</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> export</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;PS4=\${BASH_SOURCE}@\${LINENO}(\${FUNCNAME[0]}): &#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PS4=&#39;\${BASH_SOURCE}@\${LINENO}(\${FUNCNAME[0]}): &#39;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./sleep.sh@4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(): sleep 3</span></span></code></pre></div><p>如下文档介绍了bash下面PS相关变量可以实现的一些特殊功能<br><a href="https://www.thegeekstuff.com/2008/09/bash-shell-take-control-of-ps1-ps2-ps3-ps4-and-prompt_command/" target="_blank" rel="noreferrer">https://www.thegeekstuff.com/2008/09/bash-shell-take-control-of-ps1-ps2-ps3-ps4-and-prompt_command/</a></p><p><code>rd.udev.debug </code> 可以输入udev的详细日志</p><p>centos7还支持如下参数, 可以在特定的阶段打断OS的正常运行.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# grep -r </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rd.break=&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /lib/dracut/modules.d/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">systemd/</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/lib/dracut/modules.d/98systemd/dracut-cmdline.service:ConditionKernelCommandLine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rd.break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=cmdline</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/lib/dracut/modules.d/98systemd/dracut-initqueue.service:ConditionKernelCommandLine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rd.break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=initqueue</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/lib/dracut/modules.d/98systemd/dracut-mount.service:ConditionKernelCommandLine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rd.break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=mount</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/lib/dracut/modules.d/98systemd/dracut-pre-mount.service:ConditionKernelCommandLine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rd.break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=pre-mount</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/lib/dracut/modules.d/98systemd/dracut-pre-trigger.service:ConditionKernelCommandLine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rd.break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=pre-trigger</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/lib/dracut/modules.d/98systemd/dracut-pre-udev.service:ConditionKernelCommandLine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rd.break</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">=pre-udev</span></span></code></pre></div><p>initramfs大部分问题都可以通过重建initramfs解决</p><p>提取initramfs文件的命令:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/initrd</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /tmp/initrd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">/usr/lib/dracut/skipcpio</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uname</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.img</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> gunzip</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cpio</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -idmv</span></span></code></pre></div><p><a href="https://access.redhat.com/solutions/2037313" target="_blank" rel="noreferrer">https://access.redhat.com/solutions/2037313</a></p><p>查看initramfs文件里包含的文件列表, 使用<code>lsinitrd xxx</code>, 如果要查看具体文件的内容,用如下命令:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lsinitrd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /boot/initramfs-3.10.0-1062.el7.x86_64.img</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/machine-id</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ab80e79ed1cf4e9aa1108082dd40f5bc</span></span></code></pre></div><p>挂盘到一个虚拟机里, chroot到对应的root目录, 已3.10.0-1062.el7.x86_64为例,命令为:<br><code>dracut initramfs-3.10.0-1062.el7.x86_64.img 3.10.0-1062.el7.x86_64</code><br> 不要不加参数执行<code>dracut</code>, 因为它默认会使用当前的内核生成文件. 当前内核可能不是故障虚拟机里的内核版本</p><p>单用户 reboot, 可以使用reboot -f</p><p>运行initrd-switch-root.service完成其他工作并改变根目录为/sysroot, 系统打印如下:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 21:33:52</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost.localdomain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Starting</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Switch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Root...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 21:33:52</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost.localdomain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Switching</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root.</span></span></code></pre></div><h2 id="切换到真实的根目录" tabindex="-1">切换到真实的根目录 <a class="header-anchor" href="#切换到真实的根目录" aria-label="Permalink to &quot;切换到真实的根目录&quot;">​</a></h2><p>此时会remount根目录, 然后依照依赖关系并发的启动各种功能服务<br> systemd与传统sysint不同, 随OS启动的服务如果之前没有依赖关系, 是可以同时启动的. 这有别于sysinit的串行一个一个执行, 但对于定位启动类卡住问题却带来的难度. 不能简单的通过控制台显示的最后一行信息来判断是否该服务出问题</p><p>正常启动的情况下, 我们看到一个登陆界面, 让输入用户名和密码, 这个是因为getty服务正常运行了</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# systemctl status getty@tty1.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">●</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> getty@tty1.service</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Getty</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tty1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Loaded:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> loaded</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (/usr/lib/systemd/system/getty@.service; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vendor</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> preset:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   Active:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> active</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (running) since Mon 2020-04-20 22:01:32 HKT; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">24s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ago</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">     Docs:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> man:agetty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           man:systemd-getty-generator(8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           http://0pointer.de/blog/projects/serial-console.html</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Main</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> PID:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5474</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (agetty)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   CGroup:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /system.slice/system-getty.slice/getty@tty1.service</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">           └─5474</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sbin/agetty</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --noclear</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tty1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> linux</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22:01:32</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost.localdomain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Stopped</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Getty</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tty1.</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 22:01:32</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost.localdomain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> systemd[1]:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Started</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Getty</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tty1.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]# lsof -p 5474 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tty1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">agetty</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  5474</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    0u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   CHR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    4,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       0t0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  5636</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/tty1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">agetty</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  5474</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    1u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   CHR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    4,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       0t0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  5636</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/tty1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">agetty</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  5474</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    2u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   CHR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    4,1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       0t0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  5636</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/tty1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[root@localhost </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]#</span></span></code></pre></div><p>如果系统卡住没有看到这个界面, 则继续等待几分钟, 观察是否自动进入应急模式:<br> 如果进入, 则输入root后, 运行<code>journalctl</code>查看具体的问题<br> 如果无法进入, 重新启动, 输入内核参数<code>systemd.debug-shell=1</code>, 它会在systemd启动的早期在tty9运行一个shell, 用户在vnc上运行<code>CTRL+ALT+F9</code>可登陆, 运行<code>systemctl list-jobs</code>查看具体哪个服务卡住</p><p><code>systemctl list-jobs</code> 打印状态可以是&quot;starting&quot;或者&quot;waiting&quot;<br> &quot;starting&quot;的服务是可能引发问题的服务, 正式因为它一直运行, 所有其他相关服务处于&quot;waiting&quot;状态</p><p>当并未切换到真实目录时,即界面卡在&quot;Switch root&quot;, 此时是无法启动上面的debug-shell, 需要开启systemd自身的debug日志级别<br> 同时这也说明initramfs里面的systemd是OK的, 只是启动真实跟盘上的systemd出现异常了, 可以在initramfs阶段 手工chroot到/sysroot里执行 <code>rpm -V systemd</code>, <code>rpm -V glibc</code>, <code>rpm -V bash</code> 等命令查询下基础组件是否有损坏</p><h2 id="与kdump相关的initramfs知识" tabindex="-1">与kdump相关的initramfs知识 <a class="header-anchor" href="#与kdump相关的initramfs知识" aria-label="Permalink to &quot;与kdump相关的initramfs知识&quot;">​</a></h2><p>有两个方法判断是否crashkernel生效</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> dmesg</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;for crashkernel&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[Wed Sep  </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 22:24:54 2020] Reserving 128MB of memory at 720MB </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> crashkernel (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">System</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> RAM:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1535MB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sys/kernel/kexec_crash_size</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">134217728</span></span></code></pre></div><p><code>systemctl start kdump</code>的作用是检查内核参数, 生成含kdump相关功能的initramfs.<br> 通过IN_KDUMP这个环境变量,使重建的initramfs里含有kdump所有的脚本和命令. 这样一旦转储,新的initramfs里就可以sava vmcore了</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">root@localhost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~]#</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> head</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sbin/mkdumprd</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash --norc</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># New mkdumprd</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Copyright 2011 Red Hat, Inc.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Written by Cong Wang &lt;amwang@redhat.com&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">.</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /lib/kdump/kdump-lib.sh</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IN_KDUMP</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre></div><p><code>/etc/kdump.conf</code>是关于kdump的配置项, 可给initramfs添加文件或者内核参数,调整转储失败时的动作等.</p><h2 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-label="Permalink to &quot;参考&quot;">​</a></h2><ul><li><a href="https://freedesktop.org/wiki/Software/systemd/Debugging/" target="_blank" rel="noreferrer">https://freedesktop.org/wiki/Software/systemd/Debugging/</a></li><li><a href="https://www.freedesktop.org/software/systemd/man/bootup.html" target="_blank" rel="noreferrer">https://www.freedesktop.org/software/systemd/man/bootup.html</a></li><li><a href="https://www.freedesktop.org/software/systemd/man/systemctl.html" target="_blank" rel="noreferrer">https://www.freedesktop.org/software/systemd/man/systemctl.html</a></li><li><a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html" target="_blank" rel="noreferrer">https://www.freedesktop.org/software/systemd/man/systemd.service.html</a></li><li><a href="https://www.linux.com/training-tutorials/understanding-and-using-systemd/" target="_blank" rel="noreferrer">https://www.linux.com/training-tutorials/understanding-and-using-systemd/</a></li><li><a href="https://people.redhat.com/harald/dracut.html" target="_blank" rel="noreferrer">https://people.redhat.com/harald/dracut.html</a></li><li><a href="https://man7.org/linux/man-pages/man8/dracut.8.html" target="_blank" rel="noreferrer">https://man7.org/linux/man-pages/man8/dracut.8.html</a></li><li><a href="https://fedoraproject.org/wiki/How_to_debug_Dracut_problems" target="_blank" rel="noreferrer">https://fedoraproject.org/wiki/How_to_debug_Dracut_problems</a></li><li><a href="https://documentation.suse.com/sles/12-SP4/html/SLES-all/cha-udev.html" target="_blank" rel="noreferrer">https://documentation.suse.com/sles/12-SP4/html/SLES-all/cha-udev.html</a></li><li><a href="https://wiki.archlinux.org/index.php/udev" target="_blank" rel="noreferrer">https://wiki.archlinux.org/index.php/udev</a></li></ul>`,61),t=[k];function l(p,e,F,d,r,g){return a(),i("div",null,t)}const o=s(n,[["render",l]]);export{C as __pageData,o as default};

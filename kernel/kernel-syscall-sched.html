<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>系统调用与进程调度 | xixiliguo</title>
    <meta name="description" content="博客">
    <link rel="stylesheet" href="/assets/style.d1dca3a2.css">
    <link rel="modulepreload" href="/assets/app.526dca4e.js">
    <link rel="modulepreload" href="/assets/kernel_kernel-syscall-sched.md.29c8373b.lean.js">
    
    <script>(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-6b5fd0a9><!--[--><!--]--><!--[--><span tabindex="-1" data-v-45f6ae50></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-45f6ae50> Skip to content </a><!--]--><!----><header class="VPNav" data-v-6b5fd0a9 data-v-0e356168><div class="VPNavBar has-sidebar" data-v-0e356168 data-v-8856f192><div class="container" data-v-8856f192><div class="VPNavBarTitle has-sidebar" data-v-8856f192 data-v-6a6f7ff6><a class="title" href="/" data-v-6a6f7ff6><!--[--><img class="VPImage logo" src="/img/coast.jpg" data-v-73ae1788><!--]--><!--[-->xixiliguo<!--]--></a></div><div class="content" data-v-8856f192><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8856f192 data-v-a30758ee><span id="main-nav-aria-label" class="visually-hidden" data-v-a30758ee>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/linux-common-commands.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Linux运维<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/network/tcp.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->网络协议<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/golang/golang-exec.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Golang笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/k8s/runc.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->容器与k8s<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/radix-tree.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->算法笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/kernel/kernel-syscall-sched.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->内核分析<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/code_segment.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->杂项<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8856f192 data-v-311055f2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-311055f2 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-8856f192 data-v-0562f5c0 data-v-8dccea88><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8dccea88><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8dccea88><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8dccea88><div class="VPMenu" data-v-8dccea88 data-v-e73581a2><!----><!--[--><!--[--><!----><div class="group" data-v-0562f5c0><div class="item appearance" data-v-0562f5c0><p class="label" data-v-0562f5c0>Appearance</p><div class="appearance-action" data-v-0562f5c0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-0562f5c0 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8856f192 data-v-6f008456><span class="container" data-v-6f008456><span class="top" data-v-6f008456></span><span class="middle" data-v-6f008456></span><span class="bottom" data-v-6f008456></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-6b5fd0a9 data-v-92b0f14a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-92b0f14a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-92b0f14a><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-92b0f14a>Menu</span></button><a class="top-link" href="#" data-v-92b0f14a> Return to top </a></div><aside class="VPSidebar" data-v-6b5fd0a9 data-v-55e4c7db><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-55e4c7db><span class="visually-hidden" id="sidebar-aria-label" data-v-55e4c7db> Sidebar Navigation </span><!--[--><div class="group" data-v-55e4c7db><section class="VPSidebarGroup" data-v-55e4c7db data-v-1f69a7ed><div class="title" data-v-1f69a7ed><h2 class="title-text" data-v-1f69a7ed>内核分析</h2><div class="action" data-v-1f69a7ed><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-1f69a7ed><!--[--><a class="VPLink link" href="/kernel/kernel-cgroup-namespace.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>cgroup与命名空间</span><!--]--><!----></a><a class="VPLink link" href="/kernel/kernel-crash.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>crash分析</span><!--]--><!----></a><a class="VPLink link" href="/kernel/kernel-irq.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>中断</span><!--]--><!----></a><a class="VPLink link" href="/kernel/kernel-memory.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>内存管理</span><!--]--><!----></a><a class="VPLink link active" href="/kernel/kernel-syscall-sched.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>系统调用与进程调度</span><!--]--><!----></a><a class="VPLink link" href="/kernel/linux-trap.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux: Trap</span><!--]--><!----></a><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-6b5fd0a9 data-v-a4c57a06><div class="VPDoc has-sidebar" data-v-a4c57a06 data-v-79ca2460><div class="container" data-v-79ca2460><div class="aside" data-v-79ca2460><div class="aside-curtain" data-v-79ca2460></div><div class="aside-container" data-v-79ca2460><div class="aside-content" data-v-79ca2460><div class="VPDocAside" data-v-79ca2460 data-v-779d834d><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-779d834d data-v-51e5a8ce><div class="content" data-v-51e5a8ce><div class="outline-marker" data-v-51e5a8ce></div><div class="outline-title" data-v-51e5a8ce>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-51e5a8ce><span class="visually-hidden" id="doc-outline-aria-label" data-v-51e5a8ce> Table of Contents for current page </span><ul class="root" data-v-51e5a8ce><!--[--><li style="" data-v-51e5a8ce><a class="outline-link" href="#_64位下系统调用约定" data-v-51e5a8ce>64位下系统调用约定</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#task-struct部分字段的含义" data-v-51e5a8ce>task_struct部分字段的含义</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#进程管理" data-v-51e5a8ce>进程管理</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#调度细节" data-v-51e5a8ce>调度细节</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-779d834d></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-79ca2460><div class="content-container" data-v-79ca2460><!--[--><!--]--><main class="main" data-v-79ca2460><div style="position:relative;" class="vp-doc _kernel_kernel-syscall-sched" data-v-79ca2460><div><p>记录一些关于内核系统调用和进程调度相关的知识点, 以5.14内核为例</p><h2 id="_64位下系统调用约定" tabindex="-1">64位下系统调用约定 <a class="header-anchor" href="#_64位下系统调用约定" aria-hidden="true">#</a></h2><p>c语言的函数调用过程中:<br> RDI, RSI, RDX, RCX, R8, R9 分别代表第一个,二个,三个... 参数, RAX代表返回值<br> RBX, RSP, RBP, and R12–R15 是调用者保存寄存器, 意思是调用者先保存原先值,在子函数返回时需要恢复,以确保该寄存器的值没变</p><p>Linux系统调用时稍微有一点不同, 第三个参数不是放到RCX, 而是R10. RCX用于保存切换时用户态时的RIP</p><p>下面是golang在linux amd64的系统调用汇编</p><div class="language-go"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">// func Syscall6(trap, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, err uintptr)</span></span>
<span class="line"><span style="color:#A6ACCD;">TEXT ·</span><span style="color:#82AAFF;">Syscall6</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;">NOSPLIT</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">80</span></span>
<span class="line"><span style="color:#A6ACCD;">	CALL	runtime·</span><span style="color:#82AAFF;">entersyscall</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	a1</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> DI</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	a2</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">16</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> SI</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	a3</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">24</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> DX</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	a4</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">32</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> R10  </span><span style="color:#676E95;font-style:italic;">// 存放第三个参数</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	a5</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">40</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> R8</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	a6</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">48</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> R9</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	trap</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">0</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> AX	</span><span style="color:#676E95;font-style:italic;">// syscall entry</span></span>
<span class="line"><span style="color:#A6ACCD;">	SYSCALL</span></span>
<span class="line"><span style="color:#A6ACCD;">	CMPQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> $</span><span style="color:#F78C6C;">0xfffffffffffff001</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">// 判断AX 是否小于 MAX_ERRNO:-4095 , 是则成功 </span></span>
<span class="line"><span style="color:#A6ACCD;">	JLS	ok6</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	$</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> r1</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">56</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> r2</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">64</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	NEGQ	AX</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">72</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">             </span><span style="color:#676E95;font-style:italic;">// 错误时, 则负值变正值, 返回具体的错误码</span></span>
<span class="line"><span style="color:#A6ACCD;">	CALL	runtime·</span><span style="color:#82AAFF;">exitsyscall</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	RET</span></span>
<span class="line"><span style="color:#A6ACCD;">ok6</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	AX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> r1</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">56</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	DX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> r2</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">64</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	MOVQ	$</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> err</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">72</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">FP</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	CALL	runtime·</span><span style="color:#82AAFF;">exitsyscall</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">SB</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	RET</span></span>
<span class="line"></span></code></pre></div><p>系统调用返回前, 会执行<code>callq</code>, 将有符号的4字节扩展为8字节. 比如0x80000000 变为 ffffffff80000000, 0x40000000仍是40000000<br><a href="https://stackoverflow.com/questions/6555094/what-does-cltq-do-in-assembly" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/6555094/what-does-cltq-do-in-assembly</a><br> 所有系统调用的返回错误值范围为[-4095, -1], 所以可以无符号判断 RAX 小于 0xfffffffffffff001, 则为正常返回</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Kernel pointers have redundant information, so we can use a</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * scheme where we can return either an error code or a normal</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * pointer with the same return value.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * This should be a per-architecture thing, to allow different</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * error and pointer decisions.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_ERRNO</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">4095</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifndef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__ASSEMBLY__</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IS_ERR_VALUE</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">unlikely</span><span style="color:#89DDFF;">((</span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*)(</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)-</span><span style="color:#A6ACCD;">MAX_ERRNO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">__x64_sys_recv</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">:		</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> syscall with </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> parameters</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	callq	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">__fentry__</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	mov	</span><span style="color:#F78C6C;">0x70</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rdi</span><span style="color:#89DDFF;">),%</span><span style="color:#A6ACCD;">rdi	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> decode regs</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">di</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	mov	</span><span style="color:#F78C6C;">0x68</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rdi</span><span style="color:#89DDFF;">),%</span><span style="color:#A6ACCD;">rsi	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> decode regs</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">si</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	mov	</span><span style="color:#F78C6C;">0x60</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rdi</span><span style="color:#89DDFF;">),%</span><span style="color:#A6ACCD;">rdx	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> decode regs</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">dx</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	mov	</span><span style="color:#F78C6C;">0x38</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rdi</span><span style="color:#89DDFF;">),%</span><span style="color:#A6ACCD;">rcx	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> decode regs</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">r10</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	xor	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r9d</span><span style="color:#89DDFF;">,%</span><span style="color:#A6ACCD;">r9d	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> clear </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r9</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	xor	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r8d</span><span style="color:#89DDFF;">,%</span><span style="color:#A6ACCD;">r8d	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> clear </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r8</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	callq	__sys_recvfrom	</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">do</span><span style="color:#A6ACCD;"> the actual work in </span><span style="color:#82AAFF;">__sys_recvfrom</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">				    which takes </span><span style="color:#F78C6C;">6</span><span style="color:#A6ACCD;"> arguments</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	cltq			</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> extend </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> value to </span><span style="color:#F78C6C;">64</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">bit</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">	retq			</span><span style="color:#89DDFF;">&lt;--</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span></span>
<span class="line"></span></code></pre></div><p>64位下不是通过INT 0x80, 而是通过syscall指令触发系统调用, 对应的函数为<code>entry_SYSCALL_64</code>, 在这个函数里, 用户态的很多原始信息,比如rip,rsp都保存在<code>struct pt_regs</code>里, 然后 entry_SYSCALL_64 --&gt; do_syscall_64<br> 通过给<code>MSR_LSTAR</code>寄存器写入entry_SYSCALL_64地址, 那么执行syscall指令时就是切换到汇编entry_SYSCALL_64</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">wrmsr</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MSR_STAR</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">__USER32_CS </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> __KERNEL_CS</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">wrmsrl</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MSR_LSTAR</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">entry_SYSCALL_64</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p>将用户态时的rsp保存到per cpu变量cpu_tss_rw里面, 切换cpu为内核模式, 然后依次将寄存器里的值push, 填充pt_regs结构体. 保存所有用户态相关的信息<br> 从代码上看, 执行do_syscall_64前中断是关闭的, 在<code>syscall_enter_from_user_mode</code>里打开, 从<code>do_syscall_64</code>返回时又关闭了, 等执行了sysret后应该又打开了</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#82AAFF;">SYM_CODE_START</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">entry_SYSCALL_64</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	UNWIND_HINT_EMPTY</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	swapgs</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* tss.sp2 is scratch space. */</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rsp</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PER_CPU_VAR</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">cpu_tss_rw </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> TSS_sp2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	SWITCH_TO_KERNEL_CR3 scratch_reg</span><span style="color:#89DDFF;">=%</span><span style="color:#A6ACCD;">rsp</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#82AAFF;">PER_CPU_VAR</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">cpu_current_top_of_stack</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rsp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">SYM_INNER_LABEL</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">entry_SYSCALL_64_safe_stack</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> SYM_L_GLOBAL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* Construct struct pt_regs on stack */</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	$__USER_DS				</span><span style="color:#676E95;font-style:italic;">/* pt_regs-&gt;ss */</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#82AAFF;">PER_CPU_VAR</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">cpu_tss_rw </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> TSS_sp2</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* pt_regs-&gt;sp */</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r11					</span><span style="color:#676E95;font-style:italic;">/* pt_regs-&gt;flags */</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	$__USER_CS				</span><span style="color:#676E95;font-style:italic;">/* pt_regs-&gt;cs */</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rcx					</span><span style="color:#676E95;font-style:italic;">/* pt_regs-&gt;ip */</span></span>
<span class="line"><span style="color:#82AAFF;">SYM_INNER_LABEL</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">entry_SYSCALL_64_after_hwframe</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> SYM_L_GLOBAL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rax					</span><span style="color:#676E95;font-style:italic;">/* pt_regs-&gt;orig_ax */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	PUSH_AND_CLEAR_REGS rax</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">$</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">ENOSYS</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* IRQs are off. */</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rsp</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rdi</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* Sign extend the lower 32bit as syscall numbers are treated as int */</span></span>
<span class="line"><span style="color:#A6ACCD;">	movslq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">eax</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rsi</span></span>
<span class="line"><span style="color:#A6ACCD;">	call	do_syscall_64		</span><span style="color:#676E95;font-style:italic;">/* returns with IRQs disabled */</span></span>
<span class="line"></span></code></pre></div><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">__visible noinstr </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">do_syscall_64</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> pt_regs </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">regs</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> nr</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">add_random_kstack_offset</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">	nr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">syscall_enter_from_user_mode</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">regs</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/* syscall_enter_from_user_mode里面会检查一些权限, 比如是否满足SECCOMP. 对系统调用的审计也在这里 </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * 如果返回-1, 则不会执行下面的函数, 最终给用户态程序返回 -ENOSYS</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	*/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">instrumentation_begin</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">do_syscall_x64</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">regs</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nr</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">do_syscall_x32</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">regs</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> nr</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> nr </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#676E95;font-style:italic;">/* Invalid system call, but still a system call. */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">regs</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ax</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__x64_sys_ni_syscall</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">regs</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">instrumentation_end</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">syscall_exit_to_user_mode</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">regs</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>所有的系统调用的具体实现函数, 汇总到<code>sys_call_table</code>,同时<code>arch/x86/entry/syscalls/syscall_64.tbl</code> 里也可以直接查询系统调用号与具体实现函数名的对应关系</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> whatis sys_call_table</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sys_call_ptr_t</span><span style="color:#A6ACCD;"> sys_call_table</span><span style="color:#C792EA;">[]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> p sys_call_table</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">$</span><span style="color:#F78C6C;">9</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sys_call_ptr_t</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xffffffffb9b19c30</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> sym </span><span style="color:#F78C6C;">0xffffffffb9b19c30</span></span>
<span class="line"><span style="color:#82AAFF;">ffffffffb9b19c30</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> __x64_sys_read </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">usr</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">src</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">debug</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">kernel</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">4.18.0</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">305.3.1.el8_4</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">linux</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">4.18.0</span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">305.3.1.el8.x86_64</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">fs</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">read_write.c: </span><span style="color:#F78C6C;">586</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p><code>syscall_exit_to_user_mode -&gt; __syscall_exit_to_user_mode_work --&gt; exit_to_user_mode_prepare --&gt; exit_to_user_mode_loop</code>, 在exit_to_user_mode_loop里有一些重要的事情要做.<br> 如果该进程被标记为需要调度,即需要让出cpu,让其他进程执行<br> 该进程收到信号需要处理, 也是在退出syscall返回用户态空间前执行的</p><p><code>mov 0x38(%rdi),%ecx</code> 可以看到确实是将陷入内核态前的R10(代表第三个参数)赋值给RCX, 满足后续C语言的调用规约</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; dis -l __x64_sys_recv</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/src/debug/kernel-5.14.0-22.el9/linux-5.14.0-22.el9.x86_64/net/socket.c: 2111</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4400 &lt;__x64_sys_recv&gt;:    nopl   0x0(%rax,%rax,1) [FTRACE NOP]</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/src/debug/kernel-5.14.0-22.el9/linux-5.14.0-22.el9.x86_64/net/socket.c: 2114</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4405 &lt;__x64_sys_recv+5&gt;:  mov    0x60(%rdi),%rdx</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4409 &lt;__x64_sys_recv+9&gt;:  mov    0x68(%rdi),%rsi</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f440d &lt;__x64_sys_recv+13&gt;: xor    %r9d,%r9d</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4410 &lt;__x64_sys_recv+16&gt;: xor    %r8d,%r8d</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4413 &lt;__x64_sys_recv+19&gt;: mov    0x38(%rdi),%ecx</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4416 &lt;__x64_sys_recv+22&gt;: mov    0x70(%rdi),%edi</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4419 &lt;__x64_sys_recv+25&gt;: call   0xffffffffa21f4210 &lt;__sys_recvfrom&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/src/debug/kernel-5.14.0-22.el9/linux-5.14.0-22.el9.x86_64/net/socket.c: 2111</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f441e &lt;__x64_sys_recv+30&gt;: cltq</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffffffffa21f4420 &lt;__x64_sys_recv+32&gt;: ret</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; struct pt_regs -xo | grep 0x38</span></span>
<span class="line"><span style="color:#A6ACCD;">  [0x38] unsigned long r10;</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>sysretq</code>指令从RCS载入值到RIP, 返回用户态</p><p>从代码中搜索系统调用具体函数的技巧: 以open为例, 它有三个参数, 则通过<code>define3(open</code> 就能很快找到对应的实现</p><p>参考:<br><a href="http://abcdxyzk.github.io/blog/2012/11/23/assembly-args/" target="_blank" rel="noopener noreferrer">http://abcdxyzk.github.io/blog/2012/11/23/assembly-args/</a><br><a href="https://en.wikipedia.org/wiki/X86_calling_conventions" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/X86_calling_conventions</a><br><a href="https://cloud.tencent.com/developer/article/1492374" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1492374</a></p><h2 id="task-struct部分字段的含义" tabindex="-1">task_struct部分字段的含义 <a class="header-anchor" href="#task-struct部分字段的含义" aria-hidden="true">#</a></h2><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">u64        utime</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//用户态消耗的CPU时间</span></span>
<span class="line"><span style="color:#F07178;">u64        stime</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//内核态消耗的CPU时间</span></span>
<span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#F07178;">      nvcsw</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//自愿(voluntary)上下文切换计数</span></span>
<span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#F07178;">      nivcsw</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//非自愿(involuntary)上下文切换计数</span></span>
<span class="line"><span style="color:#F07178;">u64        start_time</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//进程启动时间，不包含睡眠时间</span></span>
<span class="line"><span style="color:#F07178;">u64        real_start_time</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">//进程启动时间，包含睡眠时间</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>utime, stime单位为ns, 两次时钟中断触发的时间间隔为<code>1/HZ</code>. 内核里面HZ一般是1000,(centos是1000, ubuntu是250), 在函数<code>account_process_tick</code>里每次更新utime,stime都是增加<code>TICK_NSEC</code> - steal-time`, TICK_NSEC为1000000,</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># grep CONFIG_HZ= /boot/config-5.14.0-22.el9.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">CONFIG_HZ=1000</span></span>
<span class="line"></span></code></pre></div><div class="language-c"><span class="copy"></span><pre><code><span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/* TICK_NSEC is the time between ticks in nsec assuming SHIFTED_HZ */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TICK_NSEC</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">NSEC_PER_SEC</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">HZ</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)/</span><span style="color:#A6ACCD;">HZ</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Account a tick to a process and cpustat</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * @p: the process that the CPU time gets accounted to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * @user_tick: is the tick from userspace</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * @rq: the pointer to rq</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Tick demultiplexing follows the order</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * - pending hardirq update</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * - pending softirq update</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * - user_time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * - idle_time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * - system time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *   - check for guest_time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *   - else account as system_time</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Check for hardirq is done both for system and user time as there is</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * no timer going off while we are on hardirq and hence we may never get an</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * opportunity to update it solely in system time.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * p-&gt;stime and friends are only updated on system time and not on irq</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * softirq as those do not count in task exec_runtime any more.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">irqtime_account_process_tick</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> user_tick</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">					 </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> ticks</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	u64 other</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> cputime </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> TICK_NSEC </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> ticks</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * When returning from idle, many ticks can get accounted at</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * once, including some ticks of steal, irq, and softirq time.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Subtract those ticks from the amount of time accounted to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * idle, or potentially user or system time. Due to rounding,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * other time can exceed ticks occasionally.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	other </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">account_other_time</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">ULONG_MAX</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">other </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> cputime</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	cputime </span><span style="color:#89DDFF;">-=</span><span style="color:#F07178;"> other</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">this_cpu_ksoftirqd</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> p</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 * ksoftirqd time do not get accounted in cpu_softirq_time.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 * So, we have to handle it separately here.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 * Also, p-&gt;stime needs to be updated for ksoftirqd.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">account_system_index_time</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> cputime</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> CPUTIME_SOFTIRQ</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">user_tick</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">account_user_time</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> cputime</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">this_rq</span><span style="color:#89DDFF;">()-&gt;</span><span style="color:#A6ACCD;">idle</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">account_idle_time</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">cputime</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">flags</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#F07178;"> PF_VCPU</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">/* System time or guest time */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">account_guest_time</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> cputime</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">account_system_index_time</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> cputime</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> CPUTIME_SYSTEM</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>大致的调用关系</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">     	irqtime_account_process_tick+1</span></span>
<span class="line"><span style="color:#A6ACCD;">        update_process_times+81</span></span>
<span class="line"><span style="color:#A6ACCD;">        tick_sched_handle+34</span></span>
<span class="line"><span style="color:#A6ACCD;">        tick_sched_timer+97</span></span>
<span class="line"><span style="color:#A6ACCD;">        __hrtimer_run_queues+298</span></span>
<span class="line"><span style="color:#A6ACCD;">        hrtimer_interrupt+272</span></span>
<span class="line"><span style="color:#A6ACCD;">        __sysvec_apic_timer_interrupt+92</span></span>
<span class="line"><span style="color:#A6ACCD;">        sysvec_apic_timer_interrupt+55</span></span>
<span class="line"><span style="color:#A6ACCD;">        asm_sysvec_apic_timer_interrupt+18</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">update_process_times</span></span>
<span class="line"><span style="color:#A6ACCD;">	irqtime_account_process_tick     </span><span style="color:#676E95;font-style:italic;">/* 更新cpu信息 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	scheduler_tick                   </span><span style="color:#676E95;font-style:italic;">/* 更新调度相关的信息, 比如 vruntime */</span></span>
<span class="line"></span></code></pre></div><p>start_time, real_start_time单位是ns, 指自系统启动以来到进程创建时流逝的时间, 在<code>copy_process</code>里赋值</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	p-&gt;start_time = ktime_get_ns();</span></span>
<span class="line"><span style="color:#A6ACCD;">	p-&gt;real_start_time = ktime_get_boot_ns();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>如下显示systemd进程时系统启动17ms后创建, 截止dump生成,以运行6小时多.</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> ps -t 1</span></span>
<span class="line"><span style="color:#A6ACCD;">PID: 1      TASK: ffff8fb0c6dc2f80  CPU: 0   COMMAND: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">systemd</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    RUN TIME: 06:34:57</span></span>
<span class="line"><span style="color:#A6ACCD;">  START TIME: 17000000</span></span>
<span class="line"><span style="color:#A6ACCD;">       UTIME: 1072507605</span></span>
<span class="line"><span style="color:#A6ACCD;">       STIME: 1248244355</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>我们在<code>/proc/[pid]/stat</code>里看到的utime 和 stime单位是clock ticks, 内核里HZ每个版本可能不一样, 但为了保持用户态的一致性,暴露给用户态的USER_HZ却一直都是100. 通过<code>nsec_to_clock_t</code> 将task_struct-&gt;utime,stime转化为<code>ticks</code>. 在centos8 x86_64环境为<code>x/( NSEC_PER_SEC / USER_HZ)</code></p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">u64 </span><span style="color:#FFCB6B;">nsec_to_clock_t</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u64 x</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">NSEC_PER_SEC</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">%</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">USER_HZ</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">div_u64</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">x</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> NSEC_PER_SEC </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> USER_HZ</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#elif</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">USER_HZ</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">%</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">512</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">div_u64</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">x </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> USER_HZ </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">512</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> NSEC_PER_SEC </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">512</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">         * max relative error 5.7e-8 (1.8s per year) for USER_HZ &lt;= 1024,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">         * overflow after 64.99 years.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">         * exact for HZ=60, 72, 90, 120, 144, 180, 300, 600, 900, ...</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">         */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">div_u64</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">x </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">9</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">9ull</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> NSEC_PER_SEC </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">USER_HZ </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">/</span><span style="color:#F07178;"> USER_HZ</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><code>/proc/[pid]/stat</code>的具体实现在<code>fs/proc/array.c</code>里的<code>do_task_stat</code></p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">seq_put_decimal_ull</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nsec_to_clock_t</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">utime</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">seq_put_decimal_ull</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">m</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nsec_to_clock_t</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">stime</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span></code></pre></div><p><code>top</code>里显示cpu的hi和si在<code>irqtime_account_irq</code>计算, 该函数在irq_enter和irq_exit时运行. ksoftirq的处理时间不仅算在自己进程的stime上, 还会算到cpu的si上面</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">account_softirq_enter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">tsk</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">vtime_account_irq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> SOFTIRQ_OFFSET</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">irqtime_account_irq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> SOFTIRQ_OFFSET</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">      </span><span style="color:#676E95;font-style:italic;">/*更新starttime, 但第二个参数不让计算差值*/</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">account_softirq_exit</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">tsk</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">vtime_account_softirq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">irqtime_account_irq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">                   </span><span style="color:#676E95;font-style:italic;">/*更新starttime, 并将差值(now-starttime)统计进去*/</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">account_hardirq_enter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">tsk</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">vtime_account_irq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> HARDIRQ_OFFSET</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">irqtime_account_irq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> HARDIRQ_OFFSET</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">     </span><span style="color:#676E95;font-style:italic;">/*更新starttime, 但第二个参数不让计算差值*/</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">account_hardirq_exit</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">tsk</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">vtime_account_hardirq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">irqtime_account_irq</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">tsk</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">                  </span><span style="color:#676E95;font-style:italic;">/*更新starttime, 并将差值(now-starttime)统计进去*/</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>通过task获取pt_regs的函数如下, 这里记录了进程进入内核态时, 保存的一些用户态信息.</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_KASAN</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">KASAN_STACK_ORDER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">KASAN_STACK_ORDER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">THREAD_SIZE_ORDER</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> KASAN_STACK_ORDER</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">THREAD_SIZE</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">PAGE_SIZE </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> THREAD_SIZE_ORDER</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">task_pt_regs</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">task</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#89DDFF;">({</span><span style="color:#F07178;">									</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#F07178;"> __ptr </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">unsigned</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#82AAFF;">task_stack_page</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">task</span><span style="color:#89DDFF;">);</span><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#F07178;">	__ptr </span><span style="color:#89DDFF;">+=</span><span style="color:#F07178;"> THREAD_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> TOP_OF_KERNEL_STACK_PADDING</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">((</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> pt_regs </span><span style="color:#89DDFF;">*)</span><span style="color:#F07178;">__ptr</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;">					</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#89DDFF;">})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_X86_32</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_VM86</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#  define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TOP_OF_KERNEL_STACK_PADDING</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">16</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#  define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TOP_OF_KERNEL_STACK_PADDING</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># endif</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TOP_OF_KERNEL_STACK_PADDING</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>pid的类型为int,但pidmax默认值在kernel/pid.c里的<code>pid_idr_init</code>设置, 新分配的pid是上一次分配的pid加1, 直到pid_max, 然后循环使用已闲置的最小pid.</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> __init </span><span style="color:#82AAFF;">pid_idr_init</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/* Verify no one has done anything silly: */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">BUILD_BUG_ON</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">PID_MAX_LIMIT </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> PIDNS_ADDING</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/* bump default and minimum pid_max based on number of cpus */</span></span>
<span class="line"><span style="color:#F07178;">	pid_max </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">min</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">pid_max_max</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">max_t</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> pid_max</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				PIDS_PER_CPU_DEFAULT </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">num_possible_cpus</span><span style="color:#89DDFF;">()));</span></span>
<span class="line"><span style="color:#F07178;">	pid_max_min </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">max_t</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> pid_max_min</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				PIDS_PER_CPU_MIN </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">num_possible_cpus</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">pr_info</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">pid_max: default: %u minimum: %u</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> pid_max</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> pid_max_min</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#82AAFF;">idr_init</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">init_pid_ns</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">idr</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#A6ACCD;">init_pid_ns</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pid_cachep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">KMEM_CACHE</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">pid</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			SLAB_HWCACHE_ALIGN </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> SLAB_PANIC </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> SLAB_ACCOUNT</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>如果要通过<code>sysctl -w kernel.pid_max=xxx</code>调节, 64位下最大值为4194304. 一般CONFIG_BASE_SMALL为N.</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * A maximum of 4 million PIDs should be enough for a while.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * [NOTE: PID/TIDs are limited to 2^29 ~= 500+ million, see futex.h.]</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PID_MAX_LIMIT</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">CONFIG_BASE_SMALL </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> PAGE_SIZE </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(sizeof(</span><span style="color:#C792EA;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> PID_MAX_DEFAULT</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre></div><p>在<code>copy_process</code>里先判断是否超过ulimit里面的限制, 但root用户的进程不受这个限制</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">is_ucounts_overlimit</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">task_ucounts</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> UCOUNT_RLIMIT_NPROC</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">rlimit</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">RLIMIT_NPROC</span><span style="color:#89DDFF;">)))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">real_cred</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">user</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#F07178;"> INIT_USER </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">		    </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">capable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">CAP_SYS_RESOURCE</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">capable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">CAP_SYS_ADMIN</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#F07178;"> bad_fork_free</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>如果当前的线程数(其实就是task_struct的数量, 在linux进程和线程其实是都是task_struct), 超过/proc/sys/kernel/threads-max, 也会报错</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * If multiple threads are within copy_process(), then this check</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * triggers too late. This doesn&#39;t hurt, the check is only there</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * to stop root fork bombs.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	retval </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">EAGAIN</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">data_race</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nr_threads </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> max_threads</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#A6ACCD;"> bad_fork_cleanup_count</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>紧接着如果因超过pid_max, 且没闲置的pid, 则会导致创建进程失败.</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">pid </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">init_struct_pid</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		pid </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">alloc_pid</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">nsproxy</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">pid_ns_for_children</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">set_tid</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">set_tid_size</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">IS_ERR</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">pid</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			retval </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PTR_ERR</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">pid</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#F07178;"> bad_fork_cleanup_thread</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>最后还会检查cgroup里的的pid_max限制</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Ensure that the cgroup subsystem policies allow the new process to be</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * forked. It should be noted that the new process&#39;s css_set can be changed</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * between here and cgroup_post_fork() if an organisation operation is in</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * progress.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	retval </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">cgroup_can_fork</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">retval</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#A6ACCD;"> bad_fork_put_pidfd</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>日志里面有如下报错,就是因为这个原因<br> cgroup: fork rejected by pids controller in /user.slice/user-0.slice/session-7.scope</p><p>我们再来看经常遇到的超过文件句柄数相关的一些知识<br> 通过<code>ulimit -n</code>设置进程最大的打开文件数, 最大值为<code>1048576</code>, 它是受限于<code>sysctl fs.nr_open</code></p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> sysctl_nr_open __read_mostly </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1024</span><span style="color:#89DDFF;">*</span><span style="color:#F78C6C;">1024</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">//默认值</span></span>
<span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> sysctl_nr_open_min </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> BITS_PER_LONG</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/* our min() is unusable in constant expressions ;-/ */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__const_min</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> y</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">y</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">y</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> sysctl_nr_open_max </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">__const_min</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">INT_MAX</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~(</span><span style="color:#C792EA;">size_t</span><span style="color:#89DDFF;">)</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">/sizeof(</span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;">BITS_PER_LONG</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">//最大值</span></span>
<span class="line"></span></code></pre></div><p>有两个跟文件句柄数的报错, <code>ENFILE</code>表示超过了OS整的系统限制, <code>EMFILE</code>表示超过了自身的<code>/proc/[pid]/limits</code>里面<code>Max open files</code>的限制</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">/usr/include/asm-generic/errno-base.h:#define   ENFILE          23      /* File table overflow */</span></span>
<span class="line"><span style="color:#A6ACCD;">/usr/include/asm-generic/errno-base.h:#define   EMFILE          24      /* Too many open files */</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>OS系统级所有打开的文件句柄最大数, 普通用户受限, 但root的进程不受限</p><div class="language-shell"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost abc</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;font-style:italic;"># sysctl fs.file-nr</span></span>
<span class="line"><span style="color:#A6ACCD;">fs.file-nr = 1984       0       789985</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost abc</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;font-style:italic;"># sysctl fs.file-max</span></span>
<span class="line"><span style="color:#A6ACCD;">fs.file-max = 789985</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost abc</span><span style="color:#89DDFF;">]</span><span style="color:#676E95;font-style:italic;">#</span></span>
<span class="line"></span></code></pre></div><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> file </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">alloc_empty_file</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> flags</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> cred </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">cred</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">static</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">long</span><span style="color:#F07178;"> old_max</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> file </span><span style="color:#89DDFF;">*</span><span style="color:#F07178;">f</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Privileged users can go above max_files</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_nr_files</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">files_stat</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">max_files</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">capable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">CAP_SYS_ADMIN</span><span style="color:#89DDFF;">))</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 * percpu_counters are inaccurate.  Do an expensive check before</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 * we go and fail.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">		 */</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">percpu_counter_sum_positive</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">nr_files</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">files_stat</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">max_files</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;font-style:italic;">goto</span><span style="color:#F07178;"> over</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	f </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__alloc_file</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">flags</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> cred</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">IS_ERR</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">f</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">percpu_counter_inc</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#F07178;">nr_files</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> f</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">over:</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/* Ran out of filps - report that */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">get_nr_files</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;"> old_max</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">pr_info</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">VFS: file-max limit %lu reached</span><span style="color:#A6ACCD;">\n</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_max_files</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#F07178;">		old_max </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">get_nr_files</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">ERR_PTR</span><span style="color:#89DDFF;">(-</span><span style="color:#F07178;">ENFILE</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>task_struct-&gt;stack 指向进程的内核栈, 在 dup_task_struct --&gt; alloc_thread_stack_node 里面分配, 通常是通过vmalloc分配, 而不是slab系统</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Allocated stacks are cached and later reused by new threads,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * so memcg accounting is performed manually on assigning/releasing</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * stacks to tasks. Drop __GFP_ACCOUNT.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	stack </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__vmalloc_node_range</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">THREAD_SIZE</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> THREAD_ALIGN</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				     VMALLOC_START</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> VMALLOC_END</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				     THREADINFO_GFP </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">__GFP_ACCOUNT</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				     PAGE_KERNEL</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">				     </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> node</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__builtin_return_address</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * We can&#39;t call find_vm_area() in interrupt context, and</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * free_thread_stack() can be called in interrupt context,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * so cache the vm_struct.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">stack</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">tsk</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">stack_vm_area</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">find_vm_area</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">stack</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">tsk</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">stack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> stack</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; task | grep stack</span></span>
<span class="line"><span style="color:#A6ACCD;">  stack = 0xffff97c5825e0000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  stack_canary = 2863369865746246656,</span></span>
<span class="line"><span style="color:#A6ACCD;">  curr_ret_stack = -1,</span></span>
<span class="line"><span style="color:#A6ACCD;">  ret_stack = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  stack_vm_area = 0xffff8c900af5b040,</span></span>
<span class="line"><span style="color:#A6ACCD;">  stack_refcount = {</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; grep 0xffff97c5825e0000 /proc/vmallocinfo</span></span>
<span class="line"><span style="color:#A6ACCD;">0xffff97c5825e0000-0xffff97c5825e5000   20480 dup_task_struct+0x49/0x300 pages=4 vmalloc N0=4</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="进程管理" tabindex="-1">进程管理 <a class="header-anchor" href="#进程管理" aria-hidden="true">#</a></h2><p><code>current</code>永远指向当前cpu上运行的进程的task_struct, 实现方式如下</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#82AAFF;">DECLARE_PER_CPU</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*,</span><span style="color:#A6ACCD;"> current_task</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> __always_inline </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#82AAFF;">get_current</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">this_cpu_read_stable</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">current_task</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">current</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_current</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><p><code>init_task</code>代表了pid为0的进程, 即swapper/0, 通过它和<code>task_struct.tasks</code>可以找到所有进程</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; list task_struct.tasks -s task_struct.comm -h init_task | head -19</span></span>
<span class="line"><span style="color:#A6ACCD;">ffffffffb481a940</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;swapper/0\000\000\000\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd300218000</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;systemd\000\060\000\000\000\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd30021e300</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;kthreadd\000\000\000\000\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd30021ca40</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;rcu_gp\000d\000\000\000\000\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd3002198c0</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;rcu_par_gp\000\000\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd30023b180</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;kworker/0:0H\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd30023ca40</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;mm_percpu_wq\000\000\000&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd3002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;rcu_tasks_kthre&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd300266300</span></span>
<span class="line"><span style="color:#A6ACCD;">  comm = &quot;rcu_tasks_rude_&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9dd300264a40</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>普通进程的nice值是优先级. 用户态显示的范围为 [-20 ~ 19], 值越低,优先级越高.对应的task_struct的字段为static_prio, 取值为[100～139]</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_NICE</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">19</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MIN_NICE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">20</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NICE_WIDTH</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_NICE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> MIN_NICE </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Priority of a process goes from 0..MAX_PRIO-1, valid RT</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * priority is 0..MAX_RT_PRIO-1, and SCHED_NORMAL/SCHED_BATCH</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * tasks are in the range MAX_RT_PRIO..MAX_PRIO-1. Priority</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * values are inverted: lower p-&gt;prio value means higher priority.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * The MAX_USER_RT_PRIO value allows the actual maximum</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * RT priority to be separate from the value exported to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * user-space.  This allows kernel threads to set their</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * priority to a value higher than any user task. Note:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * MAX_RT_PRIO must not be smaller than MAX_USER_RT_PRIO.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_USER_RT_PRIO</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">100</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_RT_PRIO</span><span style="color:#A6ACCD;">		MAX_USER_RT_PRIO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_PRIO</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_RT_PRIO </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> NICE_WIDTH</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DEFAULT_PRIO</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_RT_PRIO </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> NICE_WIDTH </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Convert user-nice values [ -20 ... 0 ... 19 ]</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * and back.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NICE_TO_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">nice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> DEFAULT_PRIO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PRIO_TO_NICE</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">prio</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">prio</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> DEFAULT_PRIO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * &#39;User priority&#39; is the nice value converted to something we</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * can work with better when scaling various scheduler parameters,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * it&#39;s a [ 0 ... 39 ] range.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">USER_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)-</span><span style="color:#A6ACCD;">MAX_RT_PRIO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_USER_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">USER_PRIO</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)-&gt;</span><span style="color:#A6ACCD;">static_prio</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_USER_PRIO</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">USER_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_PRIO</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Convert nice value [19,-20] to rlimit style value [1,40].</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nice_to_rlimit</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> nice</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">MAX_NICE </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> nice </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * task_nice - return the nice value of a given task.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#C792EA;font-style:italic;">@p</span><span style="color:#676E95;font-style:italic;">: the task in question.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Return: The nice value [ -20 ... 0 ... 19 ].</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">task_nice</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PRIO_TO_NICE</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">)-&gt;</span><span style="color:#A6ACCD;">static_prio</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">```普通进程的nice值是优先级. 用户态显示的范围为 </span><span style="color:#89DDFF;">[-</span><span style="color:#F78C6C;">20</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">19</span><span style="color:#89DDFF;">],</span><span style="color:#A6ACCD;"> 值越低</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">优先级越高.对应的task_struct的字段为static_prio</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> 取值为</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">100</span><span style="color:#A6ACCD;">～</span><span style="color:#F78C6C;">139</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">``` c</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_NICE</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">19</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MIN_NICE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">-</span><span style="color:#F78C6C;">20</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NICE_WIDTH</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_NICE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> MIN_NICE </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Priority of a process goes from 0..MAX_PRIO-1, valid RT</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * priority is 0..MAX_RT_PRIO-1, and SCHED_NORMAL/SCHED_BATCH</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * tasks are in the range MAX_RT_PRIO..MAX_PRIO-1. Priority</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * values are inverted: lower p-&gt;prio value means higher priority.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * The MAX_USER_RT_PRIO value allows the actual maximum</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * RT priority to be separate from the value exported to</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * user-space.  This allows kernel threads to set their</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * priority to a value higher than any user task. Note:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * MAX_RT_PRIO must not be smaller than MAX_USER_RT_PRIO.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_USER_RT_PRIO</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">100</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_RT_PRIO</span><span style="color:#A6ACCD;">		MAX_USER_RT_PRIO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_PRIO</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_RT_PRIO </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> NICE_WIDTH</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DEFAULT_PRIO</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_RT_PRIO </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> NICE_WIDTH </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Convert user-nice values [ -20 ... 0 ... 19 ]</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * to static priority [ MAX_RT_PRIO..MAX_PRIO-1 ],</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * and back.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">NICE_TO_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">nice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">nice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> DEFAULT_PRIO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PRIO_TO_NICE</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">prio</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">prio</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> DEFAULT_PRIO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * &#39;User priority&#39; is the nice value converted to something we</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * can work with better when scaling various scheduler parameters,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * it&#39;s a [ 0 ... 39 ] range.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">USER_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)-</span><span style="color:#A6ACCD;">MAX_RT_PRIO</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_USER_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">USER_PRIO</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)-&gt;</span><span style="color:#A6ACCD;">static_prio</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_USER_PRIO</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">USER_PRIO</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">MAX_PRIO</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Convert nice value [19,-20] to rlimit style value [1,40].</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">nice_to_rlimit</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">long</span><span style="color:#A6ACCD;"> nice</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">MAX_NICE </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> nice </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * task_nice - return the nice value of a given task.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * </span><span style="color:#C792EA;font-style:italic;">@p</span><span style="color:#676E95;font-style:italic;">: the task in question.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * Return: The nice value [ -20 ... 0 ... 19 ].</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">task_nice</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> task_struct </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">PRIO_TO_NICE</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">p</span><span style="color:#89DDFF;">)-&gt;</span><span style="color:#A6ACCD;">static_prio</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="调度细节" tabindex="-1">调度细节 <a class="header-anchor" href="#调度细节" aria-hidden="true">#</a></h2><p>linux支持的调度策略如下</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * The order of the sched class addresses are important, as they are</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * used to determine the order of the priority of each sched class in</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * relation to each other.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">SCHED_DATA</span><span style="color:#A6ACCD;">				\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">STRUCT_ALIGN</span><span style="color:#89DDFF;">();</span><span style="color:#A6ACCD;">				\</span></span>
<span class="line"><span style="color:#A6ACCD;">	__begin_sched_classes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> .</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">		\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">*(</span><span style="color:#A6ACCD;">__idle_sched_class</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">			\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">*(</span><span style="color:#A6ACCD;">__fair_sched_class</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">			\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">*(</span><span style="color:#A6ACCD;">__rt_sched_class</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">			\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">*(</span><span style="color:#A6ACCD;">__dl_sched_class</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">			\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">*(</span><span style="color:#A6ACCD;">__stop_sched_class</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">			\</span></span>
<span class="line"><span style="color:#A6ACCD;">	__end_sched_classes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> .</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>struct rq.clock 的单位是ns, cfs里<code>update_curr</code>用于更新进程运行时的统计量</p><p>分两种情况:</p><ol><li>主动式调度 当写IO,或者等待其他资源时,主动让出cpu的, 代码中直接调用<code>__schedule</code></li><li>被动式调度 <ul><li>自身时间执行时间过长,占用cpu过多, 调度管理会通过时钟中断调用<code>scheduler_tick</code>更新进程相关的统计信息, 判断是否需要重新调度. 如果时,则将该进程标记为<code>_TIF_NEED_RESCHED</code><ul><li>curr-&gt;sched_class-&gt;task_tick(rq, curr, 0) 里调用 entity_tick()</li><li>entity_tick() 调用 update_curr 更新当前进程 vruntime, 调用 check_preempt_tick 检测是否需要被调度</li><li>check_preempt_tick 中判断已运行的是否是否大于ideal_runtime(估算的进程应该运行的时间), 当前进程的vruntime和队列里最小的vruntime, 如果超过阈值,说明有其他进程更需要运行.</li></ul></li><li>被刚刚唤醒的进程,如果优先级更高,也会标记为<code>_TIF_NEED_RESCHED</code><ul><li>try_to_wake_up -&gt; ttwu_queue -&gt; ttwu_do_activate -&gt; activate_task 加入到可运行队列</li><li>try_to_wake_up -&gt; ttwu_queue -&gt; ttwu_do_activate -&gt; ttwu_do_wakeup 检查是否需要被调度</li></ul></li><li>抢占时机, 什么时候让已标记为<code>_TIF_NEED_RESCHED</code>的运行<code>__schedule</code>调出去 <ul><li>用户态进程 <ul><li>系统调用调用返回时,在<code>exit_to_user_mode_loop</code>里</li><li>中断返回时, irqentry_exit --&gt; irqentry_exit_to_user_mode --&gt; exit_to_user_mode_prepare --&gt; exit_to_user_mode_loop</li></ul></li><li>内核态进程 如果没有配置<code>CONFIG_PREEMPT=y</code>, 那么内核态运行时无法抢占, 假设该功能打开则: <ul><li>中断返回时,irqentry_exit --&gt; irqentry_exit_cond_resched --&gt; preempt_schedule_irq</li><li>preempt_disable在某些路径关闭抢占后, 用preempt_enable打开时可能执行<code>__schedule</code></li></ul></li><li>正是因为主流的linux发行版不支持内核抢占,所以系统调用运行时间过长会导致应用程序处理延迟,因为一直要等到临近返回用户态时才主动调度出去</li></ul></li></ul></li></ol><p>无论主动还是被动, 都会通过<code>schedule</code>把进程切出去, schedule --&gt; __schedule --&gt; context_switch --&gt; switch_to --&gt; __switch_to_asm --&gt;</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">switch_to</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">prev</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> next</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> last</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">					\</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">									</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">last</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">__switch_to_asm</span><span style="color:#89DDFF;">((</span><span style="color:#F07178;">prev</span><span style="color:#89DDFF;">),</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">next</span><span style="color:#89DDFF;">)));</span><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#82AAFF;">SYM_FUNC_START</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">__switch_to_asm</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Save callee-saved registers</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * This must match the order in inactive_task_frame</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rbp</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rbx</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r12</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r13</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r14</span></span>
<span class="line"><span style="color:#A6ACCD;">	pushq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r15</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* switch stack */</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rsp</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_threadsp</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rdi</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#82AAFF;">TASK_threadsp</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rsi</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rsp    </span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* 执行完这个命令之后, 后续操作都是在next这个进程的内核栈进行了 */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_STACKPROTECTOR</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#82AAFF;">TASK_stack_canary</span><span style="color:#89DDFF;">(%</span><span style="color:#A6ACCD;">rsi</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rbx</span></span>
<span class="line"><span style="color:#A6ACCD;">	movq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rbx</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PER_CPU_VAR</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fixed_percpu_data</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> stack_canary_offset</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_RETPOLINE</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * When switching from a shallower to a deeper call stack</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * the RSB may either underflow or use entries populated</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * with userspace addresses. On CPUs where those concerns</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * exist, overwrite the RSB with entries which capture</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * speculative execution to prevent attack.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	FILL_RETURN_BUFFER </span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r12</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> RSB_CLEAR_LOOPS</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> X86_FEATURE_RSB_CTXSW</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* restore callee-saved registers */</span></span>
<span class="line"><span style="color:#A6ACCD;">	popq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r15</span></span>
<span class="line"><span style="color:#A6ACCD;">	popq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r14</span></span>
<span class="line"><span style="color:#A6ACCD;">	popq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r13</span></span>
<span class="line"><span style="color:#A6ACCD;">	popq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">r12</span></span>
<span class="line"><span style="color:#A6ACCD;">	popq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rbx</span></span>
<span class="line"><span style="color:#A6ACCD;">	popq	</span><span style="color:#89DDFF;">%</span><span style="color:#A6ACCD;">rbp</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	jmp	__switch_to</span></span>
<span class="line"><span style="color:#82AAFF;">SYM_FUNC_END</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">__switch_to_asm</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-79ca2460 data-v-04568844><div class="edit-info" data-v-04568844><!----><div class="last-updated" data-v-04568844><p class="VPLastUpdated" data-v-04568844 data-v-0ce8c960>Last updated: <time datatime="2022-07-14T14:54:09.000Z" data-v-0ce8c960></time></p></div></div><div class="prev-next" data-v-04568844><div class="pager" data-v-04568844><a class="pager-link prev" href="/kernel/kernel-memory.html" data-v-04568844><span class="desc" data-v-04568844>Previous page</span><span class="title" data-v-04568844>内存管理</span></a></div><div class="has-prev pager" data-v-04568844><a class="pager-link next" href="/kernel/linux-trap.html" data-v-04568844><span class="desc" data-v-04568844>Next page</span><span class="title" data-v-04568844>Linux: Trap</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-6b5fd0a9 data-v-5b331722><div class="container" data-v-5b331722><p class="message" data-v-5b331722>Released under the MIT License.</p><p class="copyright" data-v-5b331722>Copyright © 2022-present xixiliguo</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_algorithm-dfs.md\":\"a73dea67\",\"algorithm_binary-index-tree.md\":\"8bc3e51f\",\"algorithm_radix-tree.md\":\"6b75afb6\",\"algorithm_segment-tree.md\":\"c689b78e\",\"algorithm_unionfind.md\":\"a646711f\",\"golang_golang-exec.md\":\"357621ac\",\"golang_strings-algorithm-golang.md\":\"57a20191\",\"index.md\":\"27757f36\",\"k8s_runc.md\":\"09e5ae92\",\"kernel_kernel-cgroup-namespace.md\":\"4a81fd3c\",\"kernel_kernel-crash.md\":\"27a485e9\",\"kernel_kernel-irq.md\":\"0bfc9b45\",\"kernel_kernel-memory.md\":\"1c2cf851\",\"kernel_kernel-syscall-sched.md\":\"29c8373b\",\"kernel_linux-trap.md\":\"ae6473f3\",\"linux_atop.md\":\"6cfa95b0\",\"linux_bandersnatch-pypi.md\":\"dee4724b\",\"linux_cloud-init.md\":\"e0bc6141\",\"linux_dns.md\":\"ccf3bd81\",\"linux_linux-boot.md\":\"459acaa4\",\"linux_linux-common-commands.md\":\"c3e4942a\",\"linux_linux-shadow.md\":\"4d01a795\",\"linux_multi-queue.md\":\"9db1b9ad\",\"linux_ntp.md\":\"0f26af7e\",\"linux_yum-update.md\":\"67a0bf95\",\"network_libvirt-network.md\":\"90682305\",\"network_tcp.md\":\"2211909d\",\"network_tcpdump-wireshark.md\":\"a2fe5423\",\"others_code_segment.md\":\"f0f03c59\",\"others_lua-implemention-gc.md\":\"80382876\",\"others_lua-implemention-type-value.md\":\"e4816df1\"}")</script>
    <script type="module" async src="/assets/app.526dca4e.js"></script>
    
  </body>
</html>
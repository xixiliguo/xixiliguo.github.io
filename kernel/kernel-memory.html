<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内存管理 | xixiliguo</title>
    <meta name="description" content="博客">
    <link rel="stylesheet" href="/assets/style.d1dca3a2.css">
    <link rel="modulepreload" href="/assets/app.526dca4e.js">
    <link rel="modulepreload" href="/assets/kernel_kernel-memory.md.1c2cf851.lean.js">
    
    <script>(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-6b5fd0a9><!--[--><!--]--><!--[--><span tabindex="-1" data-v-45f6ae50></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-45f6ae50> Skip to content </a><!--]--><!----><header class="VPNav" data-v-6b5fd0a9 data-v-0e356168><div class="VPNavBar has-sidebar" data-v-0e356168 data-v-8856f192><div class="container" data-v-8856f192><div class="VPNavBarTitle has-sidebar" data-v-8856f192 data-v-6a6f7ff6><a class="title" href="/" data-v-6a6f7ff6><!--[--><img class="VPImage logo" src="/img/coast.jpg" data-v-73ae1788><!--]--><!--[-->xixiliguo<!--]--></a></div><div class="content" data-v-8856f192><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-8856f192 data-v-a30758ee><span id="main-nav-aria-label" class="visually-hidden" data-v-a30758ee>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/linux/linux-common-commands.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Linux运维<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/network/tcp.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->网络协议<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/golang/golang-exec.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->Golang笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/k8s/runc.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->容器与k8s<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/algorithm/radix-tree.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->算法笔记<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/kernel/kernel-syscall-sched.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->内核分析<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/code_segment.html" data-v-a30758ee data-v-8fba5fa8 data-v-5704c677><!--[-->杂项<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-8856f192 data-v-311055f2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-311055f2 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-8856f192 data-v-0562f5c0 data-v-8dccea88><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-8dccea88><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-8dccea88><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-8dccea88><div class="VPMenu" data-v-8dccea88 data-v-e73581a2><!----><!--[--><!--[--><!----><div class="group" data-v-0562f5c0><div class="item appearance" data-v-0562f5c0><p class="label" data-v-0562f5c0>Appearance</p><div class="appearance-action" data-v-0562f5c0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-0562f5c0 data-v-781f9d1b data-v-1dda4c9c><span class="check" data-v-1dda4c9c><span class="icon" data-v-1dda4c9c><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-781f9d1b><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-781f9d1b><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-8856f192 data-v-6f008456><span class="container" data-v-6f008456><span class="top" data-v-6f008456></span><span class="middle" data-v-6f008456></span><span class="bottom" data-v-6f008456></span></span></button></div></div></div><!----></header><div class="VPLocalNav" data-v-6b5fd0a9 data-v-92b0f14a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-92b0f14a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-92b0f14a><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-92b0f14a>Menu</span></button><a class="top-link" href="#" data-v-92b0f14a> Return to top </a></div><aside class="VPSidebar" data-v-6b5fd0a9 data-v-55e4c7db><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-55e4c7db><span class="visually-hidden" id="sidebar-aria-label" data-v-55e4c7db> Sidebar Navigation </span><!--[--><div class="group" data-v-55e4c7db><section class="VPSidebarGroup" data-v-55e4c7db data-v-1f69a7ed><div class="title" data-v-1f69a7ed><h2 class="title-text" data-v-1f69a7ed>内核分析</h2><div class="action" data-v-1f69a7ed><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 24 24" class="icon minus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2zM20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h8c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon plus" data-v-1f69a7ed><path d="M19,2H5C3.3,2,2,3.3,2,5v14c0,1.7,1.3,3,3,3h14c1.7,0,3-1.3,3-3V5C22,3.3,20.7,2,19,2z M20,19c0,0.6-0.4,1-1,1H5c-0.6,0-1-0.4-1-1V5c0-0.6,0.4-1,1-1h14c0.6,0,1,0.4,1,1V19z"></path><path d="M16,11h-3V8c0-0.6-0.4-1-1-1s-1,0.4-1,1v3H8c-0.6,0-1,0.4-1,1s0.4,1,1,1h3v3c0,0.6,0.4,1,1,1s1-0.4,1-1v-3h3c0.6,0,1-0.4,1-1S16.6,11,16,11z"></path></svg></div></div><div class="items" data-v-1f69a7ed><!--[--><a class="VPLink link" href="/kernel/kernel-cgroup-namespace.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>cgroup与命名空间</span><!--]--><!----></a><a class="VPLink link" href="/kernel/kernel-crash.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>crash分析</span><!--]--><!----></a><a class="VPLink link" href="/kernel/kernel-irq.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>中断</span><!--]--><!----></a><a class="VPLink link active" href="/kernel/kernel-memory.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>内存管理</span><!--]--><!----></a><a class="VPLink link" href="/kernel/kernel-syscall-sched.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>系统调用与进程调度</span><!--]--><!----></a><a class="VPLink link" href="/kernel/linux-trap.html" data-v-1f69a7ed data-v-f53f775e data-v-5704c677><!--[--><span class="link-text" data-v-f53f775e>Linux: Trap</span><!--]--><!----></a><!--]--></div></section></div><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-6b5fd0a9 data-v-a4c57a06><div class="VPDoc has-sidebar" data-v-a4c57a06 data-v-79ca2460><div class="container" data-v-79ca2460><div class="aside" data-v-79ca2460><div class="aside-curtain" data-v-79ca2460></div><div class="aside-container" data-v-79ca2460><div class="aside-content" data-v-79ca2460><div class="VPDocAside" data-v-79ca2460 data-v-779d834d><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-779d834d data-v-51e5a8ce><div class="content" data-v-51e5a8ce><div class="outline-marker" data-v-51e5a8ce></div><div class="outline-title" data-v-51e5a8ce>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-51e5a8ce><span class="visually-hidden" id="doc-outline-aria-label" data-v-51e5a8ce> Table of Contents for current page </span><ul class="root" data-v-51e5a8ce><!--[--><li style="" data-v-51e5a8ce><a class="outline-link" href="#分段" data-v-51e5a8ce>分段</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#虚拟地址映射" data-v-51e5a8ce>虚拟地址映射</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#进程空间" data-v-51e5a8ce>进程空间</a><!----></li><li style="" data-v-51e5a8ce><a class="outline-link" href="#物理分配" data-v-51e5a8ce>物理分配</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-779d834d></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-79ca2460><div class="content-container" data-v-79ca2460><!--[--><!--]--><main class="main" data-v-79ca2460><div style="position:relative;" class="vp-doc _kernel_kernel-memory" data-v-79ca2460><div><h2 id="分段" tabindex="-1">分段 <a class="header-anchor" href="#分段" aria-hidden="true">#</a></h2><p>linux并没有利用分段实现虚拟内存, 但是却利用了dpl功能实现了权限控制. 用户态DPL是3, 内核态DPL是0, 当用户态程序 CPL为3时直接访问内核态的地址时，会因权限不足而报错。所以要通过syscal, int等特别指令触发切换, 这些指令会改变CPL值</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#82AAFF;">DEFINE_PER_CPU_PAGE_ALIGNED</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> gdt_page</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> gdt_page</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> .gdt </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * We need valid kernel segments for data and code in long mode too</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * IRET will check the segment types  kkeil 2000/10/28</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Also sysret mandates a special GDT layout</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * TLS descriptors are currently at a different place compared to i386.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * Hopefully nobody expects them at a fixed place (Wine?)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_KERNEL32_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc09b</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_KERNEL_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xa09b</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_KERNEL_DS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">		</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc093</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_DEFAULT_USER32_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">	</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc0fb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_DEFAULT_USER_DS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">	</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xc0f3</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">[</span><span style="color:#F07178;">GDT_ENTRY_DEFAULT_USER_CS</span><span style="color:#89DDFF;">]</span><span style="color:#F07178;">	</span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">GDT_ENTRY_INIT</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xa0fb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0xfffff</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><h2 id="虚拟地址映射" tabindex="-1">虚拟地址映射 <a class="header-anchor" href="#虚拟地址映射" aria-hidden="true">#</a></h2><p>x86_64下面分页机制采用四级目录, 相关数据结构在<code>arch/x86/include/asm/pgtable_64_types.h</code> 如果cpu支持5级分页, 当前centos9会自动激活这个特性</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PGDIR_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">39</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PGD</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * 3rd level page</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PUD_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">30</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PUD</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * PMD_SHIFT determines the size of the area a middle-level</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * page table can map</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PMD_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">21</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PMD</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> * entries per page directory level</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"> */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PTRS_PER_PTE</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">512</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PMD_SIZE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> PMD_SHIFT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PMD_MASK</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(~(</span><span style="color:#A6ACCD;">PMD_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PUD_SIZE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> PUD_SHIFT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PUD_MASK</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(~(</span><span style="color:#A6ACCD;">PUD_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PGDIR_SIZE</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> PGDIR_SHIFT</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">PGDIR_MASK</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(~(</span><span style="color:#A6ACCD;">PGDIR_SIZE </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre></div><p>x86_64的虚拟地址是64位, 但只使用48位用于映射到物理地址.因为处理器地址只有48条,要求内存地址48位到63位必须相同, 具体四级目录用到的位数如下:<br> PGD(9) + PUD(9) + PMD(9) + PTE(9) + 页内偏移(12)</p><p>查询当前系统一页的大小</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># getconf PAGE_SIZE</span></span>
<span class="line"><span style="color:#A6ACCD;">4096</span></span>
<span class="line"></span></code></pre></div><h2 id="进程空间" tabindex="-1">进程空间 <a class="header-anchor" href="#进程空间" aria-hidden="true">#</a></h2><p>进程空间分为用户态地址空间和内核态地址空间, 32位下面用户态空间是3G, 内核态时1G. 分界线为宏<code>#define TASK_SIZE</code>, 这个定义了用户态空间的最大地址, 根据下面的宏, 计算出x86_64下面为<code>0x00007FFFFFFFF000</code></p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_SIZE</span><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">test_thread_flag</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">TIF_ADDR32</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">					IA32_PAGE_OFFSET </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> TASK_SIZE_MAX</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">TASK_SIZE_MAX</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">((</span><span style="color:#F78C6C;">1UL</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#A6ACCD;"> __VIRTUAL_MASK_SHIFT</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">-</span><span style="color:#A6ACCD;"> PAGE_SIZE</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_X86_5LEVEL</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__VIRTUAL_MASK_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">pgtable_l5_enabled</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">56</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">47</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#else</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__VIRTUAL_MASK_SHIFT</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">47</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span></code></pre></div><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; struct mm_struct -x 0xffff99da00e79540 | grep size</span></span>
<span class="line"><span style="color:#A6ACCD;">    task_size = 0x7ffffffff000,</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>x86_64下<br> 用户空间 0x0000000000000000 ~ 0x00007FFFFFFFF000 128T<br> 内核空间 0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFF 128T<br> 0x00007FFFFFFFF000 到 0xFFFF800000000000 为空洞区域</p><p>在execve时,将该值设置到mm_struct上面去</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">/* Set the new mm task size. We have to do that late because it may</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * depend on TIF_32BIT which is only updated in flush_thread() on</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 * some architectures like powerpc</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	 */</span></span>
<span class="line"><span style="color:#A6ACCD;">	current</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">mm</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">task_size </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> TASK_SIZE</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> struct mm_struct.task_size -x 0xffff9f814be29f80</span></span>
<span class="line"><span style="color:#A6ACCD;">    task_size = 0x7ffffffff000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>在x86_64, 内核态从<code>0xffff888000000000</code> 开始映射整个物理内存</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__PAGE_OFFSET_BASE_L4</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xffff888000000000</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CONFIG_DYNAMIC_MEMORY_LAYOUT</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__PAGE_OFFSET</span><span style="color:#A6ACCD;">           page_offset_base</span></span>
<span class="line"></span></code></pre></div><p>如果打开了kaslr, 在<code>kernel_randomize_memory</code>里会对<code>page_offset_base</code>随机向上偏移一些位置, 如下是实际运行的cents8里的值:</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> px page_offset_base</span></span>
<span class="line"><span style="color:#A6ACCD;">page_offset_base = </span><span style="color:#89DDFF;">$</span><span style="color:#A6ACCD;">20 = 0xffff9f7f40000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>参考文档: Documentation/x86/x86_64/mm.txt</p><h3 id="用户态" tabindex="-1">用户态 <a class="header-anchor" href="#用户态" aria-hidden="true">#</a></h3><p>在load_elf_binary函数里 <code>setup_new_exec</code>里设置mm-&gt;mmap_base和mm-&gt;task_size, <code>kernel.randomize_va_space = 2</code>表示需要随机化部分区域的起始地址, 包括mmap, stack等<br><code>setup_arg_pages</code>里设置mm-&gt;arg_start和mm-&gt;start_stack, 此时这两个值一样<br><code>create_elf_tables</code> 重新设置了mm-&gt;start_stack<br> start_stack指栈底, 它与arg_start之前存放了一些信息, 比如执行命令的参数个数和每一个参数的具体字符串指针, 每一个环境变量的指针. arg_start ~ arg_end, env_start ~ env_end 之间才是真正存放这些数据的地方. 在程序内部改变这些指针值就能改变参数和环境变量信息</p><h3 id="内核态" tabindex="-1">内核态 <a class="header-anchor" href="#内核态" aria-hidden="true">#</a></h3><p>page_offset_base开始的64T范围内是直接映射内存, 这些虚拟地址对应的物理地址就是 减去page_offset_base<br> page_offset_base默认是0xffff888000000000, 如果<code>CONFIG_RANDOMIZE_MEMORY=y</code>则会随机偏移些<br> 每个进程对应的task_struct分配在这个区域, 可以减去page_offset_base直接得到物理地址</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; vtop ffff9e68002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;">VIRTUAL           PHYSICAL</span></span>
<span class="line"><span style="color:#A6ACCD;">ffff9e68002398c0  1002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">PGD DIRECTORY: ffffffffb2e10000</span></span>
<span class="line"><span style="color:#A6ACCD;">PAGE DIRECTORY: 1c601067</span></span>
<span class="line"><span style="color:#A6ACCD;">   PUD: 1c601d00 =&gt; 1c606067</span></span>
<span class="line"><span style="color:#A6ACCD;">   PMD: 1c606008 =&gt; 1057a9063</span></span>
<span class="line"><span style="color:#A6ACCD;">   PTE: 1057a91c8 =&gt; 8000000100239063</span></span>
<span class="line"><span style="color:#A6ACCD;">  PAGE: 100239000</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">      PTE         PHYSICAL   FLAGS</span></span>
<span class="line"><span style="color:#A6ACCD;">8000000100239063  100239000  (PRESENT|RW|ACCESSED|DIRTY|NX)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">      PAGE        PHYSICAL      MAPPING       INDEX CNT FLAGS</span></span>
<span class="line"><span style="color:#A6ACCD;">ffffdba004008e40 100239000 dead000000000008        0  0 17ffffc0000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; px page_offset_base</span></span>
<span class="line"><span style="color:#A6ACCD;">page_offset_base = $15 = 0xffff9e6700000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; eval ffff9e68002398c0 - 0xffff9e6700000000</span></span>
<span class="line"><span style="color:#A6ACCD;">hexadecimal: 1002398c0</span></span>
<span class="line"><span style="color:#A6ACCD;">    decimal: 4297300160</span></span>
<span class="line"><span style="color:#A6ACCD;">      octal: 40010714300</span></span>
<span class="line"><span style="color:#A6ACCD;">     binary: 0000000000000000000000000000000100000000001000111001100011000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>vmalloc_base从 0xffffc90000000000UL开始, 随机偏移后, 可通过如下命令获取当前值</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; px vmalloc_base</span></span>
<span class="line"><span style="color:#A6ACCD;">vmalloc_base = $16 = 0xffffb9cb00000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>vmemmap_base从 0xffffea0000000000UL开始, 随机偏移后, 可通过如下命令获取当前值, 存放 struct page</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; px vmemmap_base</span></span>
<span class="line"><span style="color:#A6ACCD;">vmemmap_base = $17 = 0xffffdba000000000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>内核的代码段从__START_KERNEL_map开始, 对应的物理地址是减去 __START_KERNEL_map 加上 phys_base</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__START_KERNEL_map</span><span style="color:#A6ACCD;">	</span><span style="color:#82AAFF;">_AC</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">0xffffffff80000000</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> UL</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h2 id="物理分配" tabindex="-1">物理分配 <a class="header-anchor" href="#物理分配" aria-hidden="true">#</a></h2><p>当前主流都是numa结构, 即一个CPU对应本地内存, 当本地内存不够, 再通过总线访问其他节点的内存. 内存管理的最小单位是页, 通常是4K, 它属于Zone, Zone属于node节点节. node节点就是numa节点</p><p>如下表示该OS可以支持 1&lt;&lt; 10 == 1024个numa节点</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># grep CONFIG_NODES_SHIFT /boot/config-5.14.0-22.el9.x86_64</span></span>
<span class="line"><span style="color:#A6ACCD;">CONFIG_NODES_SHIFT=10</span></span>
<span class="line"></span></code></pre></div><p>一台4u8G的机器, 只有一个numa. cpu0~3属于node0</p><div class="language-bash"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@localhost </span><span style="color:#89DDFF;">~]</span><span style="color:#676E95;font-style:italic;"># lscpu | grep NUMA</span></span>
<span class="line"><span style="color:#A6ACCD;">NUMA node</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">:                    1</span></span>
<span class="line"><span style="color:#A6ACCD;">NUMA node0 CPU</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">:               0-3</span></span>
<span class="line"></span></code></pre></div><p>node0里面的跟物理内存的相关的数据如下</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> pglist_data </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">node_data</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">MAX_NUMNODES</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> __read_mostly</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">EXPORT_SYMBOL</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">node_data</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">crash&gt; p node_data[0]</span></span>
<span class="line"><span style="color:#A6ACCD;">$22 = (pg_data_t *) 0xffff94e6dffd1000</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;  struct pg_data_t.node_id,nr_zones,node_start_pfn,node_present_pages,node_spanned_pages -x 0xffff94e6dffd1000</span></span>
<span class="line"><span style="color:#A6ACCD;">  node_id = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  nr_zones = 0x3,</span></span>
<span class="line"><span style="color:#A6ACCD;">  node_start_pfn = 0x1,              //从页号1开始</span></span>
<span class="line"><span style="color:#A6ACCD;">  node_present_pages = 0x1fff8e,     //该node管理0x1fff8e个可用的页. </span></span>
<span class="line"><span style="color:#A6ACCD;">  node_spanned_pages = 0x21ffff,     //管理0x21ffff页(8G), 除了包含present_pages, 还包含了空洞的物理地址. 这些页不可用.</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt; struct zone.name,zone_start_pfn,spanned_pages,present_pages,managed_pages -x ffff94e6dffd1000 5</span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9fa3ed3 &quot;DMA&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x1,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0xfff,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0xf9e,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0xf00</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f4c32c &quot;DMA32&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x1000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0xff000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0xdeff0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0xcaff0</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f4c222 &quot;Normal&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x100000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0x120000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0x120000,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0x1145ec</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f4c229 &quot;Movable&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0x0</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  name = 0xffffffffa9f9924d &quot;Device&quot;,</span></span>
<span class="line"><span style="color:#A6ACCD;">  zone_start_pfn = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  spanned_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  present_pages = 0x0,</span></span>
<span class="line"><span style="color:#A6ACCD;">  managed_pages = {</span></span>
<span class="line"><span style="color:#A6ACCD;">    counter = 0x0</span></span>
<span class="line"><span style="color:#A6ACCD;">  },</span></span>
<span class="line"><span style="color:#A6ACCD;">crash&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>0x1fff8e个可用页等于 8388152K</p><div class="language-"><span class="copy"></span><pre><code><span class="line"><span style="color:#A6ACCD;">[root@localhost ~]# dmesg -T | grep Mem</span></span>
<span class="line"><span style="color:#A6ACCD;">[Sun Dec 26 11:12:09 2021] Memory: 3442876K/8388152K available (14345K kernel code, 5931K rwdata, 8944K rodata, 2656K init, 5448K bss, 556100K reserved, 0K cma-reserved)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>上面可以看到64位下有三个zone, 分别是 DMA, DMA32, Normal<br> struct page代表一页, 页通过伙伴系统管理. 所有空闲页挂在11个页块链表上. 每个链表包含相同连续页的地址. 有 1、2、4、8、16、32、64、128、256、512 和 1024. 所以一次最大可申请1024个物理地址连续的页(即4M的内存). 这些链表存在struct zone.free_area<br> 第 i 个页块链表中，页块中页的数目为 2^i</p><div class="language-c"><span class="copy"></span><pre><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MAX_ORDER</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">11</span></span>
<span class="line"></span></code></pre></div><p>order为i时, 意味着申请 2 ^ i 个连续页, 如果free_area[i]没有, 则去free_area[i+1]里面找, 依次类推</p></div></div></main><footer class="VPDocFooter" data-v-79ca2460 data-v-04568844><div class="edit-info" data-v-04568844><!----><div class="last-updated" data-v-04568844><p class="VPLastUpdated" data-v-04568844 data-v-0ce8c960>Last updated: <time datatime="2022-07-14T14:54:09.000Z" data-v-0ce8c960></time></p></div></div><div class="prev-next" data-v-04568844><div class="pager" data-v-04568844><a class="pager-link prev" href="/kernel/kernel-irq.html" data-v-04568844><span class="desc" data-v-04568844>Previous page</span><span class="title" data-v-04568844>中断</span></a></div><div class="has-prev pager" data-v-04568844><a class="pager-link next" href="/kernel/kernel-syscall-sched.html" data-v-04568844><span class="desc" data-v-04568844>Next page</span><span class="title" data-v-04568844>系统调用与进程调度</span></a></div></div></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter has-sidebar" data-v-6b5fd0a9 data-v-5b331722><div class="container" data-v-5b331722><p class="message" data-v-5b331722>Released under the MIT License.</p><p class="copyright" data-v-5b331722>Copyright © 2022-present xixiliguo</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"algorithm_algorithm-dfs.md\":\"a73dea67\",\"algorithm_binary-index-tree.md\":\"8bc3e51f\",\"algorithm_radix-tree.md\":\"6b75afb6\",\"algorithm_segment-tree.md\":\"c689b78e\",\"algorithm_unionfind.md\":\"a646711f\",\"golang_golang-exec.md\":\"357621ac\",\"golang_strings-algorithm-golang.md\":\"57a20191\",\"index.md\":\"27757f36\",\"k8s_runc.md\":\"09e5ae92\",\"kernel_kernel-cgroup-namespace.md\":\"4a81fd3c\",\"kernel_kernel-crash.md\":\"27a485e9\",\"kernel_kernel-irq.md\":\"0bfc9b45\",\"kernel_kernel-memory.md\":\"1c2cf851\",\"kernel_kernel-syscall-sched.md\":\"29c8373b\",\"kernel_linux-trap.md\":\"ae6473f3\",\"linux_atop.md\":\"6cfa95b0\",\"linux_bandersnatch-pypi.md\":\"dee4724b\",\"linux_cloud-init.md\":\"e0bc6141\",\"linux_dns.md\":\"ccf3bd81\",\"linux_linux-boot.md\":\"459acaa4\",\"linux_linux-common-commands.md\":\"c3e4942a\",\"linux_linux-shadow.md\":\"4d01a795\",\"linux_multi-queue.md\":\"9db1b9ad\",\"linux_ntp.md\":\"0f26af7e\",\"linux_yum-update.md\":\"67a0bf95\",\"network_libvirt-network.md\":\"90682305\",\"network_tcp.md\":\"2211909d\",\"network_tcpdump-wireshark.md\":\"a2fe5423\",\"others_code_segment.md\":\"f0f03c59\",\"others_lua-implemention-gc.md\":\"80382876\",\"others_lua-implemention-type-value.md\":\"e4816df1\"}")</script>
    <script type="module" async src="/assets/app.526dca4e.js"></script>
    
  </body>
</html>